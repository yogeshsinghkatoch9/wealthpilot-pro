<%
// Safe defaults for all variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safeProperties = typeof properties !== 'undefined' ? properties : [];
const safeTotals = typeof totals !== 'undefined' ? totals : {
  totalValue: 0,
  totalEquity: 0,
  totalIncome: 0
};
const safeFmt = typeof fmt !== 'undefined' ? fmt : {
  money: (val) => `$${Number(val || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
};
%>
<%- include('../partials/header', { pageTitle: 'Real Estate' }) %>

<!-- Bloomberg Header Bar -->
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6 pb-4 border-b-2 border-green-400">
<div>
<h1 class="text-2xl font-bold text-green-400 font-mono tracking-tight">REAL ESTATE PORTFOLIO</h1>
<p class="text-slate-400 text-sm mt-1">Track properties and rental income</p>
</div>
<button onclick="openAddModal()" class="bloomberg-btn bloomberg-btn-primary">+ ADD PROPERTY</button>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm uppercase tracking-wider mb-2">Total Value</p>
<p class="text-3xl font-bold text-white font-mono"><%= safeFmt.money(safeTotals.totalValue || 0) %></p>
<p class="text-sm text-slate-400 mt-1 font-mono"><%= safeProperties.length %> properties</p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm uppercase tracking-wider mb-2">Total Equity</p>
<p class="text-3xl font-bold text-emerald-400 font-mono"><%= safeFmt.money(safeTotals.totalEquity || 0) %></p>
<% const ltv = safeTotals.totalValue > 0 ? ((safeTotals.totalValue - safeTotals.totalEquity) / safeTotals.totalValue * 100) : 0; %>
<p class="text-sm text-slate-400 mt-1 font-mono">LTV: <%= ltv.toFixed(1) %>%</p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm uppercase tracking-wider mb-2">Monthly Income</p>
<p class="text-3xl font-bold text-emerald-400 font-mono"><%= safeFmt.money(safeTotals.totalIncome || 0) %></p>
<p class="text-sm text-slate-400 mt-1 font-mono"><%= safeFmt.money((safeTotals.totalIncome || 0) * 12) %>/year</p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm uppercase tracking-wider mb-2">Avg Cap Rate</p>
<% const avgCapRate = safeTotals.totalValue > 0 ? ((safeTotals.totalIncome || 0) * 12 / safeTotals.totalValue * 100) : 0; %>
<p class="text-3xl font-bold text-green-400 font-mono"><%= avgCapRate.toFixed(2) %>%</p>
<p class="text-sm text-slate-400 mt-1">Net operating income</p>
</div>
</div>

<!-- Properties -->
<div class="bloomberg-card overflow-hidden">
<div class="p-4 border-b border-green-400/30 bg-black/20">
<h3 class="font-semibold text-green-400 uppercase tracking-wider font-mono">Properties</h3>
</div>
<% if (safeProperties.length === 0) { %>
<div class="p-12 text-center">
<svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
</svg>
<h4 class="text-lg font-semibold text-white mb-2 font-mono">NO PROPERTIES</h4>
<p class="text-slate-400 mb-4">Add your first property to track your real estate portfolio</p>
<button onclick="openAddModal()" class="bloomberg-btn bloomberg-btn-primary">ADD PROPERTY</button>
</div>
<% } else { %>
<table class="w-full text-sm">
<thead>
<tr class="bg-black/40 text-slate-400 text-left border-b border-green-400/30">
<th class="px-4 py-3 uppercase tracking-wider text-xs font-mono">Property</th>
<th class="px-4 py-3 uppercase tracking-wider text-xs font-mono">Type</th>
<th class="px-4 py-3 text-right uppercase tracking-wider text-xs font-mono">Value</th>
<th class="px-4 py-3 text-right uppercase tracking-wider text-xs font-mono">Mortgage</th>
<th class="px-4 py-3 text-right uppercase tracking-wider text-xs font-mono">Equity</th>
<th class="px-4 py-3 text-right uppercase tracking-wider text-xs font-mono">Monthly Income</th>
<th class="px-4 py-3 text-right uppercase tracking-wider text-xs font-mono">Cap Rate</th>
<th class="px-4 py-3 uppercase tracking-wider text-xs font-mono">Actions</th>
</tr>
</thead>
<tbody>
<% safeProperties.forEach(p => {
  const equity = (p.current_value || 0) - (p.mortgage_balance || 0);
  const capRate = p.current_value > 0 ? ((p.monthly_income || 0) * 12 / p.current_value * 100) : 0;
%>
<tr class="border-b border-slate-700/50 hover:bg-slate-800/30 transition-colors">
<td class="px-4 py-4">
<div>
<p class="font-medium text-white"><%= p.name %></p>
<p class="text-xs text-slate-400"><%= p.address || 'No address' %></p>
</div>
</td>
<td class="px-4 py-4">
<span class="px-2 py-1 rounded text-xs font-mono <%= p.property_type === 'residential' ? 'bg-sky-500/20 text-sky-400' : p.property_type === 'commercial' ? 'bg-purple-500/20 text-purple-400' : 'bg-green-500/20 text-green-400' %>">
<%= (p.property_type || 'Other').charAt(0).toUpperCase() + (p.property_type || 'other').slice(1) %>
</span>
</td>
<td class="px-4 py-4 text-right text-white font-medium font-mono"><%= safeFmt.money(p.current_value || 0) %></td>
<td class="px-4 py-4 text-right text-red-400 font-mono"><%= safeFmt.money(p.mortgage_balance || 0) %></td>
<td class="px-4 py-4 text-right text-emerald-400 font-medium font-mono"><%= safeFmt.money(equity) %></td>
<td class="px-4 py-4 text-right text-emerald-400 font-mono"><%= safeFmt.money(p.monthly_income || 0) %></td>
<td class="px-4 py-4 text-right text-slate-300 font-mono"><%= capRate.toFixed(2) %>%</td>
<td class="px-4 py-4">
<button onclick="deleteProperty('<%= p.id %>')" class="text-red-400 hover:text-red-300 transition-colors">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
</button>
</td>
</tr>
<% }) %>
</tbody>
</table>
<% } %>
</div>

</div></div></main>

<!-- Add Property Modal -->
<div id="addModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
<div class="bloomberg-card p-6 w-full max-w-lg mx-4">
<div class="border-b border-green-400/30 pb-3 mb-4">
<h3 class="text-xl font-bold text-green-400 font-mono uppercase tracking-wide">Add Property</h3>
</div>
<form id="addForm" class="space-y-4">
<div class="grid grid-cols-2 gap-4">
<div class="col-span-2">
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Property Name</label>
<input type="text" name="name" class="form-input font-mono" placeholder="Beach House" required>
</div>
<div class="col-span-2">
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Address</label>
<input type="text" name="address" class="form-input font-mono" placeholder="123 Ocean Drive, Miami, FL">
</div>
<div>
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Type</label>
<select name="propertyType" class="form-input font-mono">
<option value="residential">Residential</option>
<option value="commercial">Commercial</option>
<option value="industrial">Industrial</option>
<option value="land">Land</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Purchase Price</label>
<input type="number" name="purchasePrice" class="form-input font-mono" placeholder="500000" required>
</div>
<div>
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Current Value</label>
<input type="number" name="currentValue" class="form-input font-mono" placeholder="600000" required>
</div>
<div>
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Mortgage Balance</label>
<input type="number" name="mortgageBalance" class="form-input font-mono" placeholder="350000">
</div>
<div>
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Monthly Income</label>
<input type="number" name="monthlyIncome" class="form-input font-mono" placeholder="3500">
</div>
<div>
<label class="block text-sm font-medium text-slate-300 mb-1 uppercase tracking-wider text-xs">Monthly Expenses</label>
<input type="number" name="monthlyExpenses" class="form-input font-mono" placeholder="800">
</div>
</div>
</form>
<div class="flex gap-3 mt-6">
<button onclick="closeAddModal()" class="bloomberg-btn bloomberg-btn-secondary flex-1">CANCEL</button>
<button onclick="submitAdd()" class="bloomberg-btn bloomberg-btn-primary flex-1">ADD PROPERTY</button>
</div>
</div>
</div>

<script>
function openAddModal() {
  document.getElementById('addModal').classList.remove('hidden');
  document.getElementById('addModal').classList.add('flex');
}

function closeAddModal() {
  document.getElementById('addModal').classList.add('hidden');
  document.getElementById('addModal').classList.remove('flex');
}

async function submitAdd() {
  const form = document.getElementById('addForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);

  try {
    const res = await fetch('/api/real-estate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (res.ok) {
      showToast('Property added!', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      const err = await res.json();
      showToast(err.error || 'Failed to add', 'error');
    }
  } catch (e) {
    showToast('Error adding property', 'error');
  }
  closeAddModal();
}

async function deleteProperty(id) {
  if (!confirm('Delete this property?')) return;
  try {
    const res = await fetch('/api/real-estate/' + id, { method: 'DELETE' });
    if (res.ok) {
      showToast('Deleted!', 'success');
      setTimeout(() => location.reload(), 500);
    }
  } catch (e) {
    showToast('Error deleting', 'error');
  }
}
</script>
<%- include('../partials/footer') %>
