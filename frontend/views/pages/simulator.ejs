<%- include('../partials/header', { pageTitle: 'Simulator' }) %>
<main class="p-4 lg:p-6"><div class="max-w-7xl mx-auto space-y-6">
<div class="flex items-center justify-between"><div><h1 class="text-2xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Portfolio Simulator</h1><p class="<%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Test scenarios & what-if analysis</p></div><form method="GET"><select name="portfolio" onchange="this.form.submit()" class="form-input w-48"><% portfolios.forEach(p => { %><option value="<%= p.id %>" <%= selectedPid == p.id ? 'selected' : '' %>><%= p.name %></option><% }) %></select></form></div>

<!-- Current Portfolio Stats -->
<div class="card p-5 bg-gradient-to-r from-sky-500/10 to-purple-500/10 border-sky-500/30"><div class="flex items-center justify-between"><div><h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold mb-1">Current Portfolio</h3><p class="<%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %> text-sm">Base for simulations</p></div><div class="text-right"><p class="text-2xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>"><%= analysis ? fmt.money(analysis.summary?.total_value) : '$0' %></p><p class="<%= (analysis?.summary?.total_gain || 0) >= 0 ? 'text-emerald-400' : 'text-red-400' %>"><%= fmt.pct((analysis?.summary?.gain_pct || 0)) %> all time</p></div></div></div>

<!-- Scenario Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<!-- Market Crash -->
<div class="card p-5 hover:border-red-500/50 transition-colors cursor-pointer" onclick="runScenario('crash')"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center"><svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg></div><div><h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold">Market Crash</h3><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-sm">-30% drawdown</p></div></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs mb-1">Projected Value</p><p class="text-xl font-bold text-red-400" id="crashValue"><%= analysis ? fmt.money((analysis.summary?.total_value || 0) * 0.7) : '-' %></p></div></div>

<!-- Bull Market -->
<div class="card p-5 hover:border-emerald-500/50 transition-colors cursor-pointer" onclick="runScenario('bull')"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center"><svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg></div><div><h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold">Bull Market</h3><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-sm">+25% rally</p></div></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs mb-1">Projected Value</p><p class="text-xl font-bold text-emerald-400"><%= analysis ? fmt.money((analysis.summary?.total_value || 0) * 1.25) : '-' %></p></div></div>

<!-- Interest Rate Hike -->
<div class="card p-5 hover:border-amber-500/50 transition-colors cursor-pointer" onclick="runScenario('rates')"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center"><svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div><h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold">Rate Hike</h3><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-sm">+100bps impact</p></div></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs mb-1">Projected Value</p><p class="text-xl font-bold text-amber-400"><%= analysis ? fmt.money((analysis.summary?.total_value || 0) * 0.92) : '-' %></p></div></div>

<!-- Sector Rotation -->
<div class="card p-5 hover:border-purple-500/50 transition-colors cursor-pointer" onclick="runScenario('rotation')"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center"><svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></div><div><h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold">Sector Rotation</h3><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-sm">Tech → Value shift</p></div></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs mb-1">Projected Value</p><p class="text-xl font-bold text-purple-400"><%= analysis ? fmt.money((analysis.summary?.total_value || 0) * 0.95) : '-' %></p></div></div>

<!-- Dividend Cut -->
<div class="card p-5 hover:border-orange-500/50 transition-colors cursor-pointer" onclick="runScenario('dividend')"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl bg-orange-500/20 flex items-center justify-center"><svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div><h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold">Dividend Cut</h3><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-sm">-50% dividend income</p></div></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs mb-1">Annual Income</p><p class="text-xl font-bold text-orange-400"><%= analysis ? fmt.money((analysis.income_analysis?.annual_income || 0) * 0.5) : '-' %></p></div></div>

<!-- Custom -->
<div class="card p-5 hover:border-sky-500/50 transition-colors cursor-pointer" onclick="openModal('customModal')"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl bg-sky-500/20 flex items-center justify-center"><svg class="w-6 h-6 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg></div><div><h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold">Custom Scenario</h3><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-sm">Build your own</p></div></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl text-center"><p class="text-sky-400 font-medium">Configure →</p></div></div>
</div>

<!-- Simulation Results -->
<div class="card p-5" id="resultsCard" style="display:none;"><h3 class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Simulation Results</h3><div class="h-72"><canvas id="simulationChart"></canvas></div><div class="grid grid-cols-4 gap-4 mt-4"><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl text-center"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs">Best Case</p><p class="font-bold text-emerald-400" id="bestCase">-</p></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl text-center"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs">Expected</p><p class="font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>" id="expected">-</p></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl text-center"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs">Worst Case</p><p class="font-bold text-red-400" id="worstCase">-</p></div><div class="p-3 <%= theme === 'light' ? 'bg-gray-100' : 'bg-slate-800/50' %> rounded-xl text-center"><p class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> text-xs">Probability</p><p class="font-bold text-purple-400" id="probability">-</p></div></div></div>
</div></div></main>

<div id="customModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Custom Scenario</h3><button onclick="closeModal('customModal')" class="modal-close">&times;</button></div><div class="space-y-4"><div><label class="block text-sm font-medium <%= theme === 'light' ? 'text-gray-700' : 'text-slate-300' %> mb-1.5">Market Change (%)</label><input type="range" min="-50" max="50" value="0" class="w-full" id="marketChange" oninput="document.getElementById('marketVal').textContent=this.value+'%'"><p class="text-center <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-medium" id="marketVal">0%</p></div><div><label class="block text-sm font-medium <%= theme === 'light' ? 'text-gray-700' : 'text-slate-300' %> mb-1.5">Time Horizon (months)</label><select class="form-input"><option>3 months</option><option>6 months</option><option selected>12 months</option><option>24 months</option><option>60 months</option></select></div><div><label class="block text-sm font-medium <%= theme === 'light' ? 'text-gray-700' : 'text-slate-300' %> mb-1.5">Monthly Contribution</label><input type="number" class="form-input" placeholder="1000" value="0"></div><button onclick="runCustomScenario()" class="btn-primary w-full">Run Simulation</button></div></div></div>

<script>const baseValue = <%= analysis?.summary?.total_value || 100000 %>;function runScenario(type){document.getElementById('resultsCard').style.display='block';showToast('Running '+type+' simulation...','info');setTimeout(()=>{const mult={crash:0.7,bull:1.25,rates:0.92,rotation:0.95,dividend:1}[type];document.getElementById('bestCase').textContent=formatMoney(baseValue*mult*1.1);document.getElementById('expected').textContent=formatMoney(baseValue*mult);document.getElementById('worstCase').textContent=formatMoney(baseValue*mult*0.85);document.getElementById('probability').textContent='68%';showToast('Simulation complete','success')},1000)}function runCustomScenario(){closeModal('customModal');const change=parseInt(document.getElementById('marketChange').value);runScenario(change>0?'bull':'crash')}function formatMoney(n){return '$'+Math.round(n).toLocaleString()}</script>
<%- include('../partials/footer') %>
