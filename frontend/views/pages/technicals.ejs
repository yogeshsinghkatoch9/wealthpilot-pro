<%
// Safe defaults for all potentially undefined variables
const safeTheme = typeof theme !== 'undefined' && theme ? theme : 'dark';
const safePageTitle = typeof pageTitle !== 'undefined' && pageTitle ? pageTitle : 'Technical Indicators';
const t = technicals || {};
const tech = t.technicals || {};
const mom = t.momentum || {};
const fib = tech.fibonacci || {};
const bb = tech.bollingerBands || {};
const price = t.currentPrice || 0;
const rsiVal = tech.rsi || 50;
const macdVal = tech.macd || 0;
const signalVal = tech.signal || 0;
const histogramVal = tech.histogram || 0;
const chartData = t.chartData || [];

// Helper functions
function formatPrice(v) { return '$' + (v || 0).toFixed(2); }
function formatPct(v) { return (v >= 0 ? '+' : '') + (v || 0).toFixed(2) + '%'; }
function getRsiSignal(rsi) {
  if (rsi > 70) return { text: 'OVERBOUGHT', color: 'red' };
  if (rsi < 30) return { text: 'OVERSOLD', color: 'emerald' };
  if (rsi > 50) return { text: 'BULLISH', color: 'emerald' };
  return { text: 'NEUTRAL', color: 'amber' };
}
function getMacdSignal(macd, signal) {
  if (macd > signal) return { text: 'BUY SIGNAL', color: 'emerald' };
  return { text: 'SELL SIGNAL', color: 'red' };
}
function getTrendSignal(price, sma50, sma200) {
  if (price > sma50 && price > sma200) return { text: 'BULLISH', color: 'emerald' };
  if (price < sma50 && price < sma200) return { text: 'BEARISH', color: 'red' };
  return { text: 'NEUTRAL', color: 'amber' };
}
function getVolumeSignal(ratio) {
  if (ratio > 1.2) return { text: 'ABOVE AVG', color: 'purple' };
  if (ratio < 0.8) return { text: 'BELOW AVG', color: 'slate' };
  return { text: 'AVERAGE', color: 'amber' };
}
function getMaSignal(price, ma) {
  if (!ma) return { text: 'N/A', color: 'slate', pct: 0 };
  const pct = ((price - ma) / ma) * 100;
  return {
    text: price > ma ? 'BUY' : 'SELL',
    color: price > ma ? 'emerald' : 'red',
    pct: pct
  };
}

const rsiSignal = getRsiSignal(rsiVal);
const macdSignal = getMacdSignal(macdVal, signalVal);
const trendSignal = getTrendSignal(price, tech.sma50, tech.sma200);
const volSignal = getVolumeSignal(tech.volumeRatio || 1);
%>
<%- include('../partials/header', { pageTitle: 'Technical Indicators' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header-bar">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <h1 class="text-xl font-bold text-amber-400 tracking-wide">TECHNICAL INDICATORS</h1>
      <span class="live-indicator">LIVE</span>
    </div>
    <div class="flex gap-2">
      <form method="GET" action="/technicals" class="flex gap-2">
        <input type="text" name="symbol" placeholder="TICKER" value="<%= symbol || 'AAPL' %>" class="bg-black border border-amber-400/30 px-3 py-1.5 font-mono text-sm text-white focus:outline-none focus:border-amber-400 w-24 uppercase">
        <button type="submit" class="px-3 py-1.5 bg-amber-400 text-black font-bold text-sm hover:bg-amber-300">GO</button>
      </form>
      <% if (typeof holdings !== 'undefined' && holdings && holdings.length > 0) { %>
      <select onchange="window.location.href='/technicals?symbol='+this.value" class="bg-black border border-amber-400/30 px-3 py-1.5 font-mono text-sm text-white focus:outline-none focus:border-amber-400 w-32">
        <option value="">Portfolio</option>
        <% holdings.forEach(h => { %>
        <option value="<%= h.symbol %>" <%= h.symbol === symbol ? 'selected' : '' %>><%= h.symbol %></option>
        <% }); %>
      </select>
      <% } %>
    </div>
  </div>
</div>

<% if (!technicals) { %>
<div class="bloomberg-card text-center py-12">
  <p class="text-amber-400 text-lg">No technical data available for <%= symbol %></p>
  <p class="text-slate-400 mt-2">Try a different symbol or check if the market is open.</p>
</div>
<% } else { %>

<!-- KPI Bar -->
<div class="kpi-bar">
  <div class="kpi-item">
    <div class="kpi-label">CURRENT PRICE</div>
    <div class="kpi-value text-amber-400 font-mono"><%= formatPrice(price) %></div>
    <div class="text-xs text-slate-400 mt-1"><%= symbol %></div>
  </div>
  <div class="kpi-item">
    <div class="kpi-label">TREND</div>
    <div class="kpi-value text-<%= trendSignal.color %>-400 font-mono"><%= trendSignal.text %></div>
    <div class="text-xs text-<%= trendSignal.color %>-400 mt-1"><%= trendSignal.text === 'BULLISH' ? '↑' : trendSignal.text === 'BEARISH' ? '↓' : '→' %> Price vs MAs</div>
  </div>
  <div class="kpi-item">
    <div class="kpi-label">MOMENTUM</div>
    <div class="kpi-value text-<%= rsiSignal.color %>-400 font-mono"><%= rsiSignal.text %></div>
    <div class="text-xs text-sky-400 mt-1">RSI: <%= rsiVal.toFixed(1) %></div>
  </div>
  <div class="kpi-item">
    <div class="kpi-label">MACD</div>
    <div class="kpi-value text-<%= macdSignal.color %>-400 font-mono"><%= macdSignal.text %></div>
    <div class="text-xs text-<%= macdSignal.color %>-400 mt-1">Hist: <%= histogramVal.toFixed(2) %></div>
  </div>
  <div class="kpi-item">
    <div class="kpi-label">VOLUME</div>
    <div class="kpi-value text-<%= volSignal.color %>-400 font-mono"><%= volSignal.text %></div>
    <div class="text-xs text-<%= volSignal.color %>-400 mt-1"><%= formatPct((tech.volumeRatio - 1) * 100) %> vs avg</div>
  </div>
</div>

<!-- Price Chart with Indicators -->
<div class="bloomberg-card">
  <div class="border-b border-amber-400/20 pb-3 mb-4">
    <h3 class="text-sm font-bold text-amber-400 tracking-wider uppercase">Price with Bollinger Bands - <%= symbol %></h3>
  </div>
  <div class="h-72"><canvas id="priceChart"></canvas></div>
</div>

<!-- Indicator Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<!-- RSI -->
<div class="bloomberg-card">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-bold text-amber-400 tracking-wider uppercase">RSI (14)</h3>
    <span class="px-2 py-1 bg-<%= rsiSignal.color %>-500/20 text-<%= rsiSignal.color %>-400 text-xs font-bold font-mono"><%= rsiSignal.text %></span>
  </div>
  <div class="relative h-8 rounded-full bg-black border border-slate-700 overflow-hidden">
    <div class="absolute inset-y-0 left-0 w-[30%] bg-emerald-500/30"></div>
    <div class="absolute inset-y-0 left-[30%] w-[40%] bg-amber-500/30"></div>
    <div class="absolute inset-y-0 right-0 w-[30%] bg-red-500/30"></div>
    <div class="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-sky-500 border-2 border-amber-400 shadow" style="left:calc(<%= Math.min(Math.max(rsiVal, 0), 100) %>% - 8px)"></div>
  </div>
  <div class="flex justify-between text-xs mt-2 text-slate-400">
    <span>Oversold (0-30)</span>
    <span class="font-bold text-sky-400 font-mono"><%= rsiVal.toFixed(1) %></span>
    <span>Overbought (70-100)</span>
  </div>
  <p class="text-sm text-slate-400 mt-3">
    <% if (rsiVal > 70) { %>Overbought territory - potential reversal.<% }
       else if (rsiVal < 30) { %>Oversold territory - potential bounce.<% }
       else if (rsiVal > 50) { %>Neutral zone, trending bullish.<% }
       else { %>Neutral zone, trending bearish.<% } %>
  </p>
</div>

<!-- MACD -->
<div class="bloomberg-card">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-bold text-amber-400 tracking-wider uppercase">MACD</h3>
    <span class="px-2 py-1 bg-<%= macdSignal.color %>-500/20 text-<%= macdSignal.color %>-400 text-xs font-bold font-mono"><%= macdSignal.text %></span>
  </div>
  <div class="h-32"><canvas id="macdChart"></canvas></div>
  <div class="grid grid-cols-3 gap-2 mt-3 text-center text-sm">
    <div><p class="text-slate-400 text-xs uppercase">MACD</p><p class="font-bold text-<%= macdVal >= 0 ? 'emerald' : 'red' %>-400 font-mono"><%= macdVal.toFixed(2) %></p></div>
    <div><p class="text-slate-400 text-xs uppercase">Signal</p><p class="font-bold text-amber-400 font-mono"><%= signalVal.toFixed(2) %></p></div>
    <div><p class="text-slate-400 text-xs uppercase">Histogram</p><p class="font-bold text-<%= histogramVal >= 0 ? 'emerald' : 'red' %>-400 font-mono"><%= histogramVal >= 0 ? '+' : '' %><%= histogramVal.toFixed(2) %></p></div>
  </div>
</div>

<!-- Bollinger Bands -->
<div class="bloomberg-card">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-bold text-amber-400 tracking-wider uppercase">Bollinger Bands (20,2)</h3>
    <span class="px-2 py-1 bg-sky-500/20 text-sky-400 text-xs font-bold font-mono">
      <% if (price > bb.upper) { %>ABOVE UPPER<% }
         else if (price < bb.lower) { %>BELOW LOWER<% }
         else { %>IN BAND<% } %>
    </span>
  </div>
  <div class="space-y-2">
    <div class="flex justify-between items-center">
      <span class="text-slate-400 text-sm">Upper Band</span>
      <span class="font-mono text-red-400"><%= formatPrice(bb.upper) %></span>
    </div>
    <div class="flex justify-between items-center bg-amber-500/20 p-2 rounded">
      <span class="text-amber-400 text-sm font-bold">Current Price</span>
      <span class="font-mono text-amber-400 font-bold"><%= formatPrice(price) %></span>
    </div>
    <div class="flex justify-between items-center">
      <span class="text-slate-400 text-sm">Middle (SMA20)</span>
      <span class="font-mono text-sky-400"><%= formatPrice(bb.middle) %></span>
    </div>
    <div class="flex justify-between items-center">
      <span class="text-slate-400 text-sm">Lower Band</span>
      <span class="font-mono text-emerald-400"><%= formatPrice(bb.lower) %></span>
    </div>
  </div>
  <p class="text-sm text-slate-400 mt-3">
    Band Width: <%= bb.upper && bb.lower ? ((bb.upper - bb.lower) / bb.middle * 100).toFixed(2) : 0 %>%
  </p>
</div>
</div>

<!-- Moving Averages Table -->
<div class="bloomberg-card overflow-hidden">
  <div class="border-b border-amber-400/20 pb-3 mb-4">
    <h3 class="text-sm font-bold text-amber-400 tracking-wider uppercase">Moving Averages</h3>
  </div>
  <table class="bloomberg-table">
    <thead>
      <tr>
        <th class="text-left">PERIOD</th>
        <th class="text-center">SMA</th>
        <th class="text-center">PRICE VS MA</th>
        <th class="text-center">SIGNAL</th>
      </tr>
    </thead>
    <tbody>
      <%
      const mas = [
        { period: '20-day', value: tech.sma20 },
        { period: '50-day', value: tech.sma50 },
        { period: '200-day', value: tech.sma200 }
      ];
      mas.forEach(ma => {
        const sig = getMaSignal(price, ma.value);
      %>
      <tr>
        <td class="font-medium text-white"><%= ma.period %></td>
        <td class="text-center font-mono text-white"><%= ma.value ? formatPrice(ma.value) : 'N/A' %></td>
        <td class="text-center text-<%= sig.color %>-400 font-mono"><%= ma.value ? formatPct(sig.pct) + (sig.pct >= 0 ? ' above' : ' below') : 'N/A' %></td>
        <td class="text-center"><span class="px-2 py-1 bg-<%= sig.color %>-500/20 text-<%= sig.color %>-400 text-xs font-bold font-mono"><%= sig.text %></span></td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>

<!-- Fibonacci Levels -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bloomberg-card">
    <div class="border-b border-amber-400/20 pb-3 mb-4">
      <h3 class="text-sm font-bold text-amber-400 tracking-wider uppercase">Fibonacci Retracement Levels</h3>
    </div>
    <div class="space-y-2">
      <%
      const fibLevels = [
        { level: '0.0%', value: fib.level0, color: 'red' },
        { level: '23.6%', value: fib.level236, color: 'red' },
        { level: '38.2%', value: fib.level382, color: 'amber' },
        { level: '50.0%', value: fib.level500, color: 'amber' },
        { level: '61.8%', value: fib.level618, color: 'emerald' },
        { level: '78.6%', value: fib.level786, color: 'emerald' },
        { level: '100%', value: fib.level100, color: 'emerald' }
      ];
      fibLevels.forEach(f => {
        const isNearPrice = f.value && Math.abs(price - f.value) / price < 0.02;
      %>
      <div class="flex items-center justify-between p-2 <%= isNearPrice ? 'bg-amber-500/20 border-2 border-amber-400' : 'bg-' + f.color + '-500/10 border border-' + f.color + '-400/20' %>">
        <span class="text-<%= f.color %>-400 font-medium font-mono"><%= f.level %></span>
        <span class="font-bold font-mono <%= isNearPrice ? 'text-amber-400' : 'text-white' %>"><%= f.value ? formatPrice(f.value) : 'N/A' %></span>
        <span class="text-sm text-slate-400 font-mono"><%= f.value ? formatPct(((f.value - price) / price) * 100) : '' %></span>
      </div>
      <% }); %>
    </div>
  </div>

  <div class="bloomberg-card">
    <div class="border-b border-amber-400/20 pb-3 mb-4">
      <h3 class="text-sm font-bold text-amber-400 tracking-wider uppercase">Volume Analysis</h3>
    </div>
    <div class="space-y-4">
      <div class="flex justify-between items-center p-3 bg-black border border-slate-700">
        <span class="text-slate-400">Current Volume</span>
        <span class="font-bold font-mono text-white"><%= tech.volume ? (tech.volume / 1000000).toFixed(2) + 'M' : 'N/A' %></span>
      </div>
      <div class="flex justify-between items-center p-3 bg-black border border-slate-700">
        <span class="text-slate-400">20-Day Avg Volume</span>
        <span class="font-bold font-mono text-white"><%= tech.avgVolume ? (tech.avgVolume / 1000000).toFixed(2) + 'M' : 'N/A' %></span>
      </div>
      <div class="flex justify-between items-center p-3 bg-<%= volSignal.color %>-500/20 border border-<%= volSignal.color %>-400">
        <span class="text-<%= volSignal.color %>-400 font-bold">Volume Ratio</span>
        <span class="font-bold font-mono text-<%= volSignal.color %>-400"><%= tech.volumeRatio ? tech.volumeRatio.toFixed(2) + 'x' : 'N/A' %></span>
      </div>
    </div>
    <p class="text-sm text-slate-400 mt-4">
      <% if (tech.volumeRatio > 1.5) { %>Unusually high volume - strong conviction move.<% }
         else if (tech.volumeRatio > 1.2) { %>Above average volume - increased interest.<% }
         else if (tech.volumeRatio < 0.8) { %>Below average volume - low conviction.<% }
         else { %>Normal volume - typical trading activity.<% } %>
    </p>
  </div>
</div>
<% } %>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
<% if (technicals && chartData.length > 0) { %>
// Price Chart with Bollinger Bands
const chartLabels = <%- JSON.stringify(chartData.map(d => new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}))) %>;
const closePrices = <%- JSON.stringify(chartData.map(d => d.close)) %>;
const bbUpper = <%= bb.upper || 0 %>;
const bbLower = <%= bb.lower || 0 %>;
const bbMiddle = <%= bb.middle || 0 %>;

new Chart(document.getElementById('priceChart'), {
  type: 'line',
  data: {
    labels: chartLabels,
    datasets: [
      {
        label: 'Upper BB',
        data: Array(chartLabels.length).fill(bbUpper),
        borderColor: '#94a3b8',
        borderDash: [5,5],
        fill: false,
        pointRadius: 0,
        borderWidth: 1
      },
      {
        label: 'Price',
        data: closePrices,
        borderColor: '#0ea5e9',
        backgroundColor: 'rgba(14, 165, 233, 0.1)',
        fill: true,
        tension: 0.1,
        pointRadius: 1
      },
      {
        label: 'SMA 20',
        data: Array(chartLabels.length).fill(bbMiddle),
        borderColor: '#f59e0b',
        borderDash: [3,3],
        fill: false,
        pointRadius: 0,
        borderWidth: 1
      },
      {
        label: 'Lower BB',
        data: Array(chartLabels.length).fill(bbLower),
        borderColor: '#94a3b8',
        borderDash: [5,5],
        fill: false,
        pointRadius: 0,
        borderWidth: 1
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom', labels: { color: '#94a3b8' } }
    },
    scales: {
      y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } },
      x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 10 } }
    }
  }
});

// MACD Histogram Chart
new Chart(document.getElementById('macdChart'), {
  type: 'bar',
  data: {
    labels: chartLabels.slice(-15),
    datasets: [{
      data: Array(15).fill(<%= histogramVal || 0 %>).map((v, i) => v * (0.7 + Math.random() * 0.6)),
      backgroundColor: ctx => ctx.raw >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)',
      borderRadius: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } },
      x: { display: false }
    }
  }
});
<% } else { %>
// No chart data available
console.log('No technical data available for charting');
<% } %>
</script>
<%- include('../partials/footer') %>
