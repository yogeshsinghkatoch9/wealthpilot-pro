<%
  const attribution = data.attribution || null;
  const excessReturn = data.excessReturn || null;
  const drawdown = data.drawdown || null;
  const rolling = data.rolling || null;
%>

<!-- Performance Tab Content -->
<div class="space-y-6">

  <!-- ========== ANALYSIS 1: Performance Attribution (Waterfall Chart) ========== -->
  <div class="bg-bloomberg-dark border border-bloomberg-border rounded-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-bloomberg-amber uppercase tracking-wide">
        1. Performance Attribution
      </h2>
      <span class="text-xs text-slate-500 font-mono">BRINSON-FACHLER</span>
    </div>

    <% if (attribution && !attribution.error) { %>
      <!-- Summary Cards -->
      <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Total Return</div>
          <div class="text-2xl font-bold text-white font-mono">
            <%= (attribution.totalReturn || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Allocation Effect</div>
          <div class="text-2xl font-bold <%= attribution.allocationEffect >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
            <%= attribution.allocationEffect >= 0 ? '+' : '' %><%= (attribution.allocationEffect || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Selection Effect</div>
          <div class="text-2xl font-bold <%= attribution.selectionEffect >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
            <%= attribution.selectionEffect >= 0 ? '+' : '' %><%= (attribution.selectionEffect || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Interaction Effect</div>
          <div class="text-2xl font-bold <%= attribution.interactionEffect >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
            <%= attribution.interactionEffect >= 0 ? '+' : '' %><%= (attribution.interactionEffect || 0).toFixed(2) %>%
          </div>
        </div>
      </div>

      <!-- Waterfall Chart -->
      <div class="h-96">
        <canvas id="attribution-waterfall"></canvas>
      </div>
    <% } else { %>
      <div class="text-center py-12 text-slate-500">
        No attribution data available. Requires benchmark and historical performance data.
      </div>
    <% } %>
  </div>

  <!-- ========== ANALYSIS 2: Total & Excess Return vs Benchmark ========== -->
  <div class="bg-bloomberg-dark border border-bloomberg-border rounded-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-bloomberg-amber uppercase tracking-wide">
        2. Total & Excess Return vs Benchmark
      </h2>
      <span class="text-xs text-slate-500 font-mono">RELATIVE PERFORMANCE</span>
    </div>

    <% if (excessReturn && !excessReturn.error) { %>
      <!-- Summary Cards -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Portfolio Return</div>
          <div class="text-2xl font-bold <%= excessReturn.portfolioReturn >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
            <%= excessReturn.portfolioReturn >= 0 ? '+' : '' %><%= (excessReturn.portfolioReturn || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Benchmark Return</div>
          <div class="text-2xl font-bold <%= excessReturn.benchmarkReturn >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
            <%= excessReturn.benchmarkReturn >= 0 ? '+' : '' %><%= (excessReturn.benchmarkReturn || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Excess Return (Alpha)</div>
          <div class="text-2xl font-bold <%= excessReturn.excessReturn >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
            <%= excessReturn.excessReturn >= 0 ? '+' : '' %><%= (excessReturn.excessReturn || 0).toFixed(2) %>%
          </div>
        </div>
      </div>

      <!-- Line Chart with Shaded Bands -->
      <div class="h-96">
        <canvas id="excess-return-chart"></canvas>
      </div>
    <% } else { %>
      <div class="text-center py-12 text-slate-500">
        No excess return data available. Requires historical price data.
      </div>
    <% } %>
  </div>

  <!-- ========== ANALYSIS 3: Drawdown Analysis ========== -->
  <div class="bg-bloomberg-dark border border-bloomberg-border rounded-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-bloomberg-amber uppercase tracking-wide">
        3. Drawdown Analysis
      </h2>
      <span class="text-xs text-slate-500 font-mono">PEAK-TO-TROUGH</span>
    </div>

    <% if (drawdown && !drawdown.error) { %>
      <!-- Summary Cards -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Current Drawdown</div>
          <div class="text-2xl font-bold text-red-400 font-mono">
            -<%= (drawdown.currentDrawdown || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Max Drawdown</div>
          <div class="text-2xl font-bold text-red-400 font-mono">
            -<%= (drawdown.maxDrawdown || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Recovery Time</div>
          <div class="text-2xl font-bold text-white font-mono">
            <%= drawdown.recoveryDays || 0 %> days
          </div>
        </div>
      </div>

      <!-- Drawdown Area Chart -->
      <div class="h-96">
        <canvas id="drawdown-chart"></canvas>
      </div>
    <% } else { %>
      <div class="text-center py-12 text-slate-500">
        No drawdown data available. Requires historical portfolio snapshots.
      </div>
    <% } %>
  </div>

  <!-- ========== ANALYSIS 4: Volatility & Rolling Statistics ========== -->
  <div class="bg-bloomberg-dark border border-bloomberg-border rounded-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-bloomberg-amber uppercase tracking-wide">
        4. Volatility & Rolling Statistics
      </h2>
      <span class="text-xs text-slate-500 font-mono">90-DAY WINDOW</span>
    </div>

    <% if (rolling && !rolling.error) { %>
      <!-- Summary Cards -->
      <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Current Volatility</div>
          <div class="text-2xl font-bold text-white font-mono">
            <%= (rolling.currentVolatility || 0).toFixed(2) %>%
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Current Sharpe</div>
          <div class="text-2xl font-bold text-white font-mono">
            <%= (rolling.currentSharpe || 0).toFixed(2) %>
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Current Sortino</div>
          <div class="text-2xl font-bold text-white font-mono">
            <%= (rolling.currentSortino || 0).toFixed(2) %>
          </div>
        </div>
        <div class="bg-bloomberg-surface border border-bloomberg-border rounded p-4">
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Avg Rolling Return</div>
          <div class="text-2xl font-bold <%= rolling.avgReturn >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
            <%= rolling.avgReturn >= 0 ? '+' : '' %><%= (rolling.avgReturn || 0).toFixed(2) %>%
          </div>
        </div>
      </div>

      <!-- Rolling Statistics Chart -->
      <div class="h-96 mb-4">
        <canvas id="rolling-stats-chart"></canvas>
      </div>

      <!-- Distribution Histogram -->
      <div class="h-64">
        <canvas id="returns-distribution-chart"></canvas>
      </div>
    <% } else { %>
      <div class="text-center py-12 text-slate-500">
        No rolling statistics data available. Requires sufficient historical data.
      </div>
    <% } %>
  </div>

</div>

<script>
  // Store chart data for later initialization
  window.performanceTabData = {
    attribution: <%- JSON.stringify(attribution) %>,
    excessReturn: <%- JSON.stringify(excessReturn) %>,
    drawdown: <%- JSON.stringify(drawdown) %>,
    rolling: <%- JSON.stringify(rolling) %>
  };
</script>
