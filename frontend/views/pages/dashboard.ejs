<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Dashboard - WealthPilot Pro</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#6366f1",
            "primary-dark": "#4f46e5",
            "background-dark": "#09090b",
            "card-dark": "#18181b",
            "card-hover": "#1f1f23",
            "border-dark": "#27272a",
            "text-primary": "#fafafa",
            "text-secondary": "#a1a1aa",
            "text-muted": "#71717a",
            "accent-green": "#22c55e",
            "accent-red": "#ef4444",
            "accent-blue": "#3b82f6",
            "accent-purple": "#a855f7",
            "accent-amber": "#f59e0b",
          },
          fontFamily: {
            "sans": ["Inter", "system-ui", "sans-serif"],
            "mono": ["JetBrains Mono", "monospace"]
          },
        },
      },
    }
  </script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
    .material-symbols-outlined { font-family: 'Material Symbols Outlined'; }
    .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1; }

    /* Auto-hide Sidebar */
    .sidebar-container {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 50;
    }

    .sidebar-trigger {
      position: absolute;
      left: 0;
      top: 0;
      width: 8px;
      height: 100%;
      z-index: 51;
    }

    .sidebar-trigger::after {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60px;
      background: linear-gradient(180deg, transparent, rgba(99, 102, 241, 0.3), transparent);
      border-radius: 0 4px 4px 0;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .sidebar-trigger:hover::after,
    .sidebar-container:hover .sidebar-trigger::after {
      opacity: 1;
    }

    .sidebar-panel {
      position: absolute;
      left: 0;
      top: 0;
      width: 260px;
      height: 100%;
      background: #18181b;
      border-right: 1px solid #27272a;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 0 0 rgba(0,0,0,0);
    }

    .sidebar-container:hover .sidebar-panel,
    .sidebar-panel.show {
      transform: translateX(0);
      box-shadow: 20px 0 60px -10px rgba(0, 0, 0, 0.5);
    }

    /* Glassmorphism Cards */
    .glass-card {
      background: rgba(24, 24, 27, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(39, 39, 42, 0.8);
      border-radius: 16px;
      transition: all 0.2s ease;
    }

    .glass-card:hover {
      border-color: rgba(99, 102, 241, 0.3);
      box-shadow: 0 0 30px -10px rgba(99, 102, 241, 0.2);
    }

    /* Stat Cards */
    .stat-card {
      background: linear-gradient(135deg, rgba(24, 24, 27, 0.9) 0%, rgba(24, 24, 27, 0.6) 100%);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(39, 39, 42, 0.6);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      border-color: rgba(99, 102, 241, 0.4);
      box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.2);
    }

    /* Value Display */
    .value-display {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    /* Animated Badge */
    .pulse-badge {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
    }

    /* Chart Container */
    .chart-container {
      background: linear-gradient(180deg, rgba(24, 24, 27, 0.9) 0%, rgba(24, 24, 27, 0.7) 100%);
      border: 1px solid rgba(39, 39, 42, 0.6);
      border-radius: 20px;
      position: relative;
      overflow: hidden;
    }

    .chart-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(ellipse at top, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
      pointer-events: none;
    }

    /* Time Period Buttons */
    .period-btn {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 8px;
      color: #a1a1aa;
      transition: all 0.2s;
    }

    .period-btn:hover {
      color: #fafafa;
      background: rgba(255, 255, 255, 0.05);
    }

    .period-btn.active {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      box-shadow: 0 4px 15px -3px rgba(99, 102, 241, 0.4);
    }

    /* Market Item */
    .market-item {
      padding: 12px 16px;
      border-radius: 12px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .market-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    /* Holdings Table */
    .holdings-table tr {
      transition: background 0.2s;
    }

    .holdings-table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* AI Card Gradient */
    .ai-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 20px;
      position: relative;
      overflow: hidden;
    }

    .ai-card::before {
      content: '';
      position: absolute;
      top: -100px;
      right: -100px;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
      pointer-events: none;
    }

    /* Insight Card */
    .insight-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }

    .insight-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(99, 102, 241, 0.3);
    }

    /* News Card */
    .news-card {
      transition: all 0.2s;
    }

    .news-card:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Header */
    .top-header {
      background: rgba(9, 9, 11, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(39, 39, 42, 0.5);
    }

    /* Search Input */
    .search-input {
      background: rgba(39, 39, 42, 0.5);
      border: 1px solid rgba(63, 63, 70, 0.5);
      border-radius: 12px;
      transition: all 0.2s;
    }

    .search-input:focus {
      background: rgba(39, 39, 42, 0.8);
      border-color: rgba(99, 102, 241, 0.5);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Notification Badge */
    .notif-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      border: 2px solid #09090b;
    }
  </style>
</head>
<body class="bg-background-dark text-text-primary font-sans min-h-screen">

<%
  // Data processing
  const safeHoldings = typeof holdings !== 'undefined' && holdings ? holdings : [];
  const safeWatchlist = typeof watchlist !== 'undefined' && watchlist ? watchlist : [];
  const safeAlerts = typeof alerts !== 'undefined' && alerts ? alerts : [];
  const safeRisk = typeof risk !== 'undefined' && risk ? risk : { beta: 1.0, sharpe: 0, volatility: 0, maxDrawdown: 0 };
  const safeTotals = typeof totals !== 'undefined' && totals ? totals : { value: 0, gain: 0, cost: 0, dayChange: 0, ytdReturn: 0, income: 0, cash: 0, holdingsCount: 0 };
  const gainPct = safeTotals.cost > 0 ? (safeTotals.gain / safeTotals.cost) * 100 : 0;
  const dayChangePct = safeTotals.value > 0 ? (safeTotals.dayChange / safeTotals.value) * 100 : 0;

  const formatCurrency = (val) => {
    if (val === undefined || val === null || isNaN(val)) return '$0.00';
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(val);
  };

  const formatPercent = (val) => {
    if (val === undefined || val === null || isNaN(val)) return '0.00%';
    return (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
  };

  const userName = typeof user !== 'undefined' && user ? (user.firstName || user.email?.split('@')[0] || 'User') : 'User';
  const userInitial = userName.charAt(0).toUpperCase();
  const safeNews = typeof news !== 'undefined' && news ? news : [];

  const topHoldings = safeHoldings
    .map(h => ({
      ...h,
      value: (h.shares || 0) * (h.currentPrice || h.price || 0),
      change: h.changePercent || h.change_percent || 0
    }))
    .sort((a, b) => b.value - a.value)
    .slice(0, 5);
%>

<!-- Auto-Hide Sidebar -->
<div class="sidebar-container" id="sidebarContainer">
  <div class="sidebar-trigger"></div>
  <aside class="sidebar-panel flex flex-col h-full overflow-y-auto" id="sidebar">
    <!-- Logo -->
    <div class="p-5 border-b border-border-dark">
      <a href="/dashboard" class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-accent-purple flex items-center justify-center">
          <span class="material-symbols-outlined text-white" style="font-size: 22px;">rocket_launch</span>
        </div>
        <div>
          <h1 class="text-text-primary text-base font-bold">WealthPilot</h1>
          <p class="text-text-muted text-[10px] font-medium tracking-wider uppercase">Pro Terminal</p>
        </div>
      </a>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 p-4 space-y-1">
      <a href="/dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-primary/10 text-primary border border-primary/20">
        <span class="material-symbols-outlined filled text-lg">dashboard</span>
        <span class="text-sm font-medium">Dashboard</span>
      </a>
      <a href="/portfolios" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
        <span class="text-sm font-medium">Portfolios</span>
      </a>
      <a href="/market-overview" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">monitoring</span>
        <span class="text-sm font-medium">Market Data</span>
      </a>
      <a href="/technical-analysis" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">candlestick_chart</span>
        <span class="text-sm font-medium">Technical Analysis</span>
      </a>
      <a href="/fundamental-analysis" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">analytics</span>
        <span class="text-sm font-medium">Fundamentals</span>
      </a>
      <a href="/dividends" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">payments</span>
        <span class="text-sm font-medium">Dividends</span>
      </a>
      <a href="/risk" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">shield</span>
        <span class="text-sm font-medium">Risk Analytics</span>
      </a>
      <a href="/ai-chat" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">psychology</span>
        <span class="text-sm font-medium">AI Assistant</span>
      </a>
      <a href="/tax-loss-harvesting" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">receipt_long</span>
        <span class="text-sm font-medium">Tax Tools</span>
      </a>
    </nav>

    <!-- Bottom -->
    <div class="p-4 border-t border-border-dark space-y-1">
      <a href="/settings" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">settings</span>
        <span class="text-sm font-medium">Settings</span>
      </a>
      <a href="/logout" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-text-secondary hover:text-text-primary hover:bg-white/5 transition-all">
        <span class="material-symbols-outlined text-lg">logout</span>
        <span class="text-sm font-medium">Log Out</span>
      </a>
    </div>
  </aside>
</div>

<!-- Main Content -->
<main class="min-h-screen">
  <!-- Header -->
  <header class="top-header sticky top-0 z-40 h-16 flex items-center justify-between px-6">
    <div class="flex items-center gap-6">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent-purple flex items-center justify-center lg:hidden">
          <span class="material-symbols-outlined text-white text-sm">rocket_launch</span>
        </div>
        <h2 class="text-text-primary text-lg font-semibold hidden sm:block">Dashboard</h2>
      </div>
      <div class="hidden md:block relative">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <span class="material-symbols-outlined text-text-muted text-lg">search</span>
        </div>
        <input class="search-input w-80 pl-11 pr-4 py-2.5 text-sm text-text-primary placeholder-text-muted focus:outline-none" placeholder="Search ticker, company..." type="text" id="globalSearch"/>
        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
          <kbd class="text-[10px] text-text-muted bg-border-dark/50 px-2 py-1 rounded">âŒ˜K</kbd>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button class="relative p-2.5 rounded-xl hover:bg-white/5 text-text-secondary hover:text-text-primary transition-colors">
        <span class="material-symbols-outlined">notifications</span>
        <% if (safeAlerts.length > 0) { %><span class="notif-badge"></span><% } %>
      </button>
      <button class="p-2.5 rounded-xl hover:bg-white/5 text-text-secondary hover:text-text-primary transition-colors hidden sm:block">
        <span class="material-symbols-outlined">help</span>
      </button>
      <div class="h-6 w-px bg-border-dark mx-1"></div>
      <a href="/settings" class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/5 transition-colors">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-accent-purple flex items-center justify-center text-white font-semibold text-sm">
          <%= userInitial %>
        </div>
        <div class="hidden lg:block">
          <p class="text-sm font-medium text-text-primary leading-none"><%= userName %></p>
          <p class="text-[11px] text-text-muted mt-0.5">Pro Account</p>
        </div>
      </a>
    </div>
  </header>

  <!-- Dashboard Content -->
  <div class="px-6 py-6 max-w-[1800px] mx-auto space-y-6">

    <!-- Stats Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Total Value -->
      <div class="stat-card">
        <div class="flex justify-between items-start mb-3">
          <p class="text-text-muted text-sm font-medium">Total Portfolio Value</p>
          <div class="w-9 h-9 rounded-xl bg-primary/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-primary text-lg">account_balance</span>
          </div>
        </div>
        <h3 class="value-display text-2xl text-text-primary mb-2"><%= formatCurrency(safeTotals.value) %></h3>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs font-semibold <%= gainPct >= 0 ? 'text-accent-green bg-accent-green/10' : 'text-accent-red bg-accent-red/10' %>">
            <span class="material-symbols-outlined text-sm"><%= gainPct >= 0 ? 'trending_up' : 'trending_down' %></span>
            <%= formatPercent(gainPct) %>
          </span>
          <span class="text-text-muted text-xs">all time</span>
        </div>
      </div>

      <!-- Day's Change -->
      <div class="stat-card">
        <div class="flex justify-between items-start mb-3">
          <p class="text-text-muted text-sm font-medium">Day's Gain/Loss</p>
          <div class="w-9 h-9 rounded-xl <%= safeTotals.dayChange >= 0 ? 'bg-accent-green/10' : 'bg-accent-red/10' %> flex items-center justify-center">
            <span class="material-symbols-outlined <%= safeTotals.dayChange >= 0 ? 'text-accent-green' : 'text-accent-red' %> text-lg">show_chart</span>
          </div>
        </div>
        <h3 class="value-display text-2xl text-text-primary mb-2"><%= safeTotals.dayChange >= 0 ? '+' : '' %><%= formatCurrency(safeTotals.dayChange) %></h3>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold <%= dayChangePct >= 0 ? 'text-accent-green bg-accent-green/10' : 'text-accent-red bg-accent-red/10' %>">
            <%= formatPercent(dayChangePct) %>
          </span>
          <span class="text-text-muted text-xs">vs yesterday</span>
        </div>
      </div>

      <!-- Alpha -->
      <div class="stat-card">
        <div class="flex justify-between items-start mb-3">
          <p class="text-text-muted text-sm font-medium">Alpha vs SPY (YTD)</p>
          <div class="w-9 h-9 rounded-xl bg-accent-purple/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-accent-purple text-lg">trending_up</span>
          </div>
        </div>
        <h3 class="value-display text-2xl text-text-primary mb-2"><%= formatPercent(safeTotals.ytdReturn || 0) %></h3>
        <div class="flex items-center gap-3 text-xs text-text-muted">
          <span>Beta: <span class="text-text-secondary font-mono"><%= (safeRisk.beta || 1.0).toFixed(2) %></span></span>
          <span>Sharpe: <span class="text-text-secondary font-mono"><%= (safeRisk.sharpe || 0).toFixed(2) %></span></span>
        </div>
      </div>

      <!-- Cash -->
      <div class="stat-card">
        <div class="flex justify-between items-start mb-3">
          <p class="text-text-muted text-sm font-medium">Available Cash</p>
          <div class="w-9 h-9 rounded-xl bg-accent-amber/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-accent-amber text-lg">savings</span>
          </div>
        </div>
        <h3 class="value-display text-2xl text-text-primary mb-2"><%= formatCurrency(safeTotals.cash || 0) %></h3>
        <a href="/add-holding" class="inline-flex items-center gap-1 text-primary text-xs font-semibold hover:underline">
          <span class="material-symbols-outlined text-sm">add</span> Add Position
        </a>
      </div>
    </div>

    <!-- Chart & Market -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Chart -->
      <div class="lg:col-span-2 chart-container p-6">
        <div class="flex flex-wrap items-center justify-between mb-6 gap-4 relative z-10">
          <div>
            <h3 class="text-text-primary text-lg font-semibold">Portfolio Performance</h3>
            <p class="text-text-muted text-sm mt-0.5">Net asset value over time</p>
          </div>
          <div class="flex bg-card-dark/50 p-1 rounded-xl border border-border-dark/50">
            <button class="period-btn" data-period="1D">1D</button>
            <button class="period-btn" data-period="1W">1W</button>
            <button class="period-btn active" data-period="1M">1M</button>
            <button class="period-btn" data-period="3M">3M</button>
            <button class="period-btn" data-period="YTD">YTD</button>
            <button class="period-btn" data-period="ALL">ALL</button>
          </div>
        </div>
        <div class="h-[320px] relative z-10">
          <canvas id="portfolioChart"></canvas>
        </div>
      </div>

      <!-- Market Overview -->
      <div class="glass-card flex flex-col">
        <div class="p-5 border-b border-border-dark/50">
          <h3 class="text-text-primary font-semibold">Market Overview</h3>
          <p class="text-text-muted text-xs mt-1">Real-time indices</p>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-1" id="marketOverview">
          <div class="flex items-center justify-center py-12">
            <div class="text-center">
              <span class="material-symbols-outlined text-text-muted text-3xl animate-pulse">sync</span>
              <p class="text-text-muted text-sm mt-2">Loading...</p>
            </div>
          </div>
        </div>
        <div class="p-4 border-t border-border-dark/50">
          <a href="/market-overview" class="flex items-center justify-center gap-2 text-primary text-sm font-medium hover:underline">
            View All Markets <span class="material-symbols-outlined text-sm">arrow_forward</span>
          </a>
        </div>
      </div>
    </div>

    <!-- News -->
    <div class="glass-card overflow-hidden">
      <div class="p-5 border-b border-border-dark/50 flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-accent-blue/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-accent-blue">newspaper</span>
          </div>
          <div>
            <h3 class="text-text-primary font-semibold">Personalized News</h3>
            <p class="text-text-muted text-xs">Tailored to your holdings</p>
          </div>
        </div>
        <a href="/news" class="text-primary text-sm font-medium hover:underline">View All</a>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-border-dark/30" id="newsFeed">
        <% if (safeNews.length > 0) { %>
          <% safeNews.slice(0, 3).forEach(article => { %>
          <a href="<%= article.link || article.url || '#' %>" target="_blank" class="news-card p-5 block">
            <div class="flex items-center gap-2 mb-3">
              <% if (article.symbol) { %><span class="text-[10px] font-semibold bg-border-dark text-text-muted px-2 py-0.5 rounded"><%= article.symbol %></span><% } %>
              <span class="text-text-muted text-xs"><%= article.source || 'News' %></span>
            </div>
            <h4 class="text-text-primary font-medium text-sm leading-snug mb-2 line-clamp-2"><%= article.title %></h4>
            <p class="text-text-muted text-xs line-clamp-2"><%= article.summary || article.description || '' %></p>
          </a>
          <% }); %>
        <% } else { %>
          <div class="col-span-3 py-12 text-center">
            <span class="material-symbols-outlined text-text-muted text-4xl mb-2">article</span>
            <p class="text-text-muted text-sm">Add stocks to your watchlist to see personalized news</p>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Holdings & AI -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Holdings -->
      <div class="lg:col-span-2 glass-card overflow-hidden">
        <div class="p-5 border-b border-border-dark/50 flex justify-between items-center">
          <h3 class="text-text-primary font-semibold">Top Holdings</h3>
          <a href="/holdings" class="text-primary text-sm font-medium hover:underline">View All</a>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full holdings-table">
            <thead>
              <tr class="text-left text-xs text-text-muted uppercase tracking-wider border-b border-border-dark/30">
                <th class="px-5 py-4 font-medium">Asset</th>
                <th class="px-5 py-4 font-medium text-right">Price</th>
                <th class="px-5 py-4 font-medium text-right hidden sm:table-cell">Shares</th>
                <th class="px-5 py-4 font-medium text-right">Value</th>
                <th class="px-5 py-4 font-medium text-right">Change</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border-dark/20">
              <% if (topHoldings.length > 0) { %>
                <% topHoldings.forEach(h => {
                  const price = h.currentPrice || h.price || 0;
                  const change = h.change || 0;
                %>
                <tr class="cursor-pointer" onclick="window.location.href='/market/quote/<%= h.symbol %>'">
                  <td class="px-5 py-4">
                    <div class="flex items-center gap-3">
                      <div class="w-9 h-9 rounded-full bg-gradient-to-br from-primary to-accent-purple flex items-center justify-center text-white font-semibold text-xs">
                        <%= (h.symbol || '?').substring(0, 2) %>
                      </div>
                      <div>
                        <p class="font-semibold text-text-primary text-sm"><%= h.symbol %></p>
                        <p class="text-xs text-text-muted truncate max-w-[100px]"><%= h.name || h.symbol %></p>
                      </div>
                    </div>
                  </td>
                  <td class="px-5 py-4 text-right font-mono text-sm text-text-primary"><%= formatCurrency(price) %></td>
                  <td class="px-5 py-4 text-right font-mono text-sm text-text-secondary hidden sm:table-cell"><%= (h.shares || 0).toFixed(2) %></td>
                  <td class="px-5 py-4 text-right font-mono text-sm font-medium text-text-primary"><%= formatCurrency(h.value) %></td>
                  <td class="px-5 py-4 text-right">
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-semibold <%= change >= 0 ? 'text-accent-green bg-accent-green/10' : 'text-accent-red bg-accent-red/10' %>">
                      <%= formatPercent(change) %>
                    </span>
                  </td>
                </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="5" class="px-5 py-12 text-center">
                    <span class="material-symbols-outlined text-text-muted text-4xl mb-2">inventory_2</span>
                    <p class="text-text-muted">No holdings yet. <a href="/add-holding" class="text-primary hover:underline">Add your first position</a></p>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- AI Insights -->
      <div class="ai-card p-6 flex flex-col">
        <div class="flex items-center gap-3 mb-5 relative z-10">
          <div class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center">
            <span class="material-symbols-outlined text-primary">auto_awesome</span>
          </div>
          <h3 class="text-text-primary font-semibold">AI Insights</h3>
        </div>
        <div class="flex-1 space-y-3 relative z-10">
          <div class="insight-card">
            <div class="flex justify-between items-start mb-2">
              <span class="text-[10px] font-bold text-primary bg-primary/10 px-2 py-0.5 rounded">PORTFOLIO</span>
              <span class="text-[10px] text-text-muted">Just now</span>
            </div>
            <p class="text-text-primary text-sm font-medium mb-1">Your portfolio has <%= safeTotals.holdingsCount || 0 %> holdings.</p>
            <p class="text-text-muted text-xs">Consider diversifying across more sectors for better risk management.</p>
          </div>
          <% if (safeRisk.sharpe > 1.5) { %>
          <div class="insight-card">
            <div class="flex justify-between items-start mb-2">
              <span class="text-[10px] font-bold text-accent-green bg-accent-green/10 px-2 py-0.5 rounded">PERFORMANCE</span>
              <span class="text-[10px] text-text-muted">Today</span>
            </div>
            <p class="text-text-primary text-sm font-medium mb-1">Strong risk-adjusted returns!</p>
            <p class="text-text-muted text-xs">Your Sharpe ratio of <%= safeRisk.sharpe.toFixed(2) %> indicates excellent performance.</p>
          </div>
          <% } %>
        </div>
        <a href="/ai-chat" class="mt-5 w-full py-3 rounded-xl bg-primary/10 hover:bg-primary/20 border border-primary/20 text-primary text-sm font-semibold transition-colors flex items-center justify-center gap-2 relative z-10">
          <span class="material-symbols-outlined text-lg">chat</span>
          Ask AI Assistant
        </a>
      </div>
    </div>
  </div>
</main>

<script>
  // Portfolio Chart
  const ctx = document.getElementById('portfolioChart');
  if (ctx) {
    const portfolioValue = <%= safeTotals.value || 100000 %>;
    const dates = [];
    const values = [];
    const today = new Date();

    for (let i = 30; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      const variance = 0.02 * (30 - i) / 30;
      const randomFactor = 1 + (Math.random() - 0.5) * variance;
      values.push(portfolioValue * randomFactor * (0.95 + i * 0.0015));
    }
    values[values.length - 1] = portfolioValue;

    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.15)');
    gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          data: values,
          borderColor: '#6366f1',
          backgroundColor: gradient,
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: '#6366f1',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#18181b',
            titleColor: '#a1a1aa',
            bodyColor: '#fafafa',
            borderColor: '#27272a',
            borderWidth: 1,
            padding: 12,
            displayColors: false,
            callbacks: {
              label: ctx => '$' + ctx.raw.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: { grid: { color: 'rgba(39, 39, 42, 0.3)', drawBorder: false }, ticks: { color: '#71717a', maxTicksLimit: 6 } },
          y: { grid: { color: 'rgba(39, 39, 42, 0.3)', drawBorder: false }, ticks: { color: '#71717a', callback: v => '$' + (v/1000).toFixed(0) + 'k' } }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });
  }

  // Market Data
  async function loadMarketData() {
    const container = document.getElementById('marketOverview');
    try {
      const res = await fetch('/api/market/indices');
      if (res.ok) {
        const data = await res.json();
        const indices = data.indices || data || [];
        if (indices.length > 0) {
          container.innerHTML = indices.slice(0, 5).map(idx => {
            const change = idx.changePercent || idx.change || 0;
            return `
              <div class="market-item" onclick="window.location.href='/market/quote/${idx.symbol}'">
                <div class="flex justify-between items-center">
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="text-text-primary font-semibold text-sm">${idx.name || idx.symbol}</span>
                      <span class="text-[10px] bg-border-dark/50 text-text-muted px-1.5 py-0.5 rounded">${idx.symbol}</span>
                    </div>
                    <p class="text-text-muted text-xs mt-1 font-mono">$${(idx.price || idx.value || 0).toLocaleString()}</p>
                  </div>
                  <span class="${change >= 0 ? 'text-accent-green' : 'text-accent-red'} font-semibold text-sm font-mono">
                    ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                  </span>
                </div>
              </div>
            `;
          }).join('');
        }
      }
    } catch (e) { console.error('Market data error:', e); }
  }
  loadMarketData();

  // Period buttons
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // Search
  document.getElementById('globalSearch')?.addEventListener('keypress', e => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      window.location.href = `/market/quote/${e.target.value.trim().toUpperCase()}`;
    }
  });

  document.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('globalSearch')?.focus();
    }
  });
</script>

</body>
</html>
