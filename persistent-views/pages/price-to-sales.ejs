<%- include('../partials/header', { pageTitle: 'Price to Sales Analysis' }) %>

<style>
/* ============================================
   PRICE TO SALES - PREMIUM DASHBOARD STYLES
   ============================================ */

/* CSS Variables for consistent theming */
:root {
  --ps-primary: #8b5cf6;
  --ps-secondary: #60a5fa;
  --ps-success: #10b981;
  --ps-warning: #f59e0b;
  --ps-danger: #ef4444;
  --ps-card-bg: rgba(15, 23, 42, 0.7);
  --ps-border: rgba(148, 163, 184, 0.1);
  --ps-glow: 0 0 40px rgba(139, 92, 246, 0.15);
}

/* Main Container */
.ps-dashboard {
  max-width: 1600px;
  margin: 0 auto;
  padding: 0 16px;
}

/* Hero Section with Gradient Background */
.ps-hero {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 50%, rgba(16, 185, 129, 0.05) 100%);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 20px;
  padding: 28px 32px;
  margin-bottom: 24px;
  position: relative;
  overflow: hidden;
}

.ps-hero::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 60%;
  height: 200%;
  background: radial-gradient(ellipse, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
  pointer-events: none;
}

.ps-hero-content {
  position: relative;
  z-index: 1;
}

.ps-title {
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 30%, #60a5fa 70%, #34d399 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.ps-subtitle {
  color: #94a3b8;
  font-size: 0.925rem;
  margin-top: 6px;
}

/* Control Bar */
.ps-controls {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.ps-select {
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 10px;
  padding: 10px 40px 10px 14px;
  color: white;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238b5cf6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 18px;
  transition: all 0.2s ease;
  min-width: 180px;
}

.ps-select:hover {
  border-color: rgba(139, 92, 246, 0.5);
  box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
}

.ps-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  border-radius: 10px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
}

.ps-btn-primary {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  color: white;
}

.ps-btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
}

.ps-btn-secondary {
  background: rgba(30, 41, 59, 0.8);
  border: 1px solid rgba(148, 163, 184, 0.2);
  color: #94a3b8;
}

.ps-btn-secondary:hover {
  background: rgba(51, 65, 85, 0.8);
  color: white;
}

/* Valuation Score Widget */
.valuation-score-widget {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-top: 24px;
  padding: 20px 24px;
  background: rgba(15, 23, 42, 0.5);
  border-radius: 16px;
  border: 1px solid rgba(148, 163, 184, 0.08);
}

.score-gauge {
  position: relative;
  width: 100px;
  height: 100px;
  flex-shrink: 0;
}

.score-gauge svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.score-gauge-bg {
  fill: none;
  stroke: rgba(148, 163, 184, 0.1);
  stroke-width: 8;
}

.score-gauge-fill {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dashoffset 1s ease, stroke 0.5s ease;
}

.score-value {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.score-number {
  font-size: 1.5rem;
  font-weight: 800;
}

.score-label {
  font-size: 0.65rem;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.score-details {
  flex: 1;
}

.score-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: white;
  margin-bottom: 4px;
}

.score-description {
  font-size: 0.8rem;
  color: #94a3b8;
  line-height: 1.5;
}

.score-signals {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}

.signal-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
}

.signal-undervalued { background: rgba(16, 185, 129, 0.15); color: #34d399; }
.signal-fair { background: rgba(96, 165, 250, 0.15); color: #60a5fa; }
.signal-overvalued { background: rgba(239, 68, 68, 0.15); color: #f87171; }

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
  margin-top: 20px;
}

@media (max-width: 1200px) {
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 640px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}

.stat-card {
  background: var(--ps-card-bg);
  border: 1px solid var(--ps-border);
  border-radius: 14px;
  padding: 16px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-card.purple::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
.stat-card.blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.stat-card.green::before { background: linear-gradient(90deg, #10b981, #34d399); }
.stat-card.amber::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
.stat-card.red::before { background: linear-gradient(90deg, #ef4444, #f87171); }
.stat-card.cyan::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }

.stat-card:hover {
  transform: translateY(-2px);
  border-color: rgba(139, 92, 246, 0.3);
  box-shadow: var(--ps-glow);
}

.stat-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 10px;
}

.stat-icon.purple { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
.stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
.stat-icon.green { background: rgba(16, 185, 129, 0.15); color: #34d399; }
.stat-icon.amber { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
.stat-icon.red { background: rgba(239, 68, 68, 0.15); color: #f87171; }
.stat-icon.cyan { background: rgba(6, 182, 212, 0.15); color: #22d3ee; }

.stat-label {
  font-size: 0.7rem;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 800;
  color: white;
}

.stat-value.purple { color: #a78bfa; }
.stat-value.blue { color: #60a5fa; }
.stat-value.green { color: #34d399; }
.stat-value.amber { color: #fbbf24; }
.stat-value.red { color: #f87171; }
.stat-value.cyan { color: #22d3ee; }

.stat-change {
  font-size: 0.7rem;
  margin-top: 4px;
}

.stat-change.positive { color: #34d399; }
.stat-change.negative { color: #f87171; }

/* Main Layout Grid */
.main-grid {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 320px;
  gap: 20px;
  margin-bottom: 24px;
  align-items: start;
}

@media (max-width: 1600px) {
  .main-grid { grid-template-columns: minmax(0, 1fr) 300px; }
}

@media (max-width: 1400px) {
  .main-grid { grid-template-columns: minmax(0, 1fr) 280px; }
}

@media (max-width: 1200px) {
  .main-grid {
    grid-template-columns: 1fr;
  }
  .sidebar {
    order: -1;
  }
}

/* Ensure table card stays within grid bounds */
.main-grid > .ps-card {
  min-width: 0;
  max-width: 100%;
  overflow: hidden;
}

/* Main content area */
.main-content {
  min-width: 0;
  overflow: hidden;
}

/* Card Base */
.ps-card {
  background: var(--ps-card-bg);
  border: 1px solid var(--ps-border);
  border-radius: 16px;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.ps-card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--ps-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.ps-card-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: white;
}

.ps-card-title svg {
  width: 20px;
  height: 20px;
}

.ps-card-body {
  padding: 20px;
}

/* Holdings Table */
.holdings-table-wrapper {
  overflow-x: auto;
  overflow-y: auto;
  max-height: 600px;
  -webkit-overflow-scrolling: touch;
  margin: 0;
  padding: 0;
  border-radius: 12px;
  scrollbar-width: thin;
  scrollbar-color: rgba(139, 92, 246, 0.3) transparent;
}

.holdings-table-wrapper::-webkit-scrollbar {
  height: 8px;
  width: 8px;
}

.holdings-table-wrapper::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.5);
  border-radius: 4px;
}

.holdings-table-wrapper::-webkit-scrollbar-thumb {
  background: rgba(139, 92, 246, 0.4);
  border-radius: 4px;
}

.holdings-table-wrapper::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 92, 246, 0.6);
}

.ps-table {
  width: 100%;
  min-width: 900px;
  border-collapse: collapse;
  font-size: 0.875rem;
  table-layout: auto;
}

/* Column widths - use auto for flexibility */
.ps-table th,
.ps-table td {
  white-space: nowrap;
  padding: 14px 12px;
}

.ps-table td:first-child,
.ps-table th:first-child {
  min-width: 180px;
  max-width: 220px;
  position: sticky;
  left: 0;
  z-index: 5;
  background: rgba(15, 23, 42, 0.98);
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
}

.ps-table th:first-child {
  z-index: 15;
  background: rgba(30, 41, 59, 0.98);
}

.ps-table th:nth-child(2),
.ps-table td:nth-child(2),
.ps-table th:nth-child(3),
.ps-table td:nth-child(3) {
  min-width: 90px;
}

.ps-table th:nth-child(4),
.ps-table td:nth-child(4) {
  min-width: 100px;
}

.ps-table th:nth-child(5),
.ps-table td:nth-child(5),
.ps-table th:nth-child(6),
.ps-table td:nth-child(6) {
  min-width: 70px;
}

.ps-table th:last-child,
.ps-table td:last-child {
  min-width: 100px;
}

.ps-table th {
  position: sticky;
  top: 0;
  padding: 14px 16px;
  text-align: left;
  font-size: 0.7rem;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: rgba(30, 41, 59, 0.95);
  backdrop-filter: blur(10px);
  cursor: pointer;
  transition: color 0.2s ease;
  white-space: nowrap;
  z-index: 10;
}

.ps-table th:hover {
  color: #a78bfa;
}

.ps-table th.active {
  color: #8b5cf6;
}

.ps-table th .sort-icon {
  display: inline-block;
  margin-left: 4px;
  opacity: 0.5;
}

.ps-table th.active .sort-icon {
  opacity: 1;
}

.ps-table td {
  padding: 16px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.05);
  transition: background 0.2s ease;
}

.ps-table tr:hover td {
  background: rgba(139, 92, 246, 0.05);
}

.ps-table tr:hover td:first-child {
  background: rgba(15, 23, 42, 0.98);
}

/* Symbol Cell */
.symbol-cell {
  display: flex;
  align-items: center;
  gap: 12px;
}

.symbol-avatar {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 800;
  color: white;
  position: relative;
}

.symbol-avatar.undervalued::after {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: 12px;
  border: 2px solid rgba(16, 185, 129, 0.5);
  animation: pulse-green 2s infinite;
}

@keyframes pulse-green {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.05); }
}

.symbol-info {
  display: flex;
  flex-direction: column;
}

.symbol-ticker {
  font-weight: 700;
  color: white;
  font-size: 0.95rem;
}

.symbol-name {
  font-size: 0.75rem;
  color: #64748b;
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* PS Ratio Cell with Mini Bar */
.ps-ratio-cell {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.ps-ratio-value {
  font-weight: 800;
  font-size: 1rem;
}

.ps-ratio-bar {
  width: 80px;
  height: 4px;
  background: rgba(148, 163, 184, 0.1);
  border-radius: 2px;
  overflow: hidden;
}

.ps-ratio-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
}

/* Valuation Badge */
.valuation-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.valuation-pill.cheap { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
.valuation-pill.undervalued { background: rgba(52, 211, 153, 0.15); color: #6ee7b7; border: 1px solid rgba(52, 211, 153, 0.25); }
.valuation-pill.fair { background: rgba(96, 165, 250, 0.15); color: #93c5fd; border: 1px solid rgba(96, 165, 250, 0.25); }
.valuation-pill.stretched { background: rgba(251, 191, 36, 0.15); color: #fcd34d; border: 1px solid rgba(251, 191, 36, 0.25); }
.valuation-pill.expensive { background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.25); }

.valuation-pill svg {
  width: 12px;
  height: 12px;
}

/* Comparison Change */
.change-cell {
  display: flex;
  align-items: center;
  gap: 6px;
}

.change-arrow {
  width: 18px;
  height: 18px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.change-arrow.up { background: rgba(239, 68, 68, 0.15); color: #f87171; }
.change-arrow.down { background: rgba(16, 185, 129, 0.15); color: #34d399; }

/* Right Sidebar */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 16px;
  position: sticky;
  top: 80px;
  flex-shrink: 0;
  width: 100%;
}

/* Insights Cards */
.insight-mini-card {
  background: var(--ps-card-bg);
  border: 1px solid var(--ps-border);
  border-radius: 14px;
  padding: 18px;
  transition: all 0.3s ease;
}

.insight-mini-card:hover {
  border-color: rgba(139, 92, 246, 0.3);
  transform: translateY(-2px);
}

.insight-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}

.insight-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.insight-title.green { color: #34d399; }
.insight-title.red { color: #f87171; }
.insight-title.blue { color: #60a5fa; }

.insight-badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.65rem;
  font-weight: 700;
}

.insight-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid rgba(148, 163, 184, 0.05);
}

.insight-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.insight-stock {
  display: flex;
  align-items: center;
  gap: 10px;
}

.insight-stock-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.6rem;
  font-weight: 800;
  color: white;
}

.insight-stock-info {
  display: flex;
  flex-direction: column;
}

.insight-stock-symbol {
  font-weight: 700;
  color: white;
  font-size: 0.85rem;
}

.insight-stock-sector {
  font-size: 0.65rem;
  color: #64748b;
}

.insight-metrics {
  text-align: right;
}

.insight-ps {
  font-weight: 800;
  font-size: 0.95rem;
}

.insight-change {
  font-size: 0.7rem;
  font-weight: 600;
}

/* Charts Section */
.charts-section {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

@media (max-width: 1200px) {
  .charts-section { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
  .charts-section { grid-template-columns: 1fr; }
}

.chart-card {
  background: var(--ps-card-bg);
  border: 1px solid var(--ps-border);
  border-radius: 16px;
  padding: 20px;
}

.chart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.chart-title {
  font-size: 0.875rem;
  font-weight: 700;
  color: white;
}

.chart-subtitle {
  font-size: 0.7rem;
  color: #64748b;
  margin-top: 2px;
}

.chart-container {
  height: 220px;
  position: relative;
}

.chart-container.tall {
  height: 280px;
}

/* Sector Breakdown */
.sector-breakdown {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.sector-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.sector-label {
  width: 100px;
  font-size: 0.75rem;
  color: #94a3b8;
  flex-shrink: 0;
}

.sector-bar-container {
  flex: 1;
  height: 24px;
  background: rgba(30, 41, 59, 0.5);
  border-radius: 6px;
  overflow: hidden;
  display: flex;
}

.sector-bar {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 8px;
  font-size: 0.7rem;
  font-weight: 700;
  color: white;
  transition: width 0.8s ease;
}

.sector-bar.tech { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
.sector-bar.finance { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.sector-bar.healthcare { background: linear-gradient(90deg, #10b981, #34d399); }
.sector-bar.consumer { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
.sector-bar.energy { background: linear-gradient(90deg, #ef4444, #f87171); }
.sector-bar.other { background: linear-gradient(90deg, #6b7280, #9ca3af); }

.sector-value {
  width: 50px;
  text-align: right;
  font-size: 0.8rem;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}

/* Quick Actions */
.quick-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.quick-action {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: rgba(30, 41, 59, 0.8);
  border: 1px solid rgba(148, 163, 184, 0.1);
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
  color: #94a3b8;
  cursor: pointer;
  transition: all 0.2s ease;
}

.quick-action:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: rgba(139, 92, 246, 0.3);
  color: white;
}

.quick-action svg {
  width: 14px;
  height: 14px;
}

/* Tooltip */
.ps-tooltip {
  position: relative;
  cursor: help;
}

.ps-tooltip::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 12px;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 8px;
  font-size: 0.75rem;
  color: #e2e8f0;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  z-index: 100;
}

.ps-tooltip:hover::after {
  opacity: 1;
  visibility: visible;
  transform: translateX(-50%) translateY(-4px);
}

/* Empty State */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
}

.empty-state-icon {
  width: 80px;
  height: 80px;
  background: rgba(139, 92, 246, 0.1);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
}

.empty-state-icon svg {
  width: 40px;
  height: 40px;
  color: #8b5cf6;
}

.empty-state-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: white;
  margin-bottom: 8px;
}

.empty-state-text {
  font-size: 0.875rem;
  color: #64748b;
  max-width: 300px;
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(4px);
}

.loading-content {
  text-align: center;
}

.loading-spinner {
  width: 56px;
  height: 56px;
  border: 3px solid rgba(139, 92, 246, 0.2);
  border-top-color: #8b5cf6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: #94a3b8;
  font-size: 0.925rem;
}

.loading-progress {
  width: 200px;
  height: 4px;
  background: rgba(148, 163, 184, 0.1);
  border-radius: 2px;
  margin-top: 16px;
  overflow: hidden;
}

.loading-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #8b5cf6, #60a5fa);
  border-radius: 2px;
  animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
  0% { width: 0%; margin-left: 0%; }
  50% { width: 60%; margin-left: 20%; }
  100% { width: 0%; margin-left: 100%; }
}

/* Animation Classes */
.fade-in {
  animation: fadeIn 0.5s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.slide-up {
  animation: slideUp 0.6s ease forwards;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 640px) {
  .ps-title { font-size: 1.5rem; }
  .ps-controls { flex-direction: column; width: 100%; }
  .ps-select { width: 100%; }
  .valuation-score-widget { flex-direction: column; text-align: center; }
  .score-signals { justify-content: center; }
}

/* Hidden utility */
.hidden { display: none !important; }
</style>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <p class="loading-text">Analyzing Price-to-Sales Ratios...</p>
    <div class="loading-progress">
      <div class="loading-progress-bar"></div>
    </div>
  </div>
</div>

<div class="ps-dashboard">
  <!-- Hero Section -->
  <div class="ps-hero slide-up">
    <div class="ps-hero-content">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="ps-title">Price-to-Sales Analysis</h1>
          <p class="ps-subtitle">Discover undervalued opportunities using revenue-based valuation metrics</p>
        </div>
        <div class="ps-controls">
          <select id="portfolioSelect" class="ps-select">
            <option value="">Select Portfolio</option>
          </select>
          <button id="refreshBtn" class="ps-btn ps-btn-secondary" title="Refresh data">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
          </button>
          <button id="exportBtn" class="ps-btn ps-btn-primary" title="Export to CSV">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Export
          </button>
        </div>
      </div>

      <!-- Data Quality Badge -->
      <div id="dataQualityBadge" class="hidden mt-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium bg-slate-800/60 border border-slate-700/50">
        <span class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
          <span class="text-slate-300" id="dataSourceText">Live Data</span>
        </span>
        <span class="text-slate-500">|</span>
        <span class="text-slate-400" id="lastUpdatedText">Just now</span>
      </div>

      <!-- Valuation Score Widget -->
      <div class="valuation-score-widget" id="valuationWidget">
        <div class="score-gauge">
          <svg viewBox="0 0 100 100">
            <circle class="score-gauge-bg" cx="50" cy="50" r="42"/>
            <circle class="score-gauge-fill" id="scoreGaugeFill" cx="50" cy="50" r="42"
                    stroke-dasharray="264" stroke-dashoffset="264"/>
          </svg>
          <div class="score-value">
            <span class="score-number" id="valuationScore">--</span>
            <span class="score-label">Score</span>
          </div>
        </div>
        <div class="score-details">
          <div class="score-title" id="valuationTitle">Portfolio Valuation</div>
          <div class="score-description" id="valuationDescription">
            Select a portfolio to see your overall P/S valuation score and analysis.
          </div>
          <div class="score-signals" id="scoreSignals">
            <span class="signal-badge signal-fair">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Awaiting Data
            </span>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card purple">
          <div class="stat-icon purple">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
          </div>
          <div class="stat-label">Avg P/S Ratio</div>
          <div class="stat-value purple" id="avgPS">--</div>
          <div class="stat-change" id="avgPSChange"></div>
        </div>

        <div class="stat-card blue">
          <div class="stat-icon blue">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="stat-label">5-Year Average</div>
          <div class="stat-value blue" id="avg5YPS">--</div>
          <div class="stat-change" id="avg5YPSContext">Historical benchmark</div>
        </div>

        <div class="stat-card amber">
          <div class="stat-icon amber">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
            </svg>
          </div>
          <div class="stat-label">vs 5Y Average</div>
          <div class="stat-value amber" id="vs5YAvg">--</div>
          <div class="stat-change" id="vs5YContext"></div>
        </div>

        <div class="stat-card green">
          <div class="stat-icon green">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="stat-label">Undervalued</div>
          <div class="stat-value green" id="undervalued">--</div>
          <div class="stat-change positive" id="undervaluedContext">Below 5Y avg</div>
        </div>

        <div class="stat-card red">
          <div class="stat-icon red">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="stat-label">Overvalued</div>
          <div class="stat-value red" id="overvalued">--</div>
          <div class="stat-change negative" id="overvaluedContext">Above 5Y avg</div>
        </div>

        <div class="stat-card cyan">
          <div class="stat-icon cyan">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>
          <div class="stat-label">Holdings</div>
          <div class="stat-value cyan" id="totalHoldings">--</div>
          <div class="stat-change" id="holdingsContext">Analyzed</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="main-grid fade-in">
    <!-- Holdings Table -->
    <div class="ps-card">
      <div class="ps-card-header">
        <div class="ps-card-title">
          <svg class="text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
          </svg>
          Portfolio Holdings
        </div>
        <div class="quick-actions">
          <button class="quick-action" id="sortByPSBtn" data-sort="psRatio">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/>
            </svg>
            Sort by P/S
          </button>
          <button class="quick-action" id="sortByValueBtn" data-sort="vs5YAvg">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Best Value
          </button>
          <button class="quick-action" id="tableExportBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            Export
          </button>
        </div>
      </div>
      <div class="holdings-table-wrapper">
        <table class="ps-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="symbol">Company <span class="sort-icon">↕</span></th>
              <th class="text-right sortable" data-sort="marketCap">Market Cap <span class="sort-icon">↕</span></th>
              <th class="text-right sortable" data-sort="revenue">Revenue <span class="sort-icon">↕</span></th>
              <th class="text-right sortable active" data-sort="psRatio">P/S Ratio <span class="sort-icon">↓</span></th>
              <th class="text-right sortable" data-sort="fiveYearAvg">5Y Avg <span class="sort-icon">↕</span></th>
              <th class="text-right sortable" data-sort="vs5YAvg">vs 5Y <span class="sort-icon">↕</span></th>
              <th class="text-center">Valuation</th>
            </tr>
          </thead>
          <tbody id="holdingsTable">
            <tr>
              <td colspan="7">
                <div class="empty-state">
                  <div class="empty-state-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                  </div>
                  <div class="empty-state-title">Select a Portfolio</div>
                  <div class="empty-state-text">Choose a portfolio from the dropdown to analyze P/S valuations for your holdings</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Best Value Card -->
      <div class="insight-mini-card">
        <div class="insight-header">
          <div class="insight-title green">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
            </svg>
            Best Value
          </div>
          <span class="insight-badge" style="background: rgba(16, 185, 129, 0.15); color: #34d399;">Opportunities</span>
        </div>
        <div id="bestValueList">
          <div class="text-slate-500 text-sm text-center py-4">Loading...</div>
        </div>
      </div>

      <!-- Most Expensive Card -->
      <div class="insight-mini-card">
        <div class="insight-header">
          <div class="insight-title red">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Most Expensive
          </div>
          <span class="insight-badge" style="background: rgba(239, 68, 68, 0.15); color: #f87171;">Watch</span>
        </div>
        <div id="expensiveList">
          <div class="text-slate-500 text-sm text-center py-4">Loading...</div>
        </div>
      </div>

      <!-- Sector Comparison -->
      <div class="insight-mini-card">
        <div class="insight-header">
          <div class="insight-title blue">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
            </svg>
            Benchmark Comparison
          </div>
        </div>
        <div id="benchmarkComparison">
          <div class="insight-item">
            <span class="text-slate-400">S&P 500 Avg</span>
            <span class="font-bold text-white">2.8x</span>
          </div>
          <div class="insight-item">
            <span class="text-slate-400">Tech Sector Avg</span>
            <span class="font-bold text-white">8.2x</span>
          </div>
          <div class="insight-item">
            <span class="text-slate-400">Your Portfolio</span>
            <span class="font-bold text-purple-400" id="portfolioAvgPS">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section fade-in">
    <!-- P/S Comparison Chart -->
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">Current vs Historical P/S</div>
          <div class="chart-subtitle">Comparison with 5-year average</div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="comparisonChart"></canvas>
      </div>
    </div>

    <!-- Valuation Distribution -->
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">Valuation Distribution</div>
          <div class="chart-subtitle">Holdings by valuation category</div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="distributionChart"></canvas>
      </div>
    </div>

    <!-- P/S Range Chart -->
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">P/S Range Analysis</div>
          <div class="chart-subtitle">Current vs 52-week range</div>
        </div>
        <select id="historySymbol" class="ps-select" style="min-width: 120px; padding: 6px 30px 6px 10px; font-size: 0.75rem;">
          <option value="">Select stock</option>
        </select>
      </div>
      <div class="chart-container">
        <canvas id="rangeChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Sector Breakdown -->
  <div class="ps-card fade-in" style="margin-bottom: 24px;">
    <div class="ps-card-header">
      <div class="ps-card-title">
        <svg class="text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>
        Sector P/S Breakdown
      </div>
    </div>
    <div class="ps-card-body">
      <div class="sector-breakdown" id="sectorBreakdown">
        <div class="sector-row">
          <div class="sector-label">Technology</div>
          <div class="sector-bar-container">
            <div class="sector-bar tech" style="width: 0%"></div>
          </div>
          <div class="sector-value">--</div>
        </div>
        <div class="sector-row">
          <div class="sector-label">Finance</div>
          <div class="sector-bar-container">
            <div class="sector-bar finance" style="width: 0%"></div>
          </div>
          <div class="sector-value">--</div>
        </div>
        <div class="sector-row">
          <div class="sector-label">Healthcare</div>
          <div class="sector-bar-container">
            <div class="sector-bar healthcare" style="width: 0%"></div>
          </div>
          <div class="sector-value">--</div>
        </div>
        <div class="sector-row">
          <div class="sector-label">Consumer</div>
          <div class="sector-bar-container">
            <div class="sector-bar consumer" style="width: 0%"></div>
          </div>
          <div class="sector-value">--</div>
        </div>
        <div class="sector-row">
          <div class="sector-label">Energy</div>
          <div class="sector-bar-container">
            <div class="sector-bar energy" style="width: 0%"></div>
          </div>
          <div class="sector-value">--</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ============================================
// PRICE TO SALES - ADVANCED JAVASCRIPT
// ============================================

// Global State
let holdingsData = [];
let comparisonChart = null;
let distributionChart = null;
let rangeChart = null;
let currentSort = { field: 'psRatio', direction: 'desc' };

// ============================================
// AUTHENTICATION HELPER
// ============================================

function getToken() {
  return localStorage.getItem('wealthpilot_token') || sessionStorage.getItem('wealthpilot_token');
}

async function authFetch(url, options = {}) {
  const token = getToken();
  const headers = { 'Content-Type': 'application/json', ...options.headers };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  return fetch(url, { ...options, headers });
}

function showToast(message, type = 'info') {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-10 opacity-0`;

  const colors = {
    success: 'bg-emerald-600 text-white',
    error: 'bg-red-600 text-white',
    warning: 'bg-amber-600 text-white',
    info: 'bg-blue-600 text-white'
  };

  toast.className += ` ${colors[type] || colors.info}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  // Animate in
  requestAnimationFrame(() => {
    toast.style.transform = 'translateY(0)';
    toast.style.opacity = '1';
  });

  // Remove after 4 seconds
  setTimeout(() => {
    toast.style.transform = 'translateY(10px)';
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function formatMarketCap(value) {
  if (!value || value === 0) return '--';
  if (value >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
  if (value >= 1e9) return `$${(value / 1e9).toFixed(1)}B`;
  if (value >= 1e6) return `$${(value / 1e6).toFixed(0)}M`;
  return `$${value.toLocaleString()}`;
}

function getSymbolGradient(symbol) {
  const gradients = [
    'linear-gradient(135deg, #8b5cf6, #7c3aed)',
    'linear-gradient(135deg, #3b82f6, #2563eb)',
    'linear-gradient(135deg, #10b981, #059669)',
    'linear-gradient(135deg, #f59e0b, #d97706)',
    'linear-gradient(135deg, #ef4444, #dc2626)',
    'linear-gradient(135deg, #ec4899, #db2777)',
    'linear-gradient(135deg, #06b6d4, #0891b2)',
    'linear-gradient(135deg, #84cc16, #65a30d)'
  ];
  const index = symbol.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % gradients.length;
  return gradients[index];
}

function getValuationData(valuation) {
  const map = {
    'Cheap': { class: 'cheap', icon: '↓↓', color: '#10b981' },
    'Undervalued': { class: 'undervalued', icon: '↓', color: '#34d399' },
    'Fair Value': { class: 'fair', icon: '=', color: '#60a5fa' },
    'Stretched': { class: 'stretched', icon: '↑', color: '#fbbf24' },
    'Expensive': { class: 'expensive', icon: '↑↑', color: '#ef4444' }
  };
  return map[valuation] || map['Fair Value'];
}

function getPSRatioColor(ratio) {
  if (ratio <= 2) return '#10b981';
  if (ratio <= 5) return '#34d399';
  if (ratio <= 10) return '#60a5fa';
  if (ratio <= 15) return '#fbbf24';
  return '#ef4444';
}

function calculateValuationScore(holdings) {
  if (!holdings || holdings.length === 0) return { score: 0, label: 'N/A', color: '#64748b' };

  let totalScore = 0;
  holdings.forEach(h => {
    const vs5Y = h.vs5YAvg || 0;
    if (vs5Y <= -30) totalScore += 100;
    else if (vs5Y <= -15) totalScore += 80;
    else if (vs5Y <= 0) totalScore += 60;
    else if (vs5Y <= 15) totalScore += 40;
    else if (vs5Y <= 30) totalScore += 20;
    else totalScore += 0;
  });

  const avgScore = Math.round(totalScore / holdings.length);

  let label, color;
  if (avgScore >= 80) { label = 'Very Attractive'; color = '#10b981'; }
  else if (avgScore >= 60) { label = 'Attractive'; color = '#34d399'; }
  else if (avgScore >= 40) { label = 'Fair'; color = '#60a5fa'; }
  else if (avgScore >= 20) { label = 'Stretched'; color = '#fbbf24'; }
  else { label = 'Expensive'; color = '#ef4444'; }

  return { score: avgScore, label, color };
}

// ============================================
// DATA LOADING
// ============================================

async function loadPortfolios() {
  const select = document.getElementById('portfolioSelect');

  try {
    const token = getToken();
    console.log('[P/S] Token available:', !!token);

    if (!token) {
      select.innerHTML = '<option value="">Please log in to view portfolios</option>';
      showToast('Please log in to access your portfolios', 'warning');
      return;
    }

    const response = await authFetch('/api/portfolios');
    console.log('[P/S] API Response status:', response.status);

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || `HTTP ${response.status}`);
    }

    const portfolios = await response.json();
    console.log('[P/S] Portfolios received:', portfolios.length);

    // Handle both array and error object responses
    if (!Array.isArray(portfolios)) {
      if (portfolios.error) throw new Error(portfolios.error);
      throw new Error('Invalid response format');
    }

    select.innerHTML = '<option value="">Select Portfolio</option>';

    // Add all portfolios with holdings
    let portfoliosWithHoldings = 0;
    portfolios.forEach(p => {
      if (p.holdings && p.holdings.length > 0) {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.name} (${p.holdingsCount || p.holdings.length} holdings)`;
        select.appendChild(option);
        portfoliosWithHoldings++;
      }
    });

    console.log('[P/S] Portfolios with holdings:', portfoliosWithHoldings);

    if (portfoliosWithHoldings === 0) {
      select.innerHTML = '<option value="">No portfolios with holdings found</option>';
      showToast('Add holdings to your portfolios to analyze P/S ratios', 'info');
      return;
    }

    // Auto-select first portfolio with holdings
    const firstWithHoldings = portfolios.find(p => p.holdings && p.holdings.length > 0);
    if (firstWithHoldings) {
      select.value = firstWithHoldings.id;
      loadPSData();
    }

  } catch (error) {
    console.error('[P/S] Error loading portfolios:', error);
    select.innerHTML = '<option value="">Error loading portfolios</option>';
    showToast('Error loading portfolios: ' + error.message, 'error');
  }
}

async function loadPSData() {
  const portfolioId = document.getElementById('portfolioSelect').value;
  if (!portfolioId) return;

  document.getElementById('loadingOverlay').classList.remove('hidden');

  try {
    const response = await authFetch(`/api/fundamentals/portfolio/${portfolioId}/price-to-sales`);
    const data = await response.json();

    if (data.error) throw new Error(data.error);

    holdingsData = data.holdings || [];

    updateValuationScore(holdingsData);
    updateSummaryStats(data.summary);
    updateHoldingsTable(holdingsData);
    updateInsightCards(data.insights);
    updateCharts(data);
    updateSectorBreakdown(holdingsData);
    updateHistoryDropdown(holdingsData);
    updateDataQualityBadge(data);

    showToast(`Loaded ${holdingsData.length} holdings`, 'success');

  } catch (error) {
    console.error('Error loading P/S data:', error);
    showToast && showToast('Error loading data: ' + error.message, 'error');
  } finally {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }
}

// ============================================
// UI UPDATE FUNCTIONS
// ============================================

function updateValuationScore(holdings) {
  const { score, label, color } = calculateValuationScore(holdings);

  // Update gauge
  const gaugeFill = document.getElementById('scoreGaugeFill');
  const circumference = 2 * Math.PI * 42;
  const offset = circumference - (score / 100) * circumference;
  gaugeFill.style.strokeDashoffset = offset;
  gaugeFill.style.stroke = color;

  // Update score number
  document.getElementById('valuationScore').textContent = score;
  document.getElementById('valuationScore').style.color = color;

  // Update title and description
  document.getElementById('valuationTitle').textContent = `Portfolio Valuation: ${label}`;

  const undervalued = holdings.filter(h => h.vs5YAvg < 0).length;
  const overvalued = holdings.filter(h => h.vs5YAvg > 0).length;

  document.getElementById('valuationDescription').textContent =
    `Your portfolio has ${undervalued} undervalued and ${overvalued} overvalued holdings based on 5-year P/S averages. ${
      score >= 60 ? 'Overall, your portfolio appears attractively valued.' :
      score >= 40 ? 'Your portfolio is fairly valued relative to historical levels.' :
      'Consider reviewing holdings trading at stretched valuations.'
    }`;

  // Update signals
  const signalsContainer = document.getElementById('scoreSignals');
  signalsContainer.innerHTML = `
    ${undervalued > 0 ? `
      <span class="signal-badge signal-undervalued">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        ${undervalued} Undervalued
      </span>
    ` : ''}
    ${overvalued > 0 ? `
      <span class="signal-badge signal-overvalued">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/>
        </svg>
        ${overvalued} Overvalued
      </span>
    ` : ''}
    ${undervalued === 0 && overvalued === 0 ? `
      <span class="signal-badge signal-fair">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
        </svg>
        All Fair Value
      </span>
    ` : ''}
  `;
}

function updateSummaryStats(summary) {
  document.getElementById('avgPS').textContent = summary.avgPS ? `${summary.avgPS}x` : '--';
  document.getElementById('avg5YPS').textContent = summary.avg5YPS ? `${summary.avg5YPS}x` : '--';

  const vs5Y = summary.vs5YAvg || 0;
  const vs5YEl = document.getElementById('vs5YAvg');
  vs5YEl.textContent = `${vs5Y >= 0 ? '+' : ''}${vs5Y.toFixed(1)}%`;
  vs5YEl.className = `stat-value ${vs5Y >= 0 ? 'amber' : 'green'}`;
  document.getElementById('vs5YContext').textContent = vs5Y >= 0 ? 'Above historical' : 'Below historical';

  document.getElementById('undervalued').textContent = summary.undervalued || 0;
  document.getElementById('overvalued').textContent = summary.overvalued || 0;
  document.getElementById('totalHoldings').textContent = summary.total || 0;

  document.getElementById('portfolioAvgPS').textContent = summary.avgPS ? `${summary.avgPS}x` : '--';
}

function updateDataQualityBadge(data) {
  const badge = document.getElementById('dataQualityBadge');
  badge.classList.remove('hidden');

  const quality = data.dataQuality || {};
  const estimated = quality.estimated || 0;
  const live = quality.live || data.holdings?.length || 0;
  const total = quality.total || data.holdings?.length || 0;

  const sourceText = document.getElementById('dataSourceText');
  const statusDot = badge.querySelector('.w-2');

  if (estimated === 0) {
    sourceText.textContent = `${live} Live Data Sources`;
    statusDot.className = 'w-2 h-2 rounded-full bg-emerald-400';
  } else if (estimated < total / 2) {
    sourceText.textContent = `${live} Live, ${estimated} Estimated`;
    statusDot.className = 'w-2 h-2 rounded-full bg-amber-400';
  } else {
    sourceText.textContent = `${estimated} Estimated Values`;
    statusDot.className = 'w-2 h-2 rounded-full bg-blue-400';
  }

  document.getElementById('lastUpdatedText').textContent = new Date().toLocaleTimeString();
}

function updateHoldingsTable(holdings) {
  const tbody = document.getElementById('holdingsTable');

  if (!holdings || holdings.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7">
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
              </svg>
            </div>
            <div class="empty-state-title">No P/S Data Available</div>
            <div class="empty-state-text">We couldn't find P/S data for your holdings. Try refreshing or select a different portfolio.</div>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  // Sort holdings
  const sortedHoldings = [...holdings].sort((a, b) => {
    let aVal = a[currentSort.field] || 0;
    let bVal = b[currentSort.field] || 0;
    if (currentSort.field === 'symbol' || currentSort.field === 'name') {
      aVal = String(aVal).toLowerCase();
      bVal = String(bVal).toLowerCase();
      return currentSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    }
    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
  });

  tbody.innerHTML = sortedHoldings.map((h, index) => {
    const valData = getValuationData(h.valuation);
    const psColor = getPSRatioColor(h.psRatio);
    const barWidth = Math.min((h.psRatio / 20) * 100, 100);
    const isUndervalued = h.vs5YAvg < -10;

    return `
      <tr class="fade-in" style="animation-delay: ${index * 50}ms;">
        <td>
          <div class="symbol-cell">
            <div class="symbol-avatar ${isUndervalued ? 'undervalued' : ''}" style="background: ${getSymbolGradient(h.symbol)}">
              ${h.symbol.substring(0, 3)}
            </div>
            <div class="symbol-info">
              <span class="symbol-ticker">${h.symbol}</span>
              <span class="symbol-name">${h.name || h.symbol}</span>
            </div>
          </div>
        </td>
        <td class="text-right text-slate-300">${formatMarketCap(h.marketCap)}</td>
        <td class="text-right text-slate-300">${formatMarketCap(h.revenue)}</td>
        <td class="text-right">
          <div class="ps-ratio-cell">
            <span class="ps-ratio-value" style="color: ${psColor}">${h.psRatio ? h.psRatio.toFixed(1) + 'x' : '--'}</span>
            <div class="ps-ratio-bar">
              <div class="ps-ratio-bar-fill" style="width: ${barWidth}%; background: ${psColor}"></div>
            </div>
          </div>
        </td>
        <td class="text-right text-slate-400">${h.fiveYearAvg ? h.fiveYearAvg.toFixed(1) + 'x' : '--'}</td>
        <td class="text-right">
          <div class="change-cell" style="justify-content: flex-end;">
            <span class="change-arrow ${h.vs5YAvg >= 0 ? 'up' : 'down'}">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${h.vs5YAvg >= 0
                  ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>'
                  : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>'}
              </svg>
            </span>
            <span class="font-bold ${h.vs5YAvg >= 0 ? 'text-red-400' : 'text-emerald-400'}">
              ${h.vs5YAvg >= 0 ? '+' : ''}${h.vs5YAvg ? h.vs5YAvg.toFixed(1) : 0}%
            </span>
          </div>
        </td>
        <td class="text-center">
          <span class="valuation-pill ${valData.class}">
            ${h.valuation || 'Fair Value'}
          </span>
        </td>
      </tr>
    `;
  }).join('');
}

function updateInsightCards(insights) {
  // Best Value
  const bestValue = insights?.bestValue?.slice(0, 3) || [];
  document.getElementById('bestValueList').innerHTML = bestValue.length > 0
    ? bestValue.map(h => `
        <div class="insight-item">
          <div class="insight-stock">
            <div class="insight-stock-icon" style="background: ${getSymbolGradient(h.symbol)}">${h.symbol.substring(0, 2)}</div>
            <div class="insight-stock-info">
              <span class="insight-stock-symbol">${h.symbol}</span>
              <span class="insight-stock-sector">${h.sector || 'N/A'}</span>
            </div>
          </div>
          <div class="insight-metrics">
            <div class="insight-ps text-emerald-400">${h.psRatio?.toFixed(1) || '--'}x</div>
            <div class="insight-change text-emerald-400">${h.vs5YAvg?.toFixed(0) || 0}%</div>
          </div>
        </div>
      `).join('')
    : '<div class="text-slate-500 text-sm text-center py-4">No undervalued holdings found</div>';

  // Most Expensive
  const expensive = insights?.mostExpensive?.slice(0, 3) || [];
  document.getElementById('expensiveList').innerHTML = expensive.length > 0
    ? expensive.map(h => `
        <div class="insight-item">
          <div class="insight-stock">
            <div class="insight-stock-icon" style="background: ${getSymbolGradient(h.symbol)}">${h.symbol.substring(0, 2)}</div>
            <div class="insight-stock-info">
              <span class="insight-stock-symbol">${h.symbol}</span>
              <span class="insight-stock-sector">${h.sector || 'N/A'}</span>
            </div>
          </div>
          <div class="insight-metrics">
            <div class="insight-ps text-red-400">${h.psRatio?.toFixed(1) || '--'}x</div>
            <div class="insight-change text-red-400">+${h.vs5YAvg?.toFixed(0) || 0}%</div>
          </div>
        </div>
      `).join('')
    : '<div class="text-slate-500 text-sm text-center py-4">No overvalued holdings found</div>';
}

function updateSectorBreakdown(holdings) {
  const sectorData = {};

  holdings.forEach(h => {
    const sector = h.sector || 'Other';
    if (!sectorData[sector]) {
      sectorData[sector] = { count: 0, totalPS: 0 };
    }
    sectorData[sector].count++;
    sectorData[sector].totalPS += h.psRatio || 0;
  });

  const sectors = Object.entries(sectorData)
    .map(([name, data]) => ({
      name,
      avgPS: data.count > 0 ? data.totalPS / data.count : 0,
      count: data.count
    }))
    .sort((a, b) => b.avgPS - a.avgPS)
    .slice(0, 5);

  const maxPS = Math.max(...sectors.map(s => s.avgPS), 20);

  const sectorColors = {
    'TECHNOLOGY': 'tech',
    'FINANCIAL SERVICES': 'finance',
    'HEALTHCARE': 'healthcare',
    'CONSUMER CYCLICAL': 'consumer',
    'CONSUMER DEFENSIVE': 'consumer',
    'ENERGY': 'energy'
  };

  document.getElementById('sectorBreakdown').innerHTML = sectors.map(s => {
    const barClass = sectorColors[s.name.toUpperCase()] || 'other';
    const width = (s.avgPS / maxPS) * 100;

    return `
      <div class="sector-row">
        <div class="sector-label">${s.name.length > 12 ? s.name.substring(0, 12) + '...' : s.name}</div>
        <div class="sector-bar-container">
          <div class="sector-bar ${barClass}" style="width: ${width}%">${s.avgPS.toFixed(1)}x</div>
        </div>
        <div class="sector-value">${s.count} stocks</div>
      </div>
    `;
  }).join('');
}

function updateHistoryDropdown(holdings) {
  const select = document.getElementById('historySymbol');
  select.innerHTML = '<option value="">Select stock</option>' +
    holdings.map(h => `<option value="${h.symbol}">${h.symbol}</option>`).join('');
}

// ============================================
// CHART FUNCTIONS
// ============================================

function updateCharts(data) {
  updateComparisonChart(data.holdings);
  updateDistributionChart(data.holdings);
  updateRangeChart(data.holdings);
}

function updateComparisonChart(holdings) {
  if (comparisonChart) comparisonChart.destroy();

  const top8 = holdings.slice(0, 8);
  const ctx = document.getElementById('comparisonChart').getContext('2d');

  comparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: top8.map(h => h.symbol),
      datasets: [
        {
          label: 'Current P/S',
          data: top8.map(h => h.psRatio || 0),
          backgroundColor: top8.map(h => getPSRatioColor(h.psRatio)),
          borderRadius: 6,
          borderSkipped: false
        },
        {
          label: '5Y Average',
          data: top8.map(h => h.fiveYearAvg || 0),
          backgroundColor: 'rgba(148, 163, 184, 0.3)',
          borderRadius: 6,
          borderSkipped: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: { color: '#94a3b8', font: { size: 11 }, usePointStyle: true, padding: 15 }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          borderColor: 'rgba(139, 92, 246, 0.3)',
          borderWidth: 1,
          padding: 12,
          titleFont: { size: 13, weight: 'bold' },
          bodyFont: { size: 12 }
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', font: { size: 11 } },
          grid: { display: false }
        },
        y: {
          ticks: { color: '#64748b', callback: v => v + 'x' },
          grid: { color: 'rgba(148, 163, 184, 0.08)' },
          beginAtZero: true
        }
      }
    }
  });
}

function updateDistributionChart(holdings) {
  if (distributionChart) distributionChart.destroy();

  const distribution = {
    'Cheap': 0,
    'Undervalued': 0,
    'Fair Value': 0,
    'Stretched': 0,
    'Expensive': 0
  };

  holdings.forEach(h => {
    const val = h.valuation || 'Fair Value';
    if (distribution.hasOwnProperty(val)) {
      distribution[val]++;
    }
  });

  const ctx = document.getElementById('distributionChart').getContext('2d');

  distributionChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(distribution),
      datasets: [{
        data: Object.values(distribution),
        backgroundColor: ['#10b981', '#34d399', '#60a5fa', '#fbbf24', '#ef4444'],
        borderWidth: 0,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#94a3b8', font: { size: 11 }, usePointStyle: true, padding: 12 }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          borderColor: 'rgba(139, 92, 246, 0.3)',
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const pct = total > 0 ? ((context.raw / total) * 100).toFixed(0) : 0;
              return `${context.label}: ${context.raw} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function updateRangeChart(holdings) {
  if (rangeChart) rangeChart.destroy();

  const top6 = holdings.slice(0, 6);
  const ctx = document.getElementById('rangeChart').getContext('2d');

  rangeChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: top6.map(h => h.symbol),
      datasets: [{
        label: 'P/S Ratio',
        data: top6.map(h => h.psRatio || 0),
        backgroundColor: ctx => {
          const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 200);
          gradient.addColorStop(0, 'rgba(139, 92, 246, 0.8)');
          gradient.addColorStop(1, 'rgba(139, 92, 246, 0.2)');
          return gradient;
        },
        borderRadius: { topLeft: 6, topRight: 6 },
        borderSkipped: false
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          borderColor: 'rgba(139, 92, 246, 0.3)',
          borderWidth: 1,
          padding: 12
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', callback: v => v + 'x' },
          grid: { color: 'rgba(148, 163, 184, 0.08)' },
          beginAtZero: true
        },
        y: {
          ticks: { color: '#94a3b8', font: { weight: '600' } },
          grid: { display: false }
        }
      }
    }
  });
}

async function loadPSHistory(symbol) {
  if (!symbol) return;

  try {
    const response = await authFetch(`/api/fundamentals/${symbol}/ps-history`);
    const data = await response.json();

    if (rangeChart) rangeChart.destroy();

    const ctx = document.getElementById('rangeChart').getContext('2d');

    rangeChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.history?.map(h => h.year) || ['2020', '2021', '2022', '2023', '2024'],
        datasets: [{
          label: `${symbol} P/S History`,
          data: data.history?.map(h => h.psRatio) || [],
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#8b5cf6',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            borderColor: 'rgba(139, 92, 246, 0.3)',
            borderWidth: 1,
            padding: 12
          }
        },
        scales: {
          x: { ticks: { color: '#64748b' }, grid: { display: false } },
          y: {
            ticks: { color: '#64748b', callback: v => v + 'x' },
            grid: { color: 'rgba(148, 163, 184, 0.08)' }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error loading P/S history:', error);
  }
}

// ============================================
// SORTING
// ============================================

function sortTable(field) {
  if (currentSort.field === field) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.field = field;
    currentSort.direction = 'desc';
  }

  // Update sort icons
  document.querySelectorAll('.ps-table th').forEach(th => {
    th.classList.remove('active');
    const icon = th.querySelector('.sort-icon');
    if (icon) icon.textContent = '↕';
  });

  const activeTh = document.querySelector(`.ps-table th[data-sort="${field}"]`);
  if (activeTh) {
    activeTh.classList.add('active');
    const icon = activeTh.querySelector('.sort-icon');
    if (icon) icon.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
  }

  updateHoldingsTable(holdingsData);
}

// ============================================
// EVENT LISTENERS
// ============================================

document.addEventListener('DOMContentLoaded', async () => {
  await loadPortfolios();
});

document.getElementById('portfolioSelect').addEventListener('change', loadPSData);
document.getElementById('refreshBtn').addEventListener('click', loadPSData);
document.getElementById('historySymbol').addEventListener('change', (e) => loadPSHistory(e.target.value));

document.getElementById('sortByPSBtn').addEventListener('click', () => sortTable('psRatio'));
document.getElementById('sortByValueBtn').addEventListener('click', () => {
  currentSort.field = 'vs5YAvg';
  currentSort.direction = 'asc';
  updateHoldingsTable(holdingsData);
});

document.getElementById('exportBtn').addEventListener('click', () => {
  if (holdingsData.length === 0) {
    showToast && showToast('No data to export', 'warning');
    return;
  }

  const csv = [
    ['Symbol', 'Name', 'Market Cap', 'Revenue', 'P/S Ratio', '5Y Avg', 'vs 5Y Avg', 'Valuation'].join(','),
    ...holdingsData.map(h => [
      h.symbol,
      `"${h.name || ''}"`,
      h.marketCap || 0,
      h.revenue || 0,
      h.psRatio || 0,
      h.fiveYearAvg || 0,
      h.vs5YAvg || 0,
      h.valuation || ''
    ].join(','))
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'price-to-sales-analysis.csv';
  a.click();
  URL.revokeObjectURL(url);

  showToast && showToast('Exported to CSV', 'success');
});

// Table export button (same functionality)
document.getElementById('tableExportBtn')?.addEventListener('click', () => {
  document.getElementById('exportBtn').click();
});

// Table header sorting
document.querySelectorAll('.ps-table th.sortable').forEach(th => {
  th.addEventListener('click', () => sortTable(th.dataset.sort));
});
</script>

<%- include('../partials/footer') %>
