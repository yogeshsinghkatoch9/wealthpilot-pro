<%
  // Safe defaults for potentially undefined variables
  const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
  const safeUser = typeof user !== 'undefined' ? user : {};
%>
<%- include('../partials/header', { pageTitle: 'Position Sizing' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header mb-6">
  <h1 class="text-2xl font-bold text-green-400">POSITION SIZING CALCULATOR</h1>
  <p class="text-slate-400">Kelly criterion & risk-based sizing</p>
</div>

<!-- Account Info -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm">Portfolio Value</p>
<p class="text-2xl font-bold font-mono text-white">$276,847</p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm">Available Cash</p>
<p class="text-2xl font-bold font-mono text-emerald-400">$42,150</p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm">Max Risk Per Trade</p>
<p class="text-2xl font-bold font-mono text-green-400">2%</p>
<p class="text-xs font-mono text-slate-400">$5,537</p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-sm">Current Positions</p>
<p class="text-2xl font-bold font-mono text-white">12</p>
</div>
</div>

<!-- Calculator -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-white mb-4">RISK-BASED POSITION SIZING</h3>
<div class="space-y-4">
<div>
<label class="text-sm font-medium text-slate-300 block mb-1">Stock Symbol</label>
<input type="text" value="NVDA" class="w-full font-mono bg-slate-900/50 border border-slate-700 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" id="symbol">
</div>
<div>
<label class="text-sm font-medium text-slate-300 block mb-1">Entry Price</label>
<input type="number" value="485.00" class="w-full font-mono bg-slate-900/50 border border-slate-700 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" id="entry">
</div>
<div>
<label class="text-sm font-medium text-slate-300 block mb-1">Stop Loss Price</label>
<input type="number" value="460.00" class="w-full font-mono bg-slate-900/50 border border-slate-700 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" id="stop">
</div>
<div>
<label class="text-sm font-medium text-slate-300 block mb-1">Risk Per Trade (%)</label>
<input type="range" min="0.5" max="5" step="0.5" value="2" class="w-full" id="riskPct">
<div class="flex justify-between text-xs font-mono text-slate-400"><span>0.5%</span><span id="riskDisplay">2%</span><span>5%</span></div>
</div>
<button onclick="calculatePosition()" class="bloomberg-btn w-full mt-2">Calculate Position Size</button>
</div>
</div>

<div class="bloomberg-card p-5">
<h3 class="font-semibold text-white mb-4">RESULTS</h3>
<div class="space-y-4" id="results">
<div class="p-4 rounded-lg bg-gradient-to-r from-emerald-900/20 to-sky-900/20 border border-slate-700">
<p class="text-sm text-slate-400">Recommended Position Size</p>
<p class="text-4xl font-bold font-mono text-emerald-400">221 shares</p>
<p class="text-sm font-mono text-slate-400">$107,185 total investment</p>
</div>
<div class="grid grid-cols-2 gap-4">
<div class="p-3 rounded-lg bg-slate-800 border border-slate-700">
<p class="text-xs text-slate-400">Risk Amount</p>
<p class="text-xl font-bold font-mono text-green-400">$5,525</p>
<p class="text-xs font-mono text-slate-400">2.0% of portfolio</p>
</div>
<div class="p-3 rounded-lg bg-slate-800 border border-slate-700">
<p class="text-xs text-slate-400">Risk Per Share</p>
<p class="text-xl font-bold font-mono text-white">$25.00</p>
<p class="text-xs font-mono text-slate-400">5.2% from entry</p>
</div>
</div>
<div class="p-3 rounded-lg bg-sky-500/10 border border-sky-500/20">
<p class="text-xs text-slate-400">Position % of Portfolio</p>
<p class="text-xl font-bold font-mono text-sky-400">38.7%</p>
<p class="text-xs text-green-400">Consider reducing - high concentration</p>
</div>
</div>
</div>
</div>

<!-- Kelly Criterion -->
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-white mb-4">KELLY CRITERION CALCULATOR</h3>
<p class="text-sm text-slate-400 mb-4">Optimal bet sizing based on win rate and reward/risk ratio</p>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
<div>
<label class="text-sm font-medium text-slate-300 block mb-1">Win Rate (%)</label>
<input type="number" value="55" class="w-full font-mono bg-slate-900/50 border border-slate-700 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" id="winRate">
</div>
<div>
<label class="text-sm font-medium text-slate-300 block mb-1">Avg Win ($)</label>
<input type="number" value="2500" class="w-full font-mono bg-slate-900/50 border border-slate-700 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" id="avgWin">
</div>
<div>
<label class="text-sm font-medium text-slate-300 block mb-1">Avg Loss ($)</label>
<input type="number" value="1500" class="w-full font-mono bg-slate-900/50 border border-slate-700 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" id="avgLoss">
</div>
<div class="flex items-end">
<button onclick="calculateKelly()" class="bloomberg-btn w-full">Calculate Kelly %</button>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
<div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/20 text-center">
<p class="text-sm text-slate-400">Full Kelly</p>
<p class="text-3xl font-bold font-mono text-purple-400">21.7%</p>
<p class="text-xs text-red-400">Very aggressive</p>
</div>
<div class="p-4 rounded-lg bg-emerald-500/10 text-center border-2 border-emerald-500">
<p class="text-sm text-slate-400">Half Kelly (Recommended)</p>
<p class="text-3xl font-bold font-mono text-emerald-400">10.8%</p>
<p class="text-xs text-emerald-400">Balanced risk</p>
</div>
<div class="p-4 rounded-lg bg-sky-500/10 border border-sky-500/20 text-center">
<p class="text-sm text-slate-400">Quarter Kelly</p>
<p class="text-3xl font-bold font-mono text-sky-400">5.4%</p>
<p class="text-xs text-sky-400">Conservative</p>
</div>
</div>
</div>

<!-- Position Sizing Guidelines -->
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-white mb-4">POSITION SIZING GUIDELINES</h3>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
<div class="p-4 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
<h4 class="font-bold text-emerald-500 mb-2">Conservative</h4>
<p class="text-2xl font-bold font-mono text-white mb-2">1% Risk</p>
<ul class="text-sm text-slate-400 space-y-1">
<li>15-25 positions</li>
<li>Max 5% per position</li>
<li>Best for beginners</li>
</ul>
</div>
<div class="p-4 rounded-lg bg-sky-500/10 border border-sky-500/20">
<h4 class="font-bold text-sky-500 mb-2">Moderate</h4>
<p class="text-2xl font-bold font-mono text-white mb-2">2% Risk</p>
<ul class="text-sm text-slate-400 space-y-1">
<li>10-15 positions</li>
<li>Max 10% per position</li>
<li>Balanced approach</li>
</ul>
</div>
<div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
<h4 class="font-bold text-green-500 mb-2">Aggressive</h4>
<p class="text-2xl font-bold font-mono text-white mb-2">3-5% Risk</p>
<ul class="text-sm text-slate-400 space-y-1">
<li>5-10 positions</li>
<li>Max 20% per position</li>
<li>Higher volatility</li>
</ul>
</div>
<div class="p-4 rounded-lg bg-red-500/10 border border-red-500/20">
<h4 class="font-bold text-red-500 mb-2">Your Current</h4>
<p class="text-2xl font-bold font-mono text-white mb-2">2% Risk</p>
<ul class="text-sm text-slate-400 space-y-1">
<li>12 positions</li>
<li>Largest: 18%</li>
<li>Moderate risk</li>
</ul>
</div>
</div>
</div>
</div></div></main>

<script>
function calculatePosition() {
  const entry = parseFloat(document.getElementById('entry').value);
  const stop = parseFloat(document.getElementById('stop').value);
  const risk = entry - stop;
  const shares = Math.floor(5537 / risk);
  showToast(`Position size: ${shares} shares ($${(shares * entry).toLocaleString()})`, 'success');
}
function calculateKelly() {
  const winRate = parseFloat(document.getElementById('winRate').value) / 100;
  const avgWin = parseFloat(document.getElementById('avgWin').value);
  const avgLoss = parseFloat(document.getElementById('avgLoss').value);
  const kelly = (winRate * avgWin - (1 - winRate) * avgLoss) / avgWin;
  showToast(`Kelly Criterion: ${(kelly * 100).toFixed(1)}%`, 'info');
}
document.getElementById('riskPct').addEventListener('input', function() {
  document.getElementById('riskDisplay').textContent = this.value + '%';
});
</script>
<%- include('../partials/footer') %>
