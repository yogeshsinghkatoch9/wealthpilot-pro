<%
// Safe defaults for undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safePortfolio = typeof portfolio !== 'undefined' ? portfolio : { cash_balance: 100000, total_value: 100000 };
const safeStats = typeof stats !== 'undefined' ? stats : { totalProfitLoss: 0, winRate: '0.0', wins: 0, totalTrades: 0 };
const safeOpenTrades = typeof openTrades !== 'undefined' ? openTrades : [];
const safeFmt = typeof fmt !== 'undefined' ? fmt : { number: (n) => Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) };
%>
<%- include('../partials/header', { pageTitle: 'Paper Trading' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold text-amber-400 tracking-wide">PAPER TRADING SIMULATOR</h1>
      <p class="text-xs text-slate-400 mt-1">Virtual Trading Environment - Risk-Free Practice</p>
    </div>
    <div class="text-right">
      <p class="text-xs text-slate-400 uppercase tracking-wide">Virtual Balance</p>
      <p class="text-2xl font-mono font-bold text-emerald-400">$<%= safeFmt.number(safePortfolio.cash_balance || 100000) %></p>
    </div>
  </div>
</div>

<!-- Bloomberg KPI Bar -->
<%
const totalPL = safeStats.totalProfitLoss || 0;
const totalValue = safePortfolio.total_value || 100000;
const startingValue = 100000;
const plPercent = ((totalPL / startingValue) * 100).toFixed(2);
const winRate = parseFloat(safeStats.winRate) || 0;
%>
<div class="bloomberg-kpi-bar">
  <div class="bloomberg-kpi-item">
    <div class="bloomberg-kpi-label">TOTAL VALUE</div>
    <div class="bloomberg-kpi-value font-mono">$<%= safeFmt.number(totalValue) %></div>
    <div class="text-xs text-slate-500 font-mono">Started: $100,000</div>
  </div>
  <div class="bloomberg-kpi-item">
    <div class="bloomberg-kpi-label">TOTAL P/L</div>
    <div class="bloomberg-kpi-value font-mono <%= totalPL >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
      <%= totalPL >= 0 ? '+' : '' %>$<%= safeFmt.number(Math.abs(totalPL)) %>
    </div>
    <div class="text-xs font-mono <%= totalPL >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
      <%= totalPL >= 0 ? '+' : '' %><%= plPercent %>%
    </div>
  </div>
  <div class="bloomberg-kpi-item">
    <div class="bloomberg-kpi-label">WIN RATE</div>
    <div class="bloomberg-kpi-value font-mono <%= winRate > 50 ? 'text-emerald-400' : 'text-amber-400' %>">
      <%= safeStats.winRate %>%
    </div>
    <div class="text-xs text-slate-500 font-mono">
      <%= safeStats.wins %>/<%= safeStats.totalTrades %> trades
    </div>
  </div>
  <div class="bloomberg-kpi-item">
    <div class="bloomberg-kpi-label">OPEN POSITIONS</div>
    <div class="bloomberg-kpi-value font-mono"><%= safeOpenTrades.length %></div>
    <div class="text-xs text-slate-500">Active trades</div>
  </div>
  <div class="bloomberg-kpi-item">
    <div class="bloomberg-kpi-label">CASH AVAILABLE</div>
    <div class="bloomberg-kpi-value font-mono text-emerald-400">$<%= safeFmt.number(safePortfolio.cash_balance || 100000) %></div>
    <div class="text-xs text-slate-500">Available to trade</div>
  </div>
</div>

<!-- Trade Entry Form -->
<div class="bloomberg-card">
  <div class="p-5 border-b border-amber-400/20">
    <h3 class="text-sm font-bold text-amber-400 uppercase tracking-wider">New Trade Order</h3>
  </div>
  <div class="p-6">
    <form id="tradeForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div>
        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Symbol</label>
        <input type="text" name="symbol" placeholder="AAPL" class="form-input w-full font-mono uppercase bg-slate-900/50 border-slate-700 focus:border-amber-400 text-white" required>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Side</label>
        <select name="tradeType" class="form-input w-full font-mono bg-slate-900/50 border-slate-700 focus:border-amber-400 text-white">
          <option value="buy">BUY (LONG)</option>
          <option value="sell">SELL (SHORT)</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Quantity</label>
        <input type="number" name="quantity" placeholder="100" class="form-input w-full font-mono bg-slate-900/50 border-slate-700 focus:border-amber-400 text-white" required>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Entry Price</label>
        <input type="number" step="0.01" name="entryPrice" placeholder="150.00" class="form-input w-full font-mono bg-slate-900/50 border-slate-700 focus:border-amber-400 text-white" required>
      </div>
      <div class="flex items-end">
        <button type="submit" class="bloomberg-btn bloomberg-btn-primary w-full">
          <span class="font-semibold">PLACE ORDER</span>
        </button>
      </div>
    </form>
    <div class="mt-6 p-4 bg-amber-400/5 border border-amber-400/20 rounded">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <p class="text-xs font-semibold text-amber-400 uppercase tracking-wide mb-1">Paper Trading Mode</p>
          <p class="text-sm text-slate-400">Practice trading with virtual money. Perfect for testing strategies risk-free!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Open Positions Table -->
<div class="bloomberg-card">
  <div class="p-5 border-b border-amber-400/20 flex items-center justify-between">
    <h3 class="text-sm font-bold text-amber-400 uppercase tracking-wider">
      Open Positions (<span class="font-mono"><%= safeOpenTrades.length %></span>)
    </h3>
    <button onclick="resetAccount()" class="bloomberg-btn bloomberg-btn-secondary text-xs">
      RESET ACCOUNT
    </button>
  </div>

  <% if (safeOpenTrades.length === 0) { %>
    <div class="p-12 text-center">
      <svg class="w-20 h-20 mx-auto text-slate-700 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
      </svg>
      <h4 class="text-lg font-bold text-white mb-2 uppercase tracking-wide">No Open Positions</h4>
      <p class="text-slate-400">Place a trade order to get started with paper trading</p>
    </div>
  <% } else { %>
    <div class="overflow-x-auto">
      <table class="bloomberg-table">
        <thead>
          <tr>
            <th>SYMBOL</th>
            <th>SIDE</th>
            <th class="text-right">QUANTITY</th>
            <th class="text-right">ENTRY PRICE</th>
            <th class="text-right">ENTRY DATE</th>
            <th class="text-center">ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          <% safeOpenTrades.forEach(trade => { %>
            <tr>
              <td>
                <span class="font-mono font-bold text-amber-400"><%= trade.symbol %></span>
              </td>
              <td>
                <span class="px-2.5 py-1 rounded font-mono text-xs font-bold <%= trade.trade_type === 'buy' ? 'bg-emerald-400/20 text-emerald-400 border border-emerald-400/30' : 'bg-red-400/20 text-red-400 border border-red-400/30' %>">
                  <%= trade.trade_type.toUpperCase() %>
                </span>
              </td>
              <td class="text-right font-mono text-white"><%= trade.quantity %></td>
              <td class="text-right font-mono text-white">$<%= safeFmt.number(trade.entry_price) %></td>
              <td class="text-right font-mono text-slate-400 text-sm"><%= new Date(trade.entry_date).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) %></td>
              <td class="text-center">
                <button onclick="closeTrade('<%= trade.id %>')" class="bloomberg-btn bloomberg-btn-secondary text-xs">
                  CLOSE
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<!-- Close Trade Modal -->
<div id="closeModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm">
  <div class="bloomberg-card w-full max-w-md mx-4">
    <div class="p-5 border-b border-amber-400/20">
      <h3 class="text-lg font-bold text-amber-400 uppercase tracking-wider">Close Trade</h3>
    </div>
    <div class="p-6">
      <form id="closeForm">
        <input type="hidden" name="tradeId" id="closeTradeId">
        <div class="mb-6">
          <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">Exit Price</label>
          <input type="number" step="0.01" name="exitPrice" class="form-input w-full font-mono bg-slate-900/50 border-slate-700 focus:border-amber-400 text-white" placeholder="Current market price" required>
        </div>
      </form>
      <div class="flex gap-3">
        <button onclick="closeCloseModal()" class="bloomberg-btn bloomberg-btn-secondary flex-1">
          CANCEL
        </button>
        <button onclick="submitCloseTrade()" class="bloomberg-btn bloomberg-btn-primary flex-1">
          CLOSE TRADE
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('tradeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);

  try {
    const res = await fetch('/api/paper-trading/trade', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (res.ok) {
      showToast('Trade placed!', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      const err = await res.json();
      showToast(err.error || 'Failed to place trade', 'error');
    }
  } catch (e) {
    showToast('Error placing trade', 'error');
  }
});

function closeTrade(id) {
  document.getElementById('closeTradeId').value = id;
  document.getElementById('closeModal').classList.remove('hidden');
  document.getElementById('closeModal').classList.add('flex');
}

function closeCloseModal() {
  document.getElementById('closeModal').classList.add('hidden');
  document.getElementById('closeModal').classList.remove('flex');
}

async function submitCloseTrade() {
  const id = document.getElementById('closeTradeId').value;
  const exitPrice = document.querySelector('#closeForm input[name="exitPrice"]').value;

  try {
    const res = await fetch(`/api/paper-trading/close/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ exitPrice: parseFloat(exitPrice) })
    });
    if (res.ok) {
      showToast('Trade closed!', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      const err = await res.json();
      showToast(err.error || 'Failed to close trade', 'error');
    }
  } catch (e) {
    showToast('Error closing trade', 'error');
  }
  closeCloseModal();
}

async function resetAccount() {
  if (!confirm('Reset your paper trading account to $100,000? All trades will be deleted.')) return;

  try {
    const res = await fetch('/api/paper-trading/reset', { method: 'POST' });
    if (res.ok) {
      showToast('Account reset!', 'success');
      setTimeout(() => location.reload(), 500);
    }
  } catch (e) {
    showToast('Error resetting account', 'error');
  }
}
</script>
<%- include('../partials/footer') %>
