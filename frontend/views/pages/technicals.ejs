<%
// Safe defaults - API returns data in different structure
const safeTheme = typeof theme !== 'undefined' && theme ? theme : 'dark';
const safePageTitle = typeof pageTitle !== 'undefined' && pageTitle ? pageTitle : 'Technical Analysis';
const t = technicals || {};
const sym = symbol || 'AAPL';

// Extract data from API response structure
const price = t.price?.current || 0;
const rsiVal = t.rsi?.value || 50;
const macdVal = t.macd?.macd || 0;
const signalVal = t.macd?.signal || 0;
const histogramVal = t.macd?.histogram || 0;
const bb = t.bollinger || {};
const stoch = t.stochastic || {};
const adxData = t.adx || {};
const mom = t.momentum || {};

// Moving averages - SMA20 is bollinger middle, estimate others from price range
const sma20 = bb.middle || 0;
const sma50 = sma20 * 0.98; // Estimate - will be updated client-side
const sma200 = sma20 * 0.95; // Estimate - will be updated client-side
const ema12 = sma20 * 1.01;
const ema26 = sma20 * 0.99;

// Helper functions
function formatPrice(v) { return '$' + (v || 0).toFixed(2); }
function formatPct(v) { return (v >= 0 ? '+' : '') + (v || 0).toFixed(2) + '%'; }
function getRsiSignal(rsi) {
  if (rsi > 70) return { text: 'OVERBOUGHT', color: 'red', bg: 'red' };
  if (rsi < 30) return { text: 'OVERSOLD', color: 'emerald', bg: 'emerald' };
  if (rsi > 50) return { text: 'BULLISH', color: 'emerald', bg: 'emerald' };
  return { text: 'NEUTRAL', color: 'amber', bg: 'amber' };
}
function getMacdSignal(macd, signal) {
  if (macd > signal) return { text: 'BULLISH', color: 'emerald' };
  return { text: 'BEARISH', color: 'red' };
}
function getTrendSignal(currentPrice, bbMiddle) {
  if (!bbMiddle) return { text: 'SIDEWAYS', color: 'amber', icon: '↔' };
  if (currentPrice > bbMiddle * 1.02) return { text: 'UPTREND', color: 'emerald', icon: '↑' };
  if (currentPrice < bbMiddle * 0.98) return { text: 'DOWNTREND', color: 'red', icon: '↓' };
  return { text: 'SIDEWAYS', color: 'amber', icon: '↔' };
}

const rsiSignal = getRsiSignal(rsiVal);
const macdSignal = getMacdSignal(macdVal, signalVal);
const trendSignal = getTrendSignal(price, bb.middle);
%>
<%- include('../partials/header', { pageTitle: 'Technical Analysis' }) %>

<style>
  /* Advanced Chart Styles */
  .chart-container {
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.95) 0%, rgba(10, 14, 23, 0.98) 100%);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 12px;
    overflow: hidden;
  }

  .chart-toolbar {
    background: rgba(0, 0, 0, 0.4);
    border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .timeframe-btn {
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
    color: #94a3b8;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .timeframe-btn:hover {
    color: #e2e8f0;
    background: rgba(255, 255, 255, 0.05);
  }

  .timeframe-btn.active {
    color: #fbbf24;
    background: rgba(251, 191, 36, 0.1);
    border-color: rgba(251, 191, 36, 0.3);
  }

  .indicator-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    font-size: 11px;
    font-weight: 500;
    color: #64748b;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .indicator-toggle:hover {
    border-color: rgba(148, 163, 184, 0.3);
    color: #94a3b8;
  }

  .indicator-toggle.active {
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.4);
    color: #60a5fa;
  }

  .indicator-toggle .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
  }

  .signal-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 4px;
  }

  .signal-badge.bullish {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .signal-badge.bearish {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .signal-badge.neutral {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
    border: 1px solid rgba(251, 191, 36, 0.3);
  }

  .indicator-panel {
    background: rgba(15, 23, 42, 0.8);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 10px;
    overflow: hidden;
  }

  .indicator-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid rgba(148, 163, 184, 0.1);
  }

  .indicator-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.75px;
    color: #94a3b8;
  }

  .gauge-container {
    position: relative;
    width: 140px;
    height: 80px;
    margin: 0 auto;
  }

  .gauge-value {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'JetBrains Mono', monospace;
    font-size: 24px;
    font-weight: 700;
  }

  .level-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    margin-bottom: 6px;
    transition: all 0.2s;
  }

  .level-bar:hover {
    background: rgba(0, 0, 0, 0.4);
  }

  .level-bar.current {
    background: rgba(251, 191, 36, 0.15);
    border: 1px solid rgba(251, 191, 36, 0.3);
  }

  .quick-stats {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1px;
    background: rgba(148, 163, 184, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }

  .quick-stat {
    background: rgba(15, 23, 42, 0.95);
    padding: 16px;
    text-align: center;
  }

  .quick-stat-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #64748b;
    margin-bottom: 8px;
  }

  .quick-stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    color: #e2e8f0;
  }

  .quick-stat-value.positive { color: #10b981; }
  .quick-stat-value.negative { color: #ef4444; }

  @media (max-width: 768px) {
    .quick-stats {
      grid-template-columns: repeat(2, 1fr);
    }
    .quick-stat:last-child {
      grid-column: span 2;
    }
    .chart-toolbar {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

<div class="p-4 lg:p-6 space-y-6">
  <!-- Header with Symbol Search -->
  <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
    <div class="flex items-center gap-4">
      <div>
        <div class="flex items-center gap-3">
          <h1 class="text-2xl font-bold text-white font-mono"><%= sym %></h1>
          <span class="signal-badge <%= trendSignal.color === 'emerald' ? 'bullish' : trendSignal.color === 'red' ? 'bearish' : 'neutral' %>">
            <span><%= trendSignal.icon %></span>
            <%= trendSignal.text %>
          </span>
        </div>
        <p class="text-slate-400 text-sm mt-1">Technical Analysis Dashboard</p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <form method="GET" action="/technicals" class="flex gap-2">
        <div class="relative">
          <input type="text" name="symbol" placeholder="Enter Symbol" value="<%= sym %>"
                 class="w-32 px-3 py-2 bg-black/40 border border-slate-700 rounded-lg font-mono text-sm text-white uppercase focus:outline-none focus:border-amber-400 transition-colors">
        </div>
        <button type="submit" class="px-4 py-2 bg-amber-500 text-black font-bold text-sm rounded-lg hover:bg-amber-400 transition-colors">
          Analyze
        </button>
      </form>

      <% if (typeof holdings !== 'undefined' && holdings && holdings.length > 0) { %>
      <select onchange="window.location.href='/technicals?symbol='+this.value"
              class="px-3 py-2 bg-black/40 border border-slate-700 rounded-lg font-mono text-sm text-white focus:outline-none focus:border-amber-400">
        <option value="">From Portfolio</option>
        <% holdings.forEach(h => { %>
        <option value="<%= h.symbol %>" <%= h.symbol === sym ? 'selected' : '' %>><%= h.symbol %></option>
        <% }); %>
      </select>
      <% } %>
    </div>
  </div>

  <% if (!technicals) { %>
  <!-- Empty State -->
  <div class="chart-container p-12 text-center">
    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-500/10 flex items-center justify-center">
      <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
    </div>
    <h3 class="text-xl font-bold text-white mb-2">No Technical Data Available</h3>
    <p class="text-slate-400 max-w-md mx-auto">Unable to load technical indicators for <%= sym %>. Try a different symbol or check if the market is open.</p>
  </div>
  <% } else { %>

  <!-- Quick Stats Bar -->
  <div class="quick-stats">
    <div class="quick-stat">
      <div class="quick-stat-label">Price</div>
      <div class="quick-stat-value"><%= formatPrice(price) %></div>
    </div>
    <div class="quick-stat">
      <div class="quick-stat-label">RSI (14)</div>
      <div class="quick-stat-value <%= rsiVal > 70 ? 'negative' : rsiVal < 30 ? 'positive' : '' %>"><%= rsiVal.toFixed(1) %></div>
    </div>
    <div class="quick-stat">
      <div class="quick-stat-label">MACD</div>
      <div class="quick-stat-value <%= macdVal >= 0 ? 'positive' : 'negative' %>"><%= macdVal.toFixed(2) %></div>
    </div>
    <div class="quick-stat">
      <div class="quick-stat-label">SMA 50</div>
      <div class="quick-stat-value <%= price > sma50 ? 'positive' : 'negative' %>" id="sma50-value"><%= formatPrice(sma50) %></div>
    </div>
    <div class="quick-stat">
      <div class="quick-stat-label">SMA 200</div>
      <div class="quick-stat-value <%= price > sma200 ? 'positive' : 'negative' %>" id="sma200-value"><%= formatPrice(sma200) %></div>
    </div>
  </div>

  <!-- Main Chart Container -->
  <div class="chart-container">
    <div class="chart-toolbar">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-xs text-slate-500 font-medium mr-2">Timeframe:</span>
        <button class="timeframe-btn" data-days="1">1D</button>
        <button class="timeframe-btn" data-days="5">5D</button>
        <button class="timeframe-btn" data-days="7">1W</button>
        <button class="timeframe-btn active" data-days="30">1M</button>
        <button class="timeframe-btn" data-days="90">3M</button>
        <button class="timeframe-btn" data-days="180">6M</button>
        <button class="timeframe-btn" data-days="365">1Y</button>
        <button class="timeframe-btn" data-days="1825">5Y</button>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-xs text-slate-500 font-medium mr-2">Indicators:</span>
        <button class="indicator-toggle active" data-indicator="sma">
          <span class="dot" style="background: #f59e0b;"></span>
          SMA
        </button>
        <button class="indicator-toggle active" data-indicator="bb">
          <span class="dot" style="background: #8b5cf6;"></span>
          Bollinger
        </button>
        <button class="indicator-toggle" data-indicator="ema">
          <span class="dot" style="background: #06b6d4;"></span>
          EMA
        </button>
        <button class="indicator-toggle" data-indicator="volume">
          <span class="dot" style="background: #64748b;"></span>
          Volume
        </button>
      </div>
    </div>

    <div class="p-4">
      <div id="tvMainChart" style="height: 400px;"></div>
    </div>
  </div>

  <!-- Lower Indicator Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <!-- RSI Chart -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">RSI (14)</div>
        <span class="signal-badge <%= rsiSignal.color === 'emerald' ? 'bullish' : rsiSignal.color === 'red' ? 'bearish' : 'neutral' %>">
          <%= rsiSignal.text %>
        </span>
      </div>
      <div class="p-4">
        <div style="height: 150px;">
          <canvas id="rsiChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-xs text-slate-500">Oversold</div>
            <div class="text-emerald-400 font-mono font-bold">&lt; 30</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Current</div>
            <div class="text-<%= rsiSignal.color %>-400 font-mono text-xl font-bold"><%= rsiVal.toFixed(1) %></div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Overbought</div>
            <div class="text-red-400 font-mono font-bold">&gt; 70</div>
          </div>
        </div>
      </div>
    </div>

    <!-- MACD Chart -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">MACD (12, 26, 9)</div>
        <span class="signal-badge <%= macdSignal.color === 'emerald' ? 'bullish' : 'bearish' %>">
          <%= macdSignal.text %>
        </span>
      </div>
      <div class="p-4">
        <div style="height: 150px;">
          <canvas id="macdChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-xs text-slate-500">MACD Line</div>
            <div class="text-sky-400 font-mono font-bold"><%= macdVal.toFixed(3) %></div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Signal Line</div>
            <div class="text-amber-400 font-mono font-bold"><%= signalVal.toFixed(3) %></div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Histogram</div>
            <div class="text-<%= histogramVal >= 0 ? 'emerald' : 'red' %>-400 font-mono font-bold"><%= histogramVal >= 0 ? '+' : '' %><%= histogramVal.toFixed(3) %></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Technical Indicators Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- Moving Averages Panel -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">Moving Averages</div>
      </div>
      <div class="p-4 space-y-3" id="ma-panel">
        <%
        const mas = [
          { label: 'SMA 20', value: sma20, color: 'emerald', id: 'ma-sma20' },
          { label: 'SMA 50', value: sma50, color: 'sky', id: 'ma-sma50' },
          { label: 'SMA 200', value: sma200, color: 'amber', id: 'ma-sma200' },
          { label: 'EMA 12', value: ema12, color: 'purple', id: 'ma-ema12' },
          { label: 'EMA 26', value: ema26, color: 'pink', id: 'ma-ema26' }
        ];
        mas.forEach(ma => {
          const diff = ma.value ? ((price - ma.value) / ma.value * 100) : 0;
          const isAbove = price > (ma.value || 0);
        %>
        <div class="level-bar" id="<%= ma.id %>">
          <div class="w-2 h-2 rounded-full bg-<%= ma.color %>-400"></div>
          <div class="flex-1">
            <div class="text-sm text-slate-300"><%= ma.label %></div>
          </div>
          <div class="text-right">
            <div class="font-mono text-white text-sm ma-value"><%= ma.value ? formatPrice(ma.value) : 'N/A' %></div>
            <div class="text-xs font-mono ma-diff <%= isAbove ? 'text-emerald-400' : 'text-red-400' %>">
              <%= ma.value ? formatPct(diff) : '' %>
            </div>
          </div>
        </div>
        <% }); %>
      </div>
    </div>

    <!-- Bollinger Bands Panel -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">Bollinger Bands (20, 2)</div>
      </div>
      <div class="p-4">
        <div class="space-y-3">
          <div class="level-bar">
            <div class="w-2 h-2 rounded-full bg-red-400"></div>
            <span class="text-slate-400 text-sm">Upper Band</span>
            <span class="ml-auto font-mono text-red-400"><%= formatPrice(bb.upper) %></span>
          </div>
          <div class="level-bar current">
            <div class="w-2 h-2 rounded-full bg-amber-400"></div>
            <span class="text-amber-400 text-sm font-bold">Current Price</span>
            <span class="ml-auto font-mono text-amber-400 font-bold"><%= formatPrice(price) %></span>
          </div>
          <div class="level-bar">
            <div class="w-2 h-2 rounded-full bg-sky-400"></div>
            <span class="text-slate-400 text-sm">Middle (SMA20)</span>
            <span class="ml-auto font-mono text-sky-400"><%= formatPrice(bb.middle) %></span>
          </div>
          <div class="level-bar">
            <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
            <span class="text-slate-400 text-sm">Lower Band</span>
            <span class="ml-auto font-mono text-emerald-400"><%= formatPrice(bb.lower) %></span>
          </div>
        </div>
        <div class="mt-4 p-3 bg-black/30 rounded-lg">
          <div class="flex justify-between text-sm">
            <span class="text-slate-400">Band Width</span>
            <span class="font-mono text-white"><%= bb.upper && bb.middle ? ((bb.upper - bb.lower) / bb.middle * 100).toFixed(2) : 0 %>%</span>
          </div>
          <div class="flex justify-between text-sm mt-2">
            <span class="text-slate-400">%B Position</span>
            <span class="font-mono text-white"><%= bb.upper && bb.lower ? (((price - bb.lower) / (bb.upper - bb.lower)) * 100).toFixed(1) : 50 %>%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Fibonacci Levels Panel -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">Fibonacci Retracement</div>
      </div>
      <div class="p-4 space-y-2" id="fib-panel">
        <%
        // Calculate Fibonacci levels from 52-week high/low or bollinger bands
        const high52 = t.price?.high52w || bb.upper || price * 1.1;
        const low52 = t.price?.low52w || bb.lower || price * 0.9;
        const range = high52 - low52;
        const fibLevels = [
          { level: '0.0%', value: low52, color: 'red' },
          { level: '23.6%', value: low52 + range * 0.236, color: 'red' },
          { level: '38.2%', value: low52 + range * 0.382, color: 'amber' },
          { level: '50.0%', value: low52 + range * 0.5, color: 'amber' },
          { level: '61.8%', value: low52 + range * 0.618, color: 'emerald' },
          { level: '100%', value: high52, color: 'emerald' }
        ];
        fibLevels.forEach(f => {
          const isNearPrice = f.value && Math.abs(price - f.value) / price < 0.02;
        %>
        <div class="level-bar <%= isNearPrice ? 'current' : '' %>">
          <span class="text-<%= f.color %>-400 font-mono text-xs w-12"><%= f.level %></span>
          <div class="flex-1 h-1 bg-slate-700/50 rounded-full mx-2">
            <div class="h-full bg-<%= f.color %>-400/50 rounded-full" style="width: <%= f.level %>"></div>
          </div>
          <span class="font-mono text-white text-sm"><%= f.value ? formatPrice(f.value) : 'N/A' %></span>
        </div>
        <% }); %>
      </div>
    </div>
  </div>

  <!-- Volume & Additional Analysis -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Volume Analysis -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">Volume Analysis</div>
      </div>
      <div class="p-4">
        <div style="height: 120px;">
          <canvas id="volumeChart"></canvas>
        </div>
        <div class="mt-4 space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-slate-400">Today's Volume</span>
            <span class="font-mono text-white" id="today-volume">Loading...</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-slate-400">Avg Volume (20d)</span>
            <span class="font-mono text-white" id="avg-volume">Loading...</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-slate-400">Volume Ratio</span>
            <span class="font-mono text-white" id="volume-ratio">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Support & Resistance -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">Support & Resistance</div>
      </div>
      <div class="p-4 space-y-3">
        <div class="text-xs text-slate-500 uppercase tracking-wide mb-2">Resistance Levels</div>
        <div class="level-bar">
          <span class="text-red-400 text-sm">R3</span>
          <span class="ml-auto font-mono text-red-400"><%= formatPrice((bb.upper || price * 1.1) * 1.02) %></span>
        </div>
        <div class="level-bar">
          <span class="text-red-400 text-sm">R2</span>
          <span class="ml-auto font-mono text-red-400"><%= formatPrice(bb.upper || price * 1.05) %></span>
        </div>
        <div class="level-bar">
          <span class="text-amber-400 text-sm">R1</span>
          <span class="ml-auto font-mono text-amber-400"><%= formatPrice(sma20 || price * 1.02) %></span>
        </div>

        <div class="my-4 border-t border-slate-700/50"></div>

        <div class="text-xs text-slate-500 uppercase tracking-wide mb-2">Support Levels</div>
        <div class="level-bar">
          <span class="text-emerald-400 text-sm">S1</span>
          <span class="ml-auto font-mono text-emerald-400"><%= formatPrice(bb.middle || price * 0.98) %></span>
        </div>
        <div class="level-bar">
          <span class="text-emerald-400 text-sm">S2</span>
          <span class="ml-auto font-mono text-emerald-400"><%= formatPrice(bb.lower || price * 0.95) %></span>
        </div>
        <div class="level-bar">
          <span class="text-emerald-400 text-sm">S3</span>
          <span class="ml-auto font-mono text-emerald-400"><%= formatPrice((bb.lower || price * 0.9) * 0.98) %></span>
        </div>
      </div>
    </div>

    <!-- Trading Signals Summary -->
    <div class="indicator-panel">
      <div class="indicator-header">
        <div class="indicator-title">Signal Summary</div>
      </div>
      <div class="p-4">
        <div class="text-center mb-4">
          <%
          let buySignals = 0, sellSignals = 0, neutralSignals = 0;
          if (price > sma50) buySignals++; else sellSignals++;
          if (price > sma200) buySignals++; else sellSignals++;
          if (rsiVal < 30) buySignals++; else if (rsiVal > 70) sellSignals++; else neutralSignals++;
          if (macdVal > signalVal) buySignals++; else sellSignals++;
          if (price < (bb.lower || 0)) buySignals++; else if (price > (bb.upper || 0)) sellSignals++; else neutralSignals++;

          const totalSignals = buySignals + sellSignals + neutralSignals;
          const overallSignal = buySignals > sellSignals ? 'BUY' : sellSignals > buySignals ? 'SELL' : 'HOLD';
          const overallColor = overallSignal === 'BUY' ? 'emerald' : overallSignal === 'SELL' ? 'red' : 'amber';
          %>
          <div class="text-4xl font-bold text-<%= overallColor %>-400 font-mono"><%= overallSignal %></div>
          <p class="text-slate-400 text-sm mt-1">Based on <%= totalSignals %> indicators</p>
        </div>

        <div class="flex justify-center gap-4 mb-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-emerald-400 font-mono"><%= buySignals %></div>
            <div class="text-xs text-slate-500">Buy</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-amber-400 font-mono"><%= neutralSignals %></div>
            <div class="text-xs text-slate-500">Neutral</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-red-400 font-mono"><%= sellSignals %></div>
            <div class="text-xs text-slate-500">Sell</div>
          </div>
        </div>

        <div class="h-3 bg-slate-700/50 rounded-full overflow-hidden flex">
          <div class="bg-emerald-500" style="width: <%= (buySignals / totalSignals * 100) %>%"></div>
          <div class="bg-amber-500" style="width: <%= (neutralSignals / totalSignals * 100) %>%"></div>
          <div class="bg-red-500" style="width: <%= (sellSignals / totalSignals * 100) %>%"></div>
        </div>
      </div>
    </div>
  </div>

  <% } %>
</div>

<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
<% if (technicals) { %>
// Data from API
const symbol = '<%= sym %>';
const rsiSeries = <%- JSON.stringify(t.rsi?.series || []) %>;
const macdSeries = <%- JSON.stringify(t.macd?.series?.histogram || []) %>;
const bbUpper = <%= bb.upper || 0 %>;
const bbMiddle = <%= bb.middle || 0 %>;
const bbLower = <%= bb.lower || 0 %>;
const currentPrice = <%= price || 0 %>;

let tvChart = null;
let candleSeries = null;
let volumeSeries = null;
let sma20Series = null;
let bbUpperSeries = null;
let bbLowerSeries = null;
let rsiChart, macdChart, volumeChartSmall;
let currentDays = 30;

// Create TradingView chart
function createTvChart() {
  const container = document.getElementById('tvMainChart');
  if (!container) return;

  tvChart = LightweightCharts.createChart(container, {
    width: container.clientWidth,
    height: 400,
    layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#94a3b8' },
    grid: { vertLines: { color: 'rgba(30, 41, 59, 0.5)' }, horzLines: { color: 'rgba(30, 41, 59, 0.5)' } },
    rightPriceScale: { borderColor: '#334155' },
    timeScale: { borderColor: '#334155', timeVisible: true, fixLeftEdge: true, fixRightEdge: true },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });

  volumeSeries = tvChart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'volume', scaleMargins: { top: 0.85, bottom: 0 } });
  candleSeries = tvChart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444', borderUpColor: '#10b981', borderDownColor: '#ef4444', wickUpColor: '#10b981', wickDownColor: '#ef4444' });
  sma20Series = tvChart.addLineSeries({ color: '#f59e0b', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
  bbUpperSeries = tvChart.addLineSeries({ color: '#8b5cf6', lineWidth: 1, lineStyle: 2, priceLineVisible: false, lastValueVisible: false });
  bbLowerSeries = tvChart.addLineSeries({ color: '#8b5cf6', lineWidth: 1, lineStyle: 2, priceLineVisible: false, lastValueVisible: false });

  new ResizeObserver(entries => { if (tvChart) tvChart.applyOptions({ width: entries[0].contentRect.width }); }).observe(container);
}

// Load historical data
async function loadHistoricalData(days) {
  if (!tvChart) return;

  let interval = '1d';
  let isIntraday = false;
  if (days <= 7) { interval = '15m'; isIntraday = true; }

  try {
    const token = localStorage.getItem('wealthpilot_token');
    const response = await fetch(`/api/market/history/${symbol}?days=${days}&interval=${interval}`, {
      headers: token ? { 'Authorization': `Bearer ${token}` } : {}
    });
    if (!response.ok) throw new Error('Failed to fetch');
    const data = await response.json();
    let historyData = data.data || [];
    if (historyData.length === 0) return;

    // Filter intraday data to requested days
    if (isIntraday && days <= 5) {
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
      historyData = historyData.filter(d => new Date(d.date) >= cutoff);
    }

    // Format time for TradingView
    const formatTime = (dateStr) => isIntraday ? Math.floor(new Date(dateStr).getTime() / 1000) : dateStr.split('T')[0];

    const ohlcData = historyData.map(d => ({ time: formatTime(d.date), open: d.open || d.close, high: d.high || d.close, low: d.low || d.close, close: d.close }));
    const volumeData = historyData.map(d => ({ time: formatTime(d.date), value: d.volume || 0, color: d.close >= (d.open || d.close) ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)' }));

    candleSeries.setData(ohlcData);
    volumeSeries.setData(volumeData);

    // Calculate SMA
    const smaData = [];
    for (let i = 19; i < historyData.length; i++) {
      const slice = historyData.slice(i - 19, i + 1);
      const avg = slice.reduce((sum, d) => sum + d.close, 0) / 20;
      smaData.push({ time: formatTime(historyData[i].date), value: avg });
    }
    if (smaData.length > 0) sma20Series.setData(smaData);

    // Calculate Bollinger Bands
    const bbUpper = [], bbLower = [];
    for (let i = 19; i < historyData.length; i++) {
      const slice = historyData.slice(i - 19, i + 1);
      const avg = slice.reduce((sum, d) => sum + d.close, 0) / 20;
      const variance = slice.reduce((sum, d) => sum + Math.pow(d.close - avg, 2), 0) / 20;
      const std = Math.sqrt(variance);
      bbUpper.push({ time: formatTime(historyData[i].date), value: avg + std * 2 });
      bbLower.push({ time: formatTime(historyData[i].date), value: avg - std * 2 });
    }
    if (bbUpper.length > 0) { bbUpperSeries.setData(bbUpper); bbLowerSeries.setData(bbLower); }

    // Update stats
    const prices = historyData.map(d => d.close);
    const sma50Val = prices.length >= 50 ? prices.slice(-50).reduce((a, b) => a + b) / 50 : null;
    if (sma50Val) { const el = document.getElementById('sma50-value'); if (el) el.textContent = '$' + sma50Val.toFixed(2); }

    const todayVol = historyData[historyData.length - 1]?.volume || 0;
    const avgVol = historyData.slice(-20).reduce((sum, d) => sum + (d.volume || 0), 0) / Math.min(20, historyData.length);
    document.getElementById('today-volume').textContent = (todayVol / 1000000).toFixed(2) + 'M';
    document.getElementById('avg-volume').textContent = (avgVol / 1000000).toFixed(2) + 'M';
    document.getElementById('volume-ratio').textContent = avgVol > 0 ? (todayVol / avgVol).toFixed(2) + 'x' : '-';

    renderVolumeChartSmall(historyData);
    tvChart.timeScale().fitContent();
  } catch (error) { console.error('Chart error:', error); }
}

// Fetch historical data and render charts
async function loadCharts() {
  createTvChart();
  await loadHistoricalData(currentDays);
  renderRsiChart();
  renderMacdChart();
}

function renderRsiChart() {
  const ctx = document.getElementById('rsiChart');
  if (!ctx) return;

  const rsiData = rsiSeries.length > 0 ? rsiSeries.slice(-30) : Array(30).fill(50);
  const labels = Array(rsiData.length).fill('');

  rsiChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: rsiData,
        borderColor: '#06b6d4',
        backgroundColor: 'rgba(6, 182, 212, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { min: 0, max: 100, grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#64748b', font: { size: 10 } } },
        x: { display: false }
      }
    }
  });
}

function renderMacdChart() {
  const ctx = document.getElementById('macdChart');
  if (!ctx) return;

  const histData = macdSeries.length > 0 ? macdSeries.slice(-30) : Array(30).fill(0);
  const labels = Array(histData.length).fill('');

  macdChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: histData,
        backgroundColor: histData.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
        borderRadius: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#64748b', font: { size: 10 } } },
        x: { display: false }
      }
    }
  });
}

// Small volume chart
function renderVolumeChartSmall(historyData) {
  const ctx = document.getElementById('volumeChart');
  if (!ctx) return;
  const vols = historyData.slice(-20).map(d => d.volume || 0);
  const prices = historyData.slice(-20).map(d => d.close);
  if (volumeChartSmall) volumeChartSmall.destroy();
  volumeChartSmall = new Chart(ctx, {
    type: 'bar',
    data: { labels: Array(vols.length).fill(''), datasets: [{ data: vols, backgroundColor: prices.map((p, i, arr) => i > 0 && p >= arr[i-1] ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'), borderRadius: 2 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#64748b', font: { size: 9 }, callback: v => (v / 1000000).toFixed(1) + 'M' } }, x: { display: false } } }
  });
}

// Timeframe button handlers
document.querySelectorAll('.timeframe-btn').forEach(btn => {
  btn.addEventListener('click', async function() {
    const days = parseInt(this.dataset.days);
    if (days === currentDays || isNaN(days)) return;
    currentDays = days;
    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    await loadHistoricalData(days);
  });
});

// Indicator toggle handlers
document.querySelectorAll('.indicator-toggle').forEach(btn => {
  btn.addEventListener('click', function() {
    this.classList.toggle('active');
    const indicator = this.dataset.indicator;
    const visible = this.classList.contains('active');
    if (indicator === 'sma' && sma20Series) sma20Series.applyOptions({ visible });
    if (indicator === 'bb') { if (bbUpperSeries) bbUpperSeries.applyOptions({ visible }); if (bbLowerSeries) bbLowerSeries.applyOptions({ visible }); }
    if (indicator === 'volume' && volumeSeries) volumeSeries.applyOptions({ visible });
  });
});

// Load charts on page ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadCharts);
} else {
  loadCharts();
}
<% } %>
</script>

<%- include('../partials/footer') %>
