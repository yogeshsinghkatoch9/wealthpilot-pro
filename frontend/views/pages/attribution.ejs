<%
// Safe defaults for all potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safeFmt = typeof fmt !== 'undefined' ? fmt : {
  pct: (val) => (val >= 0 ? '+' : '') + (val || 0).toFixed(2) + '%',
  money: (val) => '$' + (val || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
};
const safeAttribution = typeof attribution !== 'undefined' ? attribution : null;
%>

<%- include('../partials/header', { pageTitle: 'Portfolio Attribution' }) %>

<!-- Bloomberg Header Bar -->
<div class="bg-black border-b border-amber-400/30 -mx-6 -mt-6 px-6 py-4 mb-6">
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
<div>
<h1 class="text-2xl font-bold text-amber-400 tracking-tight">PORTFOLIO ATTRIBUTION</h1>
<p class="text-slate-400 text-sm mt-1">Understand what's driving your returns</p>
</div>
<select class="bloomberg-btn w-40" onchange="changePeriod(this.value)">
<option value="1M">Last Month</option>
<option value="3M" selected>Last Quarter</option>
<option value="YTD">YTD</option>
<option value="1Y">1 Year</option>
</select>
</div>
</div>

<!-- Summary Cards -->
<% const summary = attribution?.summary || { totalReturn: 0, totalGain: 0, benchmarkReturn: 0, alpha: 0, informationRatio: 0 }; %>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-xs uppercase tracking-wider">Total Return</p>
<p class="text-2xl font-bold font-mono <%= summary.totalReturn >= 0 ? 'text-emerald-400' : 'text-red-400' %>"><%= fmt.pct(summary.totalReturn) %></p>
<p class="text-sm text-slate-400 font-mono"><%= fmt.money(summary.totalGain) %></p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-xs uppercase tracking-wider">Benchmark (S&P 500)</p>
<p class="text-2xl font-bold font-mono text-white"><%= fmt.pct(summary.benchmarkReturn) %></p>
<p class="text-sm text-slate-400">SPY</p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-xs uppercase tracking-wider">Alpha Generated</p>
<p class="text-2xl font-bold font-mono <%= summary.alpha >= 0 ? 'text-emerald-400' : 'text-red-400' %>"><%= fmt.pct(summary.alpha) %></p>
<p class="text-sm <%= summary.alpha >= 0 ? 'text-emerald-400' : 'text-red-400' %>"><%= summary.alpha >= 0 ? 'Outperforming' : 'Underperforming' %></p>
</div>
<div class="bloomberg-card p-4">
<p class="text-slate-400 text-xs uppercase tracking-wider">Information Ratio</p>
<p class="text-2xl font-bold font-mono text-white"><%= (summary.informationRatio || 0).toFixed(2) %></p>
<p class="text-sm <%= summary.informationRatio > 0.5 ? 'text-emerald-400' : 'text-amber-400' %>"><%= summary.informationRatio > 0.5 ? 'Strong' : 'Moderate' %></p>
</div>
</div>

<!-- Attribution Breakdown -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide text-sm">Return Attribution by Factor</h3>
<div class="h-64"><canvas id="factorChart"></canvas></div>
</div>
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide text-sm">Sector Attribution</h3>
<div class="h-64"><canvas id="sectorAttrChart"></canvas></div>
</div>
</div>

<!-- Detailed Factor Analysis -->
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide text-sm">Factor Exposure & Contribution</h3>
<table class="bloomberg-table w-full text-sm">
<thead>
<tr class="bg-slate-800/50 text-slate-400 text-left border-b border-slate-700">
<th class="px-4 py-3 uppercase text-xs tracking-wider">Factor</th>
<th class="px-4 py-3 text-center uppercase text-xs tracking-wider">Exposure</th>
<th class="px-4 py-3 text-center uppercase text-xs tracking-wider">Factor Return</th>
<th class="px-4 py-3 text-center uppercase text-xs tracking-wider">Contribution</th>
<th class="px-4 py-3 uppercase text-xs tracking-wider">Impact</th>
</tr>
</thead>
<tbody class="text-white">
<% if (attribution && attribution.factors) { %>
<% attribution.factors.forEach(factor => { %>
<tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
<td class="px-4 py-3 font-medium"><%= factor.icon %> <%= factor.name %></td>
<td class="px-4 py-3 text-center font-mono"><%= factor.exposure.toFixed(2) %></td>
<td class="px-4 py-3 text-center font-mono"><%= fmt.pct(factor.factorReturn) %></td>
<td class="px-4 py-3 text-center font-bold font-mono <%= factor.contribution >= 0 ? 'text-emerald-400' : 'text-red-400' %>"><%= fmt.pct(factor.contribution) %></td>
<td class="px-4 py-3"><div class="w-32 h-3 rounded-full bg-slate-700"><div class="h-3 rounded-full <%= factor.contribution >= 0 ? 'bg-emerald-500' : 'bg-red-500' %>" style="width:<%= Math.abs(factor.contribution * 8) %>%"></div></div></td>
</tr>
<% }); %>
<% } else { %>
<tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
<td class="px-4 py-3 font-medium">ğŸ“ˆ Market (Beta)</td>
<td class="px-4 py-3 text-center font-mono">1.12</td>
<td class="px-4 py-3 text-center font-mono">+9.8%</td>
<td class="px-4 py-3 text-center font-bold font-mono text-emerald-400">+10.98%</td>
<td class="px-4 py-3"><div class="w-32 h-3 rounded-full bg-slate-700"><div class="h-3 rounded-full bg-emerald-500" style="width:88%"></div></div></td>
</tr>
<tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
<td class="px-4 py-3 font-medium">ğŸ’ Quality</td>
<td class="px-4 py-3 text-center font-mono">0.85</td>
<td class="px-4 py-3 text-center font-mono">+2.4%</td>
<td class="px-4 py-3 text-center font-bold font-mono text-emerald-400">+2.04%</td>
<td class="px-4 py-3"><div class="w-32 h-3 rounded-full bg-slate-700"><div class="h-3 rounded-full bg-emerald-500" style="width:16%"></div></div></td>
</tr>
<tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
<td class="px-4 py-3 font-medium">ğŸš€ Momentum</td>
<td class="px-4 py-3 text-center font-mono">0.62</td>
<td class="px-4 py-3 text-center font-mono">+1.8%</td>
<td class="px-4 py-3 text-center font-bold font-mono text-emerald-400">+1.12%</td>
<td class="px-4 py-3"><div class="w-32 h-3 rounded-full bg-slate-700"><div class="h-3 rounded-full bg-emerald-500" style="width:9%"></div></div></td>
</tr>
<% } %>
</tbody>
<tfoot>
<tr class="bg-slate-800/50 font-bold border-t-2 border-amber-400/30">
<td class="px-4 py-3 uppercase text-xs tracking-wider">Total Return</td>
<td class="px-4 py-3"></td>
<td class="px-4 py-3"></td>
<td class="px-4 py-3 text-center font-mono text-emerald-400"><%= attribution ? fmt.pct(attribution.summary.totalReturn) : '+12.40%' %></td>
<td class="px-4 py-3"></td>
</tr>
</tfoot>
</table>
</div>

<!-- Top Contributors -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide text-sm">ğŸ† Top Contributors</h3>
<div class="space-y-3">
<% if (attribution && attribution.contributors && attribution.contributors.length > 0) { %>
<% attribution.contributors.forEach(item => { %>
<div class="flex items-center justify-between p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white text-xs font-bold"><%= item.symbol %></div>
<div><p class="font-bold text-white"><%= item.name %></p><p class="text-xs text-slate-400 font-mono"><%= fmt.pct(item.stockReturn) %> stock return</p></div>
</div>
<p class="text-xl font-bold font-mono text-emerald-400"><%= fmt.pct(item.contribution) %></p>
</div>
<% }); %>
<% } else { %>
<div class="flex items-center justify-between p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">NVDA</div>
<div><p class="font-bold text-white">NVIDIA</p><p class="text-xs text-slate-400 font-mono">+142% stock return</p></div>
</div>
<p class="text-xl font-bold font-mono text-emerald-400">+4.28%</p>
</div>
<% } %>
</div>
</div>
<div class="bloomberg-card p-5">
<h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide text-sm">ğŸ“‰ Top Detractors</h3>
<div class="space-y-3">
<% if (attribution && attribution.detractors && attribution.detractors.length > 0) { %>
<% attribution.detractors.forEach(item => { %>
<div class="flex items-center justify-between p-3 rounded-lg bg-red-500/10 border border-red-500/20">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center text-white text-xs font-bold"><%= item.symbol %></div>
<div><p class="font-bold text-white"><%= item.name %></p><p class="text-xs text-slate-400 font-mono"><%= fmt.pct(item.stockReturn) %> stock return</p></div>
</div>
<p class="text-xl font-bold font-mono text-red-400"><%= fmt.pct(item.contribution) %></p>
</div>
<% }); %>
<% } else { %>
<div class="flex items-center justify-between p-3 rounded-lg bg-red-500/10 border border-red-500/20">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white text-xs font-bold">AMD</div>
<div><p class="font-bold text-white">AMD</p><p class="text-xs text-slate-400 font-mono">-12% stock return</p></div>
</div>
<p class="text-xl font-bold font-mono text-red-400">-0.84%</p>
</div>
<% } %>
</div>
</div>
</div>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const factorData = <%= attribution && attribution.chartData ? JSON.stringify(attribution.chartData.factors) : JSON.stringify({labels: ['Market Beta','Quality','Momentum','Size','Value','Selection'], data: [10.98,2.04,1.12,0.77,-0.74,-1.77]}) %>;
const sectorData = <%= attribution && attribution.chartData ? JSON.stringify(attribution.chartData.sectors) : JSON.stringify({labels: ['Tech','Healthcare','Financials','Consumer','Energy','Utilities'], data: [6.2,1.8,1.4,0.8,-0.4,-1.2]}) %>;

new Chart(document.getElementById('factorChart'), {
  type: 'bar',
  data: {
    labels: factorData.labels,
    datasets: [{ data: factorData.data, backgroundColor: ctx => ctx.raw >= 0 ? '#10b981' : '#ef4444' }]
  },
  options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
});
new Chart(document.getElementById('sectorAttrChart'), {
  type: 'bar',
  data: {
    labels: sectorData.labels,
    datasets: [{ data: sectorData.data, backgroundColor: ctx => ctx.raw >= 0 ? '#0ea5e9' : '#ef4444' }]
  },
  options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
});

function changePeriod(period) {
  window.location.href = '/attribution?period=' + period;
}
</script>
<%- include('../partials/footer') %>
