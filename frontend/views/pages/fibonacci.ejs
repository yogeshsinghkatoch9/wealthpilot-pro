<%
// Safe defaults for potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
%>
<%- include('../partials/header', { pageTitle: 'Fibonacci Levels' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header mb-6">
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
<div>
<h1 class="text-2xl font-bold text-green-400">FIBONACCI LEVELS</h1>
<p class="text-slate-400 text-sm font-mono">Retracement & extension analysis</p>
</div>
<div class="flex gap-2">
<input type="text" value="AAPL" class="form-input w-24 font-mono">
<select class="form-input w-28 font-mono"><option selected>52W Range</option><option>YTD</option><option>Custom</option></select>
<button class="bloomberg-btn bloomberg-btn-primary">Calculate</button>
</div>
</div>
</div>

<!-- Stock Summary -->
<div class="bloomberg-card p-5 bg-gradient-to-r <%= safeTheme === 'light' ? 'from-green-50 to-purple-50' : 'from-green-900/20 to-purple-900/20' %>">
<div class="flex items-center gap-4">
<div class="w-14 h-14 rounded-xl bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white font-bold text-xl font-mono">AAPL</div>
<div class="flex-1">
<h2 class="text-xl font-bold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">Apple Inc.</h2>
<p class="<%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %> font-mono">Current Price: <span class="font-mono font-bold">$189.65</span></p>
</div>
</div>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">52W High</p>
<p class="text-2xl font-bold text-emerald-400 font-mono">$201.42</p>
</div>
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">52W Low</p>
<p class="text-2xl font-bold text-red-400 font-mono">$164.08</p>
</div>
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Range</p>
<p class="text-2xl font-bold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %> font-mono">$37.34</p>
</div>
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Position</p>
<p class="text-2xl font-bold text-sky-400 font-mono">68.5%</p>
<p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">of 52W range</p>
</div>
</div>
</div>

<!-- Fibonacci Levels Table -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="bloomberg-card overflow-hidden">
<div class="p-4 border-b <%= safeTheme === 'light' ? 'border-gray-200' : 'border-slate-700' %>">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">Fibonacci Retracement Levels</h3>
</div>
<table class="w-full text-sm">
<thead>
<tr class="<%= safeTheme === 'light' ? 'bg-gray-50 text-gray-500' : 'bg-slate-800 text-slate-400' %> text-left">
<th class="px-4 py-3 font-mono">Level</th>
<th class="px-4 py-3 text-center font-mono">Price</th>
<th class="px-4 py-3 text-center font-mono">vs Current</th>
<th class="px-4 py-3 text-center font-mono">Status</th>
</tr>
</thead>
<tbody class="<%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-medium font-mono">0% (High)</td>
<td class="px-4 py-3 text-center font-bold font-mono">$201.42</td>
<td class="px-4 py-3 text-center text-emerald-400 font-mono">+6.2%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-mono">Resistance</span></td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-medium text-green-400 font-mono">23.6%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$192.61</td>
<td class="px-4 py-3 text-center text-emerald-400 font-mono">+1.6%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-mono">Near</span></td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %> <%= safeTheme === 'light' ? 'bg-sky-50' : 'bg-sky-500/10' %>">
<td class="px-4 py-3 font-bold text-sky-400 font-mono">38.2%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$187.15</td>
<td class="px-4 py-3 text-center text-red-400 font-mono">-1.3%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-sky-500/20 text-sky-400 text-xs font-mono">Support</span></td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-bold text-purple-400 font-mono">50%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$182.75</td>
<td class="px-4 py-3 text-center text-red-400 font-mono">-3.6%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs font-mono">Key Level</span></td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-bold text-green-400 font-mono">61.8%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$178.35</td>
<td class="px-4 py-3 text-center text-red-400 font-mono">-6.0%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-mono">Golden Ratio</span></td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-medium font-mono">78.6%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$172.09</td>
<td class="px-4 py-3 text-center text-red-400 font-mono">-9.3%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-slate-500/20 text-slate-400 text-xs font-mono">Support</span></td>
</tr>
<tr>
<td class="px-4 py-3 font-medium font-mono">100% (Low)</td>
<td class="px-4 py-3 text-center font-bold font-mono">$164.08</td>
<td class="px-4 py-3 text-center text-red-400 font-mono">-13.5%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs font-mono">Major Support</span></td>
</tr>
</tbody>
</table>
</div>

<div class="bloomberg-card overflow-hidden">
<div class="p-4 border-b <%= safeTheme === 'light' ? 'border-gray-200' : 'border-slate-700' %>">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">Fibonacci Extension Levels</h3>
</div>
<table class="w-full text-sm">
<thead>
<tr class="<%= safeTheme === 'light' ? 'bg-gray-50 text-gray-500' : 'bg-slate-800 text-slate-400' %> text-left">
<th class="px-4 py-3 font-mono">Extension</th>
<th class="px-4 py-3 text-center font-mono">Price</th>
<th class="px-4 py-3 text-center font-mono">vs Current</th>
<th class="px-4 py-3 text-center font-mono">Target</th>
</tr>
</thead>
<tbody class="<%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-medium text-emerald-400 font-mono">127.2%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$211.58</td>
<td class="px-4 py-3 text-center text-emerald-400 font-mono">+11.6%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-mono">Target 1</span></td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-bold text-sky-400 font-mono">161.8%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$224.49</td>
<td class="px-4 py-3 text-center text-emerald-400 font-mono">+18.4%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-sky-500/20 text-sky-400 text-xs font-mono">Target 2</span></td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3 font-medium text-purple-400 font-mono">200%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$238.76</td>
<td class="px-4 py-3 text-center text-emerald-400 font-mono">+25.9%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs font-mono">Target 3</span></td>
</tr>
<tr>
<td class="px-4 py-3 font-medium text-green-400 font-mono">261.8%</td>
<td class="px-4 py-3 text-center font-bold font-mono">$261.84</td>
<td class="px-4 py-3 text-center text-emerald-400 font-mono">+38.1%</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-mono">Extended</span></td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- Analysis -->
<div class="bloomberg-card p-5">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Fibonacci Analysis</h3>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="p-4 rounded-lg border-l-4 border-sky-500 <%= safeTheme === 'light' ? 'bg-sky-50' : 'bg-sky-500/10' %>">
<p class="font-bold text-sky-400">Current Position</p>
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %> mt-1">Price is between 23.6% and 38.2% retracement, indicating bullish momentum with support at <span class="font-mono">$187.15</span></p>
</div>
<div class="p-4 rounded-lg border-l-4 border-emerald-500 <%= safeTheme === 'light' ? 'bg-emerald-50' : 'bg-emerald-500/10' %>">
<p class="font-bold text-emerald-400">Key Support</p>
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %> mt-1">Strong support at 61.8% golden ratio (<span class="font-mono">$178.35</span>) - watch for buying opportunity if tested</p>
</div>
<div class="p-4 rounded-lg border-l-4 border-purple-500 <%= safeTheme === 'light' ? 'bg-purple-50' : 'bg-purple-500/10' %>">
<p class="font-bold text-purple-400">Upside Target</p>
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %> mt-1">Breaking 52W high could target 127.2% extension at <span class="font-mono">$211.58</span> (<span class="font-mono">+11.6%</span>)</p>
</div>
</div>
</div>

<!-- Chart -->
<div class="bloomberg-card p-5">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Price with Fibonacci Levels</h3>
<div class="h-64"><canvas id="fibChart"></canvas></div>
</div>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('fibChart'), {
  type: 'line',
  data: { labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], datasets: [
    { label: 'Price', data: [180,175,168,172,185,188,178,182,192,198,195,189.65], borderColor: '#0ea5e9', fill: false, borderWidth: 2 },
    { label: '38.2%', data: Array(12).fill(187.15), borderColor: '#8b5cf6', borderDash: [5,5], fill: false, borderWidth: 1, pointRadius: 0 },
    { label: '50%', data: Array(12).fill(182.75), borderColor: '#f59e0b', borderDash: [5,5], fill: false, borderWidth: 1, pointRadius: 0 },
    { label: '61.8%', data: Array(12).fill(178.35), borderColor: '#ef4444', borderDash: [5,5], fill: false, borderWidth: 1, pointRadius: 0 }
  ]},
  options: { responsive: true, maintainAspectRatio: false }
});
</script>
<%- include('../partials/footer') %>
