<%- include('../partials/header', { pageTitle: 'Top Market Movers' }) %>

<style>
  .stat-number {
    font-feature-settings: 'tnum';
    font-variant-numeric: tabular-nums;
  }

  .positive {
    color: #10b981;
  }

  .negative {
    color: #ef4444;
  }

  .stock-row {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    padding: 16px;
    border-radius: 8px;
    background: <%= theme === 'light' ? '#ffffff' : '#0f1419' %>;
    border: 1px solid <%= theme === 'light' ? '#e5e7eb' : '#30363d' %>;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .stock-row:hover {
    border-color: <%= theme === 'light' ? '#d1d5db' : '#484f58' %>;
  }

  .stock-row-positive {
    border-left: 3px solid #10b981;
  }

  .stock-row-negative {
    border-left: 3px solid #ef4444;
  }

  .stock-row-neutral {
    border-left: 3px solid #f59e0b;
  }

  .tab-btn {
    transition: all 0.2s ease;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    border: 1px solid <%= theme === 'light' ? '#e5e7eb' : '#30363d' %>;
  }

  .tab-btn.active {
    background: <%= theme === 'light' ? '#111827' : '#f9fafb' %>;
    color: <%= theme === 'light' ? 'white' : '#111827' %>;
    border-color: <%= theme === 'light' ? '#111827' : '#f9fafb' %>;
  }

  .badge-modern {
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .badge-gain {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .badge-loss {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .rank-badge {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    background: <%= theme === 'light' ? '#f3f4f6' : '#374151' %>;
    color: <%= theme === 'light' ? '#6b7280' : '#9ca3af' %>;
  }

  .rank-1, .rank-2, .rank-3 {
    color: #111827;
  }

  .rank-1 {
    background: #fde68a;
  }

  .rank-2 {
    background: #e5e7eb;
  }

  .rank-3 {
    background: #fcd6bb;
  }
</style>

<!-- Header Section -->
<div class="tufte-stat-card mb-6">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-2xl font-semibold text-white mb-1">Market Movers</h1>
      <p class="text-slate-400 text-sm">Real-time market data â€¢ Auto-refresh every 30s</p>
    </div>

    <div class="flex items-center gap-3">
      <div class="text-right">
        <div class="text-xs text-slate-500">LAST UPDATED</div>
        <div class="text-sm text-white font-mono stat-number" id="lastUpdate">
          <%= lastUpdated ? new Date(lastUpdated).toLocaleTimeString() : new Date().toLocaleTimeString() %>
        </div>
      </div>
      <button onclick="refreshData()" class="px-4 py-2 border border-slate-600 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors flex items-center gap-2" id="refreshBtn">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        REFRESH
      </button>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-cols-3 gap-4">
    <div class="tufte-stat-card">
      <div class="stat-label">Top Gainers</div>
      <div class="stat-value-row">
        <span class="stat-value tabular-nums" id="gainersCount"><%= gainers.length %></span>
      </div>
    </div>

    <div class="tufte-stat-card">
      <div class="stat-label">Top Losers</div>
      <div class="stat-value-row">
        <span class="stat-value tabular-nums" id="losersCount"><%= losers.length %></span>
      </div>
    </div>

    <div class="tufte-stat-card">
      <div class="stat-label">Most Active</div>
      <div class="stat-value-row">
        <span class="stat-value tabular-nums" id="activeCount"><%= active.length %></span>
      </div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="flex gap-2 mb-6 overflow-x-auto pb-2">
  <button class="tab-btn active" data-tab="gainers" onclick="switchTab('gainers')">
    Top Gainers
  </button>
  <button class="tab-btn <%= theme === 'light' ? 'bg-gray-100 hover:bg-gray-200' : 'bg-gray-800 hover:bg-gray-700' %>" data-tab="losers" onclick="switchTab('losers')">
    Top Losers
  </button>
  <button class="tab-btn <%= theme === 'light' ? 'bg-gray-100 hover:bg-gray-200' : 'bg-gray-800 hover:bg-gray-700' %>" data-tab="active" onclick="switchTab('active')">
    Most Active
  </button>
  <button class="tab-btn <%= theme === 'light' ? 'bg-gray-100 hover:bg-gray-200' : 'bg-gray-800 hover:bg-gray-700' %>" data-tab="all" onclick="switchTab('all')">
    All Movers
  </button>
</div>

<!-- Tab Content -->
<div>
  <!-- Gainers Tab -->
  <div id="gainers-tab" class="tab-content">
    <div class="tufte-stat-card p-6 mb-6" id="gainersCard">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Top Gainers</h2>
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-500 bg-opacity-10 border border-emerald-500 border-opacity-30">
          <span class="text-emerald-400 text-sm font-semibold stat-number"><%= gainers.length %> stocks</span>
        </div>
      </div>

      <div class="space-y-3" id="gainersList">
        <% if (gainers && gainers.length > 0) { %>
          <% gainers.forEach((stock, index) => { %>
            <a href="/charts?symbol=<%= stock.symbol %>" class="block">
              <div class="stock-row stock-row-positive">
                <div class="flex items-center gap-4">
                  <!-- Rank Badge -->
                  <div class="rank-badge <%= index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '' %>">
                    <%= index + 1 %>
                  </div>

                  <!-- Stock Info -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-base"><%= stock.symbol %></h3>
                      <span class="badge-modern badge-gain stat-number">
                        +<%= stock.changePercent.toFixed(2) %>%
                      </span>
                    </div>
                    <div class="<%= theme === 'light' ? 'text-gray-600' : 'text-gray-400' %> text-sm"><%= stock.name || stock.symbol %></div>
                  </div>

                  <!-- Price Info -->
                  <div class="text-right">
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-xl stat-number mb-1">
                      $<%= stock.price.toFixed(2) %>
                    </div>
                    <div class="positive font-semibold text-sm stat-number">
                      +$<%= Math.abs(stock.change).toFixed(2) %>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          <% }); %>
        <% } else { %>
          <div class="text-center py-12">
            <p class="<%= theme === 'light' ? 'text-gray-600' : 'text-gray-400' %>">No gainers data available</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Losers Tab -->
  <div id="losers-tab" class="tab-content" style="display: none;">
    <div class="tufte-stat-card p-6 mb-6" id="losersCard">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Top Losers</h2>
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30">
          <span class="text-red-400 text-sm font-semibold stat-number"><%= losers.length %> stocks</span>
        </div>
      </div>

      <div class="space-y-3" id="losersList">
        <% if (losers && losers.length > 0) { %>
          <% losers.forEach((stock, index) => { %>
            <a href="/charts?symbol=<%= stock.symbol %>" class="block">
              <div class="stock-row stock-row-negative">
                <div class="flex items-center gap-4">
                  <!-- Rank Badge -->
                  <div class="rank-badge <%= index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '' %>">
                    <%= index + 1 %>
                  </div>

                  <!-- Stock Info -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-base"><%= stock.symbol %></h3>
                      <span class="badge-modern badge-loss stat-number">
                        <%= stock.changePercent.toFixed(2) %>%
                      </span>
                    </div>
                    <div class="<%= theme === 'light' ? 'text-gray-600' : 'text-gray-400' %> text-sm"><%= stock.name || stock.symbol %></div>
                  </div>

                  <!-- Price Info -->
                  <div class="text-right">
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-xl stat-number mb-1">
                      $<%= stock.price.toFixed(2) %>
                    </div>
                    <div class="negative font-semibold text-sm stat-number">
                      $<%= stock.change.toFixed(2) %>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          <% }); %>
        <% } else { %>
          <div class="text-center py-12">
            <p class="<%= theme === 'light' ? 'text-gray-600' : 'text-gray-400' %>">No losers data available</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Most Active Tab -->
  <div id="active-tab" class="tab-content" style="display: none;">
    <div class="tufte-stat-card p-6 mb-6" id="activeCard">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Most Active by Volume</h2>
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30">
          <span class="text-green-400 text-sm font-semibold stat-number"><%= active.length %> stocks</span>
        </div>
      </div>

      <div class="space-y-3" id="activeList">
        <% if (active && active.length > 0) { %>
          <% active.forEach((stock, index) => {
            const isPositive = stock.changePercent >= 0;
          %>
            <a href="/charts?symbol=<%= stock.symbol %>" class="block">
              <div class="stock-row <%= isPositive ? 'stock-row-positive' : 'stock-row-negative' %>">
                <div class="flex items-center gap-4">
                  <!-- Rank Badge -->
                  <div class="rank-badge <%= index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '' %>">
                    <%= index + 1 %>
                  </div>

                  <!-- Stock Info -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-base"><%= stock.symbol %></h3>
                      <span class="badge-modern <%= isPositive ? 'badge-gain' : 'badge-loss' %> stat-number">
                        <%= isPositive ? '+' : '' %><%= stock.changePercent.toFixed(2) %>%
                      </span>
                    </div>
                    <div class="<%= theme === 'light' ? 'text-gray-600' : 'text-gray-400' %> text-sm">
                      Volume: <span class="font-semibold stat-number"><%= (stock.volume / 1000000).toFixed(1) %>M</span>
                    </div>
                  </div>

                  <!-- Price Info -->
                  <div class="text-right">
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-xl stat-number mb-1">
                      $<%= stock.price.toFixed(2) %>
                    </div>
                    <div class="<%= isPositive ? 'positive' : 'negative' %> font-semibold text-sm stat-number">
                      <%= isPositive ? '+' : '' %>$<%= Math.abs(stock.change).toFixed(2) %>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          <% }); %>
        <% } else { %>
          <div class="text-center py-12">
            <p class="<%= theme === 'light' ? 'text-gray-600' : 'text-gray-400' %>">No activity data available</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- All Movers Tab -->
  <div id="all-tab" class="tab-content" style="display: none;">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Gainers Column -->
      <div class="tufte-stat-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Gainers</h3>
          <span class="positive text-sm font-semibold stat-number"><%= gainers.length %></span>
        </div>
        <div class="space-y-2 max-h-[600px] overflow-y-auto">
          <% gainers.slice(0, 10).forEach((stock, index) => { %>
            <a href="/charts?symbol=<%= stock.symbol %>" class="block">
              <div class="p-3 rounded-lg hover:bg-slate-800 transition-all border border-transparent hover:border-slate-600">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-sm"><%= stock.symbol %></div>
                    <div class="positive font-semibold text-xs stat-number">+<%= stock.changePercent.toFixed(2) %>%</div>
                  </div>
                  <div class="text-right">
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold text-sm stat-number">$<%= stock.price.toFixed(2) %></div>
                  </div>
                </div>
              </div>
            </a>
          <% }); %>
        </div>
      </div>

      <!-- Losers Column -->
      <div class="tufte-stat-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Losers</h3>
          <span class="negative text-sm font-semibold stat-number"><%= losers.length %></span>
        </div>
        <div class="space-y-2 max-h-[600px] overflow-y-auto">
          <% losers.slice(0, 10).forEach((stock, index) => { %>
            <a href="/charts?symbol=<%= stock.symbol %>" class="block">
              <div class="p-3 rounded-lg hover:bg-slate-800 transition-all border border-transparent hover:border-slate-600">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-sm"><%= stock.symbol %></div>
                    <div class="negative font-semibold text-xs stat-number"><%= stock.changePercent.toFixed(2) %>%</div>
                  </div>
                  <div class="text-right">
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold text-sm stat-number">$<%= stock.price.toFixed(2) %></div>
                  </div>
                </div>
              </div>
            </a>
          <% }); %>
        </div>
      </div>

      <!-- Most Active Column -->
      <div class="tufte-stat-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Most Active</h3>
          <span class="text-green-400 text-sm font-semibold stat-number"><%= active.length %></span>
        </div>
        <div class="space-y-2 max-h-[600px] overflow-y-auto">
          <% active.slice(0, 10).forEach((stock, index) => {
            const isPositive = stock.changePercent >= 0;
          %>
            <a href="/charts?symbol=<%= stock.symbol %>" class="block">
              <div class="p-3 rounded-lg hover:bg-slate-800 transition-all border border-transparent hover:border-slate-600">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-bold text-sm"><%= stock.symbol %></div>
                    <div class="<%= isPositive ? 'positive' : 'negative' %> font-semibold text-xs stat-number">
                      <%= isPositive ? '+' : '' %><%= stock.changePercent.toFixed(2) %>%
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %> font-semibold text-sm stat-number">$<%= stock.price.toFixed(2) %></div>
                  </div>
                </div>
              </div>
            </a>
          <% }); %>
        </div>
      </div>
    </div>
  </div>
</div>

</div></div></main>

<script src="/js/market-movers.js?v=<%= Date.now() %>"></script>

<script>
// Tab Switching
function switchTab(tabName) {
  // Update buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.dataset.tab === tabName) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // Show/hide content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.style.display = 'none';
  });
  document.getElementById(tabName + '-tab').style.display = 'block';
}

// Refresh Data
function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;

  setTimeout(() => {
    location.reload();
  }, 500);
}

// Update last update time every second
setInterval(() => {
  const now = new Date().toLocaleTimeString();
  document.getElementById('lastUpdate').textContent = now;
}, 1000);
</script>

<%- include('../partials/footer') %>
