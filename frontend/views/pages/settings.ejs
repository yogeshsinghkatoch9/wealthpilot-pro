<%
  // Safe defaults
  const safeUser = typeof user !== 'undefined' ? user : {};
  const safeSettings = typeof settings !== 'undefined' ? settings : {};
  const safeApiKeys = typeof apiKeys !== 'undefined' ? apiKeys : [];
  const safeSessions = typeof sessions !== 'undefined' ? sessions : [];
  const safePortfolios = typeof portfolios !== 'undefined' ? portfolios : [];

  // Current tab from query parameter
  const activeTab = typeof req !== 'undefined' && req.query && req.query.tab ? req.query.tab : 'profile';

  // Generate initials for avatar
  const fullName = `${safeUser.firstName || ''} ${safeUser.lastName || ''}`.trim() || 'User';
  const initials = fullName.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
%>
<%- include('../partials/header', { pageTitle: 'Settings' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header">
  <h1 class="text-amber-400 font-mono font-bold text-xl tracking-wide">SETTINGS</h1>
  <div class="text-slate-400 text-sm font-mono">
    <span class="text-amber-400">â–¸</span> ACCOUNT PREFERENCES & MANAGEMENT
  </div>
</div>

<main class="p-4 lg:p-6">
  <div class="max-w-7xl mx-auto">

    <!-- Tabs Navigation -->
    <div class="mb-6 overflow-x-auto">
      <div class="flex gap-2 border-b border-slate-700 min-w-max">
        <button onclick="switchTab('profile')"
                class="tab-btn <%= activeTab === 'profile' ? 'active' : '' %>"
                data-tab="profile">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          Profile
        </button>

        <button onclick="switchTab('preferences')"
                class="tab-btn <%= activeTab === 'preferences' ? 'active' : '' %>"
                data-tab="preferences">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
          </svg>
          Preferences
        </button>

        <button onclick="switchTab('notifications')"
                class="tab-btn <%= activeTab === 'notifications' ? 'active' : '' %>"
                data-tab="notifications">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
          Notifications
        </button>

        <button onclick="switchTab('api-keys')"
                class="tab-btn <%= activeTab === 'api-keys' ? 'active' : '' %>"
                data-tab="api-keys">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
          </svg>
          API Keys
        </button>

        <button onclick="switchTab('security')"
                class="tab-btn <%= activeTab === 'security' ? 'active' : '' %>"
                data-tab="security">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          Security
        </button>

        <button onclick="switchTab('data')"
                class="tab-btn <%= activeTab === 'data' ? 'active' : '' %>"
                data-tab="data">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
          </svg>
          Data & Privacy
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Profile Tab -->
      <div id="profile-tab" class="tab-pane <%= activeTab === 'profile' ? 'active' : 'hidden' %>">
        <%- include('../partials/settings/profile-tab', { user: safeUser }) %>
      </div>

      <!-- Preferences Tab -->
      <div id="preferences-tab" class="tab-pane <%= activeTab === 'preferences' ? 'active' : 'hidden' %>">
        <%- include('../partials/settings/preferences-tab', { user: safeUser, settings: safeSettings, portfolios: safePortfolios }) %>
      </div>

      <!-- Notifications Tab -->
      <div id="notifications-tab" class="tab-pane <%= activeTab === 'notifications' ? 'active' : 'hidden' %>">
        <%- include('../partials/settings/notifications-tab', { settings: safeSettings }) %>
      </div>

      <!-- API Keys Tab -->
      <div id="api-keys-tab" class="tab-pane <%= activeTab === 'api-keys' ? 'active' : 'hidden' %>">
        <%- include('../partials/settings/api-keys-tab', { apiKeys: safeApiKeys }) %>
      </div>

      <!-- Security Tab -->
      <div id="security-tab" class="tab-pane <%= activeTab === 'security' ? 'active' : 'hidden' %>">
        <%- include('../partials/settings/security-tab', { sessions: safeSessions }) %>
      </div>

      <!-- Data & Privacy Tab -->
      <div id="data-tab" class="tab-pane <%= activeTab === 'data' ? 'active' : 'hidden' %>">
        <%- include('../partials/settings/data-tab', { user: safeUser }) %>
      </div>
    </div>

  </div>
</main>

<style>
.tab-btn {
  padding: 0.75rem 1.5rem;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  font-weight: 600;
  color: #94a3b8;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;
  white-space: nowrap;
}

.tab-btn:hover {
  color: #f59e0b;
}

.tab-btn.active {
  color: #f59e0b;
  border-bottom-color: #f59e0b;
}

.tab-pane {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
function switchTab(tabName) {
  // Update URL
  const url = new URL(window.location);
  url.searchParams.set('tab', tabName);
  window.history.pushState({}, '', url);

  // Hide all tabs
  document.querySelectorAll('.tab-pane').forEach(pane => {
    pane.classList.remove('active');
    pane.classList.add('hidden');
  });

  // Show selected tab
  const selectedPane = document.getElementById(tabName + '-tab');
  if (selectedPane) {
    selectedPane.classList.remove('hidden');
    selectedPane.classList.add('active');
  }

  // Update tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
  if (selectedBtn) {
    selectedBtn.classList.add('active');
  }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', () => {
  const url = new URL(window.location);
  const tab = url.searchParams.get('tab') || 'profile';
  switchTab(tab);
});
</script>

<!-- Settings Page JavaScript -->
<script src="/js/settings.js"></script>

<%- include('../partials/footer') %>
