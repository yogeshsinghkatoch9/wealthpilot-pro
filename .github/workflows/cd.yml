##############################################
# WealthPilot Pro - CD Pipeline
# Deployment via Vercel (frontend) & Railway (backend)
# Docker builds skipped - using platform-native builds
##############################################

name: CD - Deploy

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  # Verify deployment readiness
  verify:
    name: Verify Deployment Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deployment files
        run: |
          echo "Checking deployment configuration..."
          test -f vercel.json && echo "✅ vercel.json found" || echo "❌ vercel.json missing"
          test -f railway.json && echo "✅ railway.json found" || echo "❌ railway.json missing"
          test -f nixpacks.toml && echo "✅ nixpacks.toml found" || echo "❌ nixpacks.toml missing"
          echo "✅ Deployment config verified"

  # Deploy notification
  deploy-notify:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: verify
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deployment info
        run: |
          echo "================================================"
          echo "WealthPilot Pro - Deployment Triggered"
          echo "================================================"
          echo ""
          echo "Deployments are handled automatically by:"
          echo "  - Frontend: Vercel (auto-deploys on push to main)"
          echo "  - Backend: Railway (auto-deploys on push to main)"
          echo ""
          echo "Manual deployments:"
          echo "  - Vercel: https://vercel.com/dashboard"
          echo "  - Railway: https://railway.app/dashboard"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "================================================"

  # Create GitHub Release on tags
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: verify
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
