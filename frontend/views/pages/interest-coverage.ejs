<%
// Safe defaults for potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safeUser = typeof user !== 'undefined' ? user : {};
const safePageTitle = 'Interest Coverage';
%>
<%- include('../partials/header', { pageTitle: safePageTitle }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-amber-400"><%= safePageTitle %></h1>
      <p class="text-slate-400">Debt service ability & financial health</p>
    </div>
    <div class="flex gap-2">
      <select class="form-input w-36 bg-slate-800 border-amber-400/30 text-white">
        <option selected>My Holdings</option>
        <option>Watchlist</option>
      </select>
    </div>
  </div>
</div>

<!-- Coverage Summary -->
<div class="bloomberg-card p-5 bg-gradient-to-r from-emerald-900/20 to-sky-900/20">
  <h3 class="font-semibold text-amber-400 mb-4">Portfolio Coverage Overview</h3>
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
    <div class="text-center">
      <p class="text-sm text-slate-400">Avg Interest Coverage</p>
      <p class="text-3xl font-bold font-mono text-emerald-400">18.4x</p>
      <p class="text-xs text-emerald-400">Excellent</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Median Coverage</p>
      <p class="text-3xl font-bold font-mono text-sky-400">12.8x</p>
      <p class="text-xs">Strong</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Strong (>10x)</p>
      <p class="text-3xl font-bold text-emerald-400">11</p>
      <p class="text-xs">holdings</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Adequate (3-10x)</p>
      <p class="text-3xl font-bold text-amber-400">4</p>
      <p class="text-xs">holdings</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Weak (<3x)</p>
      <p class="text-3xl font-bold text-red-400">1</p>
      <p class="text-xs text-red-400">at risk</p>
    </div>
  </div>
</div>

<!-- Coverage Scale -->
<div class="bloomberg-card p-4">
  <p class="text-xs text-slate-400 mb-2">Interest Coverage Ratio = EBIT / Interest Expense (higher is better)</p>
  <div class="flex items-center justify-between text-xs">
    <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-red-500"></div><span><1.5x Distressed</span></div>
    <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-amber-500"></div><span>1.5-3x Weak</span></div>
    <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-yellow-500"></div><span>3-5x Adequate</span></div>
    <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-sky-500"></div><span>5-10x Good</span></div>
    <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-emerald-500"></div><span>>10x Excellent</span></div>
  </div>
</div>

<!-- Holdings Coverage Table -->
<div class="card overflow-hidden">
<div class="p-4 border-b <%= theme === 'light' ? 'border-gray-200' : 'border-slate-700' %>">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Holdings Interest Coverage</h3>
</div>
<table class="w-full text-sm">
<thead>
<tr class="<%= theme === 'light' ? 'bg-gray-50 text-gray-500' : 'bg-slate-800 text-slate-400' %> text-left">
<th class="px-4 py-3">Company</th>
<th class="px-4 py-3 text-center">EBIT (TTM)</th>
<th class="px-4 py-3 text-center">Interest Exp</th>
<th class="px-4 py-3 text-center">Coverage Ratio</th>
<th class="px-4 py-3 text-center">5Y Avg</th>
<th class="px-4 py-3 text-center">Trend</th>
<th class="px-4 py-3 text-center">Rating</th>
</tr>
</thead>
<tbody class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">
<tr class="border-b <%= theme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">NVDA</div><span class="font-medium">NVIDIA</span></div></td>
<td class="px-4 py-3 text-center">$42.8B</td>
<td class="px-4 py-3 text-center">$0.26B</td>
<td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-full bg-emerald-500/30 text-emerald-400 font-bold">164.6x</span></td>
<td class="px-4 py-3 text-center">82.4x</td>
<td class="px-4 py-3 text-center text-emerald-400">‚Üë Improving</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs">Excellent</span></td>
</tr>
<tr class="border-b <%= theme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white text-xs font-bold">MSFT</div><span class="font-medium">Microsoft</span></div></td>
<td class="px-4 py-3 text-center">$109.4B</td>
<td class="px-4 py-3 text-center">$2.8B</td>
<td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-full bg-emerald-500/30 text-emerald-400 font-bold">39.1x</span></td>
<td class="px-4 py-3 text-center">34.2x</td>
<td class="px-4 py-3 text-center text-emerald-400">‚Üë Improving</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs">Excellent</span></td>
</tr>
<tr class="border-b <%= theme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white text-xs font-bold">AAPL</div><span class="font-medium">Apple</span></div></td>
<td class="px-4 py-3 text-center">$118.6B</td>
<td class="px-4 py-3 text-center">$3.9B</td>
<td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-full bg-emerald-500/30 text-emerald-400 font-bold">30.4x</span></td>
<td class="px-4 py-3 text-center">28.8x</td>
<td class="px-4 py-3 text-center">‚Üí Stable</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs">Excellent</span></td>
</tr>
<tr class="border-b <%= theme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center text-white text-xs font-bold">T</div><span class="font-medium">AT&T</span></div></td>
<td class="px-4 py-3 text-center">$24.2B</td>
<td class="px-4 py-3 text-center">$6.8B</td>
<td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-full bg-yellow-500/30 text-yellow-400 font-bold">3.6x</span></td>
<td class="px-4 py-3 text-center">4.2x</td>
<td class="px-4 py-3 text-center text-red-400">‚Üì Declining</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-amber-500/20 text-amber-400 text-xs">Adequate</span></td>
</tr>
<tr>
<td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white text-xs font-bold">BA</div><span class="font-medium">Boeing</span></div></td>
<td class="px-4 py-3 text-center text-red-400">-$2.4B</td>
<td class="px-4 py-3 text-center">$2.9B</td>
<td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-full bg-red-500/30 text-red-400 font-bold">N/M</span></td>
<td class="px-4 py-3 text-center">-1.2x</td>
<td class="px-4 py-3 text-center text-red-400">‚Üì Declining</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs">Distressed</span></td>
</tr>
</tbody>
</table>
</div>

<!-- Coverage Insights -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="card p-5">
<h4 class="font-bold text-emerald-400 mb-3">üí™ Strongest Coverage</h4>
<div class="space-y-2">
<div class="flex justify-between"><span>NVDA</span><span class="font-bold text-emerald-400">164.6x</span></div>
<div class="flex justify-between"><span>META</span><span class="font-bold text-emerald-400">84.2x</span></div>
<div class="flex justify-between"><span>GOOGL</span><span class="font-bold text-emerald-400">52.8x</span></div>
</div>
</div>
<div class="card p-5">
<h4 class="font-bold text-sky-400 mb-3">üìà Most Improved</h4>
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> mb-3">Coverage ratio YoY change</p>
<div class="space-y-2">
<div class="flex justify-between"><span>NVDA</span><span class="font-bold text-emerald-400">+82.2x</span></div>
<div class="flex justify-between"><span>META</span><span class="font-bold text-emerald-400">+24.8x</span></div>
<div class="flex justify-between"><span>AMZN</span><span class="font-bold text-emerald-400">+8.4x</span></div>
</div>
</div>
<div class="card p-5">
<h4 class="font-bold text-red-400 mb-3">‚ö†Ô∏è Concerns</h4>
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> mb-3">Low or negative coverage</p>
<div class="space-y-2">
<div class="flex justify-between"><span>BA</span><span class="font-bold text-red-400">Negative EBIT</span></div>
<div class="flex justify-between"><span>T</span><span class="font-bold text-amber-400">3.6x (declining)</span></div>
<div class="flex justify-between"><span>INTC</span><span class="font-bold text-amber-400">4.2x</span></div>
</div>
</div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="card p-5">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Coverage by Holding</h3>
<div class="h-48"><canvas id="coverageChart"></canvas></div>
</div>
<div class="card p-5">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">5-Year Coverage Trend (MSFT)</h3>
<div class="h-48"><canvas id="trendChart"></canvas></div>
</div>
</div>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('coverageChart'), {
  type: 'bar',
  data: { labels: ['NVDA','META','GOOGL','MSFT','AAPL','JNJ','VZ','T','BA'], datasets: [{ label: 'Interest Coverage', data: [164.6,84.2,52.8,39.1,30.4,18.2,6.4,3.6,-0.8], backgroundColor: d => d.raw > 10 ? '#10b981' : d.raw > 3 ? '#f59e0b' : '#ef4444' }] },
  options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
});
new Chart(document.getElementById('trendChart'), {
  type: 'line',
  data: { labels: ['2020','2021','2022','2023','2024'], datasets: [{ label: 'Coverage Ratio', data: [28.4,32.8,34.2,36.8,39.1], borderColor: '#10b981', fill: false, tension: 0.3 }] },
  options: { responsive: true, maintainAspectRatio: false }
});
</script>
<%- include('../partials/footer') %>
