<%- include('../partials/header', { pageTitle: 'Portfolio Optimizer' }) %>

<style>
  .optimizer-card {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
    border: 1px solid rgba(251, 191, 36, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    backdrop-filter: blur(10px);
  }
  .goal-option {
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }
  .goal-option:hover {
    border-color: rgba(251, 191, 36, 0.3);
    transform: translateX(4px);
  }
  .goal-option.selected {
    background: rgba(251, 191, 36, 0.15);
    border-color: #fbbf24;
  }
  .stat-card {
    background: rgba(15, 23, 42, 0.6);
    border-radius: 10px;
    padding: 1rem;
    transition: all 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }
  .stat-card.optimized {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 182, 212, 0.1));
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  .change-row {
    transition: all 0.2s ease;
    border-radius: 8px;
  }
  .change-row:hover {
    transform: scale(1.02);
  }
  .change-row.positive {
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent);
    border-left: 3px solid #10b981;
  }
  .change-row.negative {
    background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
    border-left: 3px solid #ef4444;
  }
  .asset-check {
    transition: all 0.2s ease;
  }
  .asset-check:hover {
    background: rgba(251, 191, 36, 0.1);
  }
  .slider-container input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #1e293b;
  }
  .slider-container input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #fbbf24;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
  }
  .apply-section {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), rgba(245, 158, 11, 0.02));
    border: 1px solid rgba(251, 191, 36, 0.2);
  }
  .btn-generate {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #0f172a;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
  .btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
  }
  .btn-generate:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  .frontier-container {
    position: relative;
    background: rgba(15, 23, 42, 0.5);
    border-radius: 12px;
    padding: 1rem;
  }
  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    z-index: 10;
  }
  .loading-overlay.hidden {
    display: none !important;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(251, 191, 36, 0.2);
    border-top-color: #fbbf24;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .improvement-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .improvement-badge.positive {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
  }
</style>

<!-- Header -->
<div class="mb-6 pb-4 border-b border-green-400/30">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-green-400 font-mono tracking-wide">PORTFOLIO OPTIMIZER</h1>
      <p class="text-slate-400 text-sm mt-1">Mean-variance optimization & efficient frontier analysis</p>
    </div>
    <button id="runOptBtn" onclick="runOptimization()" class="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-green-500 to-green-600 text-slate-900 font-semibold rounded-lg hover:from-green-400 hover:to-green-500 transition-all shadow-lg hover:shadow-green-500/25">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
      Run Optimization
    </button>
  </div>
</div>

<!-- Optimization Settings -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
  <!-- Optimization Goal -->
  <div class="optimizer-card">
    <h3 class="text-lg font-semibold text-green-400 mb-4 font-mono flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      OPTIMIZATION GOAL
    </h3>
    <div class="space-y-3" id="goalOptions">
      <label class="goal-option selected flex items-center gap-3 p-3 rounded-lg cursor-pointer" data-goal="sharpe">
        <input type="radio" name="goal" value="sharpe" checked class="w-4 h-4 text-green-400 focus:ring-amber-400">
        <div class="flex-1">
          <p class="font-medium text-white">Maximum Sharpe Ratio</p>
          <p class="text-xs text-slate-400">Best risk-adjusted returns</p>
        </div>
        <span class="text-green-400 text-xs font-mono">RECOMMENDED</span>
      </label>
      <label class="goal-option flex items-center gap-3 p-3 rounded-lg cursor-pointer" data-goal="minvol">
        <input type="radio" name="goal" value="minvol" class="w-4 h-4 text-green-400 focus:ring-amber-400">
        <div class="flex-1">
          <p class="font-medium text-white">Minimum Volatility</p>
          <p class="text-xs text-slate-400">Lowest risk portfolio</p>
        </div>
      </label>
      <label class="goal-option flex items-center gap-3 p-3 rounded-lg cursor-pointer" data-goal="maxret">
        <input type="radio" name="goal" value="maxret" class="w-4 h-4 text-green-400 focus:ring-amber-400">
        <div class="flex-1">
          <p class="font-medium text-white">Maximum Return</p>
          <p class="text-xs text-slate-400">Target highest returns</p>
        </div>
      </label>
      <label class="goal-option flex items-center gap-3 p-3 rounded-lg cursor-pointer" data-goal="target">
        <input type="radio" name="goal" value="target" class="w-4 h-4 text-green-400 focus:ring-amber-400">
        <div class="flex-1">
          <p class="font-medium text-white">Target Return</p>
          <p class="text-xs text-slate-400">Specify desired return %</p>
        </div>
      </label>
    </div>
  </div>

  <!-- Constraints -->
  <div class="optimizer-card">
    <h3 class="text-lg font-semibold text-green-400 mb-4 font-mono flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
      </svg>
      CONSTRAINTS
    </h3>
    <div class="space-y-5">
      <div class="slider-container">
        <div class="flex justify-between mb-2">
          <label class="text-sm font-medium text-slate-300">Max Position Size</label>
          <span id="maxPosVal" class="text-green-400 font-mono font-bold">40%</span>
        </div>
        <input type="range" id="maxPosition" min="10" max="100" value="40" oninput="document.getElementById('maxPosVal').textContent = this.value + '%'">
      </div>
      <div class="slider-container">
        <div class="flex justify-between mb-2">
          <label class="text-sm font-medium text-slate-300">Min Position Size</label>
          <span id="minPosVal" class="text-green-400 font-mono font-bold">5%</span>
        </div>
        <input type="range" id="minPosition" min="0" max="20" value="5" oninput="document.getElementById('minPosVal').textContent = this.value + '%'">
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Target Return (if applicable)</label>
        <div class="flex items-center gap-2">
          <input type="number" id="targetReturn" value="12" class="w-20 px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white font-mono focus:border-green-400 focus:ring-1 focus:ring-amber-400">
          <span class="text-slate-400">% annually</span>
        </div>
      </div>
      <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-lg">
        <input type="checkbox" id="allowShort" class="w-4 h-4 text-green-400 rounded focus:ring-amber-400">
        <label for="allowShort" class="text-slate-300 text-sm">Allow short selling</label>
      </div>
    </div>
  </div>

  <!-- Assets to Include -->
  <div class="optimizer-card">
    <h3 class="text-lg font-semibold text-green-400 mb-4 font-mono flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
      </svg>
      ASSETS TO INCLUDE
    </h3>
    <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
      <span class="text-xs text-slate-400 font-mono">SYMBOL</span>
      <span class="text-xs text-slate-400 font-mono">CURRENT %</span>
    </div>
    <div class="space-y-1 max-h-56 overflow-y-auto pr-2" id="assetList">
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">AAPL</span>
        <span class="text-green-400 font-mono text-sm">18%</span>
      </label>
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">MSFT</span>
        <span class="text-cyan-400 font-mono text-sm">15%</span>
      </label>
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">NVDA</span>
        <span class="text-emerald-400 font-mono text-sm">12%</span>
      </label>
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">GOOGL</span>
        <span class="text-purple-400 font-mono text-sm">10%</span>
      </label>
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">AMZN</span>
        <span class="text-red-400 font-mono text-sm">10%</span>
      </label>
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">META</span>
        <span class="text-pink-400 font-mono text-sm">8%</span>
      </label>
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">BND</span>
        <span class="text-sky-400 font-mono text-sm">15%</span>
      </label>
      <label class="asset-check flex items-center gap-3 p-2 rounded-lg cursor-pointer">
        <input type="checkbox" checked class="w-4 h-4 text-green-400 rounded">
        <span class="text-white font-mono flex-1">GLD</span>
        <span class="text-yellow-400 font-mono text-sm">12%</span>
      </label>
    </div>
    <div class="mt-3 pt-3 border-t border-slate-700 flex justify-between text-sm">
      <button onclick="selectAllAssets(true)" class="text-green-400 hover:text-amber-300">Select All</button>
      <button onclick="selectAllAssets(false)" class="text-slate-400 hover:text-slate-300">Deselect All</button>
    </div>
  </div>
</div>

<!-- Efficient Frontier Chart -->
<div class="optimizer-card mb-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-green-400 font-mono flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
      </svg>
      EFFICIENT FRONTIER
    </h3>
    <div class="flex items-center gap-4 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-sky-500"></div>
        <span class="text-slate-400">Frontier</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-green-500"></div>
        <span class="text-slate-400">Current</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-emerald-500" style="clip-path: polygon(50% 0%, 100% 100%, 0% 100%);"></div>
        <span class="text-slate-400">Optimal</span>
      </div>
    </div>
  </div>
  <div class="frontier-container">
    <div id="chartLoading" class="loading-overlay hidden">
      <div class="text-center">
        <div class="spinner mx-auto mb-3"></div>
        <p class="text-green-400 font-mono text-sm">Calculating efficient frontier...</p>
      </div>
    </div>
    <div class="h-80">
      <canvas id="frontierChart"></canvas>
    </div>
  </div>
</div>

<!-- Results Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <!-- Current vs Optimized -->
  <div class="optimizer-card">
    <h3 class="text-lg font-semibold text-green-400 mb-4 font-mono flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      CURRENT VS OPTIMIZED
    </h3>

    <!-- Stats Comparison -->
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="stat-card">
        <p class="text-xs text-slate-500 mb-3 font-mono uppercase tracking-wider">Current Portfolio</p>
        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <span class="text-slate-400 text-sm">Return</span>
            <span class="text-white font-bold font-mono text-lg">14.2%</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-400 text-sm">Volatility</span>
            <span class="text-white font-bold font-mono text-lg">18.5%</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-400 text-sm">Sharpe Ratio</span>
            <span class="text-white font-bold font-mono text-lg">0.65</span>
          </div>
        </div>
      </div>
      <div class="stat-card optimized">
        <div class="flex items-center justify-between mb-3">
          <p class="text-xs text-emerald-400 font-mono uppercase tracking-wider">Optimized</p>
          <span class="improvement-badge positive">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
            </svg>
            +32%
          </span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <span class="text-slate-400 text-sm">Return</span>
            <span class="text-emerald-400 font-bold font-mono text-lg">15.8%</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-400 text-sm">Volatility</span>
            <span class="text-emerald-400 font-bold font-mono text-lg">16.2%</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-400 text-sm">Sharpe Ratio</span>
            <span class="text-emerald-400 font-bold font-mono text-lg">0.86</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Recommended Changes -->
    <div>
      <p class="text-sm font-medium text-slate-300 font-mono mb-3 flex items-center gap-2">
        <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
        </svg>
        RECOMMENDED CHANGES
      </p>
      <div class="space-y-2">
        <div class="change-row positive flex items-center justify-between p-3">
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center text-sky-400 font-mono text-xs">BND</span>
            <span class="text-white font-medium">Bonds ETF</span>
          </div>
          <div class="text-right">
            <span class="text-emerald-400 font-bold font-mono">+8%</span>
            <span class="text-slate-500 mx-1">→</span>
            <span class="text-white font-mono">23%</span>
          </div>
        </div>
        <div class="change-row positive flex items-center justify-between p-3">
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 rounded-lg bg-yellow-500/20 flex items-center justify-center text-yellow-400 font-mono text-xs">GLD</span>
            <span class="text-white font-medium">Gold ETF</span>
          </div>
          <div class="text-right">
            <span class="text-emerald-400 font-bold font-mono">+3%</span>
            <span class="text-slate-500 mx-1">→</span>
            <span class="text-white font-mono">15%</span>
          </div>
        </div>
        <div class="change-row negative flex items-center justify-between p-3">
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-400 font-mono text-xs">NVDA</span>
            <span class="text-white font-medium">NVIDIA</span>
          </div>
          <div class="text-right">
            <span class="text-red-400 font-bold font-mono">-7%</span>
            <span class="text-slate-500 mx-1">→</span>
            <span class="text-white font-mono">5%</span>
          </div>
        </div>
        <div class="change-row negative flex items-center justify-between p-3">
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 rounded-lg bg-pink-500/20 flex items-center justify-center text-pink-400 font-mono text-xs">META</span>
            <span class="text-white font-medium">Meta</span>
          </div>
          <div class="text-right">
            <span class="text-red-400 font-bold font-mono">-4%</span>
            <span class="text-slate-500 mx-1">→</span>
            <span class="text-white font-mono">4%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Optimized Allocation -->
  <div class="optimizer-card">
    <h3 class="text-lg font-semibold text-green-400 mb-4 font-mono flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
      </svg>
      OPTIMIZED ALLOCATION
    </h3>
    <div class="h-72">
      <canvas id="allocationChart"></canvas>
    </div>
    <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
      <div class="flex items-center gap-2 p-2 bg-slate-800/50 rounded">
        <div class="w-3 h-3 rounded-full bg-sky-500"></div>
        <span class="text-slate-400">BND</span>
        <span class="ml-auto text-white font-mono">23%</span>
      </div>
      <div class="flex items-center gap-2 p-2 bg-slate-800/50 rounded">
        <div class="w-3 h-3 rounded-full bg-green-500"></div>
        <span class="text-slate-400">AAPL</span>
        <span class="ml-auto text-white font-mono">18%</span>
      </div>
      <div class="flex items-center gap-2 p-2 bg-slate-800/50 rounded">
        <div class="w-3 h-3 rounded-full bg-purple-500"></div>
        <span class="text-slate-400">MSFT</span>
        <span class="ml-auto text-white font-mono">15%</span>
      </div>
      <div class="flex items-center gap-2 p-2 bg-slate-800/50 rounded">
        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
        <span class="text-slate-400">GLD</span>
        <span class="ml-auto text-white font-mono">15%</span>
      </div>
    </div>
  </div>
</div>

<!-- Apply Section -->
<div class="optimizer-card apply-section">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <h3 class="text-lg font-semibold text-green-400 font-mono flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
        APPLY OPTIMIZED PORTFOLIO
      </h3>
      <p class="text-slate-400 text-sm mt-1">Generate rebalancing trades to match the optimized allocation</p>
    </div>
    <div class="flex gap-3">
      <button onclick="exportAnalysis()" class="px-4 py-2.5 border border-slate-600 text-slate-300 rounded-lg hover:bg-slate-800 transition-all flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        Export Analysis
      </button>
      <button id="applyBtn" onclick="applyOptimization()" class="btn-generate flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        Apply & Generate Trades
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Goal selection
document.querySelectorAll('.goal-option').forEach(option => {
  option.addEventListener('click', function() {
    document.querySelectorAll('.goal-option').forEach(o => o.classList.remove('selected'));
    this.classList.add('selected');
  });
});

// Select all assets
function selectAllAssets(select) {
  document.querySelectorAll('#assetList input[type="checkbox"]').forEach(cb => cb.checked = select);
}

// Run optimization
function runOptimization() {
  const btn = document.getElementById('runOptBtn');
  const loading = document.getElementById('chartLoading');

  btn.disabled = true;
  btn.innerHTML = '<div class="spinner w-5 h-5 border-2 border-slate-900/20 border-t-slate-900"></div> Optimizing...';
  loading.classList.remove('hidden');

  showToast('Running mean-variance optimization...', 'info');

  setTimeout(() => {
    loading.classList.add('hidden');
    btn.disabled = false;
    btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Run Optimization';
    showToast('Optimization complete! Sharpe ratio improved by 32%', 'success');
  }, 2000);
}

// Apply optimization - FIXED: correct route
function applyOptimization() {
  const btn = document.getElementById('applyBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner w-5 h-5 border-2 border-slate-900/20 border-t-slate-900"></div> Generating trades...';

  showToast('Generating rebalance trades...', 'info');

  setTimeout(() => {
    window.location.href = '/rebalance';  // FIXED: was /rebalancer
  }, 1500);
}

// Export analysis
function exportAnalysis() {
  showToast('Exporting optimization analysis...', 'info');
  setTimeout(() => showToast('Analysis exported to PDF', 'success'), 1000);
}

// Efficient Frontier Chart with better styling
const frontierData = [];
for (let i = 0; i < 50; i++) {
  const vol = 8 + i * 0.4;
  const ret = 4 + Math.sqrt(vol - 8) * 6;
  frontierData.push({ x: vol, y: ret });
}

new Chart(document.getElementById('frontierChart'), {
  type: 'scatter',
  data: {
    datasets: [
      {
        label: 'Efficient Frontier',
        data: frontierData,
        borderColor: '#0ea5e9',
        backgroundColor: 'rgba(14, 165, 233, 0.1)',
        showLine: true,
        tension: 0.4,
        pointRadius: 0,
        borderWidth: 3,
        fill: true
      },
      {
        label: 'Current Portfolio',
        data: [{ x: 18.5, y: 14.2 }],
        backgroundColor: '#f59e0b',
        borderColor: '#f59e0b',
        pointRadius: 12,
        pointHoverRadius: 14,
        pointStyle: 'circle',
        borderWidth: 3
      },
      {
        label: 'Optimal Portfolio',
        data: [{ x: 16.2, y: 15.8 }],
        backgroundColor: '#10b981',
        borderColor: '#10b981',
        pointRadius: 14,
        pointHoverRadius: 16,
        pointStyle: 'triangle',
        borderWidth: 3
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: 'rgba(15, 23, 42, 0.95)',
        borderColor: '#fbbf24',
        borderWidth: 1,
        titleColor: '#fbbf24',
        bodyColor: '#fff',
        padding: 12,
        displayColors: false,
        callbacks: {
          label: function(ctx) {
            return `Return: ${ctx.parsed.y.toFixed(1)}% | Volatility: ${ctx.parsed.x.toFixed(1)}%`;
          }
        }
      }
    },
    scales: {
      x: {
        title: { display: true, text: 'Volatility (%)', color: '#94a3b8', font: { family: 'monospace' } },
        min: 5, max: 30,
        grid: { color: 'rgba(148, 163, 184, 0.1)' },
        ticks: { color: '#64748b', font: { family: 'monospace' } }
      },
      y: {
        title: { display: true, text: 'Expected Return (%)', color: '#94a3b8', font: { family: 'monospace' } },
        min: 0, max: 25,
        grid: { color: 'rgba(148, 163, 184, 0.1)' },
        ticks: { color: '#64748b', font: { family: 'monospace' } }
      }
    }
  }
});

// Allocation Chart with better colors
new Chart(document.getElementById('allocationChart'), {
  type: 'doughnut',
  data: {
    labels: ['BND', 'AAPL', 'MSFT', 'GLD', 'GOOGL', 'AMZN', 'NVDA', 'META'],
    datasets: [{
      data: [23, 18, 15, 15, 10, 10, 5, 4],
      backgroundColor: [
        '#0ea5e9', // BND - sky
        '#f59e0b', // AAPL - amber
        '#8b5cf6', // MSFT - purple
        '#eab308', // GLD - yellow
        '#10b981', // GOOGL - emerald
        '#ef4444', // AMZN - red
        '#06b6d4', // NVDA - cyan
        '#ec4899'  // META - pink
      ],
      borderWidth: 0,
      hoverOffset: 8
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '65%',
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: 'rgba(15, 23, 42, 0.95)',
        borderColor: '#fbbf24',
        borderWidth: 1,
        titleColor: '#fbbf24',
        bodyColor: '#fff',
        padding: 12,
        callbacks: {
          label: function(ctx) {
            return `${ctx.label}: ${ctx.parsed}%`;
          }
        }
      }
    }
  }
});

// Hide loading overlay once charts are rendered
document.addEventListener('DOMContentLoaded', function() {
  const loader = document.getElementById('chartLoading');
  if (loader) {
    loader.classList.add('hidden');
  }
});
</script>

<%- include('../partials/footer') %>
