<%- include('../partials/header', { pageTitle: 'Edit Holding' }) %>
<%
  // Ensure all variables have defaults
  const safeHolding = typeof holding !== 'undefined' && holding ? holding : {};
  const safePortfolio = typeof portfolio !== 'undefined' && portfolio ? portfolio : {};

  // Holding details with defaults
  const symbol = safeHolding.symbol || 'UNKNOWN';
  const name = safeHolding.name || safeHolding.company_name || 'Unknown Asset';
  const exchange = safeHolding.exchange || 'NYSE';
  const quantity = safeHolding.shares || safeHolding.quantity || 0;
  const purchasePrice = safeHolding.avgCost || safeHolding.avg_cost_basis || safeHolding.purchase_price || 0;
  const purchaseDate = safeHolding.purchase_date || safeHolding.purchaseDate || '';
  const notes = safeHolding.notes || '';
  const currentPrice = safeHolding.currentPrice || safeHolding.price || 0;
  const totalCost = quantity * purchasePrice;

  // Portfolio details
  const portfolioName = safePortfolio.name || 'My Portfolio';
  const portfolioId = safePortfolio.id || safeHolding.portfolio_id || '';
  const holdingId = safeHolding.id || '';

  // Format date for input
  const formattedDate = purchaseDate ? new Date(purchaseDate).toISOString().split('T')[0] : '';
%>

<main class="flex-1 overflow-y-auto bg-background-dark">
  <div class="max-w-[1200px] mx-auto w-full p-4 md:p-8 lg:p-12">

    <!-- Breadcrumbs -->
    <nav aria-label="Breadcrumb" class="flex mb-8">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a class="inline-flex items-center text-sm font-medium text-text-secondary hover:text-white transition-colors" href="/portfolios">
            Portfolios
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <span class="material-symbols-outlined text-text-secondary text-lg mx-1">chevron_right</span>
            <a class="text-sm font-medium text-text-secondary hover:text-white transition-colors" href="/portfolios/<%= portfolioId %>"><%= portfolioName %></a>
          </div>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <span class="material-symbols-outlined text-text-secondary text-lg mx-1">chevron_right</span>
            <span class="text-sm font-medium text-white">Edit <%= symbol %></span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Page Heading -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight mb-2">Edit Holding</h1>
        <p class="text-text-secondary text-base">Modify details for <span class="text-white font-medium"><%= name %> (<%= symbol %>)</span> in '<%= portfolioName %>'</p>
      </div>
      <div class="flex items-center gap-2 bg-primary/10 px-3 py-1.5 rounded-full border border-primary/20">
        <span class="material-symbols-outlined text-primary text-sm">folder_open</span>
        <span class="text-primary text-sm font-medium"><%= portfolioName %></span>
      </div>
    </div>

    <!-- Form Container -->
    <form id="editHoldingForm" action="/api/holdings/<%= holdingId %>" method="POST">
      <input type="hidden" name="portfolioId" value="<%= portfolioId %>">
      <input type="hidden" name="holdingId" value="<%= holdingId %>">
      <input type="hidden" name="symbol" value="<%= symbol %>">

      <div class="bg-card-dark rounded-xl border border-border-dark overflow-hidden shadow-xl max-w-4xl">

        <!-- Form Header with Context -->
        <div class="border-b border-border-dark bg-[#292a38]/50 px-6 py-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="bg-white p-1.5 rounded-lg h-10 w-10 flex items-center justify-center shrink-0">
              <span class="material-symbols-outlined text-black">trending_up</span>
            </div>
            <div>
              <h3 class="text-white font-bold text-lg leading-none"><%= name %></h3>
              <span class="text-text-secondary text-xs font-mono"><%= exchange %>: <%= symbol %></span>
            </div>
          </div>
          <div class="text-right hidden sm:block">
            <p class="text-text-secondary text-xs mb-1">Current Market Price</p>
            <p class="text-white font-mono font-bold text-lg">$<%= currentPrice.toFixed(2) %></p>
          </div>
        </div>

        <!-- Main Form Fields -->
        <div class="p-6 md:p-8 space-y-8">

          <!-- Section 1: Asset Identification -->
          <div class="grid grid-cols-1 gap-6">
            <div class="flex flex-col gap-2">
              <label class="text-white text-sm font-semibold">Asset Symbol/Name (Read-only)</label>
              <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="material-symbols-outlined text-text-secondary">token</span>
                </div>
                <input
                  class="w-full bg-[#292a38] text-text-secondary border border-border-dark rounded-lg pl-10 pr-10 py-3 focus:outline-none focus:ring-0 cursor-not-allowed font-mono opacity-70"
                  readonly
                  type="text"
                  value="<%= symbol %> - <%= name %>"
                />
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                  <span class="material-symbols-outlined text-text-secondary text-xl">lock</span>
                </div>
              </div>
              <p class="text-xs text-text-secondary">Asset identity cannot be changed. Delete and re-add if incorrect.</p>
            </div>
          </div>

          <hr class="border-border-dark border-dashed"/>

          <!-- Section 2: Transaction Details -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- Quantity -->
            <div class="flex flex-col gap-2">
              <label class="text-white text-sm font-semibold" for="quantity">Quantity</label>
              <div class="relative">
                <input
                  class="w-full bg-background-dark text-white border border-border-dark rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary transition-all placeholder:text-text-secondary/50 font-mono"
                  id="quantity"
                  name="quantity"
                  step="0.0001"
                  type="number"
                  value="<%= quantity.toFixed(4) %>"
                  required
                />
              </div>
            </div>

            <!-- Purchase Price -->
            <div class="flex flex-col gap-2">
              <label class="text-white text-sm font-semibold" for="price">Purchase Price ($)</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="text-text-secondary font-bold">$</span>
                </div>
                <input
                  class="w-full bg-background-dark text-white border border-border-dark rounded-lg pl-8 pr-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary transition-all placeholder:text-text-secondary/50 font-mono"
                  id="price"
                  name="purchasePrice"
                  step="0.01"
                  type="number"
                  value="<%= purchasePrice.toFixed(2) %>"
                  required
                />
              </div>
            </div>

            <!-- Purchase Date -->
            <div class="flex flex-col gap-2">
              <label class="text-white text-sm font-semibold" for="date">Purchase Date</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="material-symbols-outlined text-text-secondary text-lg">calendar_today</span>
                </div>
                <input
                  class="w-full bg-background-dark text-white border border-border-dark rounded-lg pl-10 pr-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary transition-all placeholder:text-text-secondary/50 [color-scheme:dark]"
                  id="date"
                  name="purchaseDate"
                  type="date"
                  value="<%= formattedDate %>"
                />
              </div>
            </div>

            <!-- Total Cost (Computed) -->
            <div class="flex flex-col gap-2">
              <label class="text-white text-sm font-semibold">Total Cost Basis (Est.)</label>
              <div class="w-full bg-[#292a38]/30 text-white border border-border-dark/50 rounded-lg px-4 py-3 flex items-center justify-between">
                <span id="totalCost" class="font-mono text-lg font-medium">$<%= totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                <span class="material-symbols-outlined text-green-500 text-sm" title="Auto-calculated">calculate</span>
              </div>
            </div>
          </div>

          <!-- Section 3: Notes -->
          <div class="flex flex-col gap-2">
            <label class="text-white text-sm font-semibold" for="notes">
              Notes <span class="text-text-secondary font-normal text-xs ml-1">(Optional)</span>
            </label>
            <textarea
              class="w-full bg-background-dark text-white border border-border-dark rounded-lg p-4 focus:border-primary focus:ring-1 focus:ring-primary transition-all placeholder:text-text-secondary/50 resize-none text-sm"
              id="notes"
              name="notes"
              placeholder="Add any relevant details about this holding strategy..."
              rows="4"
            ><%= notes %></textarea>
          </div>
        </div>

        <!-- Action Footer -->
        <div class="bg-[#292a38]/30 px-6 py-4 flex flex-col-reverse sm:flex-row sm:items-center sm:justify-end gap-3 border-t border-border-dark">
          <a
            href="/portfolios/<%= portfolioId %>"
            class="px-6 py-2.5 rounded-lg border border-border-dark text-white hover:bg-white/5 font-medium transition-colors w-full sm:w-auto text-sm text-center"
          >
            Cancel
          </a>
          <button
            type="submit"
            class="px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white font-medium shadow-lg shadow-primary/20 transition-all w-full sm:w-auto text-sm flex items-center justify-center gap-2"
          >
            <span class="material-symbols-outlined text-lg">save</span>
            Save Changes
          </button>
        </div>
      </div>
    </form>

    <!-- Helper Info -->
    <div class="mt-6 flex items-start gap-3 max-w-4xl px-2">
      <span class="material-symbols-outlined text-text-secondary mt-0.5">info</span>
      <p class="text-text-secondary text-sm leading-relaxed">
        Updating historical purchase data may affect your realized/unrealized gain calculations. Ensure dates and prices account for any stock splits or dividends if applicable.
      </p>
    </div>

  </div>
</main>

<script>
  // Calculate total cost dynamically
  const quantityInput = document.getElementById('quantity');
  const priceInput = document.getElementById('price');
  const totalCostEl = document.getElementById('totalCost');

  function updateTotalCost() {
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = quantity * price;
    totalCostEl.textContent = '$' + total.toLocaleString('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  quantityInput.addEventListener('input', updateTotalCost);
  priceInput.addEventListener('input', updateTotalCost);

  // Form submission handler
  document.getElementById('editHoldingForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {
      portfolioId: formData.get('portfolioId'),
      symbol: formData.get('symbol'),
      quantity: parseFloat(formData.get('quantity')),
      purchasePrice: parseFloat(formData.get('purchasePrice')),
      purchaseDate: formData.get('purchaseDate'),
      notes: formData.get('notes')
    };

    const holdingId = formData.get('holdingId');

    try {
      const response = await fetch(`/api/holdings/${holdingId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (response.ok) {
        showToast('Holding updated successfully', 'success');
        setTimeout(() => {
          window.location.href = `/portfolios/${data.portfolioId}`;
        }, 1000);
      } else {
        showToast(result.error || 'Failed to update holding', 'error');
      }
    } catch (error) {
      console.error('Error updating holding:', error);
      showToast('An error occurred while updating the holding', 'error');
    }
  });
</script>

<!-- Stitch Design Custom Styles for Edit Holding -->
<style>
  /* Ensure the form inputs match the Stitch design */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input[type="number"] {
    -moz-appearance: textfield;
  }

  /* Date input styling for dark theme */
  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
  }

  /* Focus states with primary color */
  input:focus, textarea:focus {
    outline: none;
    border-color: #4850e5 !important;
    box-shadow: 0 0 0 1px #4850e5;
  }

  /* Smooth transitions */
  input, textarea, button, a {
    transition: all 0.2s ease;
  }
</style>

<%- include('../partials/footer') %>
