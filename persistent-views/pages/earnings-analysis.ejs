<%
// Safe defaults
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const e = earnings || {};
const quote = e.quote || {};
const price = quote.price || e.currentPrice || 0;
const change = quote.change || 0;
const changePct = quote.changePct || e.changePercent || 0;
const companyName = e.companyName || quote.name || symbol;
const sector = e.sector || 'N/A';
const industry = e.industry || 'N/A';

// Earnings data
const history = e.history || [];
const estimates = e.estimates || {};
const nextEarnings = e.nextEarningsDate || estimates.nextDate || '';
const daysToEarnings = e.daysToEarnings || 0;
const lastEps = e.lastEps || (history.length > 0 ? history[0].actual : 0);
const lastEstimate = e.lastEstimate || (history.length > 0 ? history[0].estimate : 0);
const lastSurprise = lastEps - lastEstimate;
const nextEpsEstimate = estimates.epsEstimate || e.nextEpsEstimate || 0;

// Calculate beat rate
const beatsCount = history.filter(h => h.actual > h.estimate).length;
const beatRate = history.length > 0 ? (beatsCount / history.length * 100) : 0;

// Calculate average surprise
const avgSurprise = history.length > 0
  ? history.reduce((sum, h) => sum + ((h.actual - h.estimate) / h.estimate * 100), 0) / history.length
  : 0;

// Revenue breakdown
const revenueBreakdown = e.revenueBreakdown || [];
const revisions = e.revisions || { up: 0, down: 0, unchanged: 0 };

// Helper functions
function formatPrice(v) { return '$' + (v || 0).toFixed(2); }
function formatPct(v) { return (v >= 0 ? '+' : '') + (v || 0).toFixed(1) + '%'; }
function formatEps(v) { return '$' + (v || 0).toFixed(2); }
function formatRevenue(v) {
  if (!v) return '$0';
  if (v >= 1e12) return '$' + (v / 1e12).toFixed(1) + 'T';
  if (v >= 1e9) return '$' + (v / 1e9).toFixed(1) + 'B';
  if (v >= 1e6) return '$' + (v / 1e6).toFixed(1) + 'M';
  return '$' + v.toFixed(0);
}
%>
<%- include('../partials/header', { pageTitle: 'Earnings Analysis' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-amber-400">EARNINGS ANALYSIS</h1>
      <p class="text-slate-400">EPS history, estimates & surprises</p>
    </div>
    <form method="GET" action="/earnings-analysis" class="flex gap-2">
      <input type="text" name="symbol" value="<%= symbol || 'AAPL' %>" class="form-input w-28 font-mono uppercase">
      <button type="submit" class="bloomberg-btn bloomberg-btn-primary">ANALYZE</button>
    </form>
  </div>
</div>

<% if (!earnings) { %>
<div class="bloomberg-card text-center py-12">
  <p class="text-amber-400 text-lg">No earnings data available for <%= symbol %></p>
  <p class="text-slate-400 mt-2">Try a different symbol or check if earnings data is available.</p>
</div>
<% } else { %>

<!-- Company Header -->
<div class="bloomberg-card p-5 border-l-4 border-amber-400">
  <div class="flex items-center gap-4">
    <div class="w-16 h-16 rounded bg-slate-700 flex items-center justify-center text-white font-bold text-2xl"><%= symbol %></div>
    <div class="flex-1">
      <h2 class="text-xl font-bold text-amber-400"><%= companyName %></h2>
      <p class="text-slate-400 text-sm"><%= sector %> • <%= industry %></p>
    </div>
    <div class="text-right">
      <p class="text-3xl font-bold font-mono tabular-nums text-white"><%= formatPrice(price) %></p>
      <p class="<%= changePct >= 0 ? 'positive' : 'negative' %> font-medium font-mono tabular-nums"><%= formatPct(changePct) %> TODAY</p>
    </div>
  </div>
</div>

<!-- Earnings Summary -->
<div class="grid grid-cols-1 md:grid-cols-5 gap-4">
  <div class="tufte-stat-card">
    <p class="text-slate-400 text-xs uppercase tracking-wider">LAST EPS</p>
    <p class="text-2xl font-bold font-mono tabular-nums <%= lastSurprise >= 0 ? 'positive' : 'negative' %>"><%= formatEps(lastEps) %></p>
    <p class="text-xs <%= lastSurprise >= 0 ? 'positive' : 'negative' %> uppercase">
      <%= lastSurprise >= 0 ? 'BEAT BY ' : 'MISSED BY ' %><%= formatEps(Math.abs(lastSurprise)) %>
    </p>
  </div>
  <div class="tufte-stat-card">
    <p class="text-slate-400 text-xs uppercase tracking-wider">NEXT EARNINGS</p>
    <p class="text-2xl font-bold font-mono tabular-nums text-white"><%= nextEarnings || 'TBD' %></p>
    <p class="text-xs text-slate-400 uppercase"><%= daysToEarnings > 0 ? daysToEarnings + ' DAYS AWAY' : 'DATE TBD' %></p>
  </div>
  <div class="tufte-stat-card">
    <p class="text-slate-400 text-xs uppercase tracking-wider">EPS EST.</p>
    <p class="text-2xl font-bold font-mono tabular-nums text-white"><%= formatEps(nextEpsEstimate) %></p>
    <p class="text-xs text-slate-400 uppercase">NEXT QUARTER</p>
  </div>
  <div class="tufte-stat-card">
    <p class="text-slate-400 text-xs uppercase tracking-wider">BEAT RATE</p>
    <p class="text-2xl font-bold font-mono tabular-nums <%= beatRate >= 70 ? 'positive' : beatRate >= 50 ? 'text-slate-400' : 'negative' %>"><%= beatRate.toFixed(1) %>%</p>
    <p class="text-xs text-slate-400 uppercase">LAST <%= history.length %> QUARTERS</p>
  </div>
  <div class="tufte-stat-card">
    <p class="text-slate-400 text-xs uppercase tracking-wider">AVG SURPRISE</p>
    <p class="text-2xl font-bold font-mono tabular-nums <%= avgSurprise >= 0 ? 'positive' : 'negative' %>"><%= formatPct(avgSurprise) %></p>
    <p class="text-xs text-slate-400 uppercase"><%= avgSurprise >= 0 ? 'ABOVE' : 'BELOW' %> ESTIMATES</p>
  </div>
</div>

<!-- EPS History Chart -->
<div class="bloomberg-card p-5">
  <h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide">QUARTERLY EPS HISTORY</h3>
  <div class="h-72"><canvas id="epsChart"></canvas></div>
  <div class="flex justify-center gap-6 mt-4 text-sm">
    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span><span class="text-slate-400 uppercase text-xs">ACTUAL EPS</span></span>
    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-sky-500"></span><span class="text-slate-400 uppercase text-xs">ESTIMATED EPS</span></span>
  </div>
</div>

<!-- Earnings History Table -->
<div class="bloomberg-card overflow-hidden">
  <div class="p-4 border-b border-amber-400/30">
    <h3 class="font-semibold text-amber-400 uppercase tracking-wide">EARNINGS HISTORY</h3>
  </div>
  <% if (history.length > 0) { %>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="bg-slate-800/50 text-slate-400 text-left">
          <th class="px-4 py-3 uppercase text-xs tracking-wider">QUARTER</th>
          <th class="px-4 py-3 text-center uppercase text-xs tracking-wider">REPORT DATE</th>
          <th class="px-4 py-3 text-center uppercase text-xs tracking-wider">EPS EST.</th>
          <th class="px-4 py-3 text-center uppercase text-xs tracking-wider">EPS ACTUAL</th>
          <th class="px-4 py-3 text-center uppercase text-xs tracking-wider">SURPRISE</th>
          <th class="px-4 py-3 text-center uppercase text-xs tracking-wider">REVENUE</th>
          <th class="px-4 py-3 text-center uppercase text-xs tracking-wider">STOCK MOVE</th>
        </tr>
      </thead>
      <tbody class="text-white">
        <% history.slice(0, 8).forEach(h => {
          const surprise = h.estimate > 0 ? ((h.actual - h.estimate) / h.estimate * 100) : 0;
          const beat = h.actual >= h.estimate;
        %>
        <tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
          <td class="px-4 py-3 font-medium"><%= h.quarter || h.period %></td>
          <td class="px-4 py-3 text-center text-slate-400"><%= h.reportDate || h.date || '-' %></td>
          <td class="px-4 py-3 text-center font-mono"><%= formatEps(h.estimate) %></td>
          <td class="px-4 py-3 text-center font-bold font-mono <%= beat ? 'text-emerald-400' : 'text-red-400' %>"><%= formatEps(h.actual) %></td>
          <td class="px-4 py-3 text-center">
            <span class="px-2 py-1 rounded bg-<%= beat ? 'emerald' : 'red' %>-500/20 text-<%= beat ? 'emerald' : 'red' %>-400 text-xs font-mono">
              <%= formatPct(surprise) %>
            </span>
          </td>
          <td class="px-4 py-3 text-center font-mono"><%= formatRevenue(h.revenue) %></td>
          <td class="px-4 py-3 text-center font-mono <%= (h.stockMove || 0) >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
            <%= formatPct(h.stockMove || 0) %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  <% } else { %>
  <p class="text-center text-slate-400 py-8">No earnings history available</p>
  <% } %>
</div>

<!-- Revenue Breakdown & Analyst Revisions -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bloomberg-card p-5">
    <h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide">REVENUE BY SEGMENT</h3>
    <% if (revenueBreakdown.length > 0) { %>
    <div class="h-48"><canvas id="revenueChart"></canvas></div>
    <% } else { %>
    <div class="h-48 flex items-center justify-center text-slate-400">No segment data available</div>
    <% } %>
  </div>
  <div class="bloomberg-card p-5">
    <h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide">ANALYST REVISIONS (30 DAYS)</h3>
    <div class="space-y-3">
      <div class="flex items-center justify-between p-3 rounded bg-emerald-500/10 border border-emerald-500/20">
        <span class="text-slate-300 uppercase text-sm tracking-wide">UPWARD REVISIONS</span>
        <span class="text-xl font-bold font-mono text-emerald-400"><%= revisions.up || 0 %></span>
      </div>
      <div class="flex items-center justify-between p-3 rounded bg-red-500/10 border border-red-500/20">
        <span class="text-slate-300 uppercase text-sm tracking-wide">DOWNWARD REVISIONS</span>
        <span class="text-xl font-bold font-mono text-red-400"><%= revisions.down || 0 %></span>
      </div>
      <div class="flex items-center justify-between p-3 rounded bg-slate-800 border border-slate-700">
        <span class="text-slate-300 uppercase text-sm tracking-wide">NO CHANGE</span>
        <span class="text-xl font-bold font-mono text-white"><%= revisions.unchanged || 0 %></span>
      </div>
    </div>
    <%
      const totalRevisions = (revisions.up || 0) + (revisions.down || 0) + (revisions.unchanged || 0);
      const revisionSentiment = totalRevisions > 0 ? ((revisions.up - revisions.down) / totalRevisions) : 0;
    %>
    <div class="mt-4 p-3 rounded-lg bg-<%= revisionSentiment > 0.2 ? 'emerald' : revisionSentiment < -0.2 ? 'red' : 'amber' %>-500/10">
      <p class="text-sm text-<%= revisionSentiment > 0.2 ? 'emerald' : revisionSentiment < -0.2 ? 'red' : 'amber' %>-400 font-medium">
        <%= revisionSentiment > 0.2 ? 'Positive revision momentum' : revisionSentiment < -0.2 ? 'Negative revision momentum' : 'Mixed analyst sentiment' %>
      </p>
    </div>
  </div>
</div>

<!-- Trading Signal -->
<div class="bloomberg-card p-5">
  <h3 class="font-semibold text-amber-400 mb-4 uppercase tracking-wide">EARNINGS TRADING SIGNAL</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <%
      const earningsSignal = beatRate >= 70 && avgSurprise > 3 ? 'Bullish' : beatRate < 50 ? 'Bearish' : 'Neutral';
      const signalColor = earningsSignal === 'Bullish' ? 'emerald' : earningsSignal === 'Bearish' ? 'red' : 'amber';
    %>
    <div class="p-4 rounded-lg bg-<%= signalColor %>-500/10 border border-<%= signalColor %>-500/20 text-center">
      <p class="text-sm text-slate-400 mb-2">Earnings Track Record</p>
      <p class="text-2xl font-bold text-<%= signalColor %>-400"><%= earningsSignal %></p>
      <p class="text-xs text-slate-500 mt-1"><%= beatRate.toFixed(0) %>% beat rate, <%= formatPct(avgSurprise) %> avg surprise</p>
    </div>
    <div class="p-4 rounded-lg bg-slate-800 text-center">
      <p class="text-sm text-slate-400 mb-2">Historical Post-Earnings Move</p>
      <%
        const avgMove = history.length > 0 ? history.reduce((sum, h) => sum + Math.abs(h.stockMove || 0), 0) / history.length : 0;
      %>
      <p class="text-2xl font-bold text-white font-mono">±<%= avgMove.toFixed(1) %>%</p>
      <p class="text-xs text-slate-500 mt-1">Average absolute move</p>
    </div>
    <div class="p-4 rounded-lg bg-slate-800 text-center">
      <p class="text-sm text-slate-400 mb-2">Next Earnings Play</p>
      <p class="text-lg font-bold text-amber-400"><%= daysToEarnings > 30 ? 'Wait for closer date' : daysToEarnings > 0 ? 'Consider options strategy' : 'Check next date' %></p>
      <p class="text-xs text-slate-500 mt-1"><%= daysToEarnings > 0 ? daysToEarnings + ' days to earnings' : 'Date TBD' %></p>
    </div>
  </div>
</div>
<% } %>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
<% if (earnings && history.length > 0) { %>
const historyData = <%- JSON.stringify(history.slice(0, 8).reverse()) %>;

new Chart(document.getElementById('epsChart'), {
  type: 'bar',
  data: {
    labels: historyData.map(h => h.quarter || h.period),
    datasets: [
      {
        label: 'Actual',
        data: historyData.map(h => h.actual),
        backgroundColor: '#10b981',
        borderRadius: 4
      },
      {
        label: 'Estimate',
        data: historyData.map(h => h.estimate),
        backgroundColor: '#0ea5e9',
        borderRadius: 4
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: { color: '#94a3b8', font: { family: 'monospace' } }
      }
    },
    scales: {
      y: {
        grid: { color: '#1e293b' },
        ticks: { color: '#94a3b8', font: { family: 'monospace' }, callback: v => '$' + v.toFixed(2) }
      },
      x: {
        grid: { display: false },
        ticks: { color: '#94a3b8', font: { family: 'monospace' } }
      }
    }
  }
});

<% if (revenueBreakdown.length > 0) { %>
const revenueData = <%- JSON.stringify(revenueBreakdown) %>;
new Chart(document.getElementById('revenueChart'), {
  type: 'doughnut',
  data: {
    labels: revenueData.map(r => r.segment || r.name),
    datasets: [{
      data: revenueData.map(r => r.value || r.percentage),
      backgroundColor: ['#0ea5e9','#8b5cf6','#10b981','#f59e0b','#ef4444','#ec4899','#06b6d4','#14b8a6']
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: { color: '#94a3b8', font: { family: 'monospace', size: 10 } }
      }
    }
  }
});
<% } %>
<% } %>
</script>
<%- include('../partials/footer') %>
