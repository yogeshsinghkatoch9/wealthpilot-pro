<%- include('../partials/header', { pageTitle: 'Manage Holdings' }) %>
<%
  // Safe defaults
  const safeHoldings = typeof holdings !== 'undefined' && holdings ? holdings : [];
  const safeTotals = typeof totals !== 'undefined' && totals ? totals : { marketValue: 0, costTotal: 0, gain: 0 };
  const safePortfolios = typeof portfolios !== 'undefined' && portfolios ? portfolios : [];

  // Pagination defaults
  const currentPage = typeof page !== 'undefined' ? page : 1;
  const itemsPerPage = typeof limit !== 'undefined' ? limit : 10;
  const totalHoldings = typeof totalCount !== 'undefined' ? totalCount : safeHoldings.length;
  const totalPages = Math.ceil(totalHoldings / itemsPerPage);
  const startItem = (currentPage - 1) * itemsPerPage + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalHoldings);
%>

<!-- Custom Stitch Theme Styles for Holdings Page -->
<style>
  /* Stitch Design System Colors */
  :root {
    --stitch-primary: #4850e5;
    --stitch-primary-hover: #3a42d1;
    --stitch-bg-dark: #111221;
    --stitch-surface-dark: #1c1d26;
    --stitch-surface-highlight: #292a38;
    --stitch-border-dark: #3d3e52;
    --stitch-text-secondary: #9e9fb7;
  }

  /* Material Symbols configuration */
  .material-symbols-outlined {
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  }
  .material-symbols-outlined.fill {
    font-variation-settings: 'FILL' 1;
  }

  /* Page background */
  .holdings-page {
    background: var(--stitch-bg-dark);
    min-height: 100vh;
  }

  /* Header section */
  .holdings-header {
    background: var(--stitch-bg-dark);
    border-bottom: 1px solid var(--stitch-border-dark);
    padding: 1.5rem 2rem;
  }

  /* Controls section */
  .holdings-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
  }

  /* Select dropdown styling */
  .stitch-select {
    appearance: none;
    background: var(--stitch-surface-highlight);
    color: white;
    border: 1px solid var(--stitch-border-dark);
    border-radius: 0.5rem;
    padding: 0.75rem 2.5rem 0.75rem 1rem;
    font-size: 0.875rem;
    transition: all 0.2s;
    cursor: pointer;
  }
  .stitch-select:hover {
    border-color: rgba(72, 80, 229, 0.5);
  }
  .stitch-select:focus {
    outline: none;
    border-color: var(--stitch-primary);
    box-shadow: 0 0 0 2px rgba(72, 80, 229, 0.2);
  }

  /* Input styling */
  .stitch-input {
    background: var(--stitch-surface-highlight);
    color: white;
    border: 1px solid var(--stitch-border-dark);
    border-radius: 0.5rem;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    font-size: 0.875rem;
    transition: all 0.2s;
    width: 100%;
  }
  .stitch-input:hover {
    border-color: rgba(72, 80, 229, 0.5);
  }
  .stitch-input:focus {
    outline: none;
    border-color: var(--stitch-primary);
    box-shadow: 0 0 0 2px rgba(72, 80, 229, 0.2);
  }
  .stitch-input::placeholder {
    color: var(--stitch-text-secondary);
  }

  /* Button styling */
  .stitch-btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: var(--stitch-primary);
    color: white;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 700;
    transition: all 0.2s;
    box-shadow: 0 4px 14px rgba(72, 80, 229, 0.2);
    border: none;
    cursor: pointer;
  }
  .stitch-btn-primary:hover {
    background: #3a42d1;
    box-shadow: 0 6px 20px rgba(72, 80, 229, 0.3);
  }

  .stitch-btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: var(--stitch-surface-highlight);
    color: white;
    border: 1px solid var(--stitch-border-dark);
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
  }
  .stitch-btn-secondary:hover {
    background: var(--stitch-border-dark);
  }

  /* Table container */
  .stitch-table-container {
    background: var(--stitch-surface-dark);
    border: 1px solid var(--stitch-border-dark);
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
  }

  /* Table styling */
  .stitch-table {
    width: 100%;
    min-width: 1000px;
    border-collapse: collapse;
  }

  .stitch-table thead tr {
    background: var(--stitch-surface-highlight);
    border-bottom: 1px solid var(--stitch-border-dark);
  }

  .stitch-table th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--stitch-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stitch-table th.text-right {
    text-align: right;
  }

  .stitch-table th.text-center {
    text-align: center;
  }

  .stitch-table tbody tr {
    border-bottom: 1px solid var(--stitch-border-dark);
    transition: background 0.15s;
  }

  .stitch-table tbody tr:hover {
    background: rgba(41, 42, 56, 0.5);
  }

  .stitch-table tbody tr:last-child {
    border-bottom: none;
  }

  .stitch-table td {
    padding: 1rem 1.5rem;
    white-space: nowrap;
  }

  /* Asset cell */
  .asset-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .asset-logo {
    width: 2rem;
    height: 2rem;
    border-radius: 9999px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding: 0.125rem;
    flex-shrink: 0;
  }

  .asset-logo-inner {
    width: 100%;
    height: 100%;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    font-weight: 700;
    color: white;
  }

  .asset-info {
    display: flex;
    flex-direction: column;
  }

  .asset-symbol {
    color: white;
    font-size: 0.875rem;
    font-weight: 700;
  }

  .asset-name {
    color: var(--stitch-text-secondary);
    font-size: 0.75rem;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Numeric values */
  .value-cell {
    text-align: right;
    font-family: 'JetBrains Mono', monospace;
  }

  .value-white {
    color: white;
  }

  .value-muted {
    color: var(--stitch-text-secondary);
  }

  .value-bold {
    font-weight: 700;
  }

  .value-medium {
    font-weight: 500;
  }

  /* Change indicators */
  .change-positive {
    color: #34d399;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.25rem;
  }

  .change-negative {
    color: #fb7185;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.25rem;
  }

  /* Actions */
  .action-buttons {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .stitch-table tbody tr:hover .action-buttons {
    opacity: 1;
  }

  .action-btn {
    width: 2rem;
    height: 2rem;
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--stitch-text-secondary);
    transition: all 0.15s;
    background: transparent;
    border: none;
    cursor: pointer;
  }

  .action-btn:hover {
    background: var(--stitch-surface-highlight);
  }

  .action-btn.edit:hover {
    color: var(--stitch-primary);
  }

  .action-btn.delete:hover {
    color: #f87171;
  }

  /* Pagination */
  .stitch-pagination {
    background: var(--stitch-surface-highlight);
    border-top: 1px solid var(--stitch-border-dark);
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .pagination-info {
    font-size: 0.75rem;
    color: var(--stitch-text-secondary);
  }

  .pagination-info span {
    color: white;
    font-weight: 500;
  }

  .pagination-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .pagination-btn {
    padding: 0.25rem 0.75rem;
    background: var(--stitch-surface-dark);
    border: 1px solid var(--stitch-border-dark);
    border-radius: 0.25rem;
    color: var(--stitch-text-secondary);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .pagination-btn:hover:not(:disabled) {
    color: white;
    border-color: var(--stitch-primary);
  }

  .pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Empty state */
  .empty-state {
    padding: 4rem 2rem;
    text-align: center;
  }

  .empty-icon {
    width: 5rem;
    height: 5rem;
    margin: 0 auto 1.5rem;
    border-radius: 1rem;
    background: linear-gradient(135deg, rgba(71, 85, 105, 0.5), rgba(30, 41, 59, 0.5));
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--stitch-border-dark);
  }

  .empty-icon .material-symbols-outlined {
    font-size: 2.5rem;
    color: #64748b;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .holdings-header {
      padding: 1rem;
    }

    .holdings-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .stitch-table td,
    .stitch-table th {
      padding: 0.75rem 1rem;
    }
  }
</style>

<main class="holdings-page">
  <!-- Header Section -->
  <header class="holdings-header">
    <div class="max-w-[1400px] mx-auto">
      <div class="flex flex-wrap justify-between items-end gap-4">
        <div class="flex flex-col gap-1">
          <h2 class="text-3xl font-black tracking-tight text-white">Manage Holdings</h2>
          <p class="text-[#9e9fb7] text-base">View, edit, and track your portfolio performance across all assets.</p>
        </div>
        <button onclick="openAddHoldingModal()" class="stitch-btn-primary">
          <span class="material-symbols-outlined text-[20px]">add_circle</span>
          <span>Add New Holding</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Scrollable Content Area -->
  <div class="px-8 py-8 overflow-y-auto">
    <div class="max-w-[1400px] mx-auto flex flex-col gap-6">

      <!-- Controls: Filter & Search -->
      <div class="flex flex-col md:flex-row gap-4 items-stretch md:items-end">
        <!-- Portfolio Selector -->
        <div class="w-full md:w-64">
          <label class="block text-[#9e9fb7] text-xs font-bold uppercase tracking-wider mb-2">Select Portfolio</label>
          <div class="relative">
            <select id="portfolioFilter" onchange="filterByPortfolio(this.value)" class="stitch-select w-full">
              <option value="all">All Portfolios</option>
              <% safePortfolios.forEach(p => { %>
              <option value="<%= p.id %>"><%= p.name %></option>
              <% }) %>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-[#9e9fb7]">
              <span class="material-symbols-outlined">expand_more</span>
            </div>
          </div>
        </div>

        <!-- Search Bar -->
        <div class="flex-1">
          <label class="block text-[#9e9fb7] text-xs font-bold uppercase tracking-wider mb-2">Search Assets</label>
          <div class="relative w-full">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="material-symbols-outlined text-[#9e9fb7]">search</span>
            </div>
            <input type="text" id="searchInput" onkeyup="searchHoldings(this.value)"
                   class="stitch-input" placeholder="Search holdings by symbol, name, or ISIN...">
          </div>
        </div>

        <!-- Filters Button -->
        <div>
          <button class="stitch-btn-secondary h-[46px]" onclick="toggleFilters()">
            <span class="material-symbols-outlined text-[#9e9fb7]">filter_list</span>
            <span>Filters</span>
          </button>
        </div>
      </div>

      <!-- Data Table -->
      <div class="stitch-table-container">
        <% if (safeHoldings.length === 0) { %>
          <!-- Empty State -->
          <div class="empty-state">
            <div class="empty-icon">
              <span class="material-symbols-outlined">inventory_2</span>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">No Holdings Yet</h3>
            <p class="text-[#9e9fb7] mb-8 max-w-md mx-auto">Get started by adding stocks manually or uploading a portfolio file from your broker</p>
            <div class="flex justify-center gap-4">
              <button onclick="openAddHoldingModal()" class="stitch-btn-primary">
                <span class="material-symbols-outlined text-[20px]">add_circle</span>
                Add Holding
              </button>
              <button onclick="openUploadModal()" class="stitch-btn-secondary">
                <span class="material-symbols-outlined text-[20px]">cloud_upload</span>
                Upload Portfolio
              </button>
            </div>
          </div>
        <% } else { %>
          <div class="overflow-x-auto">
            <table class="stitch-table" id="holdingsTable">
              <thead>
                <tr>
                  <th style="width: 240px;">Asset</th>
                  <th class="text-right">Quantity</th>
                  <th class="text-right">Avg Cost</th>
                  <th class="text-right">Price</th>
                  <th class="text-right">Market Value</th>
                  <th class="text-right">Daily Change</th>
                  <th class="text-right">Total Return</th>
                  <th class="text-center" style="width: 96px;">Actions</th>
                </tr>
              </thead>
              <tbody id="holdingsBody">
                <% safeHoldings.forEach((h, index) => {
                  const dailyChange = h.changePct || h.change_percent || 0;
                  const isPositiveDaily = dailyChange >= 0;
                  const gain = h.gain || 0;
                  const isPositiveGain = gain >= 0;
                  const avgCost = h.avgCostBasis || h.avg_cost_basis || 0;
                  const currentPrice = h.currentPrice || h.price || 0;
                  const marketValue = h.marketValue || (h.shares * currentPrice) || 0;
                  const shares = h.shares || h.quantity || 0;

                  // Generate logo background color based on symbol
                  const colors = ['#000', '#00a4ef', '#ff5722', '#FF9900', '#4285f4', '#ea4335', '#34a853', '#7c3aed'];
                  const colorIndex = (h.symbol || '').charCodeAt(0) % colors.length;
                  const logoColor = colors[colorIndex];
                %>
                <tr data-symbol="<%= h.symbol %>" data-portfolio="<%= h.portfolioId %>" class="holding-row">
                  <td>
                    <div class="asset-cell">
                      <div class="asset-logo">
                        <% if (h.logoUrl) { %>
                          <img src="<%= h.logoUrl %>" alt="<%= h.symbol %>" class="w-full h-full object-contain rounded-full">
                        <% } else { %>
                          <div class="asset-logo-inner" style="background: <%= logoColor %>;">
                            <%= h.symbol ? h.symbol.slice(0, 2) : '??' %>
                          </div>
                        <% } %>
                      </div>
                      <div class="asset-info">
                        <a href="/stock/<%= h.symbol %>" class="asset-symbol hover:text-[#4850e5] transition-colors"><%= h.symbol %></a>
                        <span class="asset-name" title="<%= h.name || '' %>"><%= h.name || '' %></span>
                      </div>
                    </div>
                  </td>
                  <td class="value-cell value-white text-sm"><%= fmt.number(shares) %></td>
                  <td class="value-cell value-muted text-sm"><%= fmt.money(avgCost) %></td>
                  <td class="value-cell value-white value-medium text-sm"><%= fmt.money(currentPrice) %></td>
                  <td class="value-cell value-white value-bold text-sm"><%= fmt.money(marketValue) %></td>
                  <td class="value-cell text-sm">
                    <div class="<%= isPositiveDaily ? 'change-positive' : 'change-negative' %>">
                      <span class="material-symbols-outlined text-[16px]"><%= isPositiveDaily ? 'trending_up' : 'trending_down' %></span>
                      <%= isPositiveDaily ? '+' : '' %><%= dailyChange.toFixed(2) %>%
                    </div>
                  </td>
                  <td class="value-cell value-medium text-sm <%= isPositiveGain ? 'change-positive' : 'change-negative' %>" style="justify-content: flex-end;">
                    <%= isPositiveGain ? '+' : '' %><%= fmt.money(gain) %>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="action-btn edit" onclick="editHolding('<%= h.id %>')" title="Edit Holding">
                        <span class="material-symbols-outlined text-[20px]">edit</span>
                      </button>
                      <button class="action-btn delete" onclick="deleteHolding('<%= h.id %>', '<%= h.symbol %>')" title="Remove Holding">
                        <span class="material-symbols-outlined text-[20px]">delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="stitch-pagination">
            <p class="pagination-info">
              Showing <span><%= startItem %>-<%= endItem %></span> of <span><%= totalHoldings %></span> holdings
            </p>
            <div class="pagination-buttons">
              <button class="pagination-btn" onclick="changePage(<%= currentPage - 1 %>)" <%= currentPage <= 1 ? 'disabled' : '' %>>Previous</button>
              <button class="pagination-btn" onclick="changePage(<%= currentPage + 1 %>)" <%= currentPage >= totalPages ? 'disabled' : '' %>>Next</button>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</main>

<!-- Upload Portfolio Modal -->
<div id="uploadModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
  <div class="bg-[#1c1d26] border border-[#3d3e52] rounded-xl w-full max-w-xl shadow-2xl">
    <div class="flex items-center justify-between px-6 py-4 border-b border-[#3d3e52]">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#4850e5] to-purple-600 flex items-center justify-center">
          <span class="material-symbols-outlined text-white">cloud_upload</span>
        </div>
        <h3 class="text-lg font-semibold text-white">Upload Portfolio</h3>
      </div>
      <button onclick="closeUploadModal()" class="p-2 text-[#9e9fb7] hover:text-white hover:bg-[#292a38] rounded-lg transition-all">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form id="uploadForm" enctype="multipart/form-data" class="p-6 space-y-5">
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Portfolio Name</label>
        <input type="text" name="portfolioName" id="uploadPortfolioName" placeholder="My Imported Portfolio"
               class="stitch-input pl-4 w-full">
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Portfolio File (CSV, Excel)</label>
        <div class="border-2 border-dashed border-[#3d3e52] rounded-xl p-8 text-center hover:border-[#4850e5]/50 hover:bg-[#4850e5]/5 transition-all cursor-pointer group"
             onclick="document.getElementById('portfolioFile').click()" id="dropZone">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-[#4850e5]/20 to-purple-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-[#4850e5] text-3xl">cloud_upload</span>
          </div>
          <p class="text-slate-300 mb-2 font-medium">Drag and drop your file here, or click to browse</p>
          <p class="text-xs text-slate-500">Supports: CSV, XLSX (Fidelity, Schwab, TD Ameritrade exports)</p>
          <input type="file" name="portfolio" id="portfolioFile" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleFileSelect(this)">
        </div>
        <div id="selectedFile" class="hidden mt-3 p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
              <span class="material-symbols-outlined text-emerald-400">check_circle</span>
            </div>
            <div>
              <p class="text-white font-medium" id="fileName"></p>
              <p class="text-xs text-emerald-400" id="fileSize"></p>
            </div>
          </div>
          <button type="button" onclick="clearFile()" class="p-2 text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-all">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" onclick="closeUploadModal()" class="stitch-btn-secondary">Cancel</button>
        <button type="submit" id="uploadBtn" class="stitch-btn-primary" disabled>
          <span class="material-symbols-outlined animate-spin hidden" id="uploadSpinner">sync</span>
          Upload Portfolio
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Add Holding Modal -->
<div id="addHoldingModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
  <div class="bg-[#1c1d26] border border-[#3d3e52] rounded-xl w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between px-6 py-4 border-b border-[#3d3e52]">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#4850e5] to-purple-600 flex items-center justify-center">
          <span class="material-symbols-outlined text-white">add_circle</span>
        </div>
        <h3 class="text-lg font-semibold text-white">Add Holding</h3>
      </div>
      <button onclick="closeAddHoldingModal()" class="p-2 text-[#9e9fb7] hover:text-white hover:bg-[#292a38] rounded-lg transition-all">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form id="addHoldingForm" class="p-6 space-y-5">
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Portfolio *</label>
        <div class="relative">
          <select name="portfolioId" id="holdingPortfolio" required class="stitch-select w-full">
            <% safePortfolios.forEach(p => { %>
            <option value="<%= p.id %>"><%= p.name %></option>
            <% }) %>
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-[#9e9fb7]">
            <span class="material-symbols-outlined">expand_more</span>
          </div>
        </div>
        <% if (safePortfolios.length === 0) { %>
        <p class="text-xs text-green-400 mt-2 flex items-center gap-1">
          <span class="material-symbols-outlined text-sm">warning</span>
          No portfolios found. <a href="/portfolios" class="underline hover:text-amber-300">Create one first</a>
        </p>
        <% } %>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Symbol *</label>
        <input type="text" name="symbol" id="holdingSymbol" placeholder="AAPL" required
               class="stitch-input pl-4 w-full uppercase font-mono text-lg"
               oninput="this.value = this.value.toUpperCase(); lookupSymbol(this.value)">
        <div id="symbolLookup" class="hidden mt-3 p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                <span class="material-symbols-outlined text-emerald-400 text-sm">check</span>
              </div>
              <div>
                <span id="lookupName" class="text-white font-medium"></span>
                <span id="lookupPrice" class="text-emerald-400 ml-2 font-mono"></span>
              </div>
            </div>
            <span id="lookupChange" class="text-sm font-mono px-2 py-1 rounded-md"></span>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Shares *</label>
          <input type="number" name="shares" id="holdingShares" placeholder="100" step="0.0001" min="0.0001" required
                 class="stitch-input pl-4 w-full font-mono"
                 oninput="calculateTotals()">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Avg Cost/Share *</label>
          <input type="number" name="avgCostBasis" id="holdingCost" placeholder="150.00" step="0.01" min="0.01" required
                 class="stitch-input pl-4 w-full font-mono"
                 oninput="calculateTotals()">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Purchase Date</label>
        <input type="date" name="purchaseDate" id="holdingDate"
               class="stitch-input pl-4 w-full">
      </div>
      <div id="totalCostPreview" class="hidden bg-gradient-to-r from-[#4850e5]/10 to-purple-500/10 border border-[#4850e5]/20 rounded-xl p-4">
        <div class="flex justify-between items-center">
          <span class="text-slate-400 text-sm">Total Cost:</span>
          <span id="previewTotalCost" class="text-white font-bold text-lg font-mono">$0.00</span>
        </div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" onclick="closeAddHoldingModal()" class="stitch-btn-secondary">Cancel</button>
        <button type="submit" id="addHoldingBtn" class="stitch-btn-primary">
          <span class="material-symbols-outlined text-[18px]">add</span>
          Add Holding
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Sell Holding Modal -->
<div id="sellModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
  <div class="bg-[#1c1d26] border border-[#3d3e52] rounded-xl w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between px-6 py-4 border-b border-[#3d3e52]">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-orange-600 flex items-center justify-center">
          <span class="material-symbols-outlined text-white">sell</span>
        </div>
        <h3 class="text-lg font-semibold text-white">Sell <span id="sellSymbol" class="text-green-400 font-mono"></span></h3>
      </div>
      <button onclick="closeSellModal()" class="p-2 text-[#9e9fb7] hover:text-white hover:bg-[#292a38] rounded-lg transition-all">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form id="sellForm" class="p-6 space-y-5">
      <input type="hidden" name="holdingId" id="sellHoldingId">
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Shares to Sell
          <span class="text-green-400">(Max: <span id="maxShares" class="font-mono"></span>)</span>
        </label>
        <input type="number" name="shares" id="sellShares" step="0.0001" min="0.0001" required
               class="stitch-input pl-4 w-full font-mono text-lg">
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Sell Price per Share</label>
        <div class="relative">
          <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-mono">$</span>
          <input type="number" name="price" id="sellPrice" step="0.01" min="0.01" required
                 class="stitch-input pl-8 w-full font-mono text-lg">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Cost Basis Method</label>
        <div class="relative">
          <select name="method" id="sellMethod" class="stitch-select w-full">
            <option value="FIFO">FIFO (First In, First Out)</option>
            <option value="LIFO">LIFO (Last In, First Out)</option>
            <option value="HIFO">HIFO (Highest Cost First)</option>
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-[#9e9fb7]">
            <span class="material-symbols-outlined">expand_more</span>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" onclick="closeSellModal()" class="stitch-btn-secondary">Cancel</button>
        <button type="submit" class="px-5 py-2.5 rounded-lg font-bold bg-gradient-to-r from-green-500 to-orange-600 text-white shadow-lg hover:shadow-green-500/30 transition-all flex items-center gap-2">
          <span class="material-symbols-outlined text-[18px]">sell</span>
          Sell Shares
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Holding Modal -->
<div id="editModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
  <div class="bg-[#1c1d26] border border-[#3d3e52] rounded-xl w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between px-6 py-4 border-b border-[#3d3e52]">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#4850e5] to-purple-600 flex items-center justify-center">
          <span class="material-symbols-outlined text-white">edit</span>
        </div>
        <h3 class="text-lg font-semibold text-white">Edit Holding</h3>
      </div>
      <button onclick="closeEditModal()" class="p-2 text-[#9e9fb7] hover:text-white hover:bg-[#292a38] rounded-lg transition-all">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form id="editForm" class="p-6 space-y-5">
      <input type="hidden" name="holdingId" id="editHoldingId">
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Symbol</label>
        <input type="text" id="editSymbol" readonly
               class="stitch-input pl-4 w-full font-mono text-lg bg-[#292a38] cursor-not-allowed">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Shares *</label>
          <input type="number" name="shares" id="editShares" step="0.0001" min="0.0001" required
                 class="stitch-input pl-4 w-full font-mono">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Avg Cost/Share *</label>
          <input type="number" name="avgCostBasis" id="editCost" step="0.01" min="0.01" required
                 class="stitch-input pl-4 w-full font-mono">
        </div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" onclick="closeEditModal()" class="stitch-btn-secondary">Cancel</button>
        <button type="submit" class="stitch-btn-primary">
          <span class="material-symbols-outlined text-[18px]">save</span>
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<script>
const API_BASE = '/api';
let symbolLookupTimeout;
let currentHoldings = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Store holdings data for client-side filtering
  currentHoldings = Array.from(document.querySelectorAll('.holding-row')).map(row => ({
    element: row,
    symbol: row.dataset.symbol,
    portfolio: row.dataset.portfolio
  }));
});

// Pagination
function changePage(page) {
  const url = new URL(window.location.href);
  url.searchParams.set('page', page);
  window.location.href = url.toString();
}

// Filter by Portfolio
function filterByPortfolio(portfolioId) {
  const rows = document.querySelectorAll('.holding-row');
  let visibleCount = 0;

  rows.forEach(row => {
    if (portfolioId === 'all' || row.dataset.portfolio === portfolioId) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });

  updatePaginationInfo(visibleCount);
}

// Search Holdings
function searchHoldings(query) {
  const rows = document.querySelectorAll('.holding-row');
  const lowerQuery = query.toLowerCase();
  let visibleCount = 0;

  rows.forEach(row => {
    const symbol = row.dataset.symbol?.toLowerCase() || '';
    const nameCell = row.querySelector('.asset-name');
    const name = nameCell?.textContent?.toLowerCase() || '';

    if (symbol.includes(lowerQuery) || name.includes(lowerQuery)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });

  updatePaginationInfo(visibleCount);
}

function updatePaginationInfo(count) {
  const infoEl = document.querySelector('.pagination-info');
  if (infoEl) {
    infoEl.innerHTML = `Showing <span>${count > 0 ? '1' : '0'}-${count}</span> of <span>${count}</span> holdings`;
  }
}

// Toggle Filters (placeholder for advanced filters)
function toggleFilters() {
  showToast('Advanced filters coming soon!', 'info');
}

// Upload Modal Functions
function openUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
}

function closeUploadModal() {
  document.getElementById('uploadModal').classList.add('hidden');
  document.getElementById('uploadForm').reset();
  clearFile();
}

function handleFileSelect(input) {
  const file = input.files[0];
  if (file) {
    document.getElementById('dropZone').classList.add('hidden');
    document.getElementById('selectedFile').classList.remove('hidden');
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('uploadBtn').disabled = false;
  }
}

function clearFile() {
  document.getElementById('portfolioFile').value = '';
  document.getElementById('dropZone').classList.remove('hidden');
  document.getElementById('selectedFile').classList.add('hidden');
  document.getElementById('uploadBtn').disabled = true;
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' bytes';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

// Upload form submission
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);
  const uploadBtn = document.getElementById('uploadBtn');
  const spinner = document.getElementById('uploadSpinner');

  uploadBtn.disabled = true;
  spinner.classList.remove('hidden');

  try {
    const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/portfolio-upload/upload`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });

    const data = await response.json();

    if (data.success) {
      showToast('Portfolio upload started! Processing...', 'success');
      closeUploadModal();

      if (data.uploadId) {
        pollUploadStatus(data.uploadId);
      }
    } else {
      showToast(data.error || 'Upload failed', 'error');
    }
  } catch (error) {
    console.error('Upload error:', error);
    showToast('Failed to upload portfolio', 'error');
  } finally {
    uploadBtn.disabled = false;
    spinner.classList.add('hidden');
  }
});

async function pollUploadStatus(uploadId) {
  const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
  let attempts = 0;
  const maxAttempts = 30;

  const poll = async () => {
    try {
      const response = await fetch(`${API_BASE}/portfolio-upload/status/${uploadId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();

      if (data.upload?.status === 'completed') {
        showToast(`Portfolio uploaded! ${data.upload.totalHoldings} holdings added.`, 'success');
        setTimeout(() => location.reload(), 1500);
      } else if (data.upload?.status === 'failed') {
        showToast(`Upload failed: ${data.upload.errorMessage}`, 'error');
      } else if (attempts < maxAttempts) {
        attempts++;
        setTimeout(poll, 2000);
      }
    } catch (error) {
      console.error('Poll error:', error);
    }
  };

  poll();
}

// Add Holding Modal Functions
function openAddHoldingModal() {
  document.getElementById('addHoldingModal').classList.remove('hidden');
  document.getElementById('holdingDate').value = new Date().toISOString().split('T')[0];
}

function closeAddHoldingModal() {
  document.getElementById('addHoldingModal').classList.add('hidden');
  document.getElementById('addHoldingForm').reset();
  document.getElementById('symbolLookup').classList.add('hidden');
  document.getElementById('totalCostPreview').classList.add('hidden');
}

async function lookupSymbol(symbol) {
  clearTimeout(symbolLookupTimeout);

  if (symbol.length < 1) {
    document.getElementById('symbolLookup').classList.add('hidden');
    return;
  }

  symbolLookupTimeout = setTimeout(async () => {
    try {
      const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/market/quote/${symbol}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const data = await response.json();
        if (data.price) {
          document.getElementById('lookupName').textContent = data.name || symbol;
          document.getElementById('lookupPrice').textContent = '$' + data.price.toFixed(2);
          document.getElementById('lookupChange').textContent = (data.changePercent >= 0 ? '+' : '') + data.changePercent?.toFixed(2) + '%';
          document.getElementById('lookupChange').className = 'text-sm font-mono px-2 py-1 rounded-md ' + (data.changePercent >= 0 ? 'text-emerald-400 bg-emerald-400/10' : 'text-red-400 bg-red-400/10');
          document.getElementById('symbolLookup').classList.remove('hidden');

          if (!document.getElementById('holdingCost').value) {
            document.getElementById('holdingCost').value = data.price.toFixed(2);
            calculateTotals();
          }
        }
      }
    } catch (error) {
      console.error('Symbol lookup error:', error);
    }
  }, 500);
}

function calculateTotals() {
  const shares = parseFloat(document.getElementById('holdingShares').value) || 0;
  const cost = parseFloat(document.getElementById('holdingCost').value) || 0;
  const total = shares * cost;

  if (total > 0) {
    document.getElementById('previewTotalCost').textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    document.getElementById('totalCostPreview').classList.remove('hidden');
  } else {
    document.getElementById('totalCostPreview').classList.add('hidden');
  }
}

// Add Holding Form Submission
document.getElementById('addHoldingForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = {
    portfolioId: document.getElementById('holdingPortfolio').value,
    symbol: document.getElementById('holdingSymbol').value.toUpperCase(),
    shares: parseFloat(document.getElementById('holdingShares').value),
    avgCostBasis: parseFloat(document.getElementById('holdingCost').value),
    purchaseDate: document.getElementById('holdingDate').value || new Date().toISOString()
  };

  try {
    const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/holdings`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });

    const data = await response.json();

    if (response.ok) {
      showToast(`Added ${formData.shares} shares of ${formData.symbol}`, 'success');
      closeAddHoldingModal();
      location.reload();
    } else {
      showToast(data.error || 'Failed to add holding', 'error');
    }
  } catch (error) {
    console.error('Add holding error:', error);
    showToast('Failed to add holding', 'error');
  }
});

// Edit Holding
function editHolding(holdingId) {
  // Find the holding row
  const row = document.querySelector(`tr[data-symbol]`);
  if (row) {
    const symbol = row.dataset.symbol;
    const sharesCell = row.querySelector('td:nth-child(2)');
    const costCell = row.querySelector('td:nth-child(3)');

    document.getElementById('editHoldingId').value = holdingId;
    document.getElementById('editSymbol').value = symbol;
    document.getElementById('editShares').value = sharesCell?.textContent?.replace(/,/g, '') || '';
    document.getElementById('editCost').value = costCell?.textContent?.replace(/[$,]/g, '') || '';
    document.getElementById('editModal').classList.remove('hidden');
  }
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const holdingId = document.getElementById('editHoldingId').value;
  const updateData = {
    shares: parseFloat(document.getElementById('editShares').value),
    avgCostBasis: parseFloat(document.getElementById('editCost').value)
  };

  try {
    const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/holdings/${holdingId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updateData)
    });

    if (response.ok) {
      showToast('Holding updated successfully', 'success');
      closeEditModal();
      location.reload();
    } else {
      const data = await response.json();
      showToast(data.error || 'Failed to update holding', 'error');
    }
  } catch (error) {
    console.error('Edit error:', error);
    showToast('Failed to update holding', 'error');
  }
});

// Sell Modal Functions
function sellHolding(holdingId, symbol, maxShares) {
  document.getElementById('sellHoldingId').value = holdingId;
  document.getElementById('sellSymbol').textContent = symbol;
  document.getElementById('maxShares').textContent = maxShares;
  document.getElementById('sellShares').max = maxShares;
  document.getElementById('sellShares').value = maxShares;
  document.getElementById('sellModal').classList.remove('hidden');

  const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
  fetch(`${API_BASE}/market/quote/${symbol}`, {
    headers: { 'Authorization': `Bearer ${token}` }
  })
  .then(r => r.json())
  .then(data => {
    if (data.price) {
      document.getElementById('sellPrice').value = data.price.toFixed(2);
    }
  });
}

function closeSellModal() {
  document.getElementById('sellModal').classList.add('hidden');
}

document.getElementById('sellForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const holdingId = document.getElementById('sellHoldingId').value;
  const sellData = {
    shares: parseFloat(document.getElementById('sellShares').value),
    price: parseFloat(document.getElementById('sellPrice').value),
    method: document.getElementById('sellMethod').value
  };

  try {
    const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/holdings/${holdingId}/sell`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(sellData)
    });

    const data = await response.json();

    if (response.ok) {
      showToast(`Sold ${sellData.shares} shares for $${data.proceeds?.toFixed(2)}`, 'success');
      closeSellModal();
      location.reload();
    } else {
      showToast(data.error || 'Failed to sell shares', 'error');
    }
  } catch (error) {
    console.error('Sell error:', error);
    showToast('Failed to sell shares', 'error');
  }
});

// Delete Holding
async function deleteHolding(holdingId, symbol) {
  if (!confirm(`Delete all shares of ${symbol}? This cannot be undone.`)) return;

  try {
    const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/holdings/${holdingId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      showToast(`${symbol} removed from portfolio`, 'success');
      location.reload();
    } else {
      const data = await response.json();
      showToast(data.error || 'Failed to delete holding', 'error');
    }
  } catch (error) {
    console.error('Delete error:', error);
    showToast('Failed to delete holding', 'error');
  }
}

// Toast notification
function showToast(message, type = 'info') {
  const iconMap = {
    success: 'check_circle',
    error: 'error',
    info: 'info'
  };
  const colorMap = {
    success: 'bg-emerald-600',
    error: 'bg-red-600',
    info: 'bg-[#4850e5]'
  };

  const toast = document.createElement('div');
  toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 ${colorMap[type]} text-white animate-fade-in`;
  toast.innerHTML = `
    <span class="material-symbols-outlined">${iconMap[type]}</span>
    ${message}
  `;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 4700);
}

// Drag and drop for upload
const dropZone = document.getElementById('dropZone');
if (dropZone) {
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-[#4850e5]', 'bg-[#4850e5]/10');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-[#4850e5]', 'bg-[#4850e5]/10');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-[#4850e5]', 'bg-[#4850e5]/10');
    const file = e.dataTransfer.files[0];
    if (file) {
      const input = document.getElementById('portfolioFile');
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      input.files = dataTransfer.files;
      handleFileSelect(input);
    }
  });
}
</script>

<%- include('../partials/footer') %>
