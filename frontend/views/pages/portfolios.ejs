<%
  // Safe defaults for undefined variables
  const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
  const safePortfolios = typeof portfolios !== 'undefined' ? portfolios : [];
  const safeSelected = typeof selected !== 'undefined' ? selected : null;
  const safeHoldings = typeof holdings !== 'undefined' ? holdings : [];
  const safeFmt = typeof fmt !== 'undefined' ? fmt : {
    money: (val, decimals = 0) => {
      const num = parseFloat(val) || 0;
      return '$' + num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    },
    compact: (val) => {
      const num = parseFloat(val) || 0;
      if (num >= 1000000) return '$' + (num / 1000000).toFixed(2) + 'M';
      if (num >= 1000) return '$' + (num / 1000).toFixed(1) + 'K';
      return '$' + num.toFixed(0);
    },
    pct: (val) => {
      const num = parseFloat(val) || 0;
      return (num >= 0 ? '+' : '') + num.toFixed(2) + '%';
    }
  };
%>
<%- include('../partials/header', { pageTitle: 'Portfolios' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header-bar">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <h1 class="text-amber-400 text-lg font-bold tracking-wide">PORTFOLIOS</h1>
    <div class="flex gap-3">
      <a href="/reports-ai" class="bloomberg-btn bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white border-none">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
        AI REPORT
      </a>
      <button onclick="openModal('uploadModal')" class="bloomberg-btn bloomberg-btn-secondary">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        UPLOAD PORTFOLIO
      </button>
      <button onclick="openModal('createModal')" class="bloomberg-btn bloomberg-btn-primary">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        ADD PORTFOLIO
      </button>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto space-y-6 p-6">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Portfolio List Sidebar -->
    <div class="lg:col-span-1 space-y-3">
      <% if (safePortfolios.length === 0) { %>
        <div class="bloomberg-card p-6 text-center border-dashed border-2 border-slate-600 bg-gradient-to-b from-slate-800/20 to-transparent">
          <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-slate-700/50 flex items-center justify-center">
            <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
          </div>
          <p class="text-slate-500 text-sm">No portfolios yet</p>
          <p class="text-slate-600 text-xs mt-1">Create one to get started</p>
        </div>
      <% } else {
        safePortfolios.forEach(p => { %>
          <a href="/portfolios?id=<%= p.id %>"
            class="bloomberg-card block hover:border-amber-400/50 transition-colors <%= safeSelected && safeSelected.id == p.id ? 'border-amber-400 bg-amber-400/5' : '' %>">
            <div class="flex items-center justify-between">
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-white truncate">
                  <%= p.name %>
                </h3>
                <div class="flex items-center gap-2 mt-1">
                  <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-slate-700 text-slate-300 rounded uppercase">
                    <%= p.portfolio_type %>
                  </span>
                  <span class="text-slate-500 text-xs">
                    <%= p.holdings_count %> holdings
                  </span>
                </div>
              </div>
              <div class="text-right ml-2">
                <p class="text-white font-mono text-sm font-medium">
                  <%= safeFmt.compact(p.total_value) %>
                </p>
                <p class="text-xs font-mono <%= p.total_gain >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                  <% const gainPct = p.total_cost > 0 ? (p.total_gain / p.total_cost) * 100 : 0; %>
                  <%= safeFmt.pct(Math.min(Math.max(gainPct, -99.99), 9999.99)) %>
                </p>
              </div>
            </div>
          </a>
        <% })
      } %>
    </div>

    <!-- Portfolio Details -->
    <div class="lg:col-span-3">
      <% if (safePortfolios.length === 0) { %>
        <!-- Empty State - No Portfolios (Professional Design) -->
        <div class="bloomberg-card p-0 overflow-hidden">
          <!-- Hero Section with Gradient -->
          <div class="relative bg-gradient-to-br from-slate-800 via-slate-900 to-black p-10 text-center border-b border-slate-700/50">
            <!-- Animated Background Pattern -->
            <div class="absolute inset-0 opacity-5">
              <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23f59e0b\" fill-opacity=\"0.4\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
            </div>

            <!-- Icon with Glow Effect -->
            <div class="relative mb-6">
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-32 h-32 bg-amber-500/10 rounded-full blur-2xl"></div>
              </div>
              <div class="relative w-20 h-20 mx-auto bg-gradient-to-br from-amber-400 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-500/20 transform hover:scale-105 transition-transform">
                <svg class="w-10 h-10 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
              </div>
            </div>

            <!-- Heading -->
            <h3 class="text-2xl font-bold text-white mb-2">
              Build Your Investment Portfolio
            </h3>
            <p class="text-amber-400 text-sm font-semibold tracking-widest uppercase mb-4">
              Professional Wealth Management
            </p>
            <p class="text-slate-400 max-w-lg mx-auto leading-relaxed">
              Track performance, analyze risk metrics, and make data-driven investment decisions with our institutional-grade portfolio tools.
            </p>

            <!-- CTA Buttons -->
            <div class="flex gap-4 justify-center mt-8">
              <button onclick="openModal('createModal')" class="group relative inline-flex items-center gap-2 bg-gradient-to-r from-amber-500 to-amber-600 text-black font-bold px-8 py-3.5 rounded-lg shadow-lg shadow-amber-500/25 hover:shadow-amber-500/40 hover:from-amber-400 hover:to-amber-500 transition-all duration-200 transform hover:-translate-y-0.5">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4" />
                </svg>
                CREATE PORTFOLIO
              </button>
              <button onclick="openModal('uploadModal')" class="group inline-flex items-center gap-2 bg-slate-700/80 text-white font-semibold px-8 py-3.5 rounded-lg border border-slate-600 hover:bg-slate-600 hover:border-slate-500 transition-all duration-200 transform hover:-translate-y-0.5">
                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                IMPORT FILE
              </button>
            </div>
          </div>

          <!-- Feature Highlights -->
          <div class="p-6 bg-slate-900/50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Feature 1 -->
              <div class="p-4 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:border-amber-500/30 transition-colors group">
                <div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center mb-3 group-hover:bg-emerald-500/20 transition-colors">
                  <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                </div>
                <h4 class="text-white font-semibold mb-1">Performance Tracking</h4>
                <p class="text-slate-400 text-sm">Real-time P&L, returns analysis, and benchmark comparisons</p>
              </div>

              <!-- Feature 2 -->
              <div class="p-4 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:border-amber-500/30 transition-colors group">
                <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center mb-3 group-hover:bg-blue-500/20 transition-colors">
                  <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                  </svg>
                </div>
                <h4 class="text-white font-semibold mb-1">Allocation Analysis</h4>
                <p class="text-slate-400 text-sm">Sector breakdown, diversification metrics, and rebalancing alerts</p>
              </div>

              <!-- Feature 3 -->
              <div class="p-4 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:border-amber-500/30 transition-colors group">
                <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center mb-3 group-hover:bg-purple-500/20 transition-colors">
                  <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                </div>
                <h4 class="text-white font-semibold mb-1">Risk Analytics</h4>
                <p class="text-slate-400 text-sm">Volatility, Sharpe ratio, VaR, and correlation analysis</p>
              </div>
            </div>

            <!-- Import Options -->
            <div class="mt-6 p-4 rounded-lg bg-slate-800/30 border border-slate-700/30">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center">
                  <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <h4 class="text-white font-semibold">Supported Import Formats</h4>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-slate-700/50 text-slate-300 text-xs font-medium border border-slate-600/50">
                  <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  CSV Files
                </span>
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-slate-700/50 text-slate-300 text-xs font-medium border border-slate-600/50">
                  <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  Excel (.xlsx)
                </span>
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-slate-700/50 text-slate-300 text-xs font-medium border border-slate-600/50">
                  <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  JSON Data
                </span>
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-slate-700/50 text-slate-300 text-xs font-medium border border-slate-600/50">
                  <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  Schwab Export
                </span>
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-slate-700/50 text-slate-300 text-xs font-medium border border-slate-600/50">
                  <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  Fidelity Export
                </span>
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-slate-700/50 text-slate-300 text-xs font-medium border border-slate-600/50">
                  <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  TD Ameritrade
                </span>
              </div>
            </div>
          </div>
        </div>
      <% } else if (safeSelected) { %>
        <div class="bloomberg-card">
          <!-- Portfolio Header -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-xl font-bold text-amber-400 tracking-wide uppercase">
                <%= safeSelected.name %>
              </h2>
              <p class="text-slate-400 text-sm">
                <%= safeSelected.description || 'No description' %>
              </p>
            </div>
            <div class="flex gap-2">
              <button onclick="openEditModal()" class="bloomberg-btn bloomberg-btn-secondary text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                EDIT
              </button>
              <button onclick="openModal('addModal')" class="bloomberg-btn bloomberg-btn-primary text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                ADD
              </button>
              <button onclick="generateReport('<%= safeSelected.id %>')" class="bloomberg-btn bloomberg-btn-secondary text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                REPORT
              </button>
              <button onclick="deletePortfolio('<%= safeSelected.id %>')" class="bloomberg-btn bloomberg-btn-danger text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Client Info and Notes -->
          <% if (safeSelected.client_name || safeSelected.notes) { %>
            <div class="mb-6 p-4 bg-slate-800/50 border border-slate-700 rounded">
              <% if (safeSelected.client_name) { %>
                <div class="mb-2">
                  <span class="text-xs font-semibold uppercase tracking-wider text-amber-400">Client Name</span>
                  <p class="text-white font-medium">
                    <%= safeSelected.client_name %>
                  </p>
                </div>
              <% } %>
              <% if (safeSelected.notes) { %>
                <div>
                  <span class="text-xs font-semibold uppercase tracking-wider text-amber-400">Notes</span>
                  <p class="text-slate-300 text-sm whitespace-pre-wrap">
                    <%= safeSelected.notes %>
                  </p>
                </div>
              <% } %>
            </div>
          <% } %>

          <!-- Portfolio Statistics - Tufte Style -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Total Value Card -->
            <div class="tufte-stat-card">
              <div class="stat-label">Total Value</div>
              <div class="stat-value-row">
                <span class="stat-value tabular-nums">
                  <%= safeFmt.money(safeSelected.total_value) %>
                </span>
              </div>
              <% const dayChangeVal = safeSelected.day_change || 0; %>
              <div class="stat-subtext <%= dayChangeVal >= 0 ? 'positive' : 'negative' %> tabular-nums">
                <%= dayChangeVal >= 0 ? '+' : '' %><%= safeFmt.money(Math.abs(dayChangeVal)) %> today
              </div>
            </div>

            <!-- Cost Basis Card -->
            <div class="tufte-stat-card">
              <div class="stat-label">Cost Basis</div>
              <div class="stat-value-row">
                <span class="stat-value tabular-nums">
                  <%= safeFmt.money(safeSelected.total_cost) %>
                </span>
              </div>
              <div class="stat-subtext tabular-nums">
                <%= safeHoldings.length %> positions • Avg: <%= safeFmt.money(safeSelected.total_cost / (safeHoldings.length || 1)) %>
              </div>
            </div>

            <!-- Gain/Loss Card -->
            <div class="tufte-stat-card">
              <% const totalGainPct = safeSelected.total_cost > 0 ? (safeSelected.total_gain / safeSelected.total_cost) * 100 : 0; %>
              <div class="stat-label">Total Gain/Loss</div>
              <div class="stat-value-row">
                <span class="stat-value tabular-nums <%= safeSelected.total_gain >= 0 ? 'positive' : 'negative' %>">
                  <%= safeSelected.total_gain >= 0 ? '+' : '' %><%= safeFmt.money(safeSelected.total_gain) %>
                </span>
              </div>
              <div class="stat-subtext <%= safeSelected.total_gain >= 0 ? 'positive' : 'negative' %> tabular-nums">
                <%= totalGainPct >= 0 ? '+' : '' %><%= totalGainPct.toFixed(2) %>% all time
              </div>
            </div>

            <!-- Dividend Income Card -->
            <div class="tufte-stat-card">
              <div class="stat-label">Div. Income</div>
              <div class="stat-value-row">
                <span class="stat-value tabular-nums">
                  <%= safeFmt.money(safeSelected.total_income || 0) %>
                </span>
              </div>
              <% const yieldPct = safeSelected.total_value > 0 ? ((safeSelected.total_income || 0) / safeSelected.total_value * 100) : 0; %>
              <div class="stat-subtext tabular-nums">
                <%= yieldPct.toFixed(2) %>% yield • annual est.
              </div>
            </div>
          </div>

          <!-- Quick Stats Bar -->
          <div class="flex items-center gap-6 mb-6 p-3 bg-slate-800/30 rounded-lg border border-slate-700/30">
            <div class="flex items-center gap-2">
              <span class="text-slate-500 text-xs uppercase">Day Change:</span>
              <span class="font-mono text-sm font-semibold tabular-nums <%= dayChangeVal >= 0 ? 'positive' : 'negative' %>">
                <%= dayChangeVal >= 0 ? '+' : '' %><%= safeFmt.money(dayChangeVal) %> (<%= ((dayChangeVal / (safeSelected.total_value - dayChangeVal)) * 100).toFixed(2) %>%)
              </span>
            </div>
            <div class="w-px h-4 bg-slate-700"></div>
            <div class="flex items-center gap-2">
              <span class="text-slate-500 text-xs uppercase">Benchmark:</span>
              <span class="font-mono text-sm text-amber-400"><%= safeSelected.benchmark || 'SPY' %></span>
            </div>
            <div class="w-px h-4 bg-slate-700"></div>
            <div class="flex items-center gap-2">
              <span class="text-slate-500 text-xs uppercase">Currency:</span>
              <span class="font-mono text-sm text-slate-300"><%= safeSelected.currency || 'USD' %></span>
            </div>
            <div class="flex-1"></div>
            <div class="flex items-center gap-2 text-xs text-slate-500">
              <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
              <span>Live prices</span>
            </div>
          </div>

          <!-- Allocation Charts - Enhanced -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Sector/Symbol Allocation Chart -->
            <div class="relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700/50 rounded-xl shadow-lg">
              <!-- Header -->
              <div class="flex items-center justify-between px-5 py-4 border-b border-slate-700/50">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-violet-500/20 to-purple-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-white font-semibold">Asset Allocation</h3>
                    <p class="text-slate-400 text-xs">Portfolio distribution by holding</p>
                  </div>
                </div>
                <div class="px-2 py-1 rounded-full bg-violet-500/10 border border-violet-500/20">
                  <span class="text-violet-400 text-xs font-medium"><%= safeHoldings.length %> Assets</span>
                </div>
              </div>
              <!-- Chart Container -->
              <div class="p-5">
                <% if (safeHoldings.length === 0) { %>
                  <div class="h-56 flex flex-col items-center justify-center text-center">
                    <div class="w-16 h-16 rounded-full bg-slate-700/50 flex items-center justify-center mb-3">
                      <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                      </svg>
                    </div>
                    <p class="text-slate-400 text-sm">No holdings to display</p>
                    <p class="text-slate-500 text-xs mt-1">Add holdings to see allocation</p>
                  </div>
                <% } else { %>
                  <div class="h-56 relative">
                    <canvas id="sectorChart"></canvas>
                  </div>
                  <!-- Legend -->
                  <div class="mt-4 grid grid-cols-2 gap-2" id="allocationLegend"></div>
                <% } %>
              </div>
            </div>

            <!-- Top Holdings Chart -->
            <div class="relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700/50 rounded-xl shadow-lg">
              <!-- Header -->
              <div class="flex items-center justify-between px-5 py-4 border-b border-slate-700/50">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500/20 to-orange-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-white font-semibold">Top Holdings</h3>
                    <p class="text-slate-400 text-xs">Largest positions by value</p>
                  </div>
                </div>
                <% if (safeHoldings.length > 0) {
                   const topValue = Math.max(...safeHoldings.map(h => h.quantity * h.current_price));
                %>
                  <div class="text-right">
                    <p class="text-amber-400 font-mono font-semibold text-sm"><%= safeFmt.compact(topValue) %></p>
                    <p class="text-slate-500 text-xs">Top position</p>
                  </div>
                <% } %>
              </div>
              <!-- Chart Container -->
              <div class="p-5">
                <% if (safeHoldings.length === 0) { %>
                  <div class="h-56 flex flex-col items-center justify-center text-center">
                    <div class="w-16 h-16 rounded-full bg-slate-700/50 flex items-center justify-center mb-3">
                      <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2z"/>
                      </svg>
                    </div>
                    <p class="text-slate-400 text-sm">No holdings yet</p>
                    <p class="text-slate-500 text-xs mt-1">Add your first holding</p>
                  </div>
                <% } else { %>
                  <div class="h-56 relative">
                    <canvas id="holdingsChart"></canvas>
                  </div>
                  <!-- Quick Stats -->
                  <div class="mt-4 grid grid-cols-3 gap-3">
                    <div class="bg-slate-700/30 rounded-lg p-2 text-center">
                      <p class="text-slate-400 text-xs">Holdings</p>
                      <p class="text-white font-semibold"><%= safeHoldings.length %></p>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg p-2 text-center">
                      <p class="text-slate-400 text-xs">Top Weight</p>
                      <%
                        const totalVal = safeHoldings.reduce((s, h) => s + (h.quantity * h.current_price), 0);
                        const topWeight = totalVal > 0 ? (Math.max(...safeHoldings.map(h => h.quantity * h.current_price)) / totalVal * 100) : 0;
                      %>
                      <p class="text-amber-400 font-semibold"><%= topWeight.toFixed(1) %>%</p>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg p-2 text-center">
                      <p class="text-slate-400 text-xs">Concentration</p>
                      <% const concentration = safeHoldings.length > 0 && topWeight > 50 ? 'High' : topWeight > 25 ? 'Med' : 'Low'; %>
                      <p class="<%= concentration === 'High' ? 'text-red-400' : concentration === 'Med' ? 'text-amber-400' : 'text-emerald-400' %> font-semibold"><%= concentration %></p>
                    </div>
                  </div>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Enhanced Search, Filter & Actions Bar -->
          <div class="bg-slate-800/30 rounded-xl p-4 mb-6 border border-slate-700/50">
            <div class="flex flex-wrap items-center gap-3">
              <!-- Search Input -->
              <div class="relative flex-1 min-w-[200px]">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-500"
                  fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="searchHoldings" onkeyup="filterHoldings()"
                  placeholder="Search holdings..."
                  class="w-full pl-10 pr-4 py-2.5 bg-slate-900/50 border border-slate-600/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:border-amber-400 text-white placeholder-slate-500 text-sm transition-all">
              </div>
              <!-- Filter Dropdown -->
              <select id="holdingsFilter" onchange="filterHoldings()"
                class="px-3 py-2.5 bg-slate-900/50 border border-slate-600/50 rounded-lg text-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400/50">
                <option value="all">All Holdings</option>
                <option value="gainers">Gainers Only</option>
                <option value="losers">Losers Only</option>
                <option value="dividend">Has Dividend</option>
              </select>
              <!-- Sort Dropdown -->
              <select id="holdingsSort" onchange="sortHoldings()"
                class="px-3 py-2.5 bg-slate-900/50 border border-slate-600/50 rounded-lg text-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400/50">
                <option value="value-desc">Value (High→Low)</option>
                <option value="value-asc">Value (Low→High)</option>
                <option value="gain-desc">Gain % (High→Low)</option>
                <option value="gain-asc">Gain % (Low→High)</option>
                <option value="symbol-asc">Symbol (A→Z)</option>
              </select>
              <!-- Refresh Button -->
              <button onclick="refreshAllPrices()" id="refreshPricesBtn"
                class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-slate-900 font-semibold rounded-lg transition-all shadow-lg shadow-amber-500/20">
                <svg class="w-4 h-4" id="refreshIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span id="refreshBtnText" class="text-sm">Refresh</span>
              </button>
            </div>
            <!-- Quick Stats Row -->
            <div class="flex items-center gap-6 mt-3 pt-3 border-t border-slate-700/30">
              <div class="flex items-center gap-2 text-xs">
                <span class="text-slate-500">Total:</span>
                <span class="text-white font-semibold"><%= safeHoldings.length %> holdings</span>
              </div>
              <%
                const gainerCount = safeHoldings.filter(h => (h.current_price - h.cost_basis) >= 0).length;
                const loserCount = safeHoldings.length - gainerCount;
              %>
              <div class="flex items-center gap-2 text-xs">
                <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                <span class="text-emerald-400"><%= gainerCount %> gainers</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <span class="w-2 h-2 rounded-full bg-red-400"></span>
                <span class="text-red-400"><%= loserCount %> losers</span>
              </div>
            </div>
          </div>

          <!-- Enhanced Holdings Table -->
          <div class="bg-slate-800/20 rounded-xl border border-slate-700/50 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full" id="holdingsTable">
                <thead>
                  <tr class="bg-slate-800/50">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Asset</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Shares</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Price</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Avg Cost</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Mkt Value</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Weight</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Total P/L</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Yield</th>
                    <th class="px-4 py-3 w-20"></th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-700/30">
                  <% if (safeHoldings.length === 0) { %>
                    <tr>
                      <td colspan="9" class="py-12 text-center">
                        <div class="flex flex-col items-center">
                          <div class="w-16 h-16 rounded-full bg-slate-700/50 flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                            </svg>
                          </div>
                          <p class="text-slate-400 font-medium">No holdings yet</p>
                          <p class="text-slate-500 text-sm mt-1">Add your first holding to get started</p>
                          <button onclick="openAddHoldingModal()" class="mt-4 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg text-sm transition-colors">
                            + Add Holding
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% } else {
                    const colors = ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#3b82f6', '#14b8a6'];
                    const totalValue = safeHoldings.reduce((sum, h) => sum + (h.quantity * h.current_price), 0);
                    safeHoldings.forEach((h, i) => {
                      const gl = (h.current_price - h.cost_basis) * h.quantity;
                      const glp = h.cost_basis > 0 ? (h.current_price - h.cost_basis) / h.cost_basis * 100 : 0;
                      const mktValue = h.quantity * h.current_price;
                      const weight = totalValue > 0 ? (mktValue / totalValue * 100) : 0;
                      const isGainer = gl >= 0;
                  %>
                    <tr class="hover:bg-slate-700/20 transition-colors holding-row"
                        data-symbol="<%= h.symbol %>"
                        data-gain="<%= gl %>"
                        data-value="<%= mktValue %>"
                        data-dividend="<%= h.dividend_yield || 0 %>">
                      <!-- Asset Column -->
                      <td class="px-4 py-4">
                        <div class="flex items-center gap-3">
                          <div class="relative">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-xs font-bold shadow-lg"
                              style="background: linear-gradient(135deg, <%= colors[i % colors.length] %>, <%= colors[(i + 1) % colors.length] %>)">
                              <%= h.symbol ? h.symbol.slice(0, 2) : '??' %>
                            </div>
                            <% if (isGainer) { %>
                              <div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full bg-emerald-500 flex items-center justify-center">
                                <svg class="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"/>
                                </svg>
                              </div>
                            <% } else { %>
                              <div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full bg-red-500 flex items-center justify-center">
                                <svg class="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/>
                                </svg>
                              </div>
                            <% } %>
                          </div>
                          <div>
                            <p class="text-white font-semibold symbol-text"><%= h.symbol %></p>
                            <p class="text-slate-500 text-xs truncate max-w-[140px] name-text"><%= h.name || 'Unknown' %></p>
                          </div>
                        </div>
                      </td>
                      <!-- Shares -->
                      <td class="px-4 py-4 text-right">
                        <span class="text-slate-200 font-mono text-sm"><%= h.quantity ? h.quantity.toLocaleString() : 0 %></span>
                      </td>
                      <!-- Current Price -->
                      <td class="px-4 py-4 text-right price">
                        <span class="text-white font-mono text-sm font-medium"><%= safeFmt.money(h.current_price, 2) %></span>
                      </td>
                      <!-- Avg Cost -->
                      <td class="px-4 py-4 text-right">
                        <span class="text-slate-400 font-mono text-sm"><%= safeFmt.money(h.cost_basis, 2) %></span>
                      </td>
                      <!-- Market Value -->
                      <td class="px-4 py-4 text-right">
                        <span class="text-white font-mono text-sm font-semibold"><%= safeFmt.money(mktValue) %></span>
                      </td>
                      <!-- Weight -->
                      <td class="px-4 py-4 text-right">
                        <div class="inline-flex items-center gap-2">
                          <div class="w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full" style="width: <%= Math.min(weight, 100) %>%; background-color: <%= colors[i % colors.length] %>"></div>
                          </div>
                          <span class="text-slate-300 font-mono text-xs w-10 text-right"><%= weight.toFixed(1) %>%</span>
                        </div>
                      </td>
                      <!-- Total P/L -->
                      <td class="px-4 py-4 text-right change">
                        <div class="flex flex-col items-end">
                          <span class="font-mono text-sm font-semibold <%= isGainer ? 'text-emerald-400' : 'text-red-400' %>">
                            <%= isGainer ? '+' : '' %><%= safeFmt.money(gl) %>
                          </span>
                          <span class="font-mono text-xs <%= isGainer ? 'text-emerald-400/70' : 'text-red-400/70' %>">
                            <%= isGainer ? '+' : '' %><%= glp.toFixed(2) %>%
                          </span>
                        </div>
                      </td>
                      <!-- Dividend Yield -->
                      <td class="px-4 py-4 text-right">
                        <% if ((h.dividend_yield || 0) > 0) { %>
                          <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-purple-500/10 border border-purple-500/20">
                            <svg class="w-3 h-3 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-1h2v1zm0-2H9V7h2v4z"/>
                            </svg>
                            <span class="text-purple-400 font-mono text-xs font-medium"><%= ((h.dividend_yield || 0) * 100).toFixed(2) %>%</span>
                          </div>
                        <% } else { %>
                          <span class="text-slate-600 text-xs">—</span>
                        <% } %>
                      </td>
                      <!-- Actions -->
                      <td class="px-4 py-4 text-right">
                        <div class="flex items-center justify-end gap-1">
                          <button onclick="openEditHoldingModal('<%= h.id %>', '<%= h.symbol %>', '<%= h.name %>', <%= h.quantity %>, <%= h.cost_basis %>, '<%= h.asset_type || 'stock' %>')"
                            class="p-2 text-slate-400 hover:text-amber-400 hover:bg-slate-700/50 rounded-lg transition-all" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                          </button>
                          <button onclick="confirmDeleteHolding('<%= h.id %>', '<%= h.symbol %>')"
                            class="p-2 text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-all" title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% }) } %>
              </tbody>
            </table>
          </div>
        </div>
      <% } else { %>
        <div class="bloomberg-card p-12 text-center">
          <svg class="w-16 h-16 mx-auto mb-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
          <h3 class="text-lg font-semibold text-amber-400 mb-2 uppercase tracking-wide">Select a Portfolio</h3>
          <p class="text-slate-400">Click on a portfolio to view holdings</p>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Create Portfolio Modal -->
<div id="createModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-amber-400 uppercase tracking-wide">Create Portfolio</h3>
      <button onclick="closeModal('createModal')" class="modal-close">&times;</button>
    </div>
    <form onsubmit="return handleCreatePortfolio(event)">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Name</label>
          <input type="text" name="name" required class="form-input" placeholder="My Portfolio">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Description</label>
          <textarea name="description" class="form-input" rows="2" placeholder="Optional"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Type</label>
          <select name="portfolio_type" class="form-input">
            <option value="taxable">Taxable</option>
            <option value="ira">IRA</option>
            <option value="401k">401(k)</option>
            <option value="roth">Roth IRA</option>
          </select>
        </div>
        <button type="submit" class="bloomberg-btn bloomberg-btn-primary w-full">CREATE</button>
      </div>
    </form>
  </div>
</div>

<!-- Upload Portfolio Modal -->
<div id="uploadModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-amber-400 uppercase tracking-wide">Upload Portfolio</h3>
      <button onclick="closeModal('uploadModal')" class="modal-close">&times;</button>
    </div>
    <form id="uploadForm" onsubmit="return handleUploadPortfolio(event)">
      <div class="space-y-4">
        <div class="bg-slate-800/50 border border-amber-400/30 rounded-lg p-4">
          <p class="text-slate-300 text-sm mb-2">
            <strong class="text-amber-400">Supported Formats:</strong> CSV, Excel (.xlsx, .xls), JSON
          </p>
          <p class="text-slate-400 text-xs mb-3">
            Required columns: <code class="text-amber-400">symbol</code>, <code class="text-amber-400">quantity</code>, <code class="text-amber-400">costBasis</code>
            <br>Optional: <code class="text-slate-300">purchaseDate</code>, <code class="text-slate-300">type</code>
          </p>
          <div class="text-xs text-slate-400">
            <p><strong>CSV Example:</strong></p>
            <pre class="bg-slate-900 p-2 rounded mt-1 text-xs">symbol,quantity,costBasis,purchaseDate
AAPL,100,150.00,2023-01-15
MSFT,50,300.00,2023-02-20</pre>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Portfolio Name</label>
          <input type="text" name="portfolioName" id="uploadPortfolioName" class="form-input" placeholder="Uploaded Portfolio">
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Select File</label>
          <div class="relative">
            <input type="file" name="portfolio" id="portfolioFile" accept=".csv,.xlsx,.xls,.json" required
                   class="form-input file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-amber-400 file:text-slate-900 hover:file:bg-amber-500 file:cursor-pointer">
          </div>
          <p class="text-xs text-slate-500 mt-1">Maximum file size: 10MB</p>
        </div>

        <div id="uploadProgress" class="hidden">
          <div class="bg-slate-800 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-slate-300" id="uploadStatus">Uploading...</span>
              <span class="text-xs text-amber-400" id="uploadPercent">0%</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2">
              <div id="uploadProgressBar" class="bg-amber-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div id="uploadError" class="hidden bg-red-900/20 border border-red-500/50 rounded p-3">
          <p class="text-red-400 text-sm"></p>
        </div>

        <div class="flex gap-3">
          <button type="button" onclick="closeModal('uploadModal')" class="bloomberg-btn bloomberg-btn-secondary flex-1">CANCEL</button>
          <button type="submit" id="uploadSubmitBtn" class="bloomberg-btn bloomberg-btn-primary flex-1">UPLOAD</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Edit Portfolio Modal -->
<div id="editPortfolioModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-amber-400 uppercase tracking-wide">Edit Portfolio</h3>
      <button onclick="closeModal('editPortfolioModal')" class="modal-close">&times;</button>
    </div>
    <form onsubmit="return handleEditPortfolio(event)">
      <input type="hidden" id="editPortfolioId" name="id">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Name</label>
          <input type="text" id="editPortfolioName" name="name" required class="form-input">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Client Name (Optional)</label>
          <input type="text" id="editClientName" name="client_name" class="form-input" placeholder="Client Name">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Detailed Notes</label>
          <textarea id="editPortfolioNotes" name="notes" class="form-input" rows="3" placeholder="Add detailed notes here..."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Description</label>
          <textarea id="editPortfolioDescription" name="description" class="form-input" rows="2"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Type</label>
          <select id="editPortfolioType" name="portfolio_type" class="form-input">
            <option value="taxable">Taxable</option>
            <option value="ira">IRA</option>
            <option value="401k">401(k)</option>
            <option value="roth">Roth IRA</option>
          </select>
        </div>
        <button type="submit" class="bloomberg-btn bloomberg-btn-primary w-full">SAVE CHANGES</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Holding Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-amber-400 uppercase tracking-wide">Add Holding</h3>
      <button onclick="closeModal('addModal')" class="modal-close">&times;</button>
    </div>
    <form onsubmit="return handleAddHolding(event)">
      <div class="space-y-4">
        <!-- Stock Search with Autocomplete -->
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Search Stock</label>
          <div class="relative">
            <input type="text" id="stockSearch" class="form-input" placeholder="Search by symbol or company name..."
              autocomplete="off" oninput="debounceSearch(this.value)">
            <div id="searchResults" class="absolute z-50 w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden">
              <!-- Search results will appear here -->
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Symbol</label>
            <input type="text" id="holdingSymbol" name="symbol" required class="form-input" placeholder="AAPL"
              style="text-transform: uppercase;" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Type</label>
            <select name="type" class="form-input">
              <option value="stock">Stock</option>
              <option value="etf">ETF</option>
              <option value="mutual_fund">Mutual Fund</option>
              <option value="crypto">Crypto</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Name</label>
          <input type="text" name="name" id="holdingName" required class="form-input" placeholder="Apple Inc." readonly>
        </div>

        <!-- Live Price Display -->
        <div class="bg-slate-800/50 border border-amber-400/30 p-4 rounded">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium text-amber-400 uppercase tracking-wider">Live Market Price</label>
            <button type="button" onclick="fetchLivePrice()"
              class="bloomberg-btn bloomberg-btn-primary text-xs" id="fetchPriceBtn">
              <span id="fetchBtnText">FETCH PRICE</span>
            </button>
          </div>
          <div id="priceStatus" class="text-sm text-slate-400">Search for a stock above or enter symbol manually</div>
          <div id="priceDisplay" class="mt-3 hidden">
            <div class="flex items-baseline gap-2">
              <span class="text-2xl font-bold font-mono text-white" id="currentPrice">--</span>
              <span class="text-sm font-mono" id="priceChange">--</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Quantity</label>
            <input type="number" name="quantity" required class="form-input" placeholder="100" step="0.0001">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Cost Basis (per share)</label>
            <input type="number" id="manualCostBasis" name="manual_cost_basis" class="form-input" placeholder="Use live price" step="0.01">
            <p class="text-xs text-slate-500 mt-1">Leave blank to use live price</p>
          </div>
        </div>

        <!-- Hidden field to store fetched price -->
        <input type="hidden" id="holdingCostBasis" name="cost_basis" value="">

        <button type="submit" class="bloomberg-btn bloomberg-btn-primary w-full">ADD HOLDING</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Holding Modal -->
<div id="editHoldingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-amber-400 uppercase tracking-wide">Edit Holding</h3>
      <button onclick="closeModal('editHoldingModal')" class="modal-close">&times;</button>
    </div>
    <form onsubmit="return handleEditHolding(event)">
      <input type="hidden" id="editHoldingId" name="id">
      <div class="space-y-4">
        <div class="bg-slate-800/50 border border-amber-400/30 p-4 rounded">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded bg-amber-500 flex items-center justify-center text-white text-lg font-bold" id="editHoldingIcon">
              --
            </div>
            <div>
              <h4 class="text-white font-bold text-lg" id="editHoldingSymbolDisplay">--</h4>
              <p class="text-slate-400 text-sm" id="editHoldingNameDisplay">--</p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Quantity</label>
            <input type="number" id="editQuantity" name="quantity" required class="form-input" step="0.0001">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Cost Basis (per share)</label>
            <input type="number" id="editCostBasis" name="cost_basis" required class="form-input" step="0.01">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1.5 uppercase text-xs tracking-wider">Asset Type</label>
          <select id="editAssetType" name="asset_type" class="form-input">
            <option value="stock">Stock</option>
            <option value="etf">ETF</option>
            <option value="mutual_fund">Mutual Fund</option>
            <option value="crypto">Crypto</option>
          </select>
        </div>

        <div class="flex gap-3">
          <button type="button" onclick="closeModal('editHoldingModal')" class="bloomberg-btn bloomberg-btn-secondary flex-1">CANCEL</button>
          <button type="submit" class="bloomberg-btn bloomberg-btn-primary flex-1">SAVE CHANGES</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Modal open/close functions
  function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.classList.add('active');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  }

  function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.classList.remove('active');
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  }

  // Close modal when clicking outside
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
      e.target.style.display = 'none';
      e.target.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  <% if (safeSelected) { %>
  const selectedPortfolioId = '<%= safeSelected.id %>';
  const selectedPortfolioData = {
    id: '<%= safeSelected.id %>',
    name: '<%= safeSelected.name %>',
    description: '<%= safeSelected.description || "" %>',
    type: '<%= safeSelected.portfolio_type || "taxable" %>',
    client_name: '<%= safeSelected.client_name || "" %>',
    notes: `<%- (safeSelected.notes || "").replace(new RegExp("`", "g"), "\\`").replace(/\$/g, "\\$") %>`
  };
  <% } else { %>
  const selectedPortfolioId = null;
  const selectedPortfolioData = null;
  <% } %>
  const theme = '<%= safeTheme %>';

  /**
   * Initialize allocation charts - Enhanced with symbol-based allocation
   */
  document.addEventListener('DOMContentLoaded', function() {
    <% if (safeSelected && safeHoldings.length > 0) { %>
      // Calculate allocation by symbol (more useful than sector when sector data is missing)
      const holdingsData = [];
      const totalPortfolioValue = <%= safeHoldings.reduce((sum, h) => sum + (h.quantity * h.current_price), 0) %>;

      <% safeHoldings.forEach(h => { %>
        holdingsData.push({
          symbol: '<%= h.symbol %>',
          value: <%= h.quantity * h.current_price %>,
          gain: <%= ((h.current_price - h.cost_basis) * h.quantity) %>,
          gainPct: <%= h.cost_basis > 0 ? ((h.current_price - h.cost_basis) / h.cost_basis * 100) : 0 %>
        });
      <% }) %>

      // Sort by value descending
      holdingsData.sort((a, b) => b.value - a.value);
      const topHoldings = holdingsData.slice(0, 8);

      // Modern color palette with gradients
      const chartColors = [
        '#8b5cf6', // violet
        '#06b6d4', // cyan
        '#10b981', // emerald
        '#f59e0b', // amber
        '#ef4444', // red
        '#ec4899', // pink
        '#3b82f6', // blue
        '#14b8a6', // teal
      ];

      // Asset Allocation Doughnut Chart (by symbol)
      const sectorCtx = document.getElementById('sectorChart');
      if (sectorCtx) {
        const allocationLabels = topHoldings.map(h => h.symbol);
        const allocationValues = topHoldings.map(h => h.value);

        // Add "Other" if there are more holdings
        if (holdingsData.length > 8) {
          const otherValue = holdingsData.slice(8).reduce((sum, h) => sum + h.value, 0);
          allocationLabels.push('Other');
          allocationValues.push(otherValue);
        }

        const allocationChart = new Chart(sectorCtx, {
          type: 'doughnut',
          data: {
            labels: allocationLabels,
            datasets: [{
              data: allocationValues,
              backgroundColor: chartColors.slice(0, allocationLabels.length),
              borderColor: '#0f172a',
              borderWidth: 3,
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
              legend: {
                display: false // Using custom legend
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                titleColor: '#f59e0b',
                bodyColor: '#e2e8f0',
                borderColor: '#475569',
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    const value = context.parsed;
                    const percent = ((value / totalPortfolioValue) * 100).toFixed(1);
                    return ' $' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' (' + percent + '%)';
                  }
                }
              }
            }
          }
        });

        // Build custom legend
        const legendContainer = document.getElementById('allocationLegend');
        if (legendContainer) {
          legendContainer.innerHTML = allocationLabels.map((label, i) => {
            const value = allocationValues[i];
            const pct = ((value / totalPortfolioValue) * 100).toFixed(1);
            return `
              <div class="flex items-center gap-2 p-1.5 rounded hover:bg-slate-700/30 transition-colors cursor-pointer"
                   onclick="highlightSegment(${i})">
                <div class="w-3 h-3 rounded-full" style="background-color: ${chartColors[i]}"></div>
                <span class="text-slate-300 text-xs font-medium flex-1">${label}</span>
                <span class="text-slate-400 text-xs font-mono">${pct}%</span>
              </div>
            `;
          }).join('');
        }
      }

      // Top Holdings Horizontal Bar Chart with gradient
      const holdingsCtx = document.getElementById('holdingsChart');
      if (holdingsCtx) {
        const holdingLabels = topHoldings.map(h => h.symbol);
        const holdingValues = topHoldings.map(h => h.value);
        const holdingGains = topHoldings.map(h => h.gain);

        // Create gradient for bars
        const ctx = holdingsCtx.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, holdingsCtx.width, 0);
        gradient.addColorStop(0, '#f59e0b');
        gradient.addColorStop(1, '#d97706');

        new Chart(holdingsCtx, {
          type: 'bar',
          data: {
            labels: holdingLabels,
            datasets: [{
              label: 'Market Value',
              data: holdingValues,
              backgroundColor: topHoldings.map((h, i) => chartColors[i]),
              borderColor: 'transparent',
              borderWidth: 0,
              borderRadius: 4,
              barThickness: 20
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                titleColor: '#f59e0b',
                bodyColor: '#e2e8f0',
                borderColor: '#475569',
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    const idx = context.dataIndex;
                    const value = context.parsed.x;
                    const gain = holdingGains[idx];
                    const gainPct = topHoldings[idx].gainPct;
                    const gainSymbol = gain >= 0 ? '+' : '';
                    return [
                      'Value: $' + value.toLocaleString(undefined, {minimumFractionDigits: 2}),
                      'P/L: ' + gainSymbol + '$' + gain.toLocaleString(undefined, {minimumFractionDigits: 2}) + ' (' + gainSymbol + gainPct.toFixed(1) + '%)'
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  color: '#94a3b8',
                  font: { family: 'monospace', size: 10 },
                  callback: function(value) {
                    if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                    if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                    return '$' + value;
                  }
                },
                grid: {
                  color: 'rgba(51, 65, 85, 0.5)',
                  drawBorder: false
                },
                border: {
                  display: false
                }
              },
              y: {
                ticks: {
                  color: '#e2e8f0',
                  font: { family: 'ui-monospace, monospace', size: 11, weight: '600' },
                  padding: 8
                },
                grid: {
                  display: false
                },
                border: {
                  display: false
                }
              }
            }
          }
        });
      }

      // Helper function to highlight chart segments on legend hover
      window.highlightSegment = function(index) {
        // This could be enhanced to interact with the chart
        console.log('Segment', index, 'clicked');
      };
    <% } %>
  });

  /**
   * Get authentication token from server
   */
  const serverToken = `<%= token || "" %>`;

  // Log token status on page load
  console.log('[Auth] Server token present:', !!serverToken, 'Length:', serverToken?.length || 0);
  if (serverToken) {
    console.log('[Auth] Token preview:', serverToken.substring(0, 30) + '...');
  }

  function getToken() {
    if (serverToken && serverToken.length > 0) {
      return serverToken;
    }
    console.error('[Auth] NO TOKEN AVAILABLE - user needs to log in again');
    return '';
  }

  /**
   * Make authenticated fetch request
   */
  async function authFetch(url, options = {}) {
    const token = getToken();

    if (!token) {
      console.error('[Auth] Cannot make authenticated request - no token!');
      // Return a fake response that indicates auth error
      return {
        ok: false,
        status: 401,
        json: async () => ({ error: 'No authentication token. Please log out and log back in.' })
      };
    }

    // Don't set Content-Type for FormData - browser will set it with boundary
    const isFormData = options.body instanceof FormData;
    const headers = {
      ...(!isFormData && { 'Content-Type': 'application/json' }),
      ...options.headers
    };

    headers['Authorization'] = `Bearer ${token}`;
    console.log('[Auth] Making request to', url, 'with token');

    return fetch(url, {
      ...options,
      headers,
      credentials: 'include' // Ensure cookies are sent
    });
  }

  function openEditModal() {
    if (!selectedPortfolioData) return;

    document.getElementById('editPortfolioId').value = selectedPortfolioData.id;
    document.getElementById('editPortfolioName').value = selectedPortfolioData.name;
    document.getElementById('editPortfolioDescription').value = selectedPortfolioData.description;
    document.getElementById('editPortfolioType').value = selectedPortfolioData.type || 'taxable';
    document.getElementById('editClientName').value = selectedPortfolioData.client_name;
    document.getElementById('editPortfolioNotes').value = selectedPortfolioData.notes;

    openModal('editPortfolioModal');
  }

  async function handleEditPortfolio(e) {
    e.preventDefault();
    const f = e.target;
    const id = f.id.value;

    try {
      const response = await authFetch('/api/portfolios/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: f.name.value,
          description: f.description.value,
          client_name: f.client_name.value,
          notes: f.notes.value,
          portfolio_type: f.portfolio_type.value
        })
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        alert('Error updating portfolio: ' + (data.error || 'Unknown error'));
        return false;
      }

      location.reload();
    } catch (err) {
      alert('Failed to update portfolio: ' + err.message);
    }
    return false;
  }

  function filterHoldings() {
    const search = document.getElementById('searchHoldings').value.toLowerCase();
    const filter = document.getElementById('holdingsFilter')?.value || 'all';

    document.querySelectorAll('.holding-row').forEach(row => {
      const sym = row.querySelector('.symbol-text')?.textContent.toLowerCase() || '';
      const name = row.querySelector('.name-text')?.textContent.toLowerCase() || '';
      const gain = parseFloat(row.dataset.gain) || 0;
      const dividend = parseFloat(row.dataset.dividend) || 0;

      // Search filter
      const matchesSearch = sym.includes(search) || name.includes(search);

      // Category filter
      let matchesFilter = true;
      switch (filter) {
        case 'gainers':
          matchesFilter = gain >= 0;
          break;
        case 'losers':
          matchesFilter = gain < 0;
          break;
        case 'dividend':
          matchesFilter = dividend > 0;
          break;
        default:
          matchesFilter = true;
      }

      row.style.display = matchesSearch && matchesFilter ? '' : 'none';
    });
  }

  function sortHoldings() {
    const sort = document.getElementById('holdingsSort')?.value || 'value-desc';
    const tbody = document.querySelector('#holdingsTable tbody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('.holding-row'));
    if (rows.length === 0) return;

    rows.sort((a, b) => {
      switch (sort) {
        case 'value-desc':
          return (parseFloat(b.dataset.value) || 0) - (parseFloat(a.dataset.value) || 0);
        case 'value-asc':
          return (parseFloat(a.dataset.value) || 0) - (parseFloat(b.dataset.value) || 0);
        case 'gain-desc':
          return (parseFloat(b.dataset.gain) || 0) - (parseFloat(a.dataset.gain) || 0);
        case 'gain-asc':
          return (parseFloat(a.dataset.gain) || 0) - (parseFloat(b.dataset.gain) || 0);
        case 'symbol-asc':
          return (a.dataset.symbol || '').localeCompare(b.dataset.symbol || '');
        default:
          return 0;
      }
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
  }

  async function handleCreatePortfolio(e) {
    e.preventDefault();
    const f = e.target;

    // Debug logging
    console.log('=== CREATE PORTFOLIO DEBUG ===');
    console.log('Form data:', {
      name: f.name.value,
      description: f.description.value,
      portfolio_type: f.portfolio_type.value
    });

    const token = getToken();
    console.log('Token exists:', !!token);
    console.log('Token preview:', token ? token.substring(0, 30) + '...' : 'NONE - USER NOT LOGGED IN!');

    if (!token) {
      alert('❌ You are not logged in!\n\nPlease login first at http://localhost:3000/auth\n\nThen try creating a portfolio again.');
      console.error('❌ NO TOKEN - User must login first!');
      window.location.href = '/auth';
      return false;
    }

    try {
      console.log('Making API request to /api/portfolios...');
      const response = await authFetch('/api/portfolios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: f.name.value,
          description: f.description.value,
          portfolio_type: f.portfolio_type.value
        })
      });

      console.log('Response status:', response.status, response.statusText);
      const data = await response.json();
      console.log('Response data:', data);

      if (!response.ok || data.error) {
        const errorMsg = data.error || 'Unknown error';
        console.error('❌ CREATE FAILED:', errorMsg);
        alert('Error creating portfolio: ' + errorMsg);
        return false;
      }

      console.log('✅ SUCCESS! Portfolio created:', data.id);
      console.log('Reloading page in 500ms...');

      // Show success message before reload
      if (typeof showToast === 'function') {
        showToast('Portfolio created successfully!', 'success');
      }

      setTimeout(() => {
        location.reload();
      }, 500);
    } catch (err) {
      console.error('❌ EXCEPTION:', err);
      console.error('Stack trace:', err.stack);
      alert('Failed to create portfolio: ' + err.message + '\n\nCheck browser console (F12) for details.');
    }

    return false;
  }

  async function handleUploadPortfolio(e) {
    e.preventDefault();

    const form = e.target;
    const fileInput = document.getElementById('portfolioFile');
    const submitBtn = document.getElementById('uploadSubmitBtn');
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('uploadProgressBar');
    const statusText = document.getElementById('uploadStatus');
    const percentText = document.getElementById('uploadPercent');
    const errorDiv = document.getElementById('uploadError');

    // Validate file
    if (!fileInput.files || fileInput.files.length === 0) {
      showUploadError('Please select a file');
      return false;
    }

    const file = fileInput.files[0];
    const maxSize = 10 * 1024 * 1024; // 10MB

    if (file.size > maxSize) {
      showUploadError('File size exceeds 10MB limit');
      return false;
    }

    // Validate file type
    const allowedTypes = ['.csv', '.xlsx', '.xls', '.json'];
    const fileName = file.name.toLowerCase();
    const isValidType = allowedTypes.some(type => fileName.endsWith(type));

    if (!isValidType) {
      showUploadError('Invalid file type. Only CSV, Excel (.xlsx, .xls), and JSON files are allowed.');
      return false;
    }

    // Hide error, show progress
    errorDiv.classList.add('hidden');
    progressDiv.classList.remove('hidden');
    submitBtn.disabled = true;

    try {
      const portfolioName = (form.portfolioName.value || '').trim() || `Uploaded Portfolio - ${new Date().toLocaleDateString()}`;

      console.log('Upload Debug:', {
        fileName: file.name,
        fileSize: file.size,
        fileType: file.type,
        portfolioName: portfolioName
      });

      const formData = new FormData();
      formData.append('portfolio', file);
      formData.append('portfolioName', portfolioName);

      // Simulate progress (since we can't track actual upload progress easily)
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        if (progress <= 90) {
          updateProgress(progress, 'Uploading file...');
        }
      }, 200);

      const response = await authFetch('/api/portfolio-upload/upload', {
        method: 'POST',
        body: formData
      });

      clearInterval(progressInterval);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Upload failed');
      }

      const data = await response.json();

      if (data.error) {
        throw new Error(data.error);
      }

      updateProgress(100, 'Upload complete! Refreshing...');

      // Portfolio is created immediately - just reload to show it
      // Status polling is unreliable on some deployments, so skip it
      setTimeout(() => {
        closeModal('uploadModal');
        location.reload();
      }, 1500);

    } catch (err) {
      console.error('Upload error:', err);
      // Provide helpful message for auth errors
      let errorMessage = err.message;
      if (err.message.includes('Invalid token') || err.message.includes('expired') || err.message.includes('401')) {
        errorMessage = 'Session expired. Please log out and log back in, then try again.';
      }
      showUploadError(errorMessage);
      progressDiv.classList.add('hidden');
      submitBtn.disabled = false;
    }

    return false;
  }

  function updateProgress(percent, status) {
    const progressBar = document.getElementById('uploadProgressBar');
    const statusText = document.getElementById('uploadStatus');
    const percentText = document.getElementById('uploadPercent');

    progressBar.style.width = percent + '%';
    statusText.textContent = status;
    percentText.textContent = Math.round(percent) + '%';
  }

  function showUploadError(message) {
    const errorDiv = document.getElementById('uploadError');
    errorDiv.querySelector('p').textContent = message;
    errorDiv.classList.remove('hidden');
  }

  async function pollUploadStatus(uploadId) {
    let attempts = 0;
    const maxAttempts = 30; // 30 seconds max

    const poll = async () => {
      try {
        const response = await authFetch(`/api/portfolio-upload/status/${uploadId}`);
        const data = await response.json();

        if (data.success && data.upload) {
          const upload = data.upload;

          if (upload.status === 'completed') {
            updateProgress(100, 'Processing complete!');
            setTimeout(() => {
              closeModal('uploadModal');
              location.reload();
            }, 1000);
            return;
          } else if (upload.status === 'failed') {
            showUploadError(upload.errorMessage || 'Upload processing failed');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadSubmitBtn').disabled = false;
            return;
          } else if (upload.status === 'processing') {
            updateProgress(95, 'Processing portfolio data...');

            attempts++;
            if (attempts < maxAttempts) {
              setTimeout(poll, 1000);
            } else {
              showUploadError('Upload is taking longer than expected. Please check upload history.');
              setTimeout(() => location.reload(), 2000);
            }
          }
        }
      } catch (err) {
        console.error('Error polling upload status:', err);
        attempts++;
        if (attempts < maxAttempts) {
          setTimeout(poll, 1000);
        }
      }
    };

    poll();
  }

  async function handleAddHolding(event) {
    event.preventDefault();

    const form = event.target;
    const symbolInput = document.getElementById('holdingSymbol');
    const symbol = symbolInput.value.trim().toUpperCase();
    const name = form.name.value;
    const quantity = parseFloat(form.quantity.value);
    const manualCostBasis = document.getElementById('manualCostBasis').value;
    const fetchedCostBasis = document.getElementById('holdingCostBasis').value;
    const assetType = form.type.value;

    // Use manual cost basis if provided, otherwise use fetched price
    let costBasis;
    if (manualCostBasis && !isNaN(parseFloat(manualCostBasis))) {
      costBasis = parseFloat(manualCostBasis);
    } else if (fetchedCostBasis && !isNaN(parseFloat(fetchedCostBasis))) {
      costBasis = parseFloat(fetchedCostBasis);
    } else {
      alert('Please fetch the live price or enter a manual cost basis');
      return false;
    }

    console.log('=== ADD HOLDING DEBUG ===');
    console.log('Selected Portfolio ID:', selectedPortfolioId);
    console.log('Symbol:', symbol);
    console.log('Name:', name);
    console.log('Quantity:', quantity);
    console.log('Cost Basis:', costBasis);
    console.log('Asset Type:', assetType);

    if (!symbol || !name || isNaN(quantity)) {
      console.error('Validation failed:', { symbol, name, quantity });
      alert('Please search and select a stock, then enter quantity');
      return false;
    }

    if (!selectedPortfolioId) {
      console.error('No portfolio selected!');
      alert('Please select a portfolio first');
      return false;
    }

    try {
      const requestBody = {
        symbol: symbol,
        name: name,
        quantity: quantity,
        cost_basis: costBasis,
        asset_type: assetType
      };

      const response = await authFetch('/api/portfolios/' + selectedPortfolioId + '/holdings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        console.error('Server error:', data.error);
        alert('Error adding holding: ' + (data.error || 'Unknown error'));
        return false;
      }

      if (typeof showToast === 'function') {
        showToast('Holding added successfully!', 'success');
      }

      setTimeout(() => window.location.reload(), 500);
    } catch (err) {
      console.error('Fetch error:', err);
      alert('Failed to add holding: ' + err.message);
    }

    return false;
  }

  async function deletePortfolio(id) {
    if (!confirm('Are you sure you want to delete this portfolio?')) return;

    try {
      const response = await authFetch('/api/portfolios/' + id, { method: 'DELETE' });
      const data = await response.json();

      if (!response.ok || data.error) {
        alert('Error deleting portfolio: ' + (data.error || 'Unknown error'));
        return;
      }

      window.location.href = '/portfolios';
    } catch (err) {
      alert('Failed to delete portfolio: ' + err.message);
    }
  }

  async function fetchLivePrice() {
    const symbolInput = document.getElementById('holdingSymbol');
    const symbol = symbolInput.value.trim().toUpperCase();
    const statusDiv = document.getElementById('priceStatus');
    const priceDisplay = document.getElementById('priceDisplay');
    const fetchBtn = document.querySelector('#fetchPriceBtn');
    const nameInput = document.getElementById('holdingName');

    if (!symbol) {
      statusDiv.innerHTML = '<span class="text-red-400">Please enter a symbol</span>';
      return;
    }

    fetchBtn.disabled = true;
    fetchBtn.querySelector('#fetchBtnText').textContent = 'FETCHING...';
    statusDiv.innerHTML = '<span class="text-slate-400">Loading...</span>';
    priceDisplay.classList.add('hidden');

    try {
      const [quoteResponse, profileResponse] = await Promise.all([
        fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=d4tm751r01qnn6llpesgd4tm751r01qnn6llpet0`),
        fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=d4tm751r01qnn6llpesgd4tm751r01qnn6llpet0`)
      ]);

      const quoteData = await quoteResponse.json();
      const profileData = await profileResponse.json();

      if (quoteData.c && quoteData.c > 0) {
        const price = parseFloat(quoteData.c).toFixed(2);
        const change = parseFloat(quoteData.d || 0).toFixed(2);
        const changePercent = parseFloat(quoteData.dp || 0).toFixed(2);
        const changeColor = quoteData.d >= 0 ? 'text-emerald-400' : 'text-red-400';

        if (profileData.name) {
          nameInput.value = profileData.name;
        } else {
          nameInput.value = symbol;
        }

        statusDiv.innerHTML = `<span class="${changeColor}">Current: $${price} (${change >= 0 ? '+' : ''}${change} / ${changePercent}%)</span>`;
        priceDisplay.classList.remove('hidden');
        document.getElementById('currentPrice').textContent = `$${price}`;
        document.getElementById('priceChange').textContent = `${change >= 0 ? '+' : ''}$${change} (${changePercent}%)`;
        document.getElementById('priceChange').className = `text-sm font-mono ${changeColor}`;

        document.getElementById('holdingCostBasis').value = price;
      } else {
        statusDiv.innerHTML = '<span class="text-red-400">Symbol not found or no data available</span>';
        priceDisplay.classList.add('hidden');
      }
    } catch (error) {
      console.error('Fetch price error:', error);
      statusDiv.innerHTML = '<span class="text-red-400">Failed to fetch price. Please try again.</span>';
      priceDisplay.classList.add('hidden');
    } finally {
      fetchBtn.disabled = false;
      fetchBtn.querySelector('#fetchBtnText').textContent = 'FETCH PRICE';
    }
  }

  // Stock search with debounce
  let searchTimeout = null;
  const FINNHUB_TOKEN = 'd4tm751r01qnn6llpesgd4tm751r01qnn6llpet0';

  function debounceSearch(query) {
    clearTimeout(searchTimeout);
    const resultsDiv = document.getElementById('searchResults');

    if (!query || query.length < 1) {
      resultsDiv.classList.add('hidden');
      return;
    }

    searchTimeout = setTimeout(() => searchStocks(query), 300);
  }

  async function searchStocks(query) {
    const resultsDiv = document.getElementById('searchResults');

    try {
      resultsDiv.innerHTML = '<div class="p-3 text-slate-400 text-sm">Searching...</div>';
      resultsDiv.classList.remove('hidden');

      const response = await fetch(`https://finnhub.io/api/v1/search?q=${encodeURIComponent(query)}&token=${FINNHUB_TOKEN}`);
      const data = await response.json();

      if (!data.result || data.result.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-slate-400 text-sm">No results found</div>';
        return;
      }

      // Filter to only show stocks (not bonds, forex, etc.)
      const stocks = data.result.filter(item =>
        item.type === 'Common Stock' || item.type === 'ETF' || item.type === 'ADR'
      ).slice(0, 8);

      if (stocks.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-slate-400 text-sm">No stocks found</div>';
        return;
      }

      resultsDiv.innerHTML = stocks.map(stock => `
        <div class="p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-0 transition-colors"
             onclick="selectStock('${stock.symbol}', '${stock.description.replace(/'/g, "\\'")}', '${stock.type}')">
          <div class="flex items-center justify-between">
            <div>
              <span class="text-amber-400 font-bold">${stock.symbol}</span>
              <span class="text-slate-500 text-xs ml-2">${stock.type}</span>
            </div>
          </div>
          <p class="text-slate-300 text-sm truncate">${stock.description}</p>
        </div>
      `).join('');

    } catch (error) {
      console.error('Search error:', error);
      resultsDiv.innerHTML = '<div class="p-3 text-red-400 text-sm">Search failed. Try again.</div>';
    }
  }

  function selectStock(symbol, name, type) {
    document.getElementById('holdingSymbol').value = symbol;
    document.getElementById('holdingName').value = name;
    document.getElementById('stockSearch').value = `${symbol} - ${name}`;
    document.getElementById('searchResults').classList.add('hidden');

    // Set asset type based on search result
    const typeSelect = document.querySelector('select[name="type"]');
    if (type === 'ETF') {
      typeSelect.value = 'etf';
    } else {
      typeSelect.value = 'stock';
    }

    // Auto-fetch price
    fetchLivePrice();
  }

  // Close search results when clicking outside
  document.addEventListener('click', function(e) {
    const searchResults = document.getElementById('searchResults');
    const searchInput = document.getElementById('stockSearch');
    if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
      searchResults.classList.add('hidden');
    }
  });

  // Edit Holding Functions
  function openEditHoldingModal(id, symbol, name, quantity, costBasis, assetType) {
    document.getElementById('editHoldingId').value = id;
    document.getElementById('editHoldingIcon').textContent = symbol.slice(0, 2);
    document.getElementById('editHoldingSymbolDisplay').textContent = symbol;
    document.getElementById('editHoldingNameDisplay').textContent = name;
    document.getElementById('editQuantity').value = quantity;
    document.getElementById('editCostBasis').value = costBasis;
    document.getElementById('editAssetType').value = assetType || 'stock';

    openModal('editHoldingModal');
  }

  async function handleEditHolding(event) {
    event.preventDefault();

    const form = event.target;
    const id = document.getElementById('editHoldingId').value;
    const quantity = parseFloat(document.getElementById('editQuantity').value);
    const costBasis = parseFloat(document.getElementById('editCostBasis').value);
    const assetType = document.getElementById('editAssetType').value;

    if (isNaN(quantity) || isNaN(costBasis)) {
      alert('Please enter valid quantity and cost basis');
      return false;
    }

    try {
      const response = await authFetch('/api/holdings/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          quantity: quantity,
          cost_basis: costBasis,
          asset_type: assetType
        })
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        alert('Error updating holding: ' + (data.error || 'Unknown error'));
        return false;
      }

      if (typeof showToast === 'function') {
        showToast('Holding updated successfully!', 'success');
      }

      setTimeout(() => location.reload(), 500);
    } catch (err) {
      console.error('Edit holding error:', err);
      alert('Failed to update holding: ' + err.message);
    }

    return false;
  }

  // Improved Delete with Confirmation
  function confirmDeleteHolding(id, symbol) {
    const confirmed = confirm(`Are you sure you want to delete ${symbol} from your portfolio?\n\nThis action cannot be undone.`);
    if (confirmed) {
      deleteHolding(id);
    }
  }

  async function deleteHolding(id) {
    console.log('Delete holding called with ID:', id);

    try {
      const response = await authFetch('/api/holdings/' + id, { method: 'DELETE' });
      const data = await response.json();

      if (!response.ok || data.error) {
        console.error('Delete failed:', data.error);
        alert('Error deleting holding: ' + (data.error || 'Unknown error'));
        return;
      }

      if (typeof showToast === 'function') {
        showToast('Holding deleted successfully!', 'success');
      }

      location.reload();
    } catch (err) {
      console.error('Delete holding error:', err);
      alert('Failed to delete holding: ' + err.message);
    }
  }

  async function generateReport(portfolioId) {
    if (!portfolioId) {
      alert('No portfolio selected');
      return;
    }

    const confirmed = confirm('Generate comprehensive report with all 20 analytics? This may take a moment.');
    if (!confirmed) return;

    try {
      const reportType = 'comprehensive'; // Can be changed to: performance, risk, attribution, construction, specialized

      const response = await authFetch('/api/reports/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          portfolioId,
          reportType
        })
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        alert('Error generating report: ' + (data.error || 'Unknown error'));
        return;
      }

      // Show success message with report details
      const report = data.report;
      const message = `Report generated successfully!\n\n` +
        `Report ID: ${report.reportId}\n` +
        `Type: ${report.reportType}\n` +
        `Total Value: $${report.summary.totalValue.toFixed(2)}\n` +
        `Total Gain: ${report.summary.totalGain >= 0 ? '+' : ''}$${report.summary.totalGain.toFixed(2)} (${report.summary.totalGainPct.toFixed(2)}%)\n\n` +
        `Analytics included: ${Object.keys(report.analytics).length} categories`;

      alert(message);

      // Option to view HTML summary or download PDF
      const action = confirm('Would you like to:\n\nOK = View HTML Summary\nCancel = Download PDF');

      if (action) {
        // View HTML summary
        window.open(`/api/reports/${report.reportId}/html`, '_blank');
      } else {
        // Generate and download PDF
        await generateAndDownloadPDF(portfolioId, report.reportId);
      }

    } catch (err) {
      console.error('Generate report error:', err);
      alert('Failed to generate report: ' + err.message);
    }
  }

  async function generateAndDownloadPDF(portfolioId, reportId) {
    try {
      // Show generating message
      alert('Generating PDF... This may take 10-15 seconds. Click OK to continue.');

      const response = await authFetch('/api/reports/generate-pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          portfolioId,
          reportType: 'comprehensive'
        })
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        alert('Error generating PDF: ' + (data.error || 'Unknown error'));
        return;
      }

      // Open PDF in new tab (browser will prompt to download or view)
      window.open(`/api/reports/${data.pdf.reportId}/pdf`, '_blank');

      alert('PDF generated successfully! Check your downloads or the new tab.');

    } catch (err) {
      console.error('PDF generation error:', err);
      alert('Failed to generate PDF: ' + err.message);
    }
  }

  async function refreshAllPrices() {
    const btn = document.getElementById('refreshPricesBtn');
    const btnText = document.getElementById('refreshBtnText');
    const icon = document.getElementById('refreshIcon');

    const holdingRows = document.querySelectorAll('.holding-row');
    if (holdingRows.length === 0) {
      alert('No holdings to refresh');
      return;
    }

    btn.disabled = true;
    btnText.textContent = 'REFRESHING...';
    icon.classList.add('animate-spin');

    let successCount = 0;
    let errorCount = 0;

    for (const row of holdingRows) {
      const symbolEl = row.querySelector('.symbol-text');
      if (!symbolEl) continue;

      const symbol = symbolEl.textContent.trim();
      const priceEl = row.querySelector('.price');
      const changeEl = row.querySelector('.change');

      try {
        const response = await authFetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=d4tm751r01qnn6llpesgd4tm751r01qnn6llpet0`);
        const data = await response.json();

        if (data.c && data.c > 0) {
          const price = parseFloat(data.c).toFixed(2);
          if (priceEl) {
            priceEl.textContent = `$${price}`;
            priceEl.classList.add('bg-green-500/20');
            setTimeout(() => priceEl.classList.remove('bg-green-500/20'), 1000);
          }

          if (changeEl && data.d !== undefined) {
            const change = parseFloat(data.d);
            const changePercent = parseFloat(data.dp);
            const changeColor = change >= 0 ? 'text-emerald-400' : 'text-red-400';
            changeEl.className = `py-3 text-right font-mono font-semibold ${changeColor} change`;
            changeEl.textContent = `${change >= 0 ? '+' : ''}$${Math.abs(change).toFixed(2)} (${changePercent.toFixed(2)}%)`;
          }

          successCount++;
        } else {
          errorCount++;
        }
      } catch (error) {
        console.error(`Failed to fetch price for ${symbol}:`, error);
        errorCount++;
      }

      await new Promise(resolve => setTimeout(resolve, 100));
    }

    btn.disabled = false;
    btnText.textContent = 'REFRESH PRICES';
    icon.classList.remove('animate-spin');

    if (successCount > 0) {
      btnText.textContent = `UPDATED ${successCount}`;
      setTimeout(() => btnText.textContent = 'REFRESH PRICES', 2000);
    }

    if (errorCount > 0) {
      console.log(`Failed to update ${errorCount} holdings`);
    }
  }
</script>

<!-- portfolios-fix.js removed - inline handlers work correctly with server token -->
<%- include('../partials/footer') %>
