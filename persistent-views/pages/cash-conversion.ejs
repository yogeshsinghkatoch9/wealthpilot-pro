<%
// Safe defaults for all potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
%>
<%- include('../partials/header', { pageTitle: 'Cash Conversion Cycle' }) %>

<!-- Bloomberg Header Bar -->
<div class="bg-gradient-to-r from-slate-900 to-slate-800 border-l-4 border-amber-400 px-6 py-4 mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-amber-400 font-mono">CASH CONVERSION CYCLE</h1>
      <p class="text-slate-300 text-sm mt-1">Days to convert inventory to cash</p>
    </div>
    <div class="flex gap-2">
      <select class="form-input w-36"><option selected>My Holdings</option><option>Technology</option><option>Consumer</option></select>
    </div>
  </div>
</div>

<!-- CCC Summary -->
<div class="card p-5 bg-gradient-to-r <%= theme === 'light' ? 'from-sky-50 to-emerald-50' : 'from-sky-900/20 to-emerald-900/20' %>">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Portfolio Cash Conversion Overview</h3>
<div class="grid grid-cols-2 md:grid-cols-5 gap-4">
<div class="text-center">
<p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Avg CCC</p>
<p class="text-3xl font-bold text-sky-400">42 days</p>
<p class="text-xs">weighted</p>
</div>
<div class="text-center">
<p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Avg DIO</p>
<p class="text-3xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">58 days</p>
<p class="text-xs">inventory</p>
</div>
<div class="text-center">
<p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Avg DSO</p>
<p class="text-3xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">48 days</p>
<p class="text-xs">receivables</p>
</div>
<div class="text-center">
<p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Avg DPO</p>
<p class="text-3xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">64 days</p>
<p class="text-xs">payables</p>
</div>
<div class="text-center">
<p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Efficient (<30d)</p>
<p class="text-3xl font-bold text-emerald-400">6</p>
<p class="text-xs">holdings</p>
</div>
</div>
</div>

<!-- CCC Formula -->
<div class="card p-4">
<div class="flex items-center justify-center gap-4 text-center">
<div class="p-3 rounded-lg <%= theme === 'light' ? 'bg-amber-50' : 'bg-amber-500/10' %>">
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">DIO</p>
<p class="font-bold text-amber-400">Inv Days</p>
</div>
<span class="text-2xl font-bold">+</span>
<div class="p-3 rounded-lg <%= theme === 'light' ? 'bg-sky-50' : 'bg-sky-500/10' %>">
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">DSO</p>
<p class="font-bold text-sky-400">AR Days</p>
</div>
<span class="text-2xl font-bold">-</span>
<div class="p-3 rounded-lg <%= theme === 'light' ? 'bg-purple-50' : 'bg-purple-500/10' %>">
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">DPO</p>
<p class="font-bold text-purple-400">AP Days</p>
</div>
<span class="text-2xl font-bold">=</span>
<div class="p-3 rounded-lg <%= theme === 'light' ? 'bg-emerald-50' : 'bg-emerald-500/10' %>">
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">CCC</p>
<p class="font-bold text-emerald-400">Cash Cycle</p>
</div>
</div>
</div>

<!-- Holdings CCC Table -->
<div class="card overflow-hidden">
<div class="p-4 border-b <%= theme === 'light' ? 'border-gray-200' : 'border-slate-700' %>">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Holdings Cash Conversion Analysis</h3>
</div>
<table class="w-full text-sm">
<thead>
<tr class="<%= theme === 'light' ? 'bg-gray-50 text-gray-500' : 'bg-slate-800 text-slate-400' %> text-left">
<th class="px-4 py-3">Company</th>
<th class="px-4 py-3 text-center">DIO (Inventory)</th>
<th class="px-4 py-3 text-center">DSO (Receivables)</th>
<th class="px-4 py-3 text-center">DPO (Payables)</th>
<th class="px-4 py-3 text-center">CCC</th>
<th class="px-4 py-3 text-center">YoY Change</th>
<th class="px-4 py-3 text-center">Rating</th>
</tr>
</thead>
<tbody class="<%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">
<tr class="border-b <%= theme === 'light' ? 'border-gray-100 bg-emerald-50/50' : 'border-slate-700/50 bg-emerald-500/5' %>">
<td class="px-4 py-3"><span class="font-bold">AAPL</span></td>
<td class="px-4 py-3 text-center text-amber-400">8 days</td>
<td class="px-4 py-3 text-center text-sky-400">58 days</td>
<td class="px-4 py-3 text-center text-purple-400">112 days</td>
<td class="px-4 py-3 text-center font-bold text-emerald-400">-46 days</td>
<td class="px-4 py-3 text-center text-emerald-400">-4 days</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs">Excellent</span></td>
</tr>
<tr class="border-b <%= theme === 'light' ? 'border-gray-100 bg-emerald-50/50' : 'border-slate-700/50 bg-emerald-500/5' %>">
<td class="px-4 py-3"><span class="font-bold">COST</span></td>
<td class="px-4 py-3 text-center text-amber-400">31 days</td>
<td class="px-4 py-3 text-center text-sky-400">4 days</td>
<td class="px-4 py-3 text-center text-purple-400">42 days</td>
<td class="px-4 py-3 text-center font-bold text-emerald-400">-7 days</td>
<td class="px-4 py-3 text-center text-emerald-400">-2 days</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs">Excellent</span></td>
</tr>
<tr class="border-b <%= theme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><span class="font-bold">MSFT</span></td>
<td class="px-4 py-3 text-center text-amber-400">12 days</td>
<td class="px-4 py-3 text-center text-sky-400">82 days</td>
<td class="px-4 py-3 text-center text-purple-400">68 days</td>
<td class="px-4 py-3 text-center font-bold">26 days</td>
<td class="px-4 py-3 text-center text-emerald-400">-8 days</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs">Good</span></td>
</tr>
<tr class="border-b <%= theme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><span class="font-bold">NVDA</span></td>
<td class="px-4 py-3 text-center text-amber-400">124 days</td>
<td class="px-4 py-3 text-center text-sky-400">52 days</td>
<td class="px-4 py-3 text-center text-purple-400">62 days</td>
<td class="px-4 py-3 text-center font-bold text-amber-400">114 days</td>
<td class="px-4 py-3 text-center text-red-400">+28 days</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-amber-500/20 text-amber-400 text-xs">Fair</span></td>
</tr>
<tr>
<td class="px-4 py-3"><span class="font-bold">BA</span></td>
<td class="px-4 py-3 text-center text-amber-400">428 days</td>
<td class="px-4 py-3 text-center text-sky-400">14 days</td>
<td class="px-4 py-3 text-center text-purple-400">82 days</td>
<td class="px-4 py-3 text-center font-bold text-red-400">360 days</td>
<td class="px-4 py-3 text-center text-red-400">+42 days</td>
<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs">Poor</span></td>
</tr>
</tbody>
</table>
</div>

<!-- CCC Insights -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="card p-5">
<h4 class="font-bold text-emerald-400 mb-3">üíé Negative CCC (Best)</h4>
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> mb-3">Gets paid before paying suppliers</p>
<div class="space-y-2">
<div class="flex justify-between"><span>AAPL</span><span class="font-bold text-emerald-400">-46 days</span></div>
<div class="flex justify-between"><span>AMZN</span><span class="font-bold text-emerald-400">-24 days</span></div>
<div class="flex justify-between"><span>COST</span><span class="font-bold text-emerald-400">-7 days</span></div>
</div>
</div>
<div class="card p-5">
<h4 class="font-bold text-sky-400 mb-3">üìà Most Improved</h4>
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> mb-3">YoY CCC reduction</p>
<div class="space-y-2">
<div class="flex justify-between"><span>META</span><span class="font-bold text-emerald-400">-14 days</span></div>
<div class="flex justify-between"><span>MSFT</span><span class="font-bold text-emerald-400">-8 days</span></div>
<div class="flex justify-between"><span>GOOGL</span><span class="font-bold text-emerald-400">-6 days</span></div>
</div>
</div>
<div class="card p-5">
<h4 class="font-bold text-red-400 mb-3">‚ö†Ô∏è High CCC (Watch)</h4>
<p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %> mb-3">Cash tied up in operations</p>
<div class="space-y-2">
<div class="flex justify-between"><span>BA</span><span class="font-bold text-red-400">360 days</span></div>
<div class="flex justify-between"><span>CAT</span><span class="font-bold text-red-400">142 days</span></div>
<div class="flex justify-between"><span>NVDA</span><span class="font-bold text-amber-400">114 days</span></div>
</div>
</div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="card p-5">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">CCC Breakdown - AAPL</h3>
<div class="h-48"><canvas id="breakdownChart"></canvas></div>
</div>
<div class="card p-5">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">CCC by Holding</h3>
<div class="h-48"><canvas id="cccChart"></canvas></div>
</div>
</div>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('breakdownChart'), {
  type: 'bar',
  data: { labels: ['DIO','DSO','DPO','CCC'], datasets: [{ label: 'Days', data: [8,58,-112,-46], backgroundColor: ['#f59e0b','#0ea5e9','#8b5cf6','#10b981'] }] },
  options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
});
new Chart(document.getElementById('cccChart'), {
  type: 'bar',
  data: { labels: ['AAPL','AMZN','COST','MSFT','META','NVDA','BA'], datasets: [{ label: 'CCC (days)', data: [-46,-24,-7,26,32,114,360], backgroundColor: d => d.raw < 0 ? '#10b981' : d.raw < 60 ? '#0ea5e9' : d.raw < 120 ? '#f59e0b' : '#ef4444' }] },
  options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
});
</script>
<%- include('../partials/footer') %>
