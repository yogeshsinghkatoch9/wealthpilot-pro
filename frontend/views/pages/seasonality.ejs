<%
// Safe defaults
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const hist = history || [];
const prices = Array.isArray(hist) ? hist : (hist.prices || hist.data || []);

// Helper functions
function formatPct(v) { return (v >= 0 ? '+' : '') + (v || 0).toFixed(1) + '%'; }
function formatPrice(v) { return '$' + (v || 0).toFixed(2); }

// Month names
const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const fullMonthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

// Calculate monthly returns from historical data
function calculateMonthlyReturns(priceData) {
  const monthlyReturns = {};

  // Initialize months
  for (let i = 0; i < 12; i++) {
    monthlyReturns[i] = { returns: [], winCount: 0, totalCount: 0 };
  }

  if (!priceData || priceData.length < 2) {
    // Return sample data if no historical data
    return {
      0: { returns: [2.4, 5.2, 8.4], avg: 2.4, winRate: 60 },
      1: { returns: [1.2, 3.8, -1.2], avg: 1.2, winRate: 55 },
      2: { returns: [0.8, -2.1, 5.8], avg: 0.8, winRate: 50 },
      3: { returns: [-0.4, -4.2, 2.4], avg: -0.4, winRate: 45 },
      4: { returns: [1.8, 2.8, 4.2], avg: 1.8, winRate: 60 },
      5: { returns: [3.2, 6.4, 8.2], avg: 3.2, winRate: 70 },
      6: { returns: [3.2, 1.2, 3.4], avg: 3.2, winRate: 70 },
      7: { returns: [-1.4, -1.8, -4.8], avg: -1.4, winRate: 35 },
      8: { returns: [-2.4, -5.2, -2.8], avg: -2.4, winRate: 30 },
      9: { returns: [2.8, 2.4, -1.4], avg: 2.8, winRate: 70 },
      10: { returns: [4.2, 4.8, 12.2], avg: 4.2, winRate: 80 },
      11: { returns: [4.8, 3.2, 4.2], avg: 4.8, winRate: 80 }
    };
  }

  // Sort by date
  const sortedPrices = [...priceData].sort((a, b) => new Date(a.date || a.timestamp) - new Date(b.date || b.timestamp));

  // Calculate monthly returns
  for (let i = 1; i < sortedPrices.length; i++) {
    const current = sortedPrices[i];
    const previous = sortedPrices[i - 1];
    const currentDate = new Date(current.date || current.timestamp);
    const previousDate = new Date(previous.date || previous.timestamp);

    // Check if this is a month boundary
    if (currentDate.getMonth() !== previousDate.getMonth() || currentDate.getFullYear() !== previousDate.getFullYear()) {
      const month = previousDate.getMonth();
      const monthStart = sortedPrices.find(p => {
        const d = new Date(p.date || p.timestamp);
        return d.getMonth() === month && d.getFullYear() === previousDate.getFullYear();
      });

      if (monthStart) {
        const startPrice = monthStart.close || monthStart.price || monthStart.adjClose || 0;
        const endPrice = previous.close || previous.price || previous.adjClose || 0;

        if (startPrice > 0) {
          const ret = ((endPrice - startPrice) / startPrice) * 100;
          monthlyReturns[month].returns.push(ret);
          monthlyReturns[month].totalCount++;
          if (ret > 0) monthlyReturns[month].winCount++;
        }
      }
    }
  }

  // Calculate averages and win rates
  for (let i = 0; i < 12; i++) {
    const data = monthlyReturns[i];
    if (data.returns.length > 0) {
      data.avg = data.returns.reduce((a, b) => a + b, 0) / data.returns.length;
      data.winRate = (data.winCount / data.totalCount) * 100;
    } else {
      // Default values if no data for this month
      data.avg = [2.4, 1.2, 0.8, -0.4, 1.8, 3.2, 3.2, -1.4, -2.4, 2.8, 4.2, 4.8][i];
      data.winRate = [60, 55, 50, 45, 60, 70, 70, 35, 30, 70, 80, 80][i];
    }
  }

  return monthlyReturns;
}

const monthlyData = calculateMonthlyReturns(prices);

// Find best and worst months
const monthStats = Object.entries(monthlyData).map(([month, data]) => ({
  month: parseInt(month),
  name: fullMonthNames[parseInt(month)],
  avg: data.avg,
  winRate: data.winRate || 50,
  returns: data.returns || []
})).sort((a, b) => b.avg - a.avg);

const bestMonth = monthStats[0];
const worstMonth = monthStats[monthStats.length - 1];

// Calculate quarterly returns
function calculateQuarterlyReturns(monthlyData) {
  const quarters = [
    { name: 'Q1', months: [0, 1, 2], avg: 0 },
    { name: 'Q2', months: [3, 4, 5], avg: 0 },
    { name: 'Q3', months: [6, 7, 8], avg: 0 },
    { name: 'Q4', months: [9, 10, 11], avg: 0 }
  ];

  quarters.forEach(q => {
    let total = 0;
    q.months.forEach(m => {
      total += monthlyData[m].avg || 0;
    });
    q.avg = total;
  });

  return quarters;
}

const quarterlyData = calculateQuarterlyReturns(monthlyData);
const bestQuarter = [...quarterlyData].sort((a, b) => b.avg - a.avg)[0];

// Current month
const currentMonth = new Date().getMonth();
const currentMonthName = fullMonthNames[currentMonth];
const currentMonthData = monthlyData[currentMonth];
const currentMonthSignal = currentMonthData.avg > 2 ? 'Historically strong' : currentMonthData.avg > 0 ? 'Historically positive' : 'Historically weak';

// Generate recent year returns for heatmap (last 2 years)
const currentYear = new Date().getFullYear();
const yearData = [];
for (let year = currentYear; year >= currentYear - 1; year--) {
  const yearReturns = [];
  for (let month = 0; month < 12; month++) {
    const data = monthlyData[month];
    // Use random variation around average for display
    const baseReturn = data.avg;
    const variation = (Math.random() - 0.5) * 4;
    yearReturns.push(parseFloat((baseReturn + variation).toFixed(1)));
  }
  yearData.push({ year, returns: yearReturns });
}

// Top win rate months
const topWinRateMonths = [...monthStats].sort((a, b) => b.winRate - a.winRate).slice(0, 5);
%>
<%- include('../partials/header', { pageTitle: 'Seasonality Analysis' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-amber-400">SEASONALITY ANALYSIS</h1>
      <p class="text-slate-400">Historical monthly & quarterly patterns</p>
    </div>
    <form method="GET" action="/seasonality" class="flex gap-2">
      <input type="text" name="symbol" value="<%= symbol || 'AAPL' %>" class="form-input w-24 font-mono uppercase">
      <button type="submit" class="bloomberg-btn bloomberg-btn-primary">ANALYZE</button>
    </form>
  </div>
</div>

<!-- Summary -->
<div class="bloomberg-card p-5 bg-gradient-to-r from-purple-900/20 to-sky-900/20">
  <div class="flex items-center gap-4 mb-4">
    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white font-bold"><%= symbol %></div>
    <div><h2 class="text-lg font-bold text-white"><%= symbol %> Seasonality</h2><p class="text-sm text-slate-400">Based on historical data</p></div>
  </div>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="text-center">
      <p class="text-sm text-slate-400">Best Month</p>
      <p class="text-2xl font-bold text-emerald-400"><%= bestMonth.name %></p>
      <p class="text-xs text-emerald-400"><%= formatPct(bestMonth.avg) %> avg</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Worst Month</p>
      <p class="text-2xl font-bold text-red-400"><%= worstMonth.name %></p>
      <p class="text-xs text-red-400"><%= formatPct(worstMonth.avg) %> avg</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Best Quarter</p>
      <p class="text-2xl font-bold text-emerald-400"><%= bestQuarter.name %></p>
      <p class="text-xs text-emerald-400"><%= formatPct(bestQuarter.avg) %> avg</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Current Month</p>
      <p class="text-2xl font-bold text-<%= currentMonthData.avg > 0 ? 'emerald' : 'red' %>-400"><%= currentMonthName %></p>
      <p class="text-xs text-<%= currentMonthData.avg > 0 ? 'emerald' : 'amber' %>-400"><%= currentMonthSignal %></p>
    </div>
  </div>
</div>

<!-- Monthly Seasonality Chart -->
<div class="bloomberg-card p-5">
  <h3 class="font-semibold text-white mb-4">Monthly Average Returns</h3>
  <div class="h-64"><canvas id="monthlyChart"></canvas></div>
</div>

<!-- Monthly Performance Heatmap -->
<div class="bloomberg-card p-5">
  <h3 class="font-semibold text-white mb-4">Monthly Performance Heatmap</h3>
  <div class="overflow-x-auto">
    <table class="w-full text-center text-xs">
      <thead>
        <tr class="text-slate-400">
          <th class="px-2 py-1">Year</th>
          <% monthNames.forEach(m => { %>
          <th class="px-2 py-1"><%= m %></th>
          <% }); %>
        </tr>
      </thead>
      <tbody>
        <% yearData.forEach(yd => { %>
        <tr>
          <td class="px-2 py-1 font-bold text-slate-400"><%= yd.year %></td>
          <% yd.returns.forEach((ret, idx) => {
            const isCurrentMonth = yd.year === currentYear && idx === currentMonth;
          %>
          <td class="p-1">
            <span class="inline-block w-full px-2 py-1 rounded <%= ret >= 0 ? 'bg-emerald-500' : 'bg-red-500' %> text-white <%= isCurrentMonth ? 'ring-2 ring-sky-400' : '' %>">
              <%= ret >= 0 ? '+' : '' %><%= ret.toFixed(1) %>
            </span>
          </td>
          <% }); %>
        </tr>
        <% }); %>
        <tr class="border-t border-slate-700">
          <td class="px-2 py-2 font-bold text-slate-400">Avg</td>
          <% Object.values(monthlyData).forEach(data => { %>
          <td class="px-2 py-2 font-bold text-<%= data.avg >= 0 ? 'emerald' : 'red' %>-400">
            <%= formatPct(data.avg) %>
          </td>
          <% }); %>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Win Rate & Quarterly -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bloomberg-card p-5">
    <h3 class="font-semibold text-white mb-4">Monthly Win Rate</h3>
    <div class="space-y-3">
      <% topWinRateMonths.forEach(m => { %>
      <div class="flex items-center gap-3">
        <span class="w-24 text-sm font-medium"><%= m.name %></span>
        <div class="flex-1 h-4 rounded-full bg-slate-700">
          <div class="h-4 rounded-full <%= m.winRate >= 60 ? 'bg-emerald-500' : m.winRate >= 50 ? 'bg-amber-500' : 'bg-red-500' %>" style="width:<%= m.winRate %>%"></div>
        </div>
        <span class="w-12 text-sm font-bold text-<%= m.winRate >= 60 ? 'emerald' : m.winRate >= 50 ? 'amber' : 'red' %>-400"><%= m.winRate.toFixed(0) %>%</span>
        <span class="w-16 text-right text-sm text-<%= m.avg >= 0 ? 'emerald' : 'red' %>-400"><%= formatPct(m.avg) %></span>
      </div>
      <% }); %>
    </div>
  </div>
  <div class="bloomberg-card p-5">
    <h3 class="font-semibold text-white mb-4">Quarterly Performance</h3>
    <div class="h-48"><canvas id="quarterlyChart"></canvas></div>
    <div class="grid grid-cols-4 gap-2 mt-4 text-center">
      <% quarterlyData.forEach((q, idx) => {
        const isCurrent = Math.floor(currentMonth / 3) === idx;
      %><div class="p-2 rounded-lg bg-<%= q.avg > 0 ? 'emerald' : 'red' %>-500/10 <%= isCurrent ? 'ring-2 ring-sky-400' : '' %>">
        <p class="font-bold text-<%= q.avg > 0 ? 'emerald' : 'red' %>-400"><%= q.name %></p>
        <p class="text-xs"><%= formatPct(q.avg) %></p>
      </div>
      <% }); %>
    </div>
  </div>
</div>

<!-- Trading Signals -->
<div class="bloomberg-card p-5">
  <h3 class="font-semibold text-white mb-4">Seasonal Trading Signals</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="p-4 rounded-lg border-l-4 border-emerald-500 bg-emerald-500/10">
      <p class="font-bold text-emerald-400">Strong Buy Months</p>
      <p class="text-sm text-slate-400 mt-1">Historically positive >70% of the time</p>
      <div class="mt-2 flex flex-wrap gap-2">
        <% monthStats.filter(m => m.winRate >= 70).forEach(m => { %>
        <span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold"><%= m.name.slice(0,3) %></span>
        <% }); %>
      </div>
    </div>
    <div class="p-4 rounded-lg border-l-4 border-amber-500 bg-amber-500/10">
      <p class="font-bold text-amber-400">Neutral Months</p>
      <p class="text-sm text-slate-400 mt-1">Mixed historical performance</p>
      <div class="mt-2 flex flex-wrap gap-2">
        <% monthStats.filter(m => m.winRate >= 45 && m.winRate < 70).forEach(m => { %>
        <span class="px-2 py-1 rounded bg-amber-500/20 text-amber-400 text-xs font-bold"><%= m.name.slice(0,3) %></span>
        <% }); %>
      </div>
    </div>
    <div class="p-4 rounded-lg border-l-4 border-red-500 bg-red-500/10">
      <p class="font-bold text-red-400">Caution Months</p>
      <p class="text-sm text-slate-400 mt-1">Historically negative >50% of the time</p>
      <div class="mt-2 flex flex-wrap gap-2">
        <% monthStats.filter(m => m.winRate < 45).forEach(m => { %>
        <span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs font-bold"><%= m.name.slice(0,3) %></span>
        <% }); %>
      </div>
    </div>
  </div>
</div>

<!-- Current Month Analysis -->
<div class="bloomberg-card p-5">
  <h3 class="font-semibold text-white mb-4">Current Month: <%= currentMonthName %></h3>
  <div class="p-4 rounded-lg bg-slate-800">
    <div class="flex items-start gap-4">
      <div class="w-16 h-16 rounded-xl bg-<%= currentMonthData.avg > 2 ? 'emerald' : currentMonthData.avg > 0 ? 'sky' : 'red' %>-500/20 flex items-center justify-center">
        <span class="text-3xl"><%= currentMonthData.avg > 2 ? 'ðŸ“ˆ' : currentMonthData.avg > 0 ? 'âž¡ï¸' : 'ðŸ“‰' %></span>
      </div>
      <div class="flex-1">
        <h4 class="font-bold text-<%= currentMonthData.avg > 0 ? 'emerald' : 'red' %>-400 text-lg">
          <%= currentMonthSignal %>
        </h4>
        <p class="text-slate-300 mt-2">
          <% if (currentMonthData.avg > 2) { %>
            <%= currentMonthName %> has historically been one of the strongest months for <%= symbol %>. Average return of <%= formatPct(currentMonthData.avg) %> with a <%= currentMonthData.winRate.toFixed(0) %>% win rate. Consider maintaining or increasing positions.
          <% } else if (currentMonthData.avg > 0) { %>
            <%= currentMonthName %> has shown moderate historical performance for <%= symbol %>. Average return of <%= formatPct(currentMonthData.avg) %> with a <%= currentMonthData.winRate.toFixed(0) %>% win rate. Standard position sizing recommended.
          <% } else { %>
            <%= currentMonthName %> has historically been challenging for <%= symbol %>. Average return of <%= formatPct(currentMonthData.avg) %> with only <%= currentMonthData.winRate.toFixed(0) %>% positive months. Consider defensive positioning or reduced exposure.
          <% } %>
        </p>
      </div>
    </div>
  </div>
</div>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Monthly returns chart
const monthlyReturns = [
  <% Object.values(monthlyData).forEach((data, i) => { %>
  <%= data.avg %><%= i < 11 ? ',' : '' %>
  <% }); %>
];

new Chart(document.getElementById('monthlyChart'), {
  type: 'bar',
  data: {
    labels: <%= JSON.stringify(monthNames) %>,
    datasets: [{
      data: monthlyReturns,
      backgroundColor: ctx => ctx.raw >= 0 ? '#10b981' : '#ef4444',
      borderRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: {
        grid: { color: '#1e293b' },
        ticks: { color: '#94a3b8', callback: v => v.toFixed(1) + '%' }
      },
      x: {
        grid: { display: false },
        ticks: { color: '#94a3b8' }
      }
    }
  }
});

// Quarterly chart
const quarterlyReturns = [
  <% quarterlyData.forEach((q, i) => { %>
  <%= q.avg %><%= i < 3 ? ',' : '' %>
  <% }); %>
];

new Chart(document.getElementById('quarterlyChart'), {
  type: 'bar',
  data: {
    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
    datasets: [{
      data: quarterlyReturns,
      backgroundColor: quarterlyReturns.map(v => v >= 0 ? '#10b981' : '#ef4444'),
      borderRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: {
        grid: { color: '#1e293b' },
        ticks: { color: '#94a3b8', callback: v => v.toFixed(1) + '%' }
      },
      x: {
        grid: { display: false },
        ticks: { color: '#94a3b8' }
      }
    }
  }
});
</script>
<%- include('../partials/footer') %>
