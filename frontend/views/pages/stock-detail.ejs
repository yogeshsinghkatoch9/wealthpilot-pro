<%- include('../partials/header', { pageTitle: symbol + ' Stock Details' }) %>

<link rel="stylesheet" href="/css/styles.css">
<link rel="stylesheet" href="/css/skeleton.css">
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    body {
      background: #0d1117;
      color: #c9d1d9;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }

    .stock-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header Section */
    .stock-header {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .stock-title-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .stock-title {
      font-size: 32px;
      font-weight: 600;
      color: #f0f6fc;
      margin: 0;
    }

    .stock-symbol {
      font-size: 16px;
      color: #8b949e;
      margin: 4px 0 0 0;
    }

    .stock-price-section {
      display: flex;
      align-items: baseline;
      gap: 16px;
      margin-top: 12px;
    }

    .current-price {
      font-size: 48px;
      font-weight: 600;
      color: #f0f6fc;
    }

    .price-change {
      font-size: 20px;
      font-weight: 500;
      padding: 4px 12px;
      border-radius: 4px;
    }

    .price-change.positive {
      color: #3fb950;
      background: rgba(63, 185, 80, 0.1);
    }

    .price-change.negative {
      color: #f85149;
      background: rgba(248, 81, 73, 0.1);
    }

    /* Chart Section */
    .chart-container {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .time-periods {
      display: flex;
      gap: 8px;
    }

    .period-btn {
      background: transparent;
      border: 1px solid #30363d;
      color: #8b949e;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .period-btn:hover {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    .period-btn.active {
      background: #f59e0b;
      border-color: #f59e0b;
      color: #0d1117;
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #8b949e;
      margin: 0 0 16px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #21262d;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #8b949e;
      font-size: 14px;
    }

    .stat-value {
      color: #f0f6fc;
      font-size: 14px;
      font-weight: 500;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #f59e0b;
    }

    .loading-spinner {
      border: 3px solid #30363d;
      border-top: 3px solid #f59e0b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Error State */
    .error-message {
      background: #161b22;
      border: 1px solid #f85149;
      border-left: 4px solid #f85149;
      border-radius: 6px;
      padding: 20px;
      color: #f85149;
      margin: 20px 0;
    }

    /* Back Button */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      border: 1px solid #30363d;
      color: #8b949e;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .back-btn:hover {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    /* Description */
    .description-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .description-card h3 {
      font-size: 16px;
      color: #f0f6fc;
      margin: 0 0 12px 0;
    }

    .description-card p {
      color: #8b949e;
      line-height: 1.6;
      margin: 0;
    }
  </style>
</head>
<body>
  <%- include('../partials/header') %>

  <div class="stock-container">
    <a href="/market-dashboard" class="back-btn">
      ← Back to Market Dashboard
    </a>

    <div id="loading" class="loading">
      <!-- Skeleton Loader for Stock Detail -->
      <div class="skeleton-stock-detail">
        <!-- Header Skeleton -->
        <div class="stock-header" style="border: none;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
            <div style="flex: 1;">
              <div class="skeleton skeleton-line-lg skeleton-w-1-3" style="margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-line-sm skeleton-w-1-4"></div>
            </div>
            <div style="display: flex; gap: 8px;">
              <div class="skeleton skeleton-rect" style="width: 140px; height: 36px;"></div>
              <div class="skeleton skeleton-rect" style="width: 140px; height: 36px;"></div>
            </div>
          </div>
          <div style="display: flex; align-items: baseline; gap: 16px; margin-top: 12px;">
            <div class="skeleton skeleton-line" style="width: 200px; height: 48px;"></div>
            <div class="skeleton skeleton-rect" style="width: 150px; height: 32px;"></div>
          </div>
        </div>
        <!-- Chart Skeleton -->
        <div class="skeleton-chart" style="height: 400px; margin: 20px 0;"></div>
        <!-- Stats Grid Skeleton -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 20px;">
          <div class="skeleton-stat-card">
            <div class="skeleton skeleton-line-sm skeleton-w-1-2"></div>
            <div class="skeleton skeleton-line-lg skeleton-w-3-4"></div>
          </div>
          <div class="skeleton-stat-card">
            <div class="skeleton skeleton-line-sm skeleton-w-1-2"></div>
            <div class="skeleton skeleton-line-lg skeleton-w-3-4"></div>
          </div>
          <div class="skeleton-stat-card">
            <div class="skeleton skeleton-line-sm skeleton-w-1-2"></div>
            <div class="skeleton skeleton-line-lg skeleton-w-3-4"></div>
          </div>
          <div class="skeleton-stat-card">
            <div class="skeleton skeleton-line-sm skeleton-w-1-2"></div>
            <div class="skeleton skeleton-line-lg skeleton-w-3-4"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="error" class="error-state" style="display: none;">
      <svg class="error-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <h3 class="error-state-title">Failed to load stock data</h3>
      <p class="error-state-message" id="error-message">Something went wrong. Please try again.</p>
      <button class="error-state-retry-btn" onclick="loadStockData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        Try Again
      </button>
    </div>

    <div id="content" style="display: none;">
      <!-- Header with Price -->
      <div class="stock-header">
        <div class="stock-title-row">
          <div>
            <h1 class="stock-title" id="company-name">Loading...</h1>
            <p class="stock-symbol" id="symbol-sector"></p>
          </div>
          <div class="action-buttons" style="display: flex; gap: 10px;">
            <button id="add-to-portfolio-btn" class="period-btn" style="background: #3fb950; border-color: #3fb950; color: #0d1117;">
              + Add to Portfolio
            </button>
            <button id="add-to-watchlist-btn" class="period-btn" style="background: #f59e0b; border-color: #f59e0b; color: #0d1117;">
              + Add to Watchlist
            </button>
          </div>
        </div>
        <div class="stock-price-section">
          <div class="current-price" id="current-price">$0.00</div>
          <div class="price-change" id="price-change">+$0.00 (0.00%)</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-container">
        <div class="chart-controls">
          <div class="time-periods">
            <button class="period-btn" data-period="1D">1D</button>
            <button class="period-btn active" data-period="1W">1W</button>
            <button class="period-btn" data-period="1M">1M</button>
            <button class="period-btn" data-period="6M">6M</button>
            <button class="period-btn" data-period="1Y">1Y</button>
            <button class="period-btn" data-period="5Y">5Y</button>
            <button class="period-btn" data-period="MAX">Max</button>
          </div>
          <div id="chart-source" style="color: #8b949e; font-size: 12px;">
            Source: Finnhub
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="stock-chart"></canvas>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <!-- Key Statistics -->
        <div class="stat-card">
          <h3>Key Statistics</h3>
          <div class="stat-row">
            <span class="stat-label">Open</span>
            <span class="stat-value" id="stat-open">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">High</span>
            <span class="stat-value" id="stat-high">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Low</span>
            <span class="stat-value" id="stat-low">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Prev Close</span>
            <span class="stat-value" id="stat-prev">-</span>
          </div>
        </div>

        <!-- Company Info -->
        <div class="stat-card">
          <h3>Company Info</h3>
          <div class="stat-row">
            <span class="stat-label">Market Cap</span>
            <span class="stat-value" id="stat-marketcap">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">P/E Ratio</span>
            <span class="stat-value" id="stat-pe">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Dividend Yield</span>
            <span class="stat-value" id="stat-dividend">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Beta</span>
            <span class="stat-value" id="stat-beta">-</span>
          </div>
        </div>

        <!-- 52-Week Range -->
        <div class="stat-card">
          <h3>52-Week Range</h3>
          <div class="stat-row">
            <span class="stat-label">High</span>
            <span class="stat-value" id="stat-52high">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Low</span>
            <span class="stat-value" id="stat-52low">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Range</span>
            <span class="stat-value" id="stat-52range">-</span>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="description-card" id="description-container" style="display: none;">
        <h3>About</h3>
        <p id="company-description"></p>
      </div>
    </div>
  </div>

  <script>
    const symbol = '<%= symbol %>' || 'AAPL';
    const FINNHUB_TOKEN = 'd4tm751r01qnn6llpesgd4tm751r01qnn6llpet0';
    let stockData = null;
    let chartInstance = null;
    let currentPeriod = '1W';

    // Load stock data using backend API (with 7-provider fallback) first, then Finnhub as backup
    async function loadStockData() {
      try {
        // Use comprehensive detail endpoint
        const detailRes = await fetch(`/api/market/detail/${symbol}`, { credentials: 'include' });

        if (!detailRes.ok) {
          throw new Error('Failed to fetch stock data');
        }

        const data = await detailRes.json();

        if (!data || !data.price || data.price === 0) {
          throw new Error('Stock symbol not found or no data available');
        }

        stockData = {
          quote: {
            price: data.price,
            change: data.change || 0,
            changePercent: data.changePercent || 0,
            open: data.open,
            high: data.dayHigh,
            low: data.dayLow,
            previousClose: data.previousClose
          },
          company: {
            name: data.name || symbol,
            sector: data.sector || data.industry || '',
            marketCap: data.marketCap,
            description: data.description || '',
            website: data.website || '',
            employees: data.employees
          },
          keyStats: {
            peRatio: data.peRatio,
            eps: data.eps,
            dividendYield: data.dividendYield,
            beta: data.beta,
            fiftyTwoWeekHigh: data.fiftyTwoWeekHigh,
            fiftyTwoWeekLow: data.fiftyTwoWeekLow,
            fiftyDayAverage: data.fiftyDayAverage,
            twoHundredDayAverage: data.twoHundredDayAverage,
            profitMargins: data.profitMargins,
            returnOnEquity: data.returnOnEquity
          },
          history: data.history || []
        };

        displayStockData();

        // Use pre-loaded history data for chart if available
        if (stockData.history && stockData.history.length > 0) {
          displayChartFromHistory(stockData.history, currentPeriod);
        } else {
          loadChart(currentPeriod);
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading stock data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').textContent = error.message || 'Something went wrong. Please try again.';
        document.getElementById('error').style.display = 'flex';
      }
    }

    // Display chart from pre-loaded history data
    function displayChartFromHistory(history, period) {
      const now = new Date();
      let cutoffDate;

      switch(period) {
        case '1D': cutoffDate = new Date(now - 1 * 24 * 60 * 60 * 1000); break;
        case '1W': cutoffDate = new Date(now - 7 * 24 * 60 * 60 * 1000); break;
        case '1M': cutoffDate = new Date(now - 30 * 24 * 60 * 60 * 1000); break;
        case '6M': cutoffDate = new Date(now - 180 * 24 * 60 * 60 * 1000); break;
        case '1Y': cutoffDate = new Date(now - 365 * 24 * 60 * 60 * 1000); break;
        case '5Y': cutoffDate = new Date(now - 5 * 365 * 24 * 60 * 60 * 1000); break;
        default: cutoffDate = new Date(0);
      }

      const filteredData = history.filter(h => new Date(h.date) >= cutoffDate);

      if (filteredData.length === 0) {
        loadChart(period);
        return;
      }

      const chartData = {
        labels: filteredData.map(h => new Date(h.date)),
        datasets: [{
          label: symbol,
          data: filteredData.map(h => h.close),
          borderColor: stockData.quote.change >= 0 ? '#3fb950' : '#f85149',
          backgroundColor: stockData.quote.change >= 0 ? 'rgba(63, 185, 80, 0.1)' : 'rgba(248, 81, 73, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 0,
          borderWidth: 2
        }]
      };

      if (chart) chart.destroy();

      const ctx = document.getElementById('stock-chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `$${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: period === '1D' || period === '1W' ? 'day' : 'month' },
              grid: { color: 'rgba(48, 54, 61, 0.5)' },
              ticks: { color: '#8b949e' }
            },
            y: {
              grid: { color: 'rgba(48, 54, 61, 0.5)' },
              ticks: { color: '#8b949e', callback: v => '$' + v.toFixed(2) }
            }
          }
        }
      });

      document.getElementById('chart-source').textContent = 'Source: Yahoo Finance';
    }

    // Display stock data
    function displayStockData() {
      const { quote, company, keyStats } = stockData;

      // Header
      document.getElementById('company-name').textContent = company?.name || symbol;
      document.getElementById('symbol-sector').textContent =
        `${symbol}${company?.sector ? ' • ' + company.sector : ''}`;

      // Price
      if (quote) {
        document.getElementById('current-price').textContent = `$${quote.price.toFixed(2)}`;

        const change = quote.change;
        const changePercent = quote.changePercent;
        const changeClass = change >= 0 ? 'positive' : 'negative';
        const changeSign = change >= 0 ? '+' : '';

        const changeEl = document.getElementById('price-change');
        changeEl.textContent = `${changeSign}$${Math.abs(change).toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)`;
        changeEl.className = `price-change ${changeClass}`;

        // Key Stats (Day stats)
        document.getElementById('stat-open').textContent = quote.open ? `$${quote.open.toFixed(2)}` : '-';
        document.getElementById('stat-high').textContent = quote.high ? `$${quote.high.toFixed(2)}` : '-';
        document.getElementById('stat-low').textContent = quote.low ? `$${quote.low.toFixed(2)}` : '-';
        document.getElementById('stat-prev').textContent = quote.previousClose ? `$${quote.previousClose.toFixed(2)}` : '-';
      }

      // Company Info (from keyStats)
      const marketCap = company?.marketCap || keyStats?.marketCap;
      document.getElementById('stat-marketcap').textContent =
        marketCap ? `$${(marketCap / 1e9).toFixed(2)}B` : '-';
      document.getElementById('stat-pe').textContent =
        keyStats?.peRatio ? keyStats.peRatio.toFixed(2) : '-';
      document.getElementById('stat-dividend').textContent =
        keyStats?.dividendYield ? `${(keyStats.dividendYield * 100).toFixed(2)}%` : '-';
      document.getElementById('stat-beta').textContent =
        keyStats?.beta ? keyStats.beta.toFixed(2) : '-';

      // 52-Week Range (from keyStats)
      document.getElementById('stat-52high').textContent =
        keyStats?.fiftyTwoWeekHigh ? `$${keyStats.fiftyTwoWeekHigh.toFixed(2)}` : '-';
      document.getElementById('stat-52low').textContent =
        keyStats?.fiftyTwoWeekLow ? `$${keyStats.fiftyTwoWeekLow.toFixed(2)}` : '-';

      if (keyStats?.fiftyTwoWeekHigh && keyStats?.fiftyTwoWeekLow) {
        const range = keyStats.fiftyTwoWeekHigh - keyStats.fiftyTwoWeekLow;
        document.getElementById('stat-52range').textContent = `$${range.toFixed(2)}`;
      } else {
        document.getElementById('stat-52range').textContent = '-';
      }

      // Description
      if (company?.description) {
        document.getElementById('company-description').textContent = company.description;
        document.getElementById('description-container').style.display = 'block';
      }
    }

    // Load chart data using Finnhub candles
    async function loadChart(period) {
      try {
        const now = Math.floor(Date.now() / 1000);
        let from, resolution;

        switch(period) {
          case '1D':
            from = now - 86400;
            resolution = '5';
            break;
          case '1W':
            from = now - 7 * 86400;
            resolution = '15';
            break;
          case '1M':
            from = now - 30 * 86400;
            resolution = '60';
            break;
          case '6M':
            from = now - 180 * 86400;
            resolution = 'D';
            break;
          case '1Y':
            from = now - 365 * 86400;
            resolution = 'D';
            break;
          case '5Y':
            from = now - 5 * 365 * 86400;
            resolution = 'W';
            break;
          case 'MAX':
            from = now - 10 * 365 * 86400;
            resolution = 'M';
            break;
          default:
            from = now - 7 * 86400;
            resolution = '15';
        }

        const response = await fetch(
          `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=${resolution}&from=${from}&to=${now}&token=${FINNHUB_TOKEN}`
        );

        const data = await response.json();

        if (data.s === 'no_data' || !data.c) {
          console.log('No chart data available for this period');
          return;
        }

        const history = data.t.map((timestamp, i) => ({
          timestamp: timestamp * 1000,
          close: data.c[i],
          open: data.o[i],
          high: data.h[i],
          low: data.l[i]
        }));

        renderChart(history);
      } catch (error) {
        console.error('Error loading chart:', error);
      }
    }

    // Render chart
    function renderChart(history) {
      const ctx = document.getElementById('stock-chart').getContext('2d');

      if (chartInstance) {
        chartInstance.destroy();
      }

      const labels = history.map(d => new Date(d.timestamp));
      const prices = history.map(d => d.close);

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: symbol,
            data: prices,
            borderColor: prices[prices.length - 1] >= prices[0] ? '#3fb950' : '#f85149',
            backgroundColor: prices[prices.length - 1] >= prices[0] ?
              'rgba(63, 185, 80, 0.1)' : 'rgba(248, 81, 73, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.1,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#161b22',
              titleColor: '#f0f6fc',
              bodyColor: '#8b949e',
              borderColor: '#30363d',
              borderWidth: 1,
              callbacks: {
                label: (context) => `$${context.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: currentPeriod === '1D' ? 'hour' :
                      currentPeriod === '1W' || currentPeriod === '1M' ? 'day' : 'month'
              },
              grid: { color: '#21262d' },
              ticks: { color: '#8b949e' }
            },
            y: {
              position: 'right',
              grid: { color: '#21262d' },
              ticks: {
                color: '#8b949e',
                callback: (value) => `$${value.toFixed(2)}`
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }

    // Period button handlers
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPeriod = btn.dataset.period;
        loadChart(currentPeriod);
      });
    });

    // Action button handlers
    document.getElementById('add-to-portfolio-btn').addEventListener('click', function() {
      // Redirect to portfolios page with the symbol pre-selected
      const price = stockData?.quote?.price || 0;
      const name = stockData?.company?.name || symbol;
      localStorage.setItem('addToPortfolio', JSON.stringify({ symbol, name, price }));
      window.location.href = '/portfolios';
    });

    document.getElementById('add-to-watchlist-btn').addEventListener('click', async function() {
      try {
        const token = localStorage.getItem('wealthpilot_token') || '';
        const response = await fetch('/api/watchlist', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ symbol })
        });

        if (response.ok) {
          if (typeof showToast === 'function') {
            showToast(`${symbol} added to watchlist`, 'success');
          } else {
            alert(`${symbol} added to watchlist!`);
          }
        } else {
          const data = await response.json();
          alert(data.error || 'Failed to add to watchlist');
        }
      } catch (err) {
        alert('Error adding to watchlist');
      }
    });

    // Load on page ready
    document.addEventListener('DOMContentLoaded', loadStockData);
  </script>

<%- include('../partials/footer') %>
