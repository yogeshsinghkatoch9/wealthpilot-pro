<%
// Safe defaults for potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safeUser = typeof user !== 'undefined' ? user : {};
const userName = safeUser?.name || 'User';
const userInitial = userName.charAt(0).toUpperCase();
%>
<%- include('../partials/header', { pageTitle: 'AI Assistant' }) %>

<div class="bloomberg-card h-[calc(100vh-12rem)] flex flex-col">
<!-- Bloomberg Header Bar -->
<div class="bloomberg-header">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded bg-slate-700 border border-amber-400/30 flex items-center justify-center">
<svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
</div>
<div>
<h1 class="font-bold text-amber-400 tracking-wide">WEALTHPILOT AI</h1>
<p class="text-xs text-slate-400 font-mono">YOUR PERSONAL INVESTMENT ASSISTANT</p>
</div>
<div class="ml-auto flex items-center gap-2">
<span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
<span class="text-xs text-emerald-400 font-mono">ONLINE</span>
</div>
</div>
</div>

<!-- Chat Messages -->
<div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900" id="chatMessages">
<!-- Welcome Message -->
<div class="flex gap-3">
<div class="w-8 h-8 rounded bg-slate-700 border border-amber-400/30 flex items-center justify-center flex-shrink-0">
<svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
</div>
<div class="bg-slate-800 border border-slate-700 rounded-lg rounded-tl-none p-4 max-w-[80%]">
<p class="text-slate-200">Hi! I'm your WealthPilot AI assistant. I can help you with:</p>
<ul class="mt-2 space-y-1 text-sm text-slate-400 font-mono">
<li>ğŸ“Š Analyzing your portfolio performance</li>
<li>ğŸ¯ Finding investment opportunities</li>
<li>ğŸ“ˆ Explaining market trends</li>
<li>ğŸ’¡ Answering investment questions</li>
<li>âš ï¸ Identifying risks in your holdings</li>
</ul>
<p class="mt-3 text-slate-200">What would you like to know?</p>
</div>
</div>

<!-- Example User Message -->
<div class="flex gap-3 justify-end">
<div class="bg-amber-400/10 border border-amber-400/30 text-amber-400 rounded-lg rounded-tr-none p-4 max-w-[80%]">
<p>What's my best performing stock this year?</p>
</div>
<div class="w-8 h-8 rounded bg-amber-400/20 border border-amber-400/40 flex items-center justify-center flex-shrink-0 text-amber-400 font-bold text-sm font-mono"><%= userInitial %></div>
</div>

<!-- AI Response -->
<div class="flex gap-3">
<div class="w-8 h-8 rounded bg-slate-700 border border-amber-400/30 flex items-center justify-center flex-shrink-0">
<svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
</div>
<div class="bg-slate-800 border border-slate-700 rounded-lg rounded-tl-none p-4 max-w-[80%]">
<p class="text-slate-200">Looking at your portfolio, <span class="font-bold text-emerald-400 font-mono">NVDA (NVIDIA)</span> is your best performer this year with a <span class="text-emerald-400 font-bold">+142.8%</span> return! ğŸš€</p>
<div class="mt-3 p-3 rounded-lg bg-slate-900 border border-slate-700">
<div class="flex items-center justify-between">
<div class="flex items-center gap-2">
<div class="w-8 h-8 rounded bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center text-emerald-400 text-xs font-bold font-mono">NVDA</div>
<div>
<p class="font-medium text-white">NVIDIA Corp</p>
<p class="text-xs text-slate-400 font-mono">50 shares @ $485.20</p>
</div>
</div>
<div class="text-right">
<p class="text-emerald-400 font-bold font-mono">+142.8%</p>
<p class="text-xs text-slate-400 font-mono">+$14,280</p>
</div>
</div>
</div>
<p class="mt-3 text-sm text-slate-400">The AI chip demand has driven exceptional growth. Your cost basis of $200/share is well below current prices. Want me to analyze if you should take some profits?</p>
</div>
</div>

<!-- User Follow-up -->
<div class="flex gap-3 justify-end">
<div class="bg-amber-400/10 border border-amber-400/30 text-amber-400 rounded-lg rounded-tr-none p-4 max-w-[80%]">
<p>Yes, should I sell some NVDA?</p>
</div>
<div class="w-8 h-8 rounded bg-amber-400/20 border border-amber-400/40 flex items-center justify-center flex-shrink-0 text-amber-400 font-bold text-sm font-mono"><%= userInitial %></div>
</div>

<!-- AI Analysis Response -->
<div class="flex gap-3">
<div class="w-8 h-8 rounded bg-slate-700 border border-amber-400/30 flex items-center justify-center flex-shrink-0">
<svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
</div>
<div class="bg-slate-800 border border-slate-700 rounded-lg rounded-tl-none p-4 max-w-[80%]">
<p class="text-slate-200 font-medium">Here's my analysis on your NVDA position:</p>
<div class="mt-3 space-y-2">
<div class="flex items-center gap-2">
<span class="text-amber-400">âš ï¸</span>
<span class="text-sm text-slate-300"><strong class="text-amber-400">Concentration Risk:</strong> NVDA is now 18% of your portfolio (recommend &lt;15%)</span>
</div>
<div class="flex items-center gap-2">
<span class="text-emerald-400">âœ…</span>
<span class="text-sm text-slate-300"><strong class="text-emerald-400">Strong Fundamentals:</strong> AI demand remains robust</span>
</div>
<div class="flex items-center gap-2">
<span class="text-sky-400">ğŸ“Š</span>
<span class="text-sm text-slate-300"><strong class="text-sky-400">Technical:</strong> RSI at 72 (slightly overbought)</span>
</div>
<div class="flex items-center gap-2">
<span class="text-purple-400">ğŸ’°</span>
<span class="text-sm text-slate-300"><strong class="text-purple-400">Tax:</strong> Long-term gains eligible (15% tax rate)</span>
</div>
</div>
<p class="mt-3 text-slate-200"><strong class="text-amber-400">My Suggestion:</strong> Consider selling 10 shares (~$4,850) to reduce concentration to ~15% while maintaining AI exposure. This locks in $2,850 profit.</p>
<div class="mt-3 flex gap-2">
<button onclick="showToast('Trade preview coming soon!', 'info')" class="bloomberg-btn bloomberg-btn-primary">Preview Trade</button>
<button onclick="showToast('Added to watchlist', 'success')" class="bloomberg-btn bloomberg-btn-secondary">Set Alert Instead</button>
</div>
</div>
</div>
</div>

<!-- Suggestions -->
<div class="flex flex-wrap gap-2 justify-center pt-4">
<button onclick="askQuestion('What stocks should I add to diversify?')" class="px-3 py-1.5 rounded text-sm bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 hover:border-amber-400/30 transition-all font-mono">ğŸ’¡ Diversification ideas</button>
<button onclick="askQuestion('Analyze my sector allocation')" class="px-3 py-1.5 rounded text-sm bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 hover:border-amber-400/30 transition-all font-mono">ğŸ“Š Sector analysis</button>
<button onclick="askQuestion('What are the risks in my portfolio?')" class="px-3 py-1.5 rounded text-sm bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 hover:border-amber-400/30 transition-all font-mono">âš ï¸ Risk assessment</button>
</div>
</div>

<!-- Input Area -->
<div class="p-4 border-t border-slate-700 bg-slate-900">
<div class="flex gap-3">
<input type="text" id="chatInput" class="flex-1 bg-slate-800 border border-slate-700 rounded px-4 py-2 text-slate-200 placeholder-slate-500 focus:outline-none focus:border-amber-400/50 focus:ring-1 focus:ring-amber-400/50 transition-all font-mono" placeholder="Ask me anything about your portfolio..." onkeyup="if(event.key==='Enter')sendMessage()">
<button onclick="sendMessage()" class="bloomberg-btn bloomberg-btn-primary">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
</button>
</div>
<p class="text-xs text-slate-500 mt-2 text-center font-mono">AI responses are for informational purposes only. Not financial advice.</p>
</div>
</div>
</div></div></main>

<script>
function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  const container = document.getElementById('chatMessages');
  const userInitial = '<%= userInitial %>';

  // Add user message
  container.innerHTML += `
    <div class="flex gap-3 justify-end">
      <div class="bg-amber-400/10 border border-amber-400/30 text-amber-400 rounded-lg rounded-tr-none p-4 max-w-[80%]">
        <p>${message}</p>
      </div>
      <div class="w-8 h-8 rounded bg-amber-400/20 border border-amber-400/40 flex items-center justify-center flex-shrink-0 text-amber-400 font-bold text-sm font-mono">${userInitial}</div>
    </div>
  `;

  input.value = '';

  // Simulate AI typing
  setTimeout(() => {
    container.innerHTML += `
      <div class="flex gap-3">
        <div class="w-8 h-8 rounded bg-slate-700 border border-amber-400/30 flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        </div>
        <div class="bg-slate-800 border border-slate-700 rounded-lg rounded-tl-none p-4 max-w-[80%]">
          <p class="text-slate-200">I'm analyzing your portfolio to answer that question. Let me pull up the relevant data...</p>
          <p class="mt-2 text-sm text-slate-400">ğŸ”„ This is a demo - full AI integration coming soon!</p>
        </div>
      </div>
    `;
    container.scrollTop = container.scrollHeight;
  }, 1000);

  container.scrollTop = container.scrollHeight;
}

function askQuestion(question) {
  document.getElementById('chatInput').value = question;
  sendMessage();
}
</script>
<%- include('../partials/footer') %>
