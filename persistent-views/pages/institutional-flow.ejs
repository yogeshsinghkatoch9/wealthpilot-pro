<%
// Safe defaults for potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
%>
<%- include('../partials/header', { pageTitle: 'Institutional Flow' }) %>

<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
<div><h1 class="text-2xl font-bold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">Institutional Flow</h1><p class="<%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">13F filings & smart money tracking</p></div>
<div class="flex gap-2">
<select class="form-input w-28"><option selected>Q3 2024</option><option>Q2 2024</option><option>Q1 2024</option></select>
</div>
</div>

<!-- Flow Summary -->
<div class="tufte-stat-card p-5 <%= safeTheme === 'light' ? 'bg-gray-50' : 'bg-slate-800/50' %>">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Q3 2024 Institutional Activity - Your Holdings</h3>
<div class="grid grid-cols-2 md:grid-cols-5 gap-4">
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Net Inst. Flow</p>
<p class="text-3xl font-bold positive">+$4.2B</p>
<p class="text-xs text-emerald-400">accumulation</p>
</div>
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Total Bought</p>
<p class="text-3xl font-bold text-emerald-400">$18.4B</p>
<p class="text-xs">new positions</p>
</div>
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Total Sold</p>
<p class="text-3xl font-bold text-red-400">$14.2B</p>
<p class="text-xs">exited</p>
</div>
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Most Bought</p>
<p class="text-3xl font-bold text-purple-400">NVDA</p>
<p class="text-xs">+$2.8B net</p>
</div>
<div class="text-center">
<p class="text-sm <%= safeTheme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Most Sold</p>
<p class="text-3xl font-bold text-amber-400">AAPL</p>
<p class="text-xs">-$1.4B net</p>
</div>
</div>
</div>

<!-- Top Movers -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="tufte-stat-card p-5">
<h3 class="font-semibold text-emerald-400 mb-4">Biggest Institutional Buys</h3>
<div class="space-y-3">
<div class="flex items-center justify-between p-3 rounded-lg <%= safeTheme === 'light' ? 'bg-gray-50' : 'bg-slate-800/50' %>">
<div class="flex items-center gap-3">
<span class="text-xl font-bold text-emerald-400">1</span>
<div><p class="font-bold">NVDA</p><p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">248 funds increased</p></div>
</div>
<div class="text-right">
<p class="font-bold positive">+$2.84B</p>
<p class="text-xs">+4.2% ownership</p>
</div>
</div>
<div class="flex items-center justify-between p-3 rounded-lg <%= safeTheme === 'light' ? 'bg-gray-50' : 'bg-slate-800/50' %>">
<div class="flex items-center gap-3">
<span class="text-xl font-bold text-emerald-400">2</span>
<div><p class="font-bold">META</p><p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">186 funds increased</p></div>
</div>
<div class="text-right">
<p class="font-bold positive">+$1.92B</p>
<p class="text-xs">+2.8% ownership</p>
</div>
</div>
<div class="flex items-center justify-between p-3 rounded-lg <%= safeTheme === 'light' ? 'bg-gray-50' : 'bg-slate-800/50' %>">
<div class="flex items-center gap-3">
<span class="text-xl font-bold text-emerald-400">3</span>
<div><p class="font-bold">GOOGL</p><p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">142 funds increased</p></div>
</div>
<div class="text-right">
<p class="font-bold positive">+$1.24B</p>
<p class="text-xs">+1.8% ownership</p>
</div>
</div>
</div>
</div>

<div class="tufte-stat-card p-5">
<h3 class="font-semibold text-red-400 mb-4">Biggest Institutional Sells</h3>
<div class="space-y-3">
<div class="flex items-center justify-between p-3 rounded-lg <%= safeTheme === 'light' ? 'bg-gray-50' : 'bg-slate-800/50' %>">
<div class="flex items-center gap-3">
<span class="text-xl font-bold text-red-400">1</span>
<div><p class="font-bold">AAPL</p><p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">168 funds decreased</p></div>
</div>
<div class="text-right">
<p class="font-bold negative">-$1.42B</p>
<p class="text-xs">-0.8% ownership</p>
</div>
</div>
<div class="flex items-center justify-between p-3 rounded-lg <%= safeTheme === 'light' ? 'bg-gray-50' : 'bg-slate-800/50' %>">
<div class="flex items-center gap-3">
<span class="text-xl font-bold text-red-400">2</span>
<div><p class="font-bold">TSLA</p><p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">124 funds decreased</p></div>
</div>
<div class="text-right">
<p class="font-bold negative">-$842M</p>
<p class="text-xs">-1.4% ownership</p>
</div>
</div>
<div class="flex items-center justify-between p-3 rounded-lg <%= safeTheme === 'light' ? 'bg-gray-50' : 'bg-slate-800/50' %>">
<div class="flex items-center gap-3">
<span class="text-xl font-bold text-red-400">3</span>
<div><p class="font-bold">INTC</p><p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">98 funds decreased</p></div>
</div>
<div class="text-right">
<p class="font-bold negative">-$624M</p>
<p class="text-xs">-2.8% ownership</p>
</div>
</div>
</div>
</div>
</div>

<!-- Top Funds Activity -->
<div class="tufte-stat-card overflow-hidden">
<div class="p-4 border-b <%= safeTheme === 'light' ? 'border-gray-200' : 'border-slate-700' %>">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">Top Fund Activity on Your Holdings</h3>
</div>
<table class="w-full text-sm">
<thead>
<tr class="<%= safeTheme === 'light' ? 'bg-gray-50 text-gray-500' : 'bg-slate-800 text-slate-400' %> text-left">
<th class="px-4 py-3">Fund</th>
<th class="px-4 py-3 text-center">AUM</th>
<th class="px-4 py-3 text-center">Stock</th>
<th class="px-4 py-3 text-center">Action</th>
<th class="px-4 py-3 text-center">Shares</th>
<th class="px-4 py-3 text-center">Value</th>
<th class="px-4 py-3 text-center">% of Fund</th>
</tr>
</thead>
<tbody class="<%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %>">
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><span class="font-bold">Vanguard</span></td>
<td class="px-4 py-3 text-center">$8.7T</td>
<td class="px-4 py-3 text-center font-bold text-purple-400">NVDA</td>
<td class="px-4 py-3 text-center"><span class="text-emerald-400">BUY</span></td>
<td class="px-4 py-3 text-center">+12.4M</td>
<td class="px-4 py-3 text-center positive">+$1.77B</td>
<td class="px-4 py-3 text-center">2.8%</td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><span class="font-bold">BlackRock</span></td>
<td class="px-4 py-3 text-center">$10.0T</td>
<td class="px-4 py-3 text-center font-bold text-purple-400">META</td>
<td class="px-4 py-3 text-center"><span class="text-emerald-400">BUY</span></td>
<td class="px-4 py-3 text-center">+2.8M</td>
<td class="px-4 py-3 text-center positive">+$1.64B</td>
<td class="px-4 py-3 text-center">1.4%</td>
</tr>
<tr class="border-b <%= safeTheme === 'light' ? 'border-gray-100' : 'border-slate-700/50' %>">
<td class="px-4 py-3"><span class="font-bold">Berkshire</span></td>
<td class="px-4 py-3 text-center">$364B</td>
<td class="px-4 py-3 text-center font-bold text-sky-400">AAPL</td>
<td class="px-4 py-3 text-center"><span class="text-red-400">SELL</span></td>
<td class="px-4 py-3 text-center">-100M</td>
<td class="px-4 py-3 text-center negative">-$18.9B</td>
<td class="px-4 py-3 text-center">28.4%â†’22%</td>
</tr>
<tr>
<td class="px-4 py-3"><span class="font-bold">Citadel</span></td>
<td class="px-4 py-3 text-center">$62B</td>
<td class="px-4 py-3 text-center font-bold text-purple-400">GOOGL</td>
<td class="px-4 py-3 text-center"><span class="text-emerald-400">NEW</span></td>
<td class="px-4 py-3 text-center">+4.2M</td>
<td class="px-4 py-3 text-center positive">+$714M</td>
<td class="px-4 py-3 text-center">1.2%</td>
</tr>
</tbody>
</table>
</div>

<!-- Smart Money Signals -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
<div class="tufte-stat-card p-4 text-center border-l-4 border-emerald-500">
<p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">New Positions</p>
<p class="text-2xl font-bold text-emerald-400">42</p>
<p class="text-xs">by top 50 funds</p>
</div>
<div class="tufte-stat-card p-4 text-center border-l-4 border-red-500">
<p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">Closed Positions</p>
<p class="text-2xl font-bold text-red-400">18</p>
<p class="text-xs">by top 50 funds</p>
</div>
<div class="tufte-stat-card p-4 text-center border-l-4 border-sky-500">
<p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">Funds Tracking</p>
<p class="text-2xl font-bold text-sky-400">2,847</p>
<p class="text-xs">your holdings</p>
</div>
<div class="tufte-stat-card p-4 text-center border-l-4 border-purple-500">
<p class="text-xs <%= safeTheme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">Avg Inst. Own.</p>
<p class="text-2xl font-bold text-purple-400">72.4%</p>
<p class="text-xs">of holdings</p>
</div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="tufte-stat-card p-5">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Quarterly Flow Trend</h3>
<div class="h-48"><canvas id="flowChart"></canvas></div>
</div>
<div class="tufte-stat-card p-5">
<h3 class="font-semibold <%= safeTheme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Holdings Inst. Ownership</h3>
<div class="h-48"><canvas id="ownerChart"></canvas></div>
</div>
</div>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('flowChart'), {
  type: 'bar',
  data: { labels: ['Q4 23','Q1 24','Q2 24','Q3 24'], datasets: [
    { label: 'Buys ($B)', data: [12.4,14.8,16.2,18.4], backgroundColor: '#10b981' },
    { label: 'Sells ($B)', data: [-8.4,-10.2,-12.8,-14.2], backgroundColor: '#ef4444' }
  ]},
  options: { responsive: true, maintainAspectRatio: false }
});
new Chart(document.getElementById('ownerChart'), {
  type: 'bar',
  data: { labels: ['META','MSFT','GOOGL','AAPL','NVDA','TSLA'], datasets: [{ label: 'Inst. %', data: [78.2,74.2,72.8,61.2,68.4,44.2], backgroundColor: '#8b5cf6' }] },
  options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100 } }, plugins: { legend: { display: false } } }
});
</script>
<%- include('../partials/footer') %>
