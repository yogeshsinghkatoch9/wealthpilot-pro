<%- include('../partials/header', { pageTitle: 'PDF Reports' }) %>

<main class="p-4 lg:p-6">
  <div class="max-w-7xl mx-auto space-y-6">
    <!-- Hero Header -->
    <div class="glass-card-elevated overflow-hidden">
      <div class="relative p-6 lg:p-8">
        <!-- Gradient Orbs -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-green-500/20 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-orange-500/20 rounded-full blur-3xl"></div>

        <div class="relative flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-500 to-orange-600 flex items-center justify-center shadow-lg shadow-green-500/25">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <div>
              <h1 class="text-2xl lg:text-3xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">
                PDF Reports
              </h1>
              <p class="<%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %> mt-1">
                Generate professional portfolio reports with charts and analytics
              </p>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="flex items-center gap-4">
            <div class="glass-card px-4 py-3 text-center">
              <p class="text-2xl font-bold text-green-400"><%= templates ? templates.length : 0 %></p>
              <p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">Templates</p>
            </div>
            <div class="glass-card px-4 py-3 text-center">
              <p class="text-2xl font-bold text-orange-400"><%= portfolios ? portfolios.length : 0 %></p>
              <p class="text-xs <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">Portfolios</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Report Templates Grid -->
    <div>
      <h2 class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
        </svg>
        Report Templates
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <% if (templates && templates.length > 0) { %>
          <% templates.forEach((template, index) => { %>
            <div class="glass-card group cursor-pointer hover:border-green-500/50 transition-all duration-300 hover:shadow-lg hover:shadow-green-500/10 hover:-translate-y-1"
                 onclick="openReportModal('<%= template.id %>')">
              <div class="p-6">
                <!-- Icon with gradient background -->
                <div class="flex items-start justify-between mb-4">
                  <div class="w-14 h-14 rounded-xl bg-gradient-to-br <%= index % 4 === 0 ? 'from-green-500 to-orange-600' : index % 4 === 1 ? 'from-emerald-500 to-teal-600' : index % 4 === 2 ? 'from-green-500 to-indigo-600' : 'from-purple-500 to-pink-600' %> flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                    <span class="text-2xl"><%= template.icon %></span>
                  </div>
                  <span class="px-3 py-1 text-xs font-medium bg-green-500/20 text-green-400 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    Generate
                  </span>
                </div>

                <!-- Template Info -->
                <h3 class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-2 group-hover:text-green-400 transition-colors">
                  <%= template.name %>
                </h3>
                <p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %> line-clamp-2">
                  <%= template.description %>
                </p>

                <!-- Hover Arrow -->
                <div class="mt-4 flex items-center gap-2 text-green-400 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <span class="text-sm font-medium">Create Report</span>
                  <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </div>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="col-span-4 glass-card p-12 text-center">
            <div class="w-16 h-16 rounded-full bg-slate-800/50 flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <p class="<%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">No report templates available</p>
            <p class="text-sm text-slate-500 mt-2">Check back later for new report types</p>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Features Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="glass-card p-6 group hover:border-green-500/30 transition-all">
        <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
          <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        <h3 class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-2">Interactive Charts</h3>
        <p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">
          Beautiful visualizations of your portfolio performance, allocation, and trends
        </p>
      </div>

      <div class="glass-card p-6 group hover:border-emerald-500/30 transition-all">
        <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
          <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
        </div>
        <h3 class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-2">Detailed Analytics</h3>
        <p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">
          Comprehensive metrics including returns, risk analysis, and key performance indicators
        </p>
      </div>

      <div class="glass-card p-6 group hover:border-green-500/30 transition-all">
        <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
          <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-2">Real-Time Data</h3>
        <p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">
          Reports generated with the latest market data and portfolio information
        </p>
      </div>
    </div>

    <!-- Info Banner -->
    <div class="glass-card border-green-500/30 bg-gradient-to-r from-green-500/10 to-orange-500/10">
      <div class="p-5 flex items-start gap-4">
        <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div>
          <p class="font-semibold text-green-400 mb-1">
            Professional PDF Reports
          </p>
          <p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-300' %>">
            All reports are generated in real-time from your portfolio data. Each report includes charts, analytics, and detailed metrics tailored to help you make informed investment decisions.
          </p>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Report Configuration Modal -->
<div id="report-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
  <div class="glass-card-elevated w-full max-w-2xl animate-fade-in">
    <!-- Modal Header -->
    <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-orange-600 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <div>
          <h3 class="text-xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>" id="modal-title">Generate Report</h3>
          <p class="<%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %> text-sm mt-1" id="modal-description"></p>
        </div>
      </div>
    </div>

    <form id="report-form" class="p-6 space-y-6">
      <!-- Portfolio Selection -->
      <div>
        <label class="block text-sm font-medium <%= theme === 'light' ? 'text-gray-700' : 'text-slate-300' %> mb-2">
          Select Portfolio
        </label>
        <div class="relative">
          <select name="portfolioId" required class="w-full px-4 py-3 <%= theme === 'light' ? 'bg-white border-gray-300 text-gray-900' : 'bg-slate-900/50 border-white/10 text-white' %> border rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all appearance-none cursor-pointer">
            <option value="">Choose a portfolio...</option>
            <% if (portfolios && portfolios.length > 0) { %>
              <% portfolios.forEach(p => { %>
                <option value="<%= p.id %>"><%= p.name %></option>
              <% }); %>
            <% } %>
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
            <svg class="w-5 h-5 <%= theme === 'light' ? 'text-gray-400' : 'text-slate-400' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Dynamic Options Container -->
      <div id="report-options" class="space-y-4"></div>

      <!-- Action Buttons -->
      <div class="flex gap-3 pt-4">
        <button type="submit" class="btn-gradient flex-1 flex items-center justify-center gap-2 py-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
          Generate PDF
        </button>
        <button type="button" onclick="closeReportModal()" class="btn-glass px-6 py-3">
          Cancel
        </button>
      </div>
    </form>

    <!-- Loading State -->
    <div id="report-loading" class="hidden p-12 text-center">
      <div class="relative w-20 h-20 mx-auto mb-6">
        <div class="absolute inset-0 rounded-full border-4 border-slate-700"></div>
        <div class="absolute inset-0 rounded-full border-4 border-green-500 border-t-transparent animate-spin"></div>
        <div class="absolute inset-3 rounded-full bg-gradient-to-br from-green-500/20 to-orange-500/20 flex items-center justify-center">
          <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
      </div>
      <p class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Generating your report...</p>
      <p class="text-sm <%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %> mt-2">This may take a few moments</p>
      <div class="mt-4 flex justify-center gap-1">
        <div class="w-2 h-2 rounded-full bg-green-400 animate-bounce" style="animation-delay: 0ms"></div>
        <div class="w-2 h-2 rounded-full bg-green-400 animate-bounce" style="animation-delay: 150ms"></div>
        <div class="w-2 h-2 rounded-full bg-green-400 animate-bounce" style="animation-delay: 300ms"></div>
      </div>
    </div>
  </div>
</div>

<script>
const reportTemplates = <%- JSON.stringify(templates || []) %>;
let currentTemplate = null;

function openReportModal(templateId) {
  const template = reportTemplates.find(t => t.id === templateId);
  if (!template) return;

  currentTemplate = template;

  // Update modal title and description
  document.getElementById('modal-title').textContent = `Generate ${template.name}`;
  document.getElementById('modal-description').textContent = template.description;

  // Build dynamic options
  const optionsContainer = document.getElementById('report-options');
  optionsContainer.innerHTML = '';

  if (template.options && template.options.length > 0) {
    template.options.forEach(option => {
      const optionHtml = buildOptionField(option);
      optionsContainer.innerHTML += optionHtml;
    });
  }

  // Show modal
  document.getElementById('report-modal').classList.remove('hidden');
  document.getElementById('report-form').classList.remove('hidden');
  document.getElementById('report-loading').classList.add('hidden');
}

function closeReportModal() {
  document.getElementById('report-modal').classList.add('hidden');
  currentTemplate = null;
  document.getElementById('report-form').reset();
}

function buildOptionField(option) {
  const id = `option-${option.name}`;
  const theme = document.documentElement.dataset.theme || 'dark';
  const isLight = theme === 'light';

  switch (option.type) {
    case 'boolean':
      return `
        <div class="glass-card p-4">
          <label class="flex items-center justify-between cursor-pointer">
            <div>
              <span class="${isLight ? 'text-gray-900' : 'text-white'} font-medium">${option.label}</span>
            </div>
            <div class="relative">
              <input type="checkbox" name="${option.name}" id="${id}" ${option.default ? 'checked' : ''} class="toggle-checkbox sr-only peer">
              <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
              <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></div>
            </div>
          </label>
        </div>
      `;

    case 'select':
      const selectOptions = option.options.map(opt =>
        `<option value="${opt}" ${opt === option.default ? 'selected' : ''}>${opt}</option>`
      ).join('');
      return `
        <div>
          <label class="block text-sm font-medium ${isLight ? 'text-gray-700' : 'text-slate-300'} mb-2">
            ${option.label}
          </label>
          <div class="relative">
            <select name="${option.name}" id="${id}" class="w-full px-4 py-3 ${isLight ? 'bg-white border-gray-300 text-gray-900' : 'bg-slate-900/50 border-white/10 text-white'} border rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all appearance-none cursor-pointer">
              ${selectOptions}
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
              <svg class="w-5 h-5 ${isLight ? 'text-gray-400' : 'text-slate-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </div>
          </div>
        </div>
      `;

    case 'text':
      return `
        <div>
          <label class="block text-sm font-medium ${isLight ? 'text-gray-700' : 'text-slate-300'} mb-2">
            ${option.label}
          </label>
          <input type="text" name="${option.name}" id="${id}" value="${option.default || ''}"
            class="w-full px-4 py-3 ${isLight ? 'bg-white border-gray-300 text-gray-900 placeholder-gray-400' : 'bg-slate-900/50 border-white/10 text-white placeholder-slate-500'} border rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all">
        </div>
      `;

    case 'number':
      return `
        <div>
          <label class="block text-sm font-medium ${isLight ? 'text-gray-700' : 'text-slate-300'} mb-2">
            ${option.label}
          </label>
          <input type="number" name="${option.name}" id="${id}" value="${option.default || ''}"
            class="w-full px-4 py-3 ${isLight ? 'bg-white border-gray-300 text-gray-900' : 'bg-slate-900/50 border-white/10 text-white'} border rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all">
        </div>
      `;

    default:
      return '';
  }
}

// Handle form submission
document.getElementById('report-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  if (!currentTemplate) return;

  const formData = new FormData(e.target);
  const portfolioId = formData.get('portfolioId');

  if (!portfolioId) {
    showToast('Please select a portfolio', 'error');
    return;
  }

  // Build options object
  const options = {};
  if (currentTemplate.options) {
    currentTemplate.options.forEach(option => {
      const value = formData.get(option.name);
      if (option.type === 'boolean') {
        options[option.name] = value === 'on';
      } else if (option.type === 'number') {
        options[option.name] = value ? parseInt(value) : option.default;
      } else {
        options[option.name] = value || option.default;
      }
    });
  }

  // Show loading state
  document.getElementById('report-form').classList.add('hidden');
  document.getElementById('report-loading').classList.remove('hidden');

  try {
    const response = await fetch('/api/reports/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        reportType: currentTemplate.id,
        portfolioId,
        options
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to generate report');
    }

    // Download the PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentTemplate.id}-report-${Date.now()}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);

    showToast('Report generated successfully!', 'success');
    closeReportModal();

  } catch (error) {
    console.error('Report generation error:', error);
    showToast(error.message || 'Failed to generate report', 'error');

    // Show form again
    document.getElementById('report-form').classList.remove('hidden');
    document.getElementById('report-loading').classList.add('hidden');
  }
});

// Close modal on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !document.getElementById('report-modal').classList.contains('hidden')) {
    closeReportModal();
  }
});

// Close modal on backdrop click
document.getElementById('report-modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('report-modal')) {
    closeReportModal();
  }
});
</script>

<style>
/* Toggle checkbox styling */
.toggle-checkbox:checked + div {
  background-color: #f59e0b;
}

.toggle-checkbox:checked ~ div:last-child {
  transform: translateX(1.25rem);
}

/* Line clamp for descriptions */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Fade in animation */
@keyframes fade-in {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-fade-in {
  animation: fade-in 0.2s ease-out;
}
</style>

<%- include('../partials/footer') %>
