<%
// Safe defaults for potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safeUser = typeof user !== 'undefined' ? user : {};
const userName = safeUser?.name || safeUser?.firstName || 'User';
const userInitial = userName.charAt(0).toUpperCase();
const token = typeof authToken !== 'undefined' ? authToken : '';
%>
<%- include('../partials/header', { pageTitle: 'AI Assistant' }) %>

<style>
  /* Claude-like minimal styling */
  .chat-container {
    display: flex;
    height: calc(100vh - 80px);
  }

  .chat-sidebar {
    width: 260px;
    background: rgba(15, 23, 42, 0.6);
    border-right: 1px solid rgba(255, 255, 255, 0.06);
    display: flex;
    flex-direction: column;
  }

  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 41, 59, 0.3) 100%);
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
  }

  .message-wrapper {
    max-width: 800px;
    margin: 0 auto 1.5rem;
  }

  .message {
    display: flex;
    gap: 1rem;
  }

  .message.user {
    flex-direction: row-reverse;
  }

  .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-weight: 600;
    font-size: 14px;
  }

  .message-avatar.ai {
    background: linear-gradient(135deg, #8B5CF6, #A855F7);
    color: white;
  }

  .message-avatar.user {
    background: linear-gradient(135deg, #3B82F6, #06B6D4);
    color: white;
  }

  .message-content {
    flex: 1;
    max-width: calc(100% - 50px);
  }

  .message-bubble {
    padding: 1rem 1.25rem;
    border-radius: 1rem;
    line-height: 1.6;
  }

  .message.ai .message-bubble {
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid rgba(139, 92, 246, 0.15);
    color: #E2E8F0;
  }

  .message.user .message-bubble {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    color: white;
  }

  .input-container {
    padding: 1.5rem 2rem 2rem;
    background: rgba(15, 23, 42, 0.8);
    border-top: 1px solid rgba(255, 255, 255, 0.06);
  }

  .input-wrapper {
    max-width: 800px;
    margin: 0 auto;
  }

  .chat-input-box {
    display: flex;
    align-items: flex-end;
    gap: 0.75rem;
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1.5rem;
    padding: 0.75rem 1rem;
    transition: all 0.2s;
  }

  .chat-input-box:focus-within {
    border-color: rgba(139, 92, 246, 0.5);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }

  .chat-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: white;
    font-size: 15px;
    resize: none;
    max-height: 150px;
    min-height: 24px;
    line-height: 1.5;
  }

  .chat-input::placeholder {
    color: #64748B;
  }

  .send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
  }

  .send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .send-btn svg {
    width: 20px;
    height: 20px;
    color: white;
  }

  /* Session list */
  .session-item {
    padding: 0.75rem 1rem;
    margin: 0.25rem 0.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #94A3B8;
  }

  .session-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: white;
  }

  .session-item.active {
    background: rgba(139, 92, 246, 0.15);
    color: white;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 0.5rem;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    background: #8B5CF6;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-8px); opacity: 1; }
  }

  /* Markdown styling */
  .message-bubble p { margin-bottom: 0.75rem; }
  .message-bubble p:last-child { margin-bottom: 0; }
  .message-bubble code {
    background: rgba(0, 0, 0, 0.3);
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875em;
  }
  .message-bubble pre {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    margin: 0.75rem 0;
  }
  .message-bubble ul, .message-bubble ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
  }
  .message-bubble li { margin-bottom: 0.25rem; }
  .message-bubble strong { color: #A78BFA; }
  .message-bubble h1, .message-bubble h2, .message-bubble h3 {
    color: #E2E8F0;
    margin: 1rem 0 0.5rem;
  }

  /* Quick actions */
  .quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 1rem 0;
    max-width: 800px;
    margin: 0 auto;
  }

  .quick-action {
    padding: 0.5rem 1rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 2rem;
    color: #A78BFA;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .quick-action:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.4);
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .chat-sidebar { display: none; }
    .messages-container { padding: 1rem; }
    .input-container { padding: 1rem; }
  }
</style>

<div class="chat-container">
  <!-- Sidebar -->
  <div class="chat-sidebar">
    <div class="p-4">
      <button onclick="newChat()" class="w-full py-2.5 px-4 bg-violet-600 hover:bg-violet-500 rounded-lg text-white font-medium transition-colors flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New Chat
      </button>
    </div>

    <div class="flex-1 overflow-y-auto px-2">
      <div class="text-xs text-slate-500 px-3 py-2 uppercase tracking-wider">Recent Chats</div>
      <div id="sessionsList">
        <!-- Sessions will be loaded here -->
      </div>
    </div>

    <div class="p-4 border-t border-white/5">
      <div class="flex items-center gap-3 px-2">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white text-sm font-medium">
          <%= userInitial %>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-sm text-white truncate"><%= userName %></div>
          <div class="text-xs text-slate-500">Free Plan</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main">
    <!-- Messages -->
    <div class="messages-container" id="messagesContainer">
      <!-- Welcome screen -->
      <div id="welcomeScreen" class="flex flex-col items-center justify-center h-full text-center">
        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center mb-6 shadow-lg shadow-violet-500/25">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-white mb-2">WealthPilot AI</h1>
        <p class="text-slate-400 mb-8 max-w-md">Your intelligent investment assistant. Ask questions about your portfolio, get market insights, or request analysis.</p>

        <div class="quick-actions">
          <button class="quick-action" onclick="askQuestion('Analyze my portfolio performance')">Analyze my portfolio</button>
          <button class="quick-action" onclick="askQuestion('What are the risks in my holdings?')">Risk assessment</button>
          <button class="quick-action" onclick="askQuestion('Suggest stocks to diversify my portfolio')">Diversification ideas</button>
          <button class="quick-action" onclick="askQuestion('Generate a portfolio report')">Generate report</button>
        </div>
      </div>

      <!-- Messages will appear here -->
      <div id="chatMessages"></div>
    </div>

    <!-- Input Area -->
    <div class="input-container">
      <div class="input-wrapper">
        <div class="chat-input-box">
          <textarea
            id="chatInput"
            class="chat-input"
            placeholder="Ask about your portfolio, markets, or investments..."
            rows="1"
            onkeydown="handleKeyDown(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button id="sendBtn" class="send-btn" onclick="sendMessage()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
        </div>
        <p class="text-xs text-slate-500 mt-3 text-center">
          Powered by Claude AI. Responses are for informational purposes only.
        </p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// State
let currentSessionId = null;
let isStreaming = false;
const API_BASE = '/api';

// Get auth token
function getToken() {
  return localStorage.getItem('token') || '<%= token %>';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadSessions();
});

// Auto-resize textarea
function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

// Handle Enter key
function handleKeyDown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
}

// Send message with streaming
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message || isStreaming) return;

  // Hide welcome screen
  document.getElementById('welcomeScreen').style.display = 'none';

  // Add user message
  addMessage('user', message);
  input.value = '';
  autoResize(input);

  // Disable send button
  isStreaming = true;
  document.getElementById('sendBtn').disabled = true;

  // Add AI message placeholder with typing indicator
  const aiMessageId = addMessage('ai', '', true);

  try {
    const response = await fetch(`${API_BASE}/ai/chat/stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getToken()}`
      },
      body: JSON.stringify({
        message,
        sessionId: currentSessionId
      })
    });

    if (!response.ok) {
      throw new Error('Failed to connect to AI');
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullContent = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);

            if (parsed.type === 'text') {
              fullContent += parsed.content;
              updateMessage(aiMessageId, fullContent);
            } else if (parsed.type === 'done') {
              currentSessionId = parsed.sessionId;
              // Final update with markdown rendering
              updateMessage(aiMessageId, fullContent, true);
            } else if (parsed.type === 'error') {
              updateMessage(aiMessageId, `Error: ${parsed.error}`, true);
            }
          } catch (e) {
            // Skip invalid JSON
          }
        }
      }
    }

    // Reload sessions
    loadSessions();

  } catch (error) {
    console.error('Chat error:', error);
    updateMessage(aiMessageId, 'Sorry, I encountered an error. Please try again.', true);
  } finally {
    isStreaming = false;
    document.getElementById('sendBtn').disabled = false;
  }
}

// Add a message to the chat
function addMessage(role, content, isTyping = false) {
  const container = document.getElementById('chatMessages');
  const id = 'msg-' + Date.now();

  const avatar = role === 'ai'
    ? `<div class="message-avatar ai">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
       </div>`
    : `<div class="message-avatar user"><%= userInitial %></div>`;

  let bubbleContent = content;
  if (isTyping) {
    bubbleContent = `<div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>`;
  }

  const html = `
    <div class="message-wrapper">
      <div class="message ${role}" id="${id}">
        ${avatar}
        <div class="message-content">
          <div class="message-bubble">${bubbleContent}</div>
        </div>
      </div>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', html);
  scrollToBottom();

  return id;
}

// Update message content
function updateMessage(id, content, renderMarkdown = false) {
  const msg = document.getElementById(id);
  if (!msg) return;

  const bubble = msg.querySelector('.message-bubble');
  if (bubble) {
    if (renderMarkdown && content) {
      bubble.innerHTML = marked.parse(content);
    } else if (content) {
      bubble.textContent = content;
    }
  }
  scrollToBottom();
}

// Scroll to bottom
function scrollToBottom() {
  const container = document.getElementById('messagesContainer');
  container.scrollTop = container.scrollHeight;
}

// Ask a preset question
function askQuestion(question) {
  document.getElementById('chatInput').value = question;
  sendMessage();
}

// New chat
function newChat() {
  currentSessionId = null;
  document.getElementById('chatMessages').innerHTML = '';
  document.getElementById('welcomeScreen').style.display = 'flex';
  document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
}

// Load sessions
async function loadSessions() {
  try {
    const response = await fetch(`${API_BASE}/ai/chat/sessions`, {
      headers: {
        'Authorization': `Bearer ${getToken()}`
      }
    });

    if (!response.ok) return;

    const data = await response.json();
    const container = document.getElementById('sessionsList');

    if (data.sessions?.length) {
      container.innerHTML = data.sessions.map(session => `
        <div class="session-item ${session.id === currentSessionId ? 'active' : ''}"
             onclick="loadSession('${session.id}')">
          <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          <span class="truncate flex-1 text-sm">${escapeHtml(session.title || 'New conversation')}</span>
        </div>
      `).join('');
    } else {
      container.innerHTML = '<div class="text-slate-500 text-sm px-4 py-2">No conversations yet</div>';
    }
  } catch (error) {
    console.error('Failed to load sessions:', error);
  }
}

// Load a specific session
async function loadSession(sessionId) {
  try {
    const response = await fetch(`${API_BASE}/ai/chat/sessions/${sessionId}`, {
      headers: {
        'Authorization': `Bearer ${getToken()}`
      }
    });

    if (!response.ok) return;

    const data = await response.json();
    currentSessionId = sessionId;

    // Hide welcome screen
    document.getElementById('welcomeScreen').style.display = 'none';

    // Clear and reload messages
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';

    if (data.session?.messages) {
      data.session.messages.forEach(msg => {
        addMessage(msg.role, marked.parse(msg.content));
      });
    }

    // Update active state
    document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.session-item[onclick="loadSession('${sessionId}')"]`)?.classList.add('active');

  } catch (error) {
    console.error('Failed to load session:', error);
  }
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Marked.js configuration
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: false,
  mangle: false
});
</script>

<%- include('../partials/footer') %>
