<%
// Safe defaults for all potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safeStats = typeof stats !== 'undefined' ? stats : {
  totalTrades: 0,
  winRate: 0,
  wins: 0,
  losses: 0,
  totalProfitLoss: 0,
  avgProfitLoss: 0
};
const safeEntries = typeof entries !== 'undefined' ? entries : [];
const safeFmt = typeof fmt !== 'undefined' ? fmt : {
  number: (val) => parseFloat(val || 0).toFixed(2)
};
%>
<%- include('../partials/header', { pageTitle: 'Trade Journal' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-amber-400">TRADE JOURNAL</h1>
      <p class="text-slate-400 font-mono text-sm">Document your trades and learn from history</p>
    </div>
    <button onclick="openNewEntry()" class="bloomberg-btn bloomberg-btn-primary">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      NEW ENTRY
    </button>
  </div>
</div>

<!-- Stats Overview -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
  <div class="bloomberg-card p-4">
    <p class="text-slate-400 text-xs font-mono uppercase tracking-wider">Total Trades</p>
    <p class="text-2xl font-bold text-white font-mono"><%= safeStats.totalTrades %></p>
  </div>
  <div class="bloomberg-card p-4">
    <p class="text-slate-400 text-xs font-mono uppercase tracking-wider">Win Rate</p>
    <p class="text-2xl font-bold text-emerald-400 font-mono"><%= safeStats.winRate %>%</p>
  </div>
  <div class="bloomberg-card p-4">
    <p class="text-slate-400 text-xs font-mono uppercase tracking-wider">Wins</p>
    <p class="text-2xl font-bold text-emerald-400 font-mono"><%= safeStats.wins %></p>
  </div>
  <div class="bloomberg-card p-4">
    <p class="text-slate-400 text-xs font-mono uppercase tracking-wider">Losses</p>
    <p class="text-2xl font-bold text-red-400 font-mono"><%= safeStats.losses %></p>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Journal Entries -->
  <div class="lg:col-span-2 space-y-4">
    <div class="flex gap-2">
      <input type="text" id="searchTrades" placeholder="SEARCH TRADES..." class="form-input flex-1 font-mono" onkeyup="filterEntries()">
      <select id="filterType" class="form-input w-32 font-mono" onchange="filterEntries()">
        <option value="all">ALL TRADES</option>
        <option value="winners">WINNERS</option>
        <option value="losers">LOSERS</option>
      </select>
    </div>

    <% if (safeEntries.length === 0) { %>
    <div class="bloomberg-card p-8 text-center">
      <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      <h3 class="text-lg font-semibold text-amber-400 mb-2 font-mono">NO JOURNAL ENTRIES YET</h3>
      <p class="text-slate-400 mb-4 font-mono text-sm">Start documenting your trades to track your progress</p>
      <button onclick="openNewEntry()" class="bloomberg-btn bloomberg-btn-primary">ADD YOUR FIRST ENTRY</button>
    </div>
    <% } else { %>
    <div id="entriesList">
      <% safeEntries.forEach(entry => { %>
      <div class="bloomberg-card p-5 entry-card" data-symbol="<%= entry.symbol %>" data-pl="<%= entry.profit_loss || 0 %>">
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br <%= (entry.profit_loss || 0) >= 0 ? 'from-emerald-500 to-emerald-600' : 'from-red-500 to-red-600' %> flex items-center justify-center text-white font-bold font-mono">
              <%= entry.entry_type === 'buy' ? '+' : '-' %>
            </div>
            <div>
              <p class="font-semibold text-white font-mono"><%= entry.symbol %> - <%= entry.entry_type === 'buy' ? 'BOUGHT' : 'SOLD' %> <%= entry.shares %> shares</p>
              <p class="text-sm text-slate-400 font-mono"><%= new Date(entry.entry_date).toLocaleDateString() %> @ $<%= safeFmt.number(entry.entry_price) %></p>
            </div>
          </div>
          <span class="<%= (entry.profit_loss || 0) >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-bold font-mono">
            <%= (entry.profit_loss || 0) >= 0 ? '+' : '' %>$<%= safeFmt.number(entry.profit_loss || 0) %>
          </span>
        </div>
        <% if (entry.lessons) { %>
        <p class="text-slate-400 text-sm mb-3"><%= entry.lessons %></p>
        <% } %>
        <div class="flex flex-wrap gap-2 mb-3">
          <% if (entry.strategy) { %>
          <span class="px-2 py-1 bg-sky-500/20 text-sky-400 rounded text-xs font-mono"><%= entry.strategy %></span>
          <% } %>
          <% if (entry.setup) { %>
          <span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-mono"><%= entry.setup %></span>
          <% } %>
        </div>
        <div class="flex items-center gap-4 pt-3 border-t border-slate-700">
          <% if (entry.emotions) { %>
          <div class="flex items-center gap-1">
            <span class="text-xs text-slate-400 font-mono"><%= entry.emotions %></span>
          </div>
          <% } %>
          <% if (entry.rating) { %>
          <div class="flex items-center gap-1">
            <span class="text-xs text-slate-400 font-mono">RATING: <%= entry.rating %>/5</span>
          </div>
          <% } %>
          <button onclick="deleteEntry('<%= entry.id %>')" class="ml-auto bloomberg-btn bloomberg-btn-ghost text-sm">DELETE</button>
        </div>
      </div>
      <% }) %>
    </div>
    <% } %>
</div>

  <!-- Sidebar Analytics -->
  <div class="space-y-6">
    <!-- Total P/L -->
    <div class="bloomberg-card p-5">
      <h3 class="text-lg font-semibold text-amber-400 mb-4 font-mono">TOTAL P/L</h3>
      <p class="text-3xl font-bold <%= safeStats.totalProfitLoss >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-mono">
        <%= safeStats.totalProfitLoss >= 0 ? '+' : '' %>$<%= safeFmt.number(safeStats.totalProfitLoss) %>
      </p>
      <p class="text-sm text-slate-400 mt-2 font-mono">
        AVG P/L PER TRADE: $<%= safeFmt.number(safeStats.avgProfitLoss) %>
      </p>
    </div>

    <!-- Performance Summary -->
    <div class="bloomberg-card p-5">
      <h3 class="text-lg font-semibold text-amber-400 mb-4 font-mono">PERFORMANCE SUMMARY</h3>
      <div class="space-y-3">
        <div>
          <div class="flex justify-between mb-1">
            <span class="text-slate-300 text-sm font-mono">WIN RATE</span>
            <span class="text-emerald-400 text-sm font-mono"><%= safeStats.winRate %>%</span>
          </div>
          <div class="h-2 rounded-full bg-slate-700">
            <div class="h-2 rounded-full bg-emerald-400" style="width: <%= safeStats.winRate %>%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="bloomberg-card p-5">
      <h3 class="text-lg font-semibold text-amber-400 mb-4 font-mono">QUICK STATS</h3>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-slate-400 font-mono text-sm">TOTAL TRADES</span>
          <span class="text-white font-semibold font-mono"><%= safeStats.totalTrades %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-slate-400 font-mono text-sm">WINNING TRADES</span>
          <span class="text-emerald-400 font-semibold font-mono"><%= safeStats.wins %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-slate-400 font-mono text-sm">LOSING TRADES</span>
          <span class="text-red-400 font-semibold font-mono"><%= safeStats.losses %></span>
        </div>
      </div>
    </div>

    <!-- Tips -->
    <div class="bloomberg-card p-5">
      <h3 class="text-lg font-semibold text-amber-400 mb-4 font-mono">TIPS</h3>
      <ul class="space-y-2 text-sm text-slate-400">
        <li>Document every trade, even losing ones</li>
        <li>Note your emotional state before trading</li>
        <li>Review entries weekly to identify patterns</li>
        <li>Track what strategies work best for you</li>
      </ul>
    </div>
  </div>
</div>
</div></div></main>

<!-- New Entry Modal -->
<div id="entryModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
  <div class="bloomberg-card p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
    <h3 class="text-xl font-bold text-amber-400 mb-4 font-mono">NEW JOURNAL ENTRY</h3>
    <form id="journalForm" class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">SYMBOL</label>
          <input type="text" name="symbol" class="form-input font-mono" placeholder="AAPL" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">ACTION</label>
          <select name="entry_type" class="form-input font-mono">
            <option value="buy">BUY</option>
            <option value="sell">SELL</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">SHARES</label>
          <input type="number" name="shares" class="form-input font-mono" placeholder="100" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">ENTRY PRICE</label>
          <input type="number" step="0.01" name="entry_price" class="form-input font-mono" placeholder="150.00" required>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">EXIT PRICE</label>
          <input type="number" step="0.01" name="exit_price" class="form-input font-mono" placeholder="155.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">ENTRY DATE</label>
          <input type="date" name="entry_date" class="form-input font-mono" value="<%= new Date().toISOString().split('T')[0] %>">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">STRATEGY</label>
        <select name="strategy" class="form-input font-mono">
          <option value="Trend Following">TREND FOLLOWING</option>
          <option value="Breakout">BREAKOUT</option>
          <option value="Mean Reversion">MEAN REVERSION</option>
          <option value="Earnings Play">EARNINGS PLAY</option>
          <option value="Swing Trade">SWING TRADE</option>
          <option value="Day Trade">DAY TRADE</option>
          <option value="Value Investing">VALUE INVESTING</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">EMOTIONAL STATE</label>
        <select name="emotions" class="form-input font-mono">
          <option value="Calm">CALM</option>
          <option value="Confident">CONFIDENT</option>
          <option value="Uncertain">UNCERTAIN</option>
          <option value="Anxious">ANXIOUS</option>
          <option value="FOMO">FOMO</option>
          <option value="Excited">EXCITED</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">NOTES / LESSONS</label>
        <textarea name="lessons" class="form-input" rows="3" placeholder="What did you learn? Why did you make this trade?"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-1 font-mono">RATING (1-5)</label>
        <select name="rating" class="form-input font-mono">
          <option value="5">5 - EXCELLENT</option>
          <option value="4">4 - GOOD</option>
          <option value="3" selected>3 - AVERAGE</option>
          <option value="2">2 - POOR</option>
          <option value="1">1 - BAD</option>
        </select>
      </div>
    </form>
    <div class="flex gap-3 mt-6">
      <button onclick="closeEntryModal()" class="bloomberg-btn bloomberg-btn-ghost flex-1">CANCEL</button>
      <button onclick="saveEntry()" class="bloomberg-btn bloomberg-btn-primary flex-1">SAVE ENTRY</button>
    </div>
  </div>
</div>

<script>
function openNewEntry() {
  document.getElementById('entryModal').classList.remove('hidden');
  document.getElementById('entryModal').classList.add('flex');
}

function closeEntryModal() {
  document.getElementById('entryModal').classList.add('hidden');
  document.getElementById('entryModal').classList.remove('flex');
}

function filterEntries() {
  const search = document.getElementById('searchTrades').value.toLowerCase();
  const filter = document.getElementById('filterType').value;
  document.querySelectorAll('.entry-card').forEach(card => {
    const symbol = card.dataset.symbol.toLowerCase();
    const pl = parseFloat(card.dataset.pl);
    let show = symbol.includes(search);
    if (filter === 'winners') show = show && pl > 0;
    if (filter === 'losers') show = show && pl < 0;
    card.style.display = show ? 'block' : 'none';
  });
}

async function saveEntry() {
  const form = document.getElementById('journalForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);

  // Calculate P/L if exit price provided
  if (data.exit_price && data.entry_price && data.shares) {
    const entryTotal = parseFloat(data.entry_price) * parseFloat(data.shares);
    const exitTotal = parseFloat(data.exit_price) * parseFloat(data.shares);
    data.profit_loss = data.entry_type === 'buy' ? exitTotal - entryTotal : entryTotal - exitTotal;
  }

  try {
    const res = await fetch('/api/journal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (res.ok) {
      showToast('Journal entry saved!', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      const err = await res.json();
      showToast(err.error || 'Failed to save entry', 'error');
    }
  } catch (e) {
    showToast('Error saving entry', 'error');
  }
  closeEntryModal();
}

async function deleteEntry(id) {
  if (!confirm('Delete this journal entry?')) return;
  try {
    const res = await fetch(`/api/journal/${id}`, { method: 'DELETE' });
    if (res.ok) {
      showToast('Entry deleted', 'success');
      location.reload();
    }
  } catch (e) {
    showToast('Error deleting entry', 'error');
  }
}
</script>
<%- include('../partials/footer') %>
