<%
  // Get current page for active state
  const currentPage = typeof pageTitle !== 'undefined' ? pageTitle.toLowerCase() : 'dashboard';

  // Navigation items configuration - Stitch Design
  const navItems = [
    { name: 'Dashboard', icon: 'dashboard', href: '/dashboard', keywords: ['dashboard', 'overview', 'home'] },
    { name: 'Portfolios', icon: 'account_balance_wallet', href: '/portfolios', keywords: ['portfolio', 'holdings'] },
    { name: 'Market Data', icon: 'bar_chart', href: '/market-overview', keywords: ['market', 'stocks', 'quotes'] },
    { name: 'Technical Analysis', icon: 'show_chart', href: '/technical-analysis', keywords: ['technical', 'chart', 'indicator'] },
    { name: 'Fundamental Analysis', icon: 'pie_chart', href: '/fundamental-analysis', keywords: ['fundamental', 'financial', 'valuation'] },
    { name: 'Dividends', icon: 'payments', href: '/dividends', keywords: ['dividend', 'income', 'yield'] },
    { name: 'Risk Analytics', icon: 'shield', href: '/risk', keywords: ['risk', 'analytics', 'beta', 'sharpe'] },
    { name: 'Options Trading', icon: 'candlestick_chart', href: '/options', keywords: ['option', 'derivatives', 'greeks'] },
    { name: 'AI & Research', icon: 'smart_toy', href: '/ai-chat', keywords: ['ai', 'research', 'assistant', 'chat'] },
    { name: 'Tax Tools', icon: 'description', href: '/tax-loss-harvesting', keywords: ['tax', 'harvesting', 'loss'] },
  ];

  // Check if current page matches any keywords
  function isActive(item) {
    return item.keywords.some(kw => currentPage.includes(kw));
  }
%>

<!-- Side Navigation - Green Theme -->
<aside id="sidebar" class="w-64 flex-shrink-0 border-r border-green-500/15 bg-gradient-to-b from-green-950/60 to-gray-900/95 flex flex-col h-screen overflow-y-auto fixed left-0 top-0 z-40 transform transition-transform duration-300 lg:translate-x-0 -translate-x-full backdrop-blur-xl">
  <div class="p-6 pb-2">
    <!-- Logo -->
    <a href="/dashboard" class="flex items-center gap-3 mb-8 group">
      <div class="bg-green-500/20 p-2 rounded-lg shadow-lg shadow-green-500/20 group-hover:shadow-green-500/40 transition-all duration-300">
        <span class="material-symbols-outlined text-green-400" style="font-size: 28px;">flight_takeoff</span>
      </div>
      <div class="flex flex-col">
        <h1 class="text-white text-lg font-bold leading-tight">Wealth<span class="text-green-400">Pilot</span></h1>
        <p class="text-slate-400 text-xs font-medium">PRO TERMINAL</p>
      </div>
    </a>

    <!-- Navigation Items -->
    <div class="flex flex-col gap-1">
      <% navItems.forEach(item => {
        const active = isActive(item);
      %>
      <a href="<%= item.href %>" class="flex items-center gap-3 px-3 py-2.5 rounded-lg <%= active ? 'bg-gradient-to-r from-green-600 to-green-500 text-white shadow-lg shadow-green-500/30' : 'hover:bg-green-500/10 text-slate-400 hover:text-green-400' %> transition-all duration-300 cursor-pointer group">
        <span class="material-symbols-outlined <%= active ? 'filled' : '' %>" <%= active ? 'style="font-variation-settings: \'FILL\' 1;"' : '' %>><%= item.icon %></span>
        <p class="text-sm font-medium"><%= item.name %></p>
      </a>
      <% }); %>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="mt-auto p-6 border-t border-green-500/15">
    <% if (typeof user !== 'undefined' && user) { %>
    <!-- User Profile -->
    <div class="flex items-center gap-3 px-3 py-2 mb-4 rounded-lg bg-green-500/10 border border-green-500/20">
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-600 to-green-400 flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-green-500/30">
        <%= user.firstName ? user.firstName.charAt(0).toUpperCase() : (user.email ? user.email.charAt(0).toUpperCase() : 'U') %>
      </div>
      <div class="flex-1 min-w-0">
        <p class="text-white text-sm font-medium truncate">
          <%= user.firstName || (user.email ? user.email.split('@')[0] : 'User') %>
        </p>
        <p class="text-green-400 text-xs truncate">Pro Account</p>
      </div>
    </div>
    <% } %>

    <a href="/settings" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-green-500/10 text-slate-400 hover:text-green-400 transition-all duration-300 cursor-pointer">
      <span class="material-symbols-outlined">settings</span>
      <p class="text-sm font-medium">Settings</p>
    </a>
    <a href="/logout" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-500/10 text-slate-400 hover:text-red-400 transition-all duration-300 cursor-pointer">
      <span class="material-symbols-outlined">logout</span>
      <p class="text-sm font-medium">Log Out</p>
    </a>
  </div>
</aside>

<!-- Mobile Sidebar Overlay -->
<div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

<!-- Mobile Menu Toggle Button -->
<button id="mobile-menu-toggle" onclick="toggleSidebar()" class="fixed top-4 left-4 z-50 p-2 rounded-lg bg-green-950/80 border border-green-500/20 lg:hidden backdrop-blur-xl shadow-lg shadow-green-500/10 hover:border-green-500/40 transition-all duration-300">
  <span class="material-symbols-outlined text-green-400">menu</span>
</button>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    if (sidebar.classList.contains('-translate-x-full')) {
      sidebar.classList.remove('-translate-x-full');
      overlay.classList.remove('hidden');
    } else {
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
    }
  }
</script>

<style>
  /* Sidebar Styles - Green Theme */
  #sidebar {
    background: linear-gradient(180deg, rgba(5, 46, 22, 0.6) 0%, rgba(10, 15, 13, 0.95) 100%);
  }

  /* Custom scrollbar for sidebar */
  #sidebar::-webkit-scrollbar {
    width: 6px;
  }
  #sidebar::-webkit-scrollbar-track {
    background: transparent;
  }
  #sidebar::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.3);
    border-radius: 3px;
  }
  #sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 197, 94, 0.5);
  }
</style>
