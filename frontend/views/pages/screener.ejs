<%- include('../partials/header', { pageTitle: 'Advanced Stock Screener' }) %>

<main class="p-4 md:p-6 space-y-6">
  <!-- Page Header -->
  <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/25">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
      </div>
      <div>
        <h1 class="text-2xl font-bold text-white">Advanced Stock Screener</h1>
        <p class="text-slate-400 text-sm">Find stocks matching your exact criteria with 50+ filters</p>
      </div>
    </div>
    <div class="flex gap-3">
      <button onclick="saveScreen()" class="btn-glass">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
        </svg>
        Save Screen
      </button>
      <button onclick="resetFilters()" class="btn-ghost">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Reset
      </button>
      <button onclick="runScreen()" class="btn-primary" id="screenBtn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        Screen Stocks
      </button>
    </div>
  </div>

  <!-- Quick Presets -->
  <div class="flex flex-wrap gap-2">
    <span class="text-slate-400 text-sm mr-2 self-center">Quick Screens:</span>
    <button onclick="applyPreset('dividend')" class="preset-btn bg-emerald-500/10 border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/20">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
      </svg>
      High Dividend
    </button>
    <button onclick="applyPreset('value')" class="preset-btn bg-green-500/10 border-green-500/30 text-green-400 hover:bg-green-500/20">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01"/>
      </svg>
      Value Stocks
    </button>
    <button onclick="applyPreset('growth')" class="preset-btn bg-purple-500/10 border-purple-500/30 text-purple-400 hover:bg-purple-500/20">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
      </svg>
      Growth Stocks
    </button>
    <button onclick="applyPreset('mega')" class="preset-btn bg-green-500/10 border-green-500/30 text-green-400 hover:bg-green-500/20">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/>
      </svg>
      Mega Caps
    </button>
    <button onclick="applyPreset('momentum')" class="preset-btn bg-red-500/10 border-red-500/30 text-red-400 hover:bg-red-500/20">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
      Momentum
    </button>
    <button onclick="applyPreset('oversold')" class="preset-btn bg-cyan-500/10 border-cyan-500/30 text-cyan-400 hover:bg-cyan-500/20">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
      </svg>
      Oversold (RSI<30)
    </button>
    <button onclick="applyPreset('breakout')" class="preset-btn bg-pink-500/10 border-pink-500/30 text-pink-400 hover:bg-pink-500/20">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>
      </svg>
      52W High Breakout
    </button>
  </div>

  <div class="grid grid-cols-12 gap-6">
    <!-- Filters Panel (Collapsible) -->
    <div class="col-span-12 lg:col-span-3">
      <div class="glass-card-elevated sticky top-4">
        <div class="p-4 border-b border-slate-700/50">
          <div class="flex items-center justify-between">
            <h3 class="text-white font-semibold">Filters</h3>
            <span id="activeFilters" class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400">0 active</span>
          </div>
        </div>

        <div class="p-4 space-y-4 max-h-[calc(100vh-250px)] overflow-y-auto">
          <!-- Fundamental Filters -->
          <div class="space-y-3">
            <h4 class="text-xs text-slate-400 uppercase tracking-wider font-semibold flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
              Fundamentals
            </h4>

            <!-- Market Cap -->
            <div class="filter-group">
              <label class="filter-label">Market Cap</label>
              <select id="marketCap" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="mega">Mega ($200B+)</option>
                <option value="large">Large ($10B-$200B)</option>
                <option value="mid">Mid ($2B-$10B)</option>
                <option value="small">Small ($300M-$2B)</option>
                <option value="micro">Micro (&lt;$300M)</option>
              </select>
            </div>

            <!-- Sector -->
            <div class="filter-group">
              <label class="filter-label">Sector</label>
              <select id="sector" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="Technology">Technology</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Financial">Financial Services</option>
                <option value="Consumer">Consumer Cyclical</option>
                <option value="Consumer Defensive">Consumer Defensive</option>
                <option value="Industrial">Industrials</option>
                <option value="Energy">Energy</option>
                <option value="Utilities">Utilities</option>
                <option value="Real Estate">Real Estate</option>
                <option value="Materials">Basic Materials</option>
                <option value="Communication">Communication Services</option>
              </select>
            </div>

            <!-- P/E Ratio -->
            <div class="filter-group">
              <label class="filter-label">P/E Ratio</label>
              <div class="flex gap-2">
                <input type="number" id="peMin" placeholder="Min" class="filter-input w-1/2" onchange="updateFilterCount()">
                <input type="number" id="peMax" placeholder="Max" class="filter-input w-1/2" onchange="updateFilterCount()">
              </div>
            </div>

            <!-- Forward P/E -->
            <div class="filter-group">
              <label class="filter-label">Forward P/E</label>
              <div class="flex gap-2">
                <input type="number" id="fwdPeMin" placeholder="Min" class="filter-input w-1/2" onchange="updateFilterCount()">
                <input type="number" id="fwdPeMax" placeholder="Max" class="filter-input w-1/2" onchange="updateFilterCount()">
              </div>
            </div>

            <!-- PEG Ratio -->
            <div class="filter-group">
              <label class="filter-label">PEG Ratio</label>
              <select id="pegRatio" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="under1">Under 1 (Undervalued)</option>
                <option value="1to2">1 to 2 (Fair)</option>
                <option value="over2">Over 2 (Overvalued)</option>
              </select>
            </div>

            <!-- Price/Sales -->
            <div class="filter-group">
              <label class="filter-label">Price/Sales</label>
              <div class="flex gap-2">
                <input type="number" id="psMin" placeholder="Min" class="filter-input w-1/2" onchange="updateFilterCount()">
                <input type="number" id="psMax" placeholder="Max" class="filter-input w-1/2" onchange="updateFilterCount()">
              </div>
            </div>

            <!-- Price/Book -->
            <div class="filter-group">
              <label class="filter-label">Price/Book</label>
              <div class="flex gap-2">
                <input type="number" id="pbMin" placeholder="Min" class="filter-input w-1/2" onchange="updateFilterCount()">
                <input type="number" id="pbMax" placeholder="Max" class="filter-input w-1/2" onchange="updateFilterCount()">
              </div>
            </div>
          </div>

          <!-- Dividend Filters -->
          <div class="space-y-3 pt-4 border-t border-slate-700/50">
            <h4 class="text-xs text-slate-400 uppercase tracking-wider font-semibold flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Dividends
            </h4>

            <!-- Dividend Yield -->
            <div class="filter-group">
              <label class="filter-label">Dividend Yield</label>
              <div class="flex gap-2">
                <input type="number" id="divMin" placeholder="Min %" class="filter-input w-1/2" onchange="updateFilterCount()">
                <input type="number" id="divMax" placeholder="Max %" class="filter-input w-1/2" onchange="updateFilterCount()">
              </div>
            </div>

            <!-- Payout Ratio -->
            <div class="filter-group">
              <label class="filter-label">Payout Ratio</label>
              <select id="payoutRatio" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="low">Low (&lt;30%)</option>
                <option value="moderate">Moderate (30-60%)</option>
                <option value="high">High (60-80%)</option>
                <option value="veryhigh">Very High (>80%)</option>
              </select>
            </div>

            <!-- Dividend Growth -->
            <div class="filter-group">
              <label class="filter-label">5Y Div Growth</label>
              <select id="divGrowth" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="10plus">10%+ per year</option>
                <option value="5plus">5%+ per year</option>
                <option value="positive">Positive</option>
                <option value="aristocrat">Dividend Aristocrat</option>
              </select>
            </div>
          </div>

          <!-- Technical Filters -->
          <div class="space-y-3 pt-4 border-t border-slate-700/50">
            <h4 class="text-xs text-slate-400 uppercase tracking-wider font-semibold flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
              </svg>
              Technical Indicators
            </h4>

            <!-- RSI -->
            <div class="filter-group">
              <label class="filter-label">RSI (14)</label>
              <select id="rsi" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="oversold">Oversold (&lt;30)</option>
                <option value="neutral">Neutral (30-70)</option>
                <option value="overbought">Overbought (>70)</option>
              </select>
            </div>

            <!-- Moving Averages -->
            <div class="filter-group">
              <label class="filter-label">Price vs 50-Day MA</label>
              <select id="ma50" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="above">Above 50-Day MA</option>
                <option value="below">Below 50-Day MA</option>
                <option value="crossabove">Crossed Above (Bullish)</option>
                <option value="crossbelow">Crossed Below (Bearish)</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Price vs 200-Day MA</label>
              <select id="ma200" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="above">Above 200-Day MA</option>
                <option value="below">Below 200-Day MA</option>
                <option value="goldencross">Golden Cross (50 > 200)</option>
                <option value="deathcross">Death Cross (50 < 200)</option>
              </select>
            </div>

            <!-- 52-Week Range -->
            <div class="filter-group">
              <label class="filter-label">52-Week Range Position</label>
              <select id="range52w" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="nearhigh">Near 52W High (>90%)</option>
                <option value="nearlow">Near 52W Low (<10%)</option>
                <option value="newHigh">New 52W High</option>
                <option value="newLow">New 52W Low</option>
              </select>
            </div>

            <!-- Volume -->
            <div class="filter-group">
              <label class="filter-label">Relative Volume</label>
              <select id="relVolume" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="high">High (>2x avg)</option>
                <option value="elevated">Elevated (1.5-2x)</option>
                <option value="normal">Normal</option>
                <option value="low">Low (<0.5x avg)</option>
              </select>
            </div>
          </div>

          <!-- Performance Filters -->
          <div class="space-y-3 pt-4 border-t border-slate-700/50">
            <h4 class="text-xs text-slate-400 uppercase tracking-wider font-semibold flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
              </svg>
              Performance
            </h4>

            <!-- Price Change -->
            <div class="filter-group">
              <label class="filter-label">1-Day Change</label>
              <select id="change1d" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="up5">Up 5%+</option>
                <option value="up2">Up 2%+</option>
                <option value="up">Up (Any)</option>
                <option value="down">Down (Any)</option>
                <option value="down2">Down 2%+</option>
                <option value="down5">Down 5%+</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">YTD Performance</label>
              <div class="flex gap-2">
                <input type="number" id="ytdMin" placeholder="Min %" class="filter-input w-1/2" onchange="updateFilterCount()">
                <input type="number" id="ytdMax" placeholder="Max %" class="filter-input w-1/2" onchange="updateFilterCount()">
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">52-Week Performance</label>
              <div class="flex gap-2">
                <input type="number" id="perf52wMin" placeholder="Min %" class="filter-input w-1/2" onchange="updateFilterCount()">
                <input type="number" id="perf52wMax" placeholder="Max %" class="filter-input w-1/2" onchange="updateFilterCount()">
              </div>
            </div>
          </div>

          <!-- Analyst Ratings -->
          <div class="space-y-3 pt-4 border-t border-slate-700/50">
            <h4 class="text-xs text-slate-400 uppercase tracking-wider font-semibold flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
              </svg>
              Analyst Ratings
            </h4>

            <div class="filter-group">
              <label class="filter-label">Consensus Rating</label>
              <select id="analystRating" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="strongbuy">Strong Buy</option>
                <option value="buy">Buy</option>
                <option value="hold">Hold</option>
                <option value="sell">Sell</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Price Target Upside</label>
              <select id="targetUpside" class="filter-select" onchange="updateFilterCount()">
                <option value="">Any</option>
                <option value="20plus">20%+ Upside</option>
                <option value="10plus">10%+ Upside</option>
                <option value="positive">Any Upside</option>
                <option value="negative">Downside Risk</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Panel -->
    <div class="col-span-12 lg:col-span-9 space-y-4">
      <!-- Results Summary -->
      <div class="glass-card-elevated p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <span id="resultCount" class="text-white font-semibold">0 stocks found</span>
            <div class="flex gap-2">
              <button onclick="exportCSV()" class="text-xs text-slate-400 hover:text-white transition flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Export CSV
              </button>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-400">View:</span>
            <button onclick="setView('table')" id="viewTable" class="p-1.5 rounded bg-green-500/20 text-green-400">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
              </svg>
            </button>
            <button onclick="setView('cards')" id="viewCards" class="p-1.5 rounded text-slate-400 hover:text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Results Table -->
      <div id="tableView" class="glass-card-elevated overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-slate-700/50 text-xs text-slate-400 uppercase">
                <th class="px-4 py-3 text-left cursor-pointer hover:text-white transition" onclick="sortBy('symbol')">
                  <span class="flex items-center gap-1">Symbol <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                </th>
                <th class="px-4 py-3 text-left cursor-pointer hover:text-white transition" onclick="sortBy('name')">Company</th>
                <th class="px-4 py-3 text-right cursor-pointer hover:text-white transition" onclick="sortBy('price')">Price</th>
                <th class="px-4 py-3 text-right cursor-pointer hover:text-white transition" onclick="sortBy('change')">Change</th>
                <th class="px-4 py-3 text-right cursor-pointer hover:text-white transition" onclick="sortBy('marketCap')">Market Cap</th>
                <th class="px-4 py-3 text-right cursor-pointer hover:text-white transition" onclick="sortBy('pe')">P/E</th>
                <th class="px-4 py-3 text-right cursor-pointer hover:text-white transition" onclick="sortBy('dividend')">Yield</th>
                <th class="px-4 py-3 text-right cursor-pointer hover:text-white transition" onclick="sortBy('rsi')">RSI</th>
                <th class="px-4 py-3 text-center">Sector</th>
                <th class="px-4 py-3 text-center">Chart</th>
                <th class="px-4 py-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <tr>
                <td colspan="11" class="px-4 py-16 text-center">
                  <div class="flex flex-col items-center gap-4">
                    <div class="w-16 h-16 rounded-xl bg-slate-800/50 flex items-center justify-center">
                      <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                      </svg>
                    </div>
                    <div class="text-center">
                      <p class="text-white font-medium mb-1">Set Your Criteria</p>
                      <p class="text-slate-400 text-sm">Use filters or quick presets to find matching stocks</p>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Cards View (Hidden by default) -->
      <div id="cardsView" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        <!-- Cards will be inserted here -->
      </div>
    </div>
  </div>
</main>

<!-- Stock Detail Modal -->
<div id="stockModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeStockModal()"></div>
  <div class="absolute inset-4 md:inset-10 bg-slate-900 rounded-2xl border border-slate-700/50 overflow-hidden flex flex-col">
    <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
      <div class="flex items-center gap-3">
        <span id="modalSymbol" class="text-xl font-bold text-green-400">AAPL</span>
        <span id="modalName" class="text-slate-400">Apple Inc.</span>
      </div>
      <button onclick="closeStockModal()" class="text-slate-400 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="flex-1 overflow-auto p-4">
      <div id="modalContent">
        <!-- Technical chart and details will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
// Extended stock database with technical indicators
const stockData = [
  { symbol: 'AAPL', name: 'Apple Inc.', price: 185.50, change: 1.2, marketCap: 2900, pe: 28.5, fwdPe: 25.2, peg: 2.1, ps: 7.2, pb: 45.3, dividend: 0.5, payoutRatio: 15, divGrowth: 5.2, rsi: 58, ma50: 'above', ma200: 'above', range52w: 85, relVolume: 1.2, ytd: 48, perf52w: 35, sector: 'Technology', rating: 'buy', targetUpside: 12 },
  { symbol: 'MSFT', name: 'Microsoft Corporation', price: 378.20, change: 0.8, marketCap: 2800, pe: 35.2, fwdPe: 30.1, peg: 2.3, ps: 12.5, pb: 12.8, dividend: 0.8, payoutRatio: 28, divGrowth: 10.5, rsi: 62, ma50: 'above', ma200: 'above', range52w: 92, relVolume: 0.9, ytd: 52, perf52w: 45, sector: 'Technology', rating: 'buy', targetUpside: 15 },
  { symbol: 'GOOGL', name: 'Alphabet Inc.', price: 141.80, change: -0.5, marketCap: 1750, pe: 24.1, fwdPe: 20.5, peg: 1.5, ps: 5.8, pb: 6.2, dividend: 0, payoutRatio: 0, divGrowth: 0, rsi: 45, ma50: 'below', ma200: 'above', range52w: 68, relVolume: 1.1, ytd: 55, perf52w: 40, sector: 'Technology', rating: 'outperform', targetUpside: 25 },
  { symbol: 'AMZN', name: 'Amazon.com Inc.', price: 178.50, change: 2.1, marketCap: 1850, pe: 62.3, fwdPe: 42.5, peg: 1.8, ps: 2.8, pb: 8.5, dividend: 0, payoutRatio: 0, divGrowth: 0, rsi: 65, ma50: 'above', ma200: 'above', range52w: 88, relVolume: 1.5, ytd: 75, perf52w: 55, sector: 'Consumer', rating: 'buy', targetUpside: 20 },
  { symbol: 'NVDA', name: 'NVIDIA Corporation', price: 495.00, change: 3.5, marketCap: 1220, pe: 65.8, fwdPe: 35.2, peg: 1.2, ps: 28.5, pb: 42.1, dividend: 0.04, payoutRatio: 2, divGrowth: 0, rsi: 72, ma50: 'above', ma200: 'above', range52w: 98, relVolume: 2.2, ytd: 220, perf52w: 180, sector: 'Technology', rating: 'buy', targetUpside: 8 },
  { symbol: 'JPM', name: 'JPMorgan Chase & Co.', price: 170.25, change: 0.3, marketCap: 490, pe: 10.2, fwdPe: 9.8, peg: 1.1, ps: 2.8, pb: 1.6, dividend: 2.4, payoutRatio: 25, divGrowth: 8.5, rsi: 55, ma50: 'above', ma200: 'above', range52w: 78, relVolume: 0.8, ytd: 18, perf52w: 28, sector: 'Financial', rating: 'outperform', targetUpside: 10 },
  { symbol: 'JNJ', name: 'Johnson & Johnson', price: 156.80, change: -0.2, marketCap: 378, pe: 15.8, fwdPe: 14.5, peg: 2.8, ps: 4.2, pb: 5.8, dividend: 3.0, payoutRatio: 45, divGrowth: 6.2, rsi: 42, ma50: 'below', ma200: 'below', range52w: 25, relVolume: 0.6, ytd: -8, perf52w: -5, sector: 'Healthcare', rating: 'hold', targetUpside: 5 },
  { symbol: 'V', name: 'Visa Inc.', price: 260.40, change: 0.9, marketCap: 535, pe: 29.4, fwdPe: 25.2, peg: 1.8, ps: 16.2, pb: 13.5, dividend: 0.8, payoutRatio: 22, divGrowth: 15.2, rsi: 58, ma50: 'above', ma200: 'above', range52w: 82, relVolume: 0.9, ytd: 22, perf52w: 18, sector: 'Financial', rating: 'buy', targetUpside: 12 },
  { symbol: 'XOM', name: 'Exxon Mobil Corp.', price: 105.60, change: -1.2, marketCap: 420, pe: 9.8, fwdPe: 11.2, peg: 0.8, ps: 1.2, pb: 2.1, dividend: 3.5, payoutRatio: 35, divGrowth: 3.5, rsi: 38, ma50: 'below', ma200: 'above', range52w: 45, relVolume: 1.3, ytd: -5, perf52w: 8, sector: 'Energy', rating: 'outperform', targetUpside: 18 },
  { symbol: 'CVX', name: 'Chevron Corporation', price: 150.30, change: -0.8, marketCap: 280, pe: 11.2, fwdPe: 12.5, peg: 0.9, ps: 1.4, pb: 1.8, dividend: 4.1, payoutRatio: 45, divGrowth: 5.8, rsi: 35, ma50: 'below', ma200: 'below', range52w: 32, relVolume: 1.1, ytd: -12, perf52w: 2, sector: 'Energy', rating: 'hold', targetUpside: 15 },
  { symbol: 'PFE', name: 'Pfizer Inc.', price: 28.40, change: -2.1, marketCap: 160, pe: 8.5, fwdPe: 10.2, peg: 0.6, ps: 2.8, pb: 1.5, dividend: 5.8, payoutRatio: 48, divGrowth: 2.5, rsi: 25, ma50: 'below', ma200: 'below', range52w: 8, relVolume: 1.8, ytd: -42, perf52w: -35, sector: 'Healthcare', rating: 'hold', targetUpside: 35 },
  { symbol: 'VZ', name: 'Verizon Communications', price: 38.50, change: 0.2, marketCap: 162, pe: 7.8, fwdPe: 8.2, peg: 1.2, ps: 1.2, pb: 1.8, dividend: 6.8, payoutRatio: 52, divGrowth: 2.1, rsi: 48, ma50: 'above', ma200: 'below', range52w: 55, relVolume: 0.7, ytd: -2, perf52w: -8, sector: 'Communication', rating: 'hold', targetUpside: 8 },
  { symbol: 'T', name: 'AT&T Inc.', price: 17.20, change: -0.3, marketCap: 123, pe: 6.2, fwdPe: 7.5, peg: 0.8, ps: 1.0, pb: 1.2, dividend: 6.5, payoutRatio: 40, divGrowth: -5, rsi: 42, ma50: 'below', ma200: 'below', range52w: 42, relVolume: 0.9, ytd: -8, perf52w: -12, sector: 'Communication', rating: 'hold', targetUpside: 12 },
  { symbol: 'KO', name: 'Coca-Cola Company', price: 60.25, change: 0.4, marketCap: 260, pe: 23.5, fwdPe: 21.8, peg: 3.5, ps: 5.8, pb: 10.2, dividend: 3.1, payoutRatio: 72, divGrowth: 4.5, rsi: 52, ma50: 'above', ma200: 'above', range52w: 72, relVolume: 0.8, ytd: 5, perf52w: 8, sector: 'Consumer Defensive', rating: 'hold', targetUpside: 5 },
  { symbol: 'PG', name: 'Procter & Gamble', price: 159.20, change: 0.1, marketCap: 375, pe: 26.1, fwdPe: 24.5, peg: 3.2, ps: 4.5, pb: 7.8, dividend: 2.4, payoutRatio: 62, divGrowth: 5.5, rsi: 55, ma50: 'above', ma200: 'above', range52w: 75, relVolume: 0.7, ytd: 8, perf52w: 12, sector: 'Consumer Defensive', rating: 'hold', targetUpside: 3 },
  { symbol: 'AMD', name: 'AMD Inc.', price: 145.80, change: 4.2, marketCap: 235, pe: 48.5, fwdPe: 28.2, peg: 0.9, ps: 9.5, pb: 4.2, dividend: 0, payoutRatio: 0, divGrowth: 0, rsi: 68, ma50: 'above', ma200: 'above', range52w: 85, relVolume: 1.8, ytd: 95, perf52w: 72, sector: 'Technology', rating: 'buy', targetUpside: 22 },
  { symbol: 'INTC', name: 'Intel Corporation', price: 45.60, change: -1.5, marketCap: 192, pe: 12.3, fwdPe: 15.8, peg: 1.5, ps: 1.8, pb: 1.2, dividend: 1.1, payoutRatio: 14, divGrowth: -25, rsi: 32, ma50: 'below', ma200: 'below', range52w: 28, relVolume: 1.2, ytd: -15, perf52w: -18, sector: 'Technology', rating: 'underperform', targetUpside: 8 },
  { symbol: 'DIS', name: 'Walt Disney Company', price: 95.20, change: 1.8, marketCap: 174, pe: 45.2, fwdPe: 22.5, peg: 1.2, ps: 2.1, pb: 1.8, dividend: 0, payoutRatio: 0, divGrowth: 0, rsi: 58, ma50: 'above', ma200: 'below', range52w: 55, relVolume: 1.1, ytd: 8, perf52w: -8, sector: 'Communication', rating: 'outperform', targetUpside: 28 },
  { symbol: 'NFLX', name: 'Netflix Inc.', price: 485.30, change: 2.5, marketCap: 210, pe: 42.8, fwdPe: 28.5, peg: 1.1, ps: 6.8, pb: 12.5, dividend: 0, payoutRatio: 0, divGrowth: 0, rsi: 62, ma50: 'above', ma200: 'above', range52w: 88, relVolume: 1.3, ytd: 65, perf52w: 85, sector: 'Communication', rating: 'buy', targetUpside: 12 },
  { symbol: 'CRM', name: 'Salesforce Inc.', price: 265.40, change: 1.1, marketCap: 258, pe: 58.2, fwdPe: 28.2, peg: 1.5, ps: 7.5, pb: 3.8, dividend: 0, payoutRatio: 0, divGrowth: 0, rsi: 55, ma50: 'above', ma200: 'above', range52w: 78, relVolume: 0.9, ytd: 72, perf52w: 58, sector: 'Technology', rating: 'outperform', targetUpside: 15 },
];

let currentSort = { column: 'marketCap', asc: false };
let filteredData = [];
let currentView = 'table';

// Run screen with all filters
function runScreen() {
  const filters = getFilters();

  filteredData = stockData.filter(stock => {
    // Market Cap
    if (filters.marketCap) {
      const cap = stock.marketCap;
      if (filters.marketCap === 'mega' && cap < 200) return false;
      if (filters.marketCap === 'large' && (cap < 10 || cap >= 200)) return false;
      if (filters.marketCap === 'mid' && (cap < 2 || cap >= 10)) return false;
      if (filters.marketCap === 'small' && (cap < 0.3 || cap >= 2)) return false;
      if (filters.marketCap === 'micro' && cap >= 0.3) return false;
    }

    // Sector
    if (filters.sector && stock.sector !== filters.sector) return false;

    // P/E Range
    if (filters.peMin && stock.pe < filters.peMin) return false;
    if (filters.peMax && stock.pe > filters.peMax) return false;

    // Dividend Range
    if (filters.divMin && stock.dividend < filters.divMin) return false;
    if (filters.divMax && stock.dividend > filters.divMax) return false;

    // RSI
    if (filters.rsi) {
      if (filters.rsi === 'oversold' && stock.rsi >= 30) return false;
      if (filters.rsi === 'neutral' && (stock.rsi < 30 || stock.rsi > 70)) return false;
      if (filters.rsi === 'overbought' && stock.rsi <= 70) return false;
    }

    // MA50
    if (filters.ma50 && stock.ma50 !== filters.ma50) return false;

    // MA200
    if (filters.ma200) {
      if (filters.ma200 === 'above' && stock.ma200 !== 'above') return false;
      if (filters.ma200 === 'below' && stock.ma200 !== 'below') return false;
    }

    // 52W Range
    if (filters.range52w) {
      if (filters.range52w === 'nearhigh' && stock.range52w < 90) return false;
      if (filters.range52w === 'nearlow' && stock.range52w > 10) return false;
      if (filters.range52w === 'newHigh' && stock.range52w < 98) return false;
      if (filters.range52w === 'newLow' && stock.range52w > 2) return false;
    }

    // YTD Performance
    if (filters.ytdMin && stock.ytd < filters.ytdMin) return false;
    if (filters.ytdMax && stock.ytd > filters.ytdMax) return false;

    // 52W Performance
    if (filters.perf52wMin && stock.perf52w < filters.perf52wMin) return false;
    if (filters.perf52wMax && stock.perf52w > filters.perf52wMax) return false;

    // Analyst Rating
    if (filters.analystRating) {
      const ratingMap = { 'strongbuy': 'buy', 'buy': 'buy', 'hold': 'hold', 'sell': 'underperform' };
      if (filters.analystRating === 'strongbuy' && stock.rating !== 'buy') return false;
      if (filters.analystRating === 'buy' && !['buy', 'outperform'].includes(stock.rating)) return false;
      if (filters.analystRating === 'hold' && stock.rating !== 'hold') return false;
      if (filters.analystRating === 'sell' && stock.rating !== 'underperform') return false;
    }

    // Target Upside
    if (filters.targetUpside) {
      if (filters.targetUpside === '20plus' && stock.targetUpside < 20) return false;
      if (filters.targetUpside === '10plus' && stock.targetUpside < 10) return false;
      if (filters.targetUpside === 'positive' && stock.targetUpside <= 0) return false;
      if (filters.targetUpside === 'negative' && stock.targetUpside >= 0) return false;
    }

    return true;
  });

  renderResults();
}

function getFilters() {
  return {
    marketCap: document.getElementById('marketCap').value,
    sector: document.getElementById('sector').value,
    peMin: parseFloat(document.getElementById('peMin').value) || null,
    peMax: parseFloat(document.getElementById('peMax').value) || null,
    divMin: parseFloat(document.getElementById('divMin').value) || null,
    divMax: parseFloat(document.getElementById('divMax').value) || null,
    rsi: document.getElementById('rsi').value,
    ma50: document.getElementById('ma50').value,
    ma200: document.getElementById('ma200').value,
    range52w: document.getElementById('range52w').value,
    ytdMin: parseFloat(document.getElementById('ytdMin').value) || null,
    ytdMax: parseFloat(document.getElementById('ytdMax').value) || null,
    perf52wMin: parseFloat(document.getElementById('perf52wMin').value) || null,
    perf52wMax: parseFloat(document.getElementById('perf52wMax').value) || null,
    analystRating: document.getElementById('analystRating').value,
    targetUpside: document.getElementById('targetUpside').value,
  };
}

function updateFilterCount() {
  const filters = getFilters();
  const count = Object.values(filters).filter(v => v !== null && v !== '').length;
  document.getElementById('activeFilters').textContent = count + ' active';
}

function renderResults() {
  document.getElementById('resultCount').textContent = filteredData.length + ' stocks found';

  // Sort
  filteredData.sort((a, b) => {
    let valA = a[currentSort.column];
    let valB = b[currentSort.column];
    if (typeof valA === 'string') valA = valA.toLowerCase();
    if (typeof valB === 'string') valB = valB.toLowerCase();
    return currentSort.asc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });

  if (currentView === 'table') {
    renderTable();
  } else {
    renderCards();
  }
}

function renderTable() {
  const tbody = document.getElementById('resultsBody');

  if (filteredData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="11" class="px-4 py-16 text-center">
          <div class="flex flex-col items-center gap-4">
            <div class="w-16 h-16 rounded-xl bg-slate-800/50 flex items-center justify-center">
              <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <p class="text-slate-400">No stocks match your criteria. Try adjusting filters.</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = filteredData.map(stock => `
    <tr class="border-b border-slate-700/30 hover:bg-slate-800/30 transition-colors">
      <td class="px-4 py-3">
        <button onclick="openStockModal('${stock.symbol}')" class="font-bold text-green-400 hover:text-amber-300 transition">${stock.symbol}</button>
      </td>
      <td class="px-4 py-3 text-slate-300 text-sm">${stock.name}</td>
      <td class="px-4 py-3 text-right font-mono text-white">$${stock.price.toFixed(2)}</td>
      <td class="px-4 py-3 text-right font-mono ${stock.change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%</td>
      <td class="px-4 py-3 text-right text-slate-300">$${stock.marketCap}B</td>
      <td class="px-4 py-3 text-right font-mono text-slate-300">${stock.pe.toFixed(1)}</td>
      <td class="px-4 py-3 text-right font-mono ${stock.dividend > 2 ? 'text-emerald-400' : 'text-slate-300'}">${stock.dividend.toFixed(1)}%</td>
      <td class="px-4 py-3 text-right">
        <span class="px-2 py-1 rounded text-xs font-mono ${stock.rsi < 30 ? 'bg-emerald-500/20 text-emerald-400' : stock.rsi > 70 ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-300'}">${stock.rsi}</span>
      </td>
      <td class="px-4 py-3 text-center">
        <span class="text-xs px-2 py-1 rounded-full bg-slate-700/50 text-slate-300">${stock.sector}</span>
      </td>
      <td class="px-4 py-3 text-center">
        <div class="w-16 h-8 mx-auto">
          <canvas id="mini-${stock.symbol}" width="64" height="32"></canvas>
        </div>
      </td>
      <td class="px-4 py-3 text-center">
        <div class="flex items-center justify-center gap-1">
          <button onclick="addToWatchlist('${stock.symbol}')" class="p-1.5 rounded hover:bg-slate-700 transition" title="Add to Watchlist">
            <svg class="w-4 h-4 text-slate-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
          </button>
          <button onclick="addToPortfolio('${stock.symbol}')" class="p-1.5 rounded hover:bg-slate-700 transition" title="Add to Portfolio">
            <svg class="w-4 h-4 text-slate-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
          </button>
        </div>
      </td>
    </tr>
  `).join('');

  // Draw mini sparklines
  setTimeout(() => {
    filteredData.forEach(stock => {
      drawMiniChart(stock.symbol, stock.change >= 0);
    });
  }, 100);
}

function drawMiniChart(symbol, isPositive) {
  const canvas = document.getElementById(`mini-${symbol}`);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 64, 32);

  // Generate random sparkline data
  const data = Array.from({length: 20}, () => 10 + Math.random() * 12);
  if (isPositive) {
    data.forEach((v, i) => data[i] = v + i * 0.3);
  } else {
    data.forEach((v, i) => data[i] = v - i * 0.3);
  }

  const min = Math.min(...data);
  const max = Math.max(...data);
  const range = max - min || 1;

  ctx.beginPath();
  ctx.strokeStyle = isPositive ? '#10b981' : '#ef4444';
  ctx.lineWidth = 1.5;

  data.forEach((val, i) => {
    const x = (i / (data.length - 1)) * 64;
    const y = 32 - ((val - min) / range) * 28;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();
}

function renderCards() {
  const container = document.getElementById('cardsView');

  if (filteredData.length === 0) {
    container.innerHTML = `<div class="col-span-full text-center py-16 text-slate-400">No stocks match your criteria</div>`;
    return;
  }

  container.innerHTML = filteredData.map(stock => `
    <div class="glass-card-elevated p-4 hover:border-slate-600 transition cursor-pointer" onclick="openStockModal('${stock.symbol}')">
      <div class="flex items-start justify-between mb-3">
        <div>
          <span class="text-lg font-bold text-green-400">${stock.symbol}</span>
          <p class="text-sm text-slate-400 truncate">${stock.name}</p>
        </div>
        <span class="${stock.change >= 0 ? 'text-emerald-400' : 'text-red-400'} font-mono">${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%</span>
      </div>
      <div class="text-2xl font-bold text-white mb-3">$${stock.price.toFixed(2)}</div>
      <div class="grid grid-cols-3 gap-2 text-xs">
        <div class="text-center p-2 bg-slate-800/50 rounded">
          <p class="text-slate-400">P/E</p>
          <p class="text-white font-mono">${stock.pe.toFixed(1)}</p>
        </div>
        <div class="text-center p-2 bg-slate-800/50 rounded">
          <p class="text-slate-400">Yield</p>
          <p class="${stock.dividend > 2 ? 'text-emerald-400' : 'text-white'} font-mono">${stock.dividend.toFixed(1)}%</p>
        </div>
        <div class="text-center p-2 bg-slate-800/50 rounded">
          <p class="text-slate-400">RSI</p>
          <p class="${stock.rsi < 30 ? 'text-emerald-400' : stock.rsi > 70 ? 'text-red-400' : 'text-white'} font-mono">${stock.rsi}</p>
        </div>
      </div>
    </div>
  `).join('');
}

function setView(view) {
  currentView = view;
  document.getElementById('viewTable').className = view === 'table' ? 'p-1.5 rounded bg-green-500/20 text-green-400' : 'p-1.5 rounded text-slate-400 hover:text-white';
  document.getElementById('viewCards').className = view === 'cards' ? 'p-1.5 rounded bg-green-500/20 text-green-400' : 'p-1.5 rounded text-slate-400 hover:text-white';
  document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
  document.getElementById('cardsView').classList.toggle('hidden', view !== 'cards');
  renderResults();
}

function sortBy(column) {
  if (currentSort.column === column) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort = { column, asc: true };
  }
  renderResults();
}

function resetFilters() {
  document.querySelectorAll('.filter-select, .filter-input').forEach(el => {
    if (el.tagName === 'SELECT') el.selectedIndex = 0;
    else el.value = '';
  });
  updateFilterCount();
  filteredData = [];
  renderResults();
}

function applyPreset(preset) {
  resetFilters();
  switch (preset) {
    case 'dividend':
      document.getElementById('divMin').value = '3';
      break;
    case 'value':
      document.getElementById('peMax').value = '15';
      document.getElementById('divMin').value = '2';
      break;
    case 'growth':
      document.getElementById('sector').value = 'Technology';
      document.getElementById('ytdMin').value = '20';
      break;
    case 'mega':
      document.getElementById('marketCap').value = 'mega';
      break;
    case 'momentum':
      document.getElementById('ytdMin').value = '30';
      document.getElementById('ma50').value = 'above';
      break;
    case 'oversold':
      document.getElementById('rsi').value = 'oversold';
      break;
    case 'breakout':
      document.getElementById('range52w').value = 'nearhigh';
      break;
  }
  updateFilterCount();
  runScreen();
}

function openStockModal(symbol) {
  const stock = stockData.find(s => s.symbol === symbol);
  if (!stock) return;

  document.getElementById('modalSymbol').textContent = stock.symbol;
  document.getElementById('modalName').textContent = stock.name;
  document.getElementById('modalContent').innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div>
        <h4 class="text-white font-semibold mb-4">Technical Chart</h4>
        <div class="bg-slate-800/50 rounded-lg p-4" style="height: 300px;">
          <canvas id="modalChart"></canvas>
        </div>
      </div>
      <div class="space-y-4">
        <div>
          <h4 class="text-white font-semibold mb-3">Key Metrics</h4>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 bg-slate-800/50 rounded-lg">
              <p class="text-slate-400 text-xs">Price</p>
              <p class="text-white font-mono text-lg">$${stock.price.toFixed(2)}</p>
            </div>
            <div class="p-3 bg-slate-800/50 rounded-lg">
              <p class="text-slate-400 text-xs">Change</p>
              <p class="${stock.change >= 0 ? 'text-emerald-400' : 'text-red-400'} font-mono text-lg">${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%</p>
            </div>
            <div class="p-3 bg-slate-800/50 rounded-lg">
              <p class="text-slate-400 text-xs">P/E Ratio</p>
              <p class="text-white font-mono text-lg">${stock.pe.toFixed(1)}</p>
            </div>
            <div class="p-3 bg-slate-800/50 rounded-lg">
              <p class="text-slate-400 text-xs">Forward P/E</p>
              <p class="text-white font-mono text-lg">${stock.fwdPe.toFixed(1)}</p>
            </div>
            <div class="p-3 bg-slate-800/50 rounded-lg">
              <p class="text-slate-400 text-xs">Dividend Yield</p>
              <p class="${stock.dividend > 2 ? 'text-emerald-400' : 'text-white'} font-mono text-lg">${stock.dividend.toFixed(2)}%</p>
            </div>
            <div class="p-3 bg-slate-800/50 rounded-lg">
              <p class="text-slate-400 text-xs">RSI (14)</p>
              <p class="${stock.rsi < 30 ? 'text-emerald-400' : stock.rsi > 70 ? 'text-red-400' : 'text-white'} font-mono text-lg">${stock.rsi}</p>
            </div>
          </div>
        </div>
        <div>
          <h4 class="text-white font-semibold mb-3">Analyst Rating</h4>
          <div class="flex items-center gap-4">
            <span class="px-4 py-2 rounded-lg text-sm font-semibold ${stock.rating === 'buy' ? 'bg-emerald-500/20 text-emerald-400' : stock.rating === 'outperform' ? 'bg-green-500/20 text-green-400' : stock.rating === 'hold' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${stock.rating.toUpperCase()}</span>
            <span class="text-slate-400">Target Upside: <span class="text-white font-mono">+${stock.targetUpside}%</span></span>
          </div>
        </div>
        <div class="flex gap-3 pt-4">
          <button onclick="addToWatchlist('${stock.symbol}')" class="btn-glass flex-1">Add to Watchlist</button>
          <button onclick="addToPortfolio('${stock.symbol}')" class="btn-primary flex-1">Add to Portfolio</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('stockModal').classList.remove('hidden');

  // Draw chart
  setTimeout(() => {
    const ctx = document.getElementById('modalChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({length: 30}, (_, i) => `Day ${i+1}`),
          datasets: [{
            label: 'Price',
            data: Array.from({length: 30}, (_, i) => stock.price * (0.95 + Math.random() * 0.1 + (stock.change >= 0 ? i * 0.002 : -i * 0.002))),
            borderColor: stock.change >= 0 ? '#10b981' : '#ef4444',
            backgroundColor: stock.change >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', callback: v => '$' + v.toFixed(0) } }
          }
        }
      });
    }
  }, 100);
}

function closeStockModal() {
  document.getElementById('stockModal').classList.add('hidden');
}

async function addToWatchlist(symbol) {
  try {
    await fetch('/api/watchlist', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ symbol, target_price: 0 })
    });
    showToast(symbol + ' added to watchlist', 'success');
  } catch (e) {
    showToast('Failed to add to watchlist', 'error');
  }
}

async function addToPortfolio(symbol) {
  window.location.href = `/portfolio-manager?add=${symbol}`;
}

function exportCSV() {
  if (filteredData.length === 0) {
    showToast('No data to export', 'error');
    return;
  }

  const headers = ['Symbol', 'Name', 'Price', 'Change', 'Market Cap', 'P/E', 'Dividend', 'RSI', 'Sector'];
  const rows = filteredData.map(s => [s.symbol, s.name, s.price, s.change, s.marketCap, s.pe, s.dividend, s.rsi, s.sector]);

  const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'screener-results.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exported', 'success');
}

function saveScreen() {
  const filters = getFilters();
  localStorage.setItem('savedScreen', JSON.stringify(filters));
  showToast('Screen saved', 'success');
}

function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${type === 'success' ? 'bg-emerald-500' : 'bg-red-500'}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  updateFilterCount();
  runScreen();
});
</script>

<style>
.filter-group { }
.filter-label { @apply block text-xs text-slate-400 mb-1.5; }
.filter-select { @apply w-full bg-slate-800/50 border border-slate-600/50 rounded-lg px-3 py-2 text-white text-sm focus:border-green-500 focus:ring-1 focus:ring-green-500 transition; }
.filter-input { @apply w-full bg-slate-800/50 border border-slate-600/50 rounded-lg px-3 py-2 text-white text-sm font-mono focus:border-green-500 focus:ring-1 focus:ring-green-500 transition; }
.preset-btn { @apply inline-flex items-center gap-1.5 px-3 py-1.5 text-sm border rounded-lg transition-colors; }
.glass-card-elevated { @apply bg-slate-800/50 border border-slate-700/50 rounded-xl backdrop-blur-sm; }
.btn-glass { @apply inline-flex items-center gap-2 px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white hover:bg-slate-600/50 transition; }
.btn-ghost { @apply inline-flex items-center gap-2 px-4 py-2 text-slate-400 hover:text-white transition; }
.btn-primary { @apply inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-500 to-purple-600 text-white rounded-lg hover:from-green-400 hover:to-purple-500 transition shadow-lg shadow-blue-500/25; }
</style>

<%- include('../partials/footer') %>
