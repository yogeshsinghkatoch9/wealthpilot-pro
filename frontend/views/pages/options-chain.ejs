<%
// Safe defaults
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const opt = options || {};
const calls = opt.calls || [];
const puts = opt.puts || [];
const expirations = opt.expirations || [];
const quote = opt.quote || {};
const price = quote.price || opt.currentPrice || 0;
const change = quote.change || 0;
const changePercent = quote.changePercent || 0;

// Helper functions
function formatPrice(v) { return '$' + (v || 0).toFixed(2); }
function formatPct(v) { return (v || 0).toFixed(2) + '%'; }
function formatVol(v) {
  if (!v) return '0';
  if (v >= 1e6) return (v / 1e6).toFixed(1) + 'M';
  if (v >= 1e3) return (v / 1e3).toFixed(1) + 'K';
  return v.toString();
}
function formatDelta(v) { return (v || 0).toFixed(2); }
function formatIV(v) { return ((v || 0) * 100).toFixed(1) + '%'; }

// Calculate aggregate metrics
let totalCallVolume = 0, totalPutVolume = 0;
let totalCallOI = 0, totalPutOI = 0;
let avgIV = 0, ivCount = 0;

calls.forEach(c => {
  totalCallVolume += c.volume || 0;
  totalCallOI += c.openInterest || 0;
  if (c.impliedVolatility) { avgIV += c.impliedVolatility; ivCount++; }
});
puts.forEach(p => {
  totalPutVolume += p.volume || 0;
  totalPutOI += p.openInterest || 0;
  if (p.impliedVolatility) { avgIV += p.impliedVolatility; ivCount++; }
});

const totalVolume = totalCallVolume + totalPutVolume;
const totalOI = totalCallOI + totalPutOI;
avgIV = ivCount > 0 ? (avgIV / ivCount) : 0;
const putCallRatio = totalCallVolume > 0 ? (totalPutVolume / totalCallVolume) : 0;

// Build strike map - matching calls and puts by strike
const strikeMap = {};
calls.forEach(c => {
  const strike = c.strike;
  if (!strikeMap[strike]) strikeMap[strike] = { strike: strike };
  strikeMap[strike].call = c;
});
puts.forEach(p => {
  const strike = p.strike;
  if (!strikeMap[strike]) strikeMap[strike] = { strike: strike };
  strikeMap[strike].put = p;
});

// Sort strikes
const strikes = Object.keys(strikeMap).map(Number).sort((a, b) => a - b);
const atmIndex = strikes.findIndex(s => s >= price);
const displayStrikes = strikes.slice(Math.max(0, atmIndex - 5), atmIndex + 6);

// Demo data if no real data
const demoPrice = price || 432.15;
const demoChange = changePercent || 1.25;
%>
<%- include('../partials/header', { pageTitle: 'Options Chain Analysis' }) %>

<!-- Stitch Design System -->
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        "primary": "#4850e5",
        "background-dark": "#111217",
        "surface-dark": "#292a38",
        "text-secondary": "#9e9fb7"
      },
      fontFamily: {
        "display": ["Manrope", "sans-serif"]
      }
    }
  }
}
</script>
<style>
  body { font-family: 'Manrope', sans-serif; }
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #111217; }
  ::-webkit-scrollbar-thumb { background: #292a38; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #3d3e52; }
</style>

<main class="flex-1 px-4 md:px-10 py-8 max-w-[1600px] mx-auto w-full flex flex-col gap-6 bg-[#111217] min-h-screen">
  <!-- Header & Description -->
  <div class="flex flex-wrap justify-between gap-4 items-end">
    <div class="flex flex-col gap-2">
      <h1 class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">Options Chain Analysis</h1>
      <p class="text-[#9e9fb7] text-base font-normal">Real-time derivatives data, Greeks, and execution for US Equities.</p>
    </div>
  </div>

  <!-- Search and Stats Bar -->
  <div class="flex flex-col xl:flex-row gap-6">
    <!-- Search -->
    <div class="xl:w-1/3 w-full">
      <form method="GET" action="/options-chain">
        <label class="flex flex-col h-14 w-full">
          <div class="flex w-full flex-1 items-stretch rounded-xl h-full border border-[#292a38] bg-[#292a38] focus-within:border-[#4850e5] transition-colors overflow-hidden">
            <div class="text-[#9e9fb7] flex items-center justify-center pl-4 pr-2">
              <span class="material-symbols-outlined">search</span>
            </div>
            <input type="text" name="symbol" value="<%= symbol || 'SPY' %>" class="flex w-full min-w-0 flex-1 bg-transparent text-white focus:outline-0 placeholder:text-[#9e9fb7] px-2 text-base font-medium uppercase" placeholder="Search symbol (e.g., SPY, AAPL, NVDA)">
            <button type="submit" class="bg-[#4850e5] hover:bg-[#5a62f0] text-white px-4 font-semibold transition-colors">
              <span class="material-symbols-outlined">arrow_forward</span>
            </button>
          </div>
        </label>
      </form>
    </div>

    <!-- Asset Summary Cards -->
    <div class="flex-1 flex flex-wrap gap-4 items-center">
      <div class="flex flex-col px-4 py-2 rounded-xl bg-[#292a38]/50 border border-[#292a38] min-w-[120px]">
        <span class="text-[#9e9fb7] text-xs font-semibold uppercase tracking-wider">Last Price</span>
        <span class="text-white text-2xl font-bold font-mono"><%= formatPrice(demoPrice) %></span>
      </div>
      <div class="flex flex-col px-4 py-2 rounded-xl bg-[#292a38]/50 border border-[#292a38] min-w-[120px]">
        <span class="text-[#9e9fb7] text-xs font-semibold uppercase tracking-wider">Change</span>
        <span class="<%= demoChange >= 0 ? 'text-green-400' : 'text-red-400' %> text-2xl font-bold font-mono"><%= demoChange >= 0 ? '+' : '' %><%= formatPct(demoChange) %></span>
      </div>
      <div class="flex flex-col px-4 py-2 rounded-xl bg-[#292a38]/50 border border-[#292a38] min-w-[120px]">
        <span class="text-[#9e9fb7] text-xs font-semibold uppercase tracking-wider">IV Rank</span>
        <span class="text-[#4850e5] text-2xl font-bold font-mono"><%= avgIV > 0 ? formatPct(avgIV * 100) : '18.5%' %></span>
      </div>
      <div class="flex flex-col px-4 py-2 rounded-xl bg-[#292a38]/50 border border-[#292a38] min-w-[120px]">
        <span class="text-[#9e9fb7] text-xs font-semibold uppercase tracking-wider">Volume</span>
        <span class="text-white text-2xl font-bold font-mono"><%= totalVolume > 0 ? formatVol(totalVolume) : '42.8M' %></span>
      </div>
    </div>
  </div>

  <!-- Expiration Tabs & Filters -->
  <div class="flex flex-col gap-4">
    <div class="flex flex-col md:flex-row justify-between items-center border-b border-[#292a38] gap-4">
      <div class="flex overflow-x-auto w-full md:w-auto no-scrollbar gap-8">
        <% if (expirations.length > 0) { %>
          <% expirations.slice(0, 5).forEach((exp, idx) => {
            const expDate = new Date(exp);
            const now = new Date();
            const daysToExp = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
            const monthStr = expDate.toLocaleString('en-US', { month: 'short' });
            const dayStr = expDate.getDate();
            const isWeekly = expDate.getDay() === 5;
          %>
          <a href="/options-chain?symbol=<%= symbol %>&expiration=<%= exp %>" class="group flex flex-col items-center justify-center border-b-[3px] <%= idx === 0 ? 'border-b-[#4850e5] text-white' : 'border-b-transparent text-[#9e9fb7] hover:text-white' %> pb-3 pt-2 min-w-[80px] transition-colors">
            <span class="text-sm font-bold tracking-[0.015em]"><%= monthStr %> <%= dayStr %> (<%= isWeekly ? 'W' : 'M' %>)</span>
            <span class="text-[10px] <%= idx === 0 ? 'text-[#4850e5] bg-[#4850e5]/10' : 'text-[#9e9fb7] bg-[#292a38]' %> px-1.5 rounded mt-1"><%= daysToExp %>d</span>
          </a>
          <% }); %>
        <% } else { %>
          <!-- Demo expirations -->
          <button class="group flex flex-col items-center justify-center border-b-[3px] border-b-[#4850e5] text-white pb-3 pt-2 min-w-[80px]">
            <span class="text-sm font-bold tracking-[0.015em]">Oct 20 (W)</span>
            <span class="text-[10px] text-[#4850e5] bg-[#4850e5]/10 px-1.5 rounded mt-1">2d</span>
          </button>
          <button class="group flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#9e9fb7] hover:text-white pb-3 pt-2 min-w-[80px] transition-colors">
            <span class="text-sm font-bold tracking-[0.015em]">Oct 27 (W)</span>
            <span class="text-[10px] text-[#9e9fb7] bg-[#292a38] px-1.5 rounded mt-1">9d</span>
          </button>
          <button class="group flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#9e9fb7] hover:text-white pb-3 pt-2 min-w-[80px] transition-colors">
            <span class="text-sm font-bold tracking-[0.015em]">Nov 03 (W)</span>
            <span class="text-[10px] text-[#9e9fb7] bg-[#292a38] px-1.5 rounded mt-1">16d</span>
          </button>
          <button class="group flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#9e9fb7] hover:text-white pb-3 pt-2 min-w-[80px] transition-colors">
            <span class="text-sm font-bold tracking-[0.015em]">Nov 17 (M)</span>
            <span class="text-[10px] text-[#9e9fb7] bg-[#292a38] px-1.5 rounded mt-1">30d</span>
          </button>
          <button class="group flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#9e9fb7] hover:text-white pb-3 pt-2 min-w-[80px] transition-colors">
            <span class="text-sm font-bold tracking-[0.015em]">Dec 15 (M)</span>
            <span class="text-[10px] text-[#9e9fb7] bg-[#292a38] px-1.5 rounded mt-1">58d</span>
          </button>
        <% } %>
      </div>

      <div class="flex items-center gap-3 pb-2 w-full md:w-auto overflow-x-auto">
        <div class="flex items-center bg-[#292a38] rounded-lg p-1 border border-[#292a38]">
          <button class="px-3 py-1.5 rounded-md text-xs font-bold bg-[#3d3e52] text-white shadow-sm">All</button>
          <button class="px-3 py-1.5 rounded-md text-xs font-bold text-[#9e9fb7] hover:text-white">ITM</button>
          <button class="px-3 py-1.5 rounded-md text-xs font-bold text-[#9e9fb7] hover:text-white">OTM</button>
        </div>
        <button class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-[#292a38] text-[#9e9fb7] hover:text-white text-xs font-bold whitespace-nowrap">
          <span>Strikes: 10</span>
          <span class="material-symbols-outlined text-[16px]">expand_more</span>
        </button>
        <button class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-[#292a38] text-[#9e9fb7] hover:text-white text-xs font-bold whitespace-nowrap">
          <span>Layout: Standard</span>
          <span class="material-symbols-outlined text-[16px]">view_column</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Options Chain Table -->
  <div class="flex-1 min-h-[500px] w-full rounded-xl border border-[#292a38] bg-[#14151a] overflow-hidden flex flex-col shadow-2xl">
    <!-- Table Header -->
    <div class="grid grid-cols-[1fr_auto_1fr] bg-[#1e1f29] border-b border-[#292a38] sticky top-0 z-10 text-xs font-bold text-[#9e9fb7] uppercase tracking-wider">
      <!-- Calls Header -->
      <div class="grid grid-cols-6 divide-x divide-[#292a38]/50">
        <div class="py-3 px-2 text-center hidden lg:block">Delta</div>
        <div class="py-3 px-2 text-center hidden md:block">IV</div>
        <div class="py-3 px-2 text-center hidden sm:block">Vol</div>
        <div class="py-3 px-2 text-center hidden sm:block">Open Int</div>
        <div class="py-3 px-2 text-center text-white bg-[#292a38]/30">Bid</div>
        <div class="py-3 px-2 text-center text-white bg-[#292a38]/30">Ask</div>
      </div>
      <!-- Strike Header -->
      <div class="py-3 px-6 text-center text-white bg-[#4850e5]/20 border-x border-[#292a38] min-w-[100px]">
        Strike
      </div>
      <!-- Puts Header -->
      <div class="grid grid-cols-6 divide-x divide-[#292a38]/50">
        <div class="py-3 px-2 text-center text-white bg-[#292a38]/30">Bid</div>
        <div class="py-3 px-2 text-center text-white bg-[#292a38]/30">Ask</div>
        <div class="py-3 px-2 text-center hidden sm:block">Open Int</div>
        <div class="py-3 px-2 text-center hidden sm:block">Vol</div>
        <div class="py-3 px-2 text-center hidden md:block">IV</div>
        <div class="py-3 px-2 text-center hidden lg:block">Delta</div>
      </div>
    </div>

    <!-- Table Body -->
    <div class="overflow-y-auto flex-1">
      <% if (displayStrikes.length > 0) { %>
        <% displayStrikes.forEach((strike, idx) => {
          const row = strikeMap[strike] || {};
          const call = row.call || {};
          const put = row.put || {};
          const isITMCall = strike < demoPrice;
          const isITMPut = strike > demoPrice;
          const isATM = Math.abs(strike - demoPrice) < demoPrice * 0.02;
        %>
        <div class="group grid grid-cols-[1fr_auto_1fr] <%= isATM ? 'bg-[#292a38] border-y border-[#4850e5]/30' : 'hover:bg-[#292a38]/20 border-b border-[#292a38]/50' %> text-sm font-mono transition-colors cursor-pointer relative">
          <% if (isATM) { %>
          <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[1px] bg-[#4850e5]/20 pointer-events-none z-0"></div>
          <% } %>

          <!-- Calls -->
          <div class="grid grid-cols-6 divide-x divide-[#292a38]/30 <%= isITMCall && !isATM ? 'bg-[#4850e5]/5 group-hover:bg-[#4850e5]/10' : '' %> z-10 transition-colors">
            <div class="py-2.5 px-2 text-right <%= isATM ? 'text-white font-bold' : 'text-[#9e9fb7]' %> hidden lg:block"><%= call.delta ? formatDelta(call.delta) : '-' %></div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden md:block"><%= call.impliedVolatility ? formatIV(call.impliedVolatility) : '-' %></div>
            <div class="py-2.5 px-2 text-right text-white hidden sm:block"><%= formatVol(call.volume) %></div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden sm:block"><%= formatVol(call.openInterest) %></div>
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-green-500/20 hover:bg-green-500/30' : 'bg-green-500/10 hover:bg-green-500/20' %> text-green-400 font-bold text-xs py-1"><%= call.bid ? call.bid.toFixed(2) : '-' %></button>
            </div>
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-red-500/20 hover:bg-red-500/30' : 'bg-red-500/10 hover:bg-red-500/20' %> text-red-400 font-bold text-xs py-1"><%= call.ask ? call.ask.toFixed(2) : '-' %></button>
            </div>
          </div>

          <!-- Strike -->
          <div class="py-2.5 px-4 text-center <%= isATM ? 'text-[#4850e5] font-black shadow-[0_0_15px_rgba(72,80,229,0.1)]' : 'text-white font-bold' %> bg-[#1e1f29] border-x <%= isATM ? 'border-[#4850e5]/30' : 'border-[#292a38]' %> min-w-[100px] z-10">
            <%= strike.toFixed(2) %>
          </div>

          <!-- Puts -->
          <div class="grid grid-cols-6 divide-x divide-[#292a38]/30 <%= isITMPut && !isATM ? 'bg-[#4850e5]/5 group-hover:bg-[#4850e5]/10' : '' %> z-10 transition-colors">
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-green-500/20 hover:bg-green-500/30' : 'bg-green-500/10 hover:bg-green-500/20' %> text-green-400 font-bold text-xs py-1"><%= put.bid ? put.bid.toFixed(2) : '-' %></button>
            </div>
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-red-500/20 hover:bg-red-500/30' : 'bg-red-500/10 hover:bg-red-500/20' %> text-red-400 font-bold text-xs py-1"><%= put.ask ? put.ask.toFixed(2) : '-' %></button>
            </div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden sm:block"><%= formatVol(put.openInterest) %></div>
            <div class="py-2.5 px-2 text-right text-white hidden sm:block"><%= formatVol(put.volume) %></div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden md:block"><%= put.impliedVolatility ? formatIV(put.impliedVolatility) : '-' %></div>
            <div class="py-2.5 px-2 text-right <%= isATM ? 'text-white font-bold' : 'text-[#9e9fb7]' %> hidden lg:block"><%= put.delta ? formatDelta(put.delta) : '-' %></div>
          </div>
        </div>
        <% }); %>
      <% } else { %>
        <!-- Demo Data Rows -->
        <% const demoStrikes = [430, 431, 432, 433, 434, 435, 436]; %>
        <% const demoData = [
          { strike: 430, callDelta: 0.65, callIV: '19.2%', callVol: '1.2K', callOI: '5.4K', callBid: 2.45, callAsk: 2.48, putBid: 0.85, putAsk: 0.88, putOI: '12K', putVol: '854', putIV: '18.5%', putDelta: -0.32 },
          { strike: 431, callDelta: 0.58, callIV: '18.9%', callVol: '3.5K', callOI: '8.2K', callBid: 1.85, callAsk: 1.88, putBid: 1.12, putAsk: 1.15, putOI: '9.4K', putVol: '1.1K', putIV: '18.1%', putDelta: -0.41 },
          { strike: 432, callDelta: 0.51, callIV: '18.5%', callVol: '15.2K', callOI: '22K', callBid: 1.35, callAsk: 1.38, putBid: 1.42, putAsk: 1.45, putOI: '18K', putVol: '9.5K', putIV: '18.5%', putDelta: -0.49, atm: true },
          { strike: 433, callDelta: 0.42, callIV: '18.2%', callVol: '8.1K', callOI: '15.4K', callBid: 0.92, callAsk: 0.95, putBid: 1.95, putAsk: 1.98, putOI: '4.2K', putVol: '2.1K', putIV: '19.1%', putDelta: -0.58 },
          { strike: 434, callDelta: 0.31, callIV: '17.8%', callVol: '4.3K', callOI: '9.8K', callBid: 0.55, callAsk: 0.58, putBid: 2.65, putAsk: 2.70, putOI: '3.1K', putVol: '1.5K', putIV: '19.5%', putDelta: -0.69 },
          { strike: 435, callDelta: 0.22, callIV: '17.5%', callVol: '2.8K', callOI: '14.1K', callBid: 0.32, callAsk: 0.34, putBid: 3.45, putAsk: 3.50, putOI: '1.2K', putVol: '650', putIV: '20.1%', putDelta: -0.78 },
          { strike: 436, callDelta: 0.15, callIV: '17.2%', callVol: '1.1K', callOI: '8.4K', callBid: 0.18, callAsk: 0.20, putBid: 4.30, putAsk: 4.38, putOI: '950', putVol: '320', putIV: '20.8%', putDelta: -0.85 }
        ]; %>
        <% demoData.forEach(row => {
          const isITMCall = row.strike < 432;
          const isITMPut = row.strike > 432;
          const isATM = row.atm;
        %>
        <div class="group grid grid-cols-[1fr_auto_1fr] <%= isATM ? 'bg-[#292a38] border-y border-[#4850e5]/30' : 'hover:bg-[#292a38]/20 border-b border-[#292a38]/50' %> text-sm font-mono transition-colors cursor-pointer relative">
          <% if (isATM) { %>
          <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[1px] bg-[#4850e5]/20 pointer-events-none z-0"></div>
          <% } %>

          <!-- Calls -->
          <div class="grid grid-cols-6 divide-x divide-[#292a38]/30 <%= isITMCall && !isATM ? 'bg-[#4850e5]/5 group-hover:bg-[#4850e5]/10' : '' %> z-10 transition-colors">
            <div class="py-2.5 px-2 text-right <%= isATM ? 'text-white font-bold' : 'text-[#9e9fb7]' %> hidden lg:block"><%= row.callDelta %></div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden md:block"><%= row.callIV %></div>
            <div class="py-2.5 px-2 text-right text-white hidden sm:block"><%= row.callVol %></div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden sm:block"><%= row.callOI %></div>
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-green-500/20 hover:bg-green-500/30' : 'bg-green-500/10 hover:bg-green-500/20' %> text-green-400 font-bold text-xs py-1"><%= row.callBid.toFixed(2) %></button>
            </div>
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-red-500/20 hover:bg-red-500/30' : 'bg-red-500/10 hover:bg-red-500/20' %> text-red-400 font-bold text-xs py-1"><%= row.callAsk.toFixed(2) %></button>
            </div>
          </div>

          <!-- Strike -->
          <div class="py-2.5 px-4 text-center <%= isATM ? 'text-[#4850e5] font-black shadow-[0_0_15px_rgba(72,80,229,0.1)]' : 'text-white font-bold' %> bg-[#1e1f29] border-x <%= isATM ? 'border-[#4850e5]/30' : 'border-[#292a38]' %> min-w-[100px] z-10">
            <%= row.strike.toFixed(2) %>
          </div>

          <!-- Puts -->
          <div class="grid grid-cols-6 divide-x divide-[#292a38]/30 <%= isITMPut && !isATM ? 'bg-[#4850e5]/5 group-hover:bg-[#4850e5]/10' : '' %> z-10 transition-colors">
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-green-500/20 hover:bg-green-500/30' : 'bg-green-500/10 hover:bg-green-500/20' %> text-green-400 font-bold text-xs py-1"><%= row.putBid.toFixed(2) %></button>
            </div>
            <div class="py-2 px-1 text-center">
              <button class="w-full h-full rounded <%= isATM ? 'bg-red-500/20 hover:bg-red-500/30' : 'bg-red-500/10 hover:bg-red-500/20' %> text-red-400 font-bold text-xs py-1"><%= row.putAsk.toFixed(2) %></button>
            </div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden sm:block"><%= row.putOI %></div>
            <div class="py-2.5 px-2 text-right text-white hidden sm:block"><%= row.putVol %></div>
            <div class="py-2.5 px-2 text-right text-[#9e9fb7] hidden md:block"><%= row.putIV %></div>
            <div class="py-2.5 px-2 text-right <%= isATM ? 'text-white font-bold' : 'text-[#9e9fb7]' %> hidden lg:block"><%= row.putDelta %></div>
          </div>
        </div>
        <% }); %>
      <% } %>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Put/Call Ratio -->
    <div class="bg-[#1a1b26] rounded-xl border border-[#292a38] p-5">
      <h3 class="text-white text-lg font-bold mb-4">Volume Analysis</h3>
      <div class="space-y-4">
        <div>
          <div class="flex justify-between text-sm mb-1">
            <span class="text-green-400">Call Volume</span>
            <span class="text-green-400 font-bold font-mono"><%= totalCallVolume > 0 ? formatVol(totalCallVolume) : '24.5M' %></span>
          </div>
          <div class="h-2 bg-[#292a38] rounded-full overflow-hidden">
            <div class="h-2 bg-green-500 rounded-full" style="width: <%= totalVolume > 0 ? (totalCallVolume / totalVolume * 100) : 58 %>%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-sm mb-1">
            <span class="text-red-400">Put Volume</span>
            <span class="text-red-400 font-bold font-mono"><%= totalPutVolume > 0 ? formatVol(totalPutVolume) : '18.3M' %></span>
          </div>
          <div class="h-2 bg-[#292a38] rounded-full overflow-hidden">
            <div class="h-2 bg-red-500 rounded-full" style="width: <%= totalVolume > 0 ? (totalPutVolume / totalVolume * 100) : 42 %>%"></div>
          </div>
        </div>
        <div class="pt-3 border-t border-[#292a38]">
          <div class="flex justify-between items-center">
            <span class="text-[#9e9fb7] text-sm">Put/Call Ratio</span>
            <span class="text-xl font-bold font-mono <%= putCallRatio > 1 ? 'text-red-400' : 'text-green-400' %>"><%= putCallRatio > 0 ? putCallRatio.toFixed(2) : '0.75' %></span>
          </div>
          <p class="text-[#9e9fb7] text-xs mt-1"><%= putCallRatio > 1 ? 'Bearish sentiment' : 'Bullish sentiment' %></p>
        </div>
      </div>
    </div>

    <!-- Quick Strategies -->
    <div class="bg-[#1a1b26] rounded-xl border border-[#292a38] p-5">
      <h3 class="text-white text-lg font-bold mb-4">Quick Strategies</h3>
      <div class="grid grid-cols-2 gap-2">
        <a href="/options-greeks?symbol=<%= symbol || 'SPY' %>&strategy=long_call" class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-green-500/10 hover:bg-green-500/20 border border-green-500/30 text-green-400 font-semibold text-sm transition-colors">
          <span class="material-symbols-outlined text-[18px]">trending_up</span>
          Long Call
        </a>
        <a href="/options-greeks?symbol=<%= symbol || 'SPY' %>&strategy=long_put" class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 font-semibold text-sm transition-colors">
          <span class="material-symbols-outlined text-[18px]">trending_down</span>
          Long Put
        </a>
        <a href="/straddles?symbol=<%= symbol || 'SPY' %>" class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-[#4850e5]/10 hover:bg-[#4850e5]/20 border border-[#4850e5]/30 text-[#4850e5] font-semibold text-sm transition-colors">
          <span class="material-symbols-outlined text-[18px]">swap_vert</span>
          Straddle
        </a>
        <a href="/iv-surface?symbol=<%= symbol || 'SPY' %>" class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-[#292a38] hover:bg-[#3d3e52] border border-[#292a38] text-white font-semibold text-sm transition-colors">
          <span class="material-symbols-outlined text-[18px]">layers</span>
          IV Surface
        </a>
      </div>
    </div>

    <!-- Implied Move -->
    <div class="bg-[#1a1b26] rounded-xl border border-[#292a38] p-5">
      <h3 class="text-white text-lg font-bold mb-4">Expected Move</h3>
      <div class="text-center">
        <p class="text-[#9e9fb7] text-sm mb-1">Based on ATM Straddle</p>
        <p class="text-4xl font-black font-mono text-[#4850e5]">Â±2.8%</p>
      </div>
      <div class="grid grid-cols-3 gap-2 mt-4 text-center">
        <div>
          <p class="text-[#9e9fb7] text-xs">Low</p>
          <p class="text-red-400 font-bold font-mono">$420.05</p>
        </div>
        <div>
          <p class="text-[#9e9fb7] text-xs">Current</p>
          <p class="text-white font-bold font-mono">$432.15</p>
        </div>
        <div>
          <p class="text-[#9e9fb7] text-xs">High</p>
          <p class="text-green-400 font-bold font-mono">$444.25</p>
        </div>
      </div>
      <div class="mt-4 h-2 bg-[#292a38] rounded-full overflow-hidden relative">
        <div class="absolute inset-0 bg-gradient-to-r from-red-500 via-[#4850e5] to-green-500 opacity-50"></div>
        <div class="absolute top-0 bottom-0 w-0.5 bg-white left-1/2 -translate-x-1/2"></div>
      </div>
    </div>
  </div>
</main>

<%- include('../partials/footer') %>
