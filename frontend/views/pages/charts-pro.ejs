<%
// Safe defaults
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safePageTitle = typeof pageTitle !== 'undefined' ? pageTitle : 'Professional Charts';
%>
<%- include('../partials/header', { pageTitle: safePageTitle }) %>

<!-- Professional Charts CSS -->
<link rel="stylesheet" href="/css/professional-charts.css">

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Professional Trading Platform Layout -->
<div class="pro-charts-container fade-in">

  <!-- Top Toolbar -->
  <div class="pro-header slide-in">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center shadow-lg">
            <i class="fas fa-chart-line text-slate-900 text-lg"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gradient" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Professional Charts</h1>
            <p class="text-xs text-slate-400 mt-0.5">Real-time market analysis platform</p>
          </div>
        </div>

        <div class="status-indicator">
          <span class="pulse-dot"></span>
          <span id="connectionStatus">Live Market Data</span>
        </div>

        <div class="text-xs text-slate-400">
          <i class="far fa-clock mr-1"></i>
          <span id="lastUpdate">Updated just now</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <!-- Quick Symbol Search -->
        <div class="relative">
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
            <input
              type="text"
              id="quickSearch"
              placeholder="Search symbol (Ctrl+F)"
              class="pl-10 pr-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 transition-all w-56"
              autocomplete="off"
            />
          </div>
          <div id="searchResults" class="absolute top-full left-0 right-0 mt-2 glass-card max-h-64 overflow-y-auto z-50 hidden"></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-1">
          <button onclick="togglePanel('watchlist')" class="btn btn-ghost btn-icon tooltip" data-tooltip="Toggle Watchlist (Ctrl+W)">
            <i class="fas fa-list"></i>
          </button>

          <button onclick="togglePanel('news')" class="btn btn-ghost btn-icon tooltip" data-tooltip="Toggle News (Ctrl+N)">
            <i class="fas fa-newspaper"></i>
          </button>

          <button onclick="toggleDrawingMode()" class="btn btn-ghost btn-icon tooltip" data-tooltip="Drawing Tools (Ctrl+D)">
            <i class="fas fa-pen"></i>
          </button>

          <button onclick="createAlert()" class="btn btn-ghost btn-icon tooltip" data-tooltip="Create Alert">
            <i class="fas fa-bell"></i>
          </button>

          <button onclick="exportChart()" class="btn btn-primary btn-icon tooltip" data-tooltip="Export Chart (Ctrl+E)">
            <i class="fas fa-download"></i>
          </button>

          <button onclick="openSettings()" class="btn btn-ghost btn-icon tooltip" data-tooltip="Settings">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Layout Container -->
  <div class="flex gap-4">

    <!-- Main Chart Panel (Left/Center) -->
    <div id="mainChartPanel" class="flex-1 transition-all duration-300">

      <!-- Chart Controls Bar -->
      <div class="bloomberg-card p-4 mb-4">
        <div class="flex flex-wrap items-center justify-between gap-4">

          <!-- Symbol Info -->
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-purple-500 flex items-center justify-center">
              <span id="symbolIcon" class="text-white font-bold text-lg"><%= symbol %></span>
            </div>
            <div>
              <h2 id="companyName" class="text-xl font-bold text-white"><%= symbol %></h2>
              <div class="flex items-center gap-2 text-sm">
                <span class="text-slate-400">NASDAQ</span>
                <span class="text-slate-600">â€¢</span>
                <span id="currentPrice" class="font-mono text-white">$0.00</span>
                <span id="priceChange" class="font-mono text-emerald-400">+$0.00 (+0.00%)</span>
              </div>
            </div>
          </div>

          <!-- Timeframe Selector -->
          <div class="flex gap-1">
            <button onclick="setTimeframe('1D')" class="timeframe-btn" data-tf="1D">1D</button>
            <button onclick="setTimeframe('1W')" class="timeframe-btn" data-tf="1W">1W</button>
            <button onclick="setTimeframe('1M')" class="timeframe-btn active" data-tf="1M">1M</button>
            <button onclick="setTimeframe('3M')" class="timeframe-btn" data-tf="3M">3M</button>
            <button onclick="setTimeframe('6M')" class="timeframe-btn" data-tf="6M">6M</button>
            <button onclick="setTimeframe('1Y')" class="timeframe-btn" data-tf="1Y">1Y</button>
            <button onclick="setTimeframe('5Y')" class="timeframe-btn" data-tf="5Y">5Y</button>
          </div>

          <!-- Chart Type -->
          <div class="flex gap-1">
            <button onclick="setChartType('candlestick')" class="chart-type-btn active" data-type="candlestick" title="Candlestick">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><rect x="8" y="4" width="2" height="16"></rect><rect x="6" y="8" width="6" height="6"></rect></svg>
            </button>
            <button onclick="setChartType('line')" class="chart-type-btn" data-type="line" title="Line">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4"></path></svg>
            </button>
            <button onclick="setChartType('area')" class="chart-type-btn" data-type="area" title="Area">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2v-7"></path></svg>
            </button>
            <button onclick="setChartType('heikinashi')" class="chart-type-btn" data-type="heikinashi" title="Heikin-Ashi">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><rect x="8" y="6" width="2" height="12"></rect><rect x="6" y="9" width="6" height="4"></rect></svg>
            </button>
          </div>

          <!-- Compare Button -->
          <button onclick="toggleCompare()" class="bloomberg-btn bloomberg-btn-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Compare
          </button>
        </div>

        <!-- Indicator Toggles -->
        <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-slate-700">
          <div class="text-xs text-slate-400 flex items-center mr-2">Indicators:</div>
          <button onclick="toggleIndicator('sma')" class="indicator-btn" data-ind="sma">SMA (20)</button>
          <button onclick="toggleIndicator('ema')" class="indicator-btn" data-ind="ema">EMA (20)</button>
          <button onclick="toggleIndicator('bollinger')" class="indicator-btn" data-ind="bollinger">Bollinger</button>
          <button onclick="toggleIndicator('vwap')" class="indicator-btn" data-ind="vwap">VWAP</button>
          <button onclick="toggleIndicator('sar')" class="indicator-btn" data-ind="sar">SAR</button>
          <button onclick="toggleIndicator('ichimoku')" class="indicator-btn" data-ind="ichimoku">Ichimoku</button>

          <div class="text-xs text-slate-400 flex items-center ml-4 mr-2">Oscillators:</div>
          <button onclick="toggleIndicator('rsi')" class="indicator-btn" data-ind="rsi">RSI</button>
          <button onclick="toggleIndicator('macd')" class="indicator-btn" data-ind="macd">MACD</button>
          <button onclick="toggleIndicator('stochastic')" class="indicator-btn" data-ind="stochastic">Stochastic</button>
          <button onclick="toggleIndicator('atr')" class="indicator-btn" data-ind="atr">ATR</button>
          <button onclick="toggleIndicator('adx')" class="indicator-btn" data-ind="adx">ADX</button>
          <button onclick="toggleIndicator('cci')" class="indicator-btn" data-ind="cci">CCI</button>
          <button onclick="toggleIndicator('williams')" class="indicator-btn" data-ind="williams">Williams %R</button>
          <button onclick="toggleIndicator('mfi')" class="indicator-btn" data-ind="mfi">MFI</button>
          <button onclick="toggleIndicator('obv')" class="indicator-btn" data-ind="obv">OBV</button>
        </div>
      </div>

      <!-- Drawing Tools (Hidden by default) -->
      <div id="drawingToolbar" class="bloomberg-card p-4 mb-4 hidden">
        <div class="flex items-center gap-2">
          <div class="text-xs text-amber-400 font-semibold mr-2">Drawing Tools:</div>
          <button onclick="selectTool('trendline')" class="tool-btn" data-tool="trendline" title="Trendline (T)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="4" y1="20" x2="20" y2="4" stroke-width="2"></line></svg>
            Trendline
          </button>
          <button onclick="selectTool('horizontal')" class="tool-btn" data-tool="horizontal" title="Horizontal Line (H)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke-width="2"></line></svg>
            Horizontal
          </button>
          <button onclick="selectTool('fibonacci')" class="tool-btn" data-tool="fibonacci" title="Fibonacci (F)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4h4v16H4V4zM10 8h4v12h-4V8zM16 12h4v8h-4v-8z" stroke-width="2"></path></svg>
            Fibonacci
          </button>
          <button onclick="selectTool('rectangle')" class="tool-btn" data-tool="rectangle" title="Rectangle (R)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="12" stroke-width="2"></rect></svg>
            Rectangle
          </button>
          <button onclick="selectTool('text')" class="tool-btn" data-tool="text" title="Text (X)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg>
            Text
          </button>
          <div class="border-l border-slate-600 h-6 mx-2"></div>
          <button onclick="deleteSelected()" class="tool-btn text-red-400" title="Delete (Del)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            Delete
          </button>
          <button onclick="clearAllDrawings()" class="tool-btn text-red-400" title="Clear All">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            Clear All
          </button>
        </div>
      </div>

      <!-- Main Chart -->
      <div class="bloomberg-card p-5 mb-4">
        <div class="h-[500px] relative">
          <canvas id="mainChart"></canvas>
        </div>
      </div>

      <!-- Secondary Charts (Indicators) -->
      <div id="secondaryCharts" class="space-y-4">
        <!-- Volume Chart -->
        <div class="bloomberg-card p-5">
          <h3 class="text-sm font-semibold text-slate-400 mb-3">Volume</h3>
          <div class="h-32">
            <canvas id="volumeChart"></canvas>
          </div>
        </div>
      </div>

    </div>

    <!-- Watchlist Panel (Right) -->
    <div id="watchlistPanel" class="w-80 transition-all duration-300">

      <!-- Watchlist Card -->
      <div class="bloomberg-card p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-white">Watchlist</h3>
          <button onclick="addToWatchlist()" class="text-amber-400 hover:text-amber-300 text-xs">+ Add</button>
        </div>

        <div class="space-y-1 max-h-[400px] overflow-y-auto" id="watchlistItems">
          <!-- Watchlist items will be dynamically added -->
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="bloomberg-card p-4 mb-4">
        <h3 class="text-sm font-semibold text-white mb-3">Key Metrics</h3>
        <div class="space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">Market Cap</span>
            <span id="marketCap" class="text-white font-mono">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">P/E Ratio</span>
            <span id="peRatio" class="text-white font-mono">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">52W Range</span>
            <span id="range52w" class="text-white font-mono text-xs">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Avg Volume</span>
            <span id="avgVolume" class="text-white font-mono text-xs">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Beta</span>
            <span id="beta" class="text-white font-mono">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Div Yield</span>
            <span id="divYield" class="text-white font-mono">-</span>
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="bloomberg-card p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-white">Active Alerts</h3>
          <span class="text-xs text-slate-400" id="alertCount">0 alerts</span>
        </div>
        <div id="alertsList" class="space-y-2 max-h-48 overflow-y-auto">
          <div class="text-center text-slate-500 text-xs py-4">
            No active alerts
          </div>
        </div>
      </div>

    </div>

  </div>

  <!-- News Panel (Bottom, Collapsible) -->
  <div id="newsPanel" class="mt-4 hidden">
    <div class="bloomberg-card p-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">Market News & Analysis</h3>
        <button onclick="togglePanel('news')" class="text-slate-400 hover:text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="newsFeed">
        <!-- News items will be dynamically added -->
      </div>
    </div>
  </div>

</div>

<style>
/* Professional Trading Platform Styles */
.timeframe-btn, .chart-type-btn, .indicator-btn, .tool-btn {
  @apply px-3 py-1.5 text-xs font-medium rounded-lg transition-all;
  @apply bg-slate-800 text-slate-300 border border-slate-700;
  @apply hover:bg-slate-700 hover:border-slate-600;
}

.timeframe-btn.active, .chart-type-btn.active, .indicator-btn.active, .tool-btn.active {
  @apply bg-amber-500 text-slate-900 border-amber-400;
  @apply font-semibold;
}

.watchlist-item {
  @apply p-3 rounded-lg bg-slate-800/50 border border-slate-700;
  @apply hover:bg-slate-800 hover:border-slate-600 cursor-pointer transition-all;
}

.watchlist-item.active {
  @apply border-amber-500 bg-slate-800;
}

.news-item {
  @apply p-4 rounded-lg bg-slate-800/50 border border-slate-700;
  @apply hover:bg-slate-800 hover:border-slate-600 cursor-pointer transition-all;
}

/* Custom Scrollbar */
#watchlistItems::-webkit-scrollbar,
#alertsList::-webkit-scrollbar,
#newsFeed::-webkit-scrollbar {
  width: 6px;
}

#watchlistItems::-webkit-scrollbar-track,
#alertsList::-webkit-scrollbar-track,
#newsFeed::-webkit-scrollbar-track {
  background: #1e293b;
}

#watchlistItems::-webkit-scrollbar-thumb,
#alertsList::-webkit-scrollbar-thumb,
#newsFeed::-webkit-scrollbar-thumb {
  background: #475569;
  border-radius: 3px;
}

#watchlistItems::-webkit-scrollbar-thumb:hover,
#alertsList::-webkit-scrollbar-thumb:hover,
#newsFeed::-webkit-scrollbar-thumb:hover {
  background: #64748b;
}

/* Loading Skeleton */
.skeleton {
  @apply animate-pulse bg-slate-700 rounded;
}

/* Toast Notifications */
.toast {
  @apply fixed bottom-4 right-4 bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-xl;
  @apply flex items-center gap-3 z-50;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast.success {
  @apply border-emerald-500;
}

.toast.error {
  @apply border-red-500;
}

.toast.warning {
  @apply border-amber-500;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<script>
// Professional Charts Application
const ProCharts = {
  // State
  currentSymbol: '<%= symbol %>',
  currentTimeframe: '1M',
  currentChartType: 'candlestick',
  mainChart: null,
  volumeChart: null,
  ws: null,
  indicators: {
    sma: false, ema: false, bollinger: false, vwap: false, sar: false, ichimoku: false,
    rsi: false, macd: false, stochastic: false, atr: false, adx: false, cci: false,
    williams: false, mfi: false, obv: false
  },
  historicalData: [],
  watchlist: ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'NVDA', 'META', 'AMZN'],
  alerts: [],
  drawings: [],
  drawingMode: false,
  selectedTool: null,

  // Initialize
  init() {
    console.log('[ProCharts] Initializing professional charts...');
    this.loadInitialData();
    this.initializeWebSocket();
    this.initializeWatchlist();
    this.setupKeyboardShortcuts();
    this.startLiveUpdates();
  },

  // Load initial data
  async loadInitialData() {
    await this.loadSymbol(this.currentSymbol, this.currentTimeframe);
  },

  // Load symbol data
  async loadSymbol(symbol, timeframe) {
    try {
      console.log(`[ProCharts] Loading ${symbol} - ${timeframe}`);

      // Fetch quote
      const quoteRes = await fetch(`/api/market/quote/${symbol}`, { credentials: 'include' });
      const quote = await quoteRes.json();

      if (quote) {
        this.updateQuoteDisplay(quote);
      }

      // Fetch historical data
      const days = this.getTimeframeDays(timeframe);
      const histRes = await fetch(`/api/market/history/${symbol}?days=${days}`, { credentials: 'include' });
      const histData = await histRes.json();

      if (histData && histData.data) {
        this.historicalData = histData.data;
        this.renderMainChart();
        this.renderVolumeChart();
      }

      // Fetch profile
      this.loadProfileData(symbol);

    } catch (error) {
      console.error('[ProCharts] Error loading symbol:', error);
      this.showToast('Failed to load symbol data', 'error');
    }
  },

  // Get days from timeframe
  getTimeframeDays(tf) {
    const map = { '1D': 1, '1W': 7, '1M': 30, '3M': 90, '6M': 180, '1Y': 365, '5Y': 1825 };
    return map[tf] || 30;
  },

  // Update quote display
  updateQuoteDisplay(quote) {
    document.getElementById('symbolIcon').textContent = quote.symbol.slice(0, 4);
    document.getElementById('companyName').textContent = quote.symbol;
    document.getElementById('currentPrice').textContent = '$' + quote.price.toFixed(2);

    const changeText = `${quote.change >= 0 ? '+' : ''}$${quote.change.toFixed(2)} (${quote.changePercent >= 0 ? '+' : ''}${quote.changePercent.toFixed(2)}%)`;
    const changeEl = document.getElementById('priceChange');
    changeEl.textContent = changeText;
    changeEl.className = `font-mono ${quote.change >= 0 ? 'text-emerald-400' : 'text-red-400'}`;

    document.getElementById('lastUpdate').textContent = 'Updated ' + new Date(quote.timestamp).toLocaleTimeString();
  },

  // Render main chart
  renderMainChart() {
    const ctx = document.getElementById('mainChart');
    if (!ctx) return;

    const context = ctx.getContext('2d');
    if (this.mainChart) {
      this.mainChart.destroy();
    }

    const labels = this.historicalData.map(d => new Date(d.date).toLocaleDateString());
    const datasets = this.getChartDatasets();

    this.mainChart = new Chart(context, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'top', labels: { color: '#e5e7eb' } },
          annotation: { annotations: this.drawings }
        },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#9ca3af' } },
          y: { position: 'right', grid: { color: '#334155' }, ticks: { color: '#9ca3af' } }
        }
      }
    });
  },

  // Get chart datasets based on chart type and indicators
  getChartDatasets() {
    const datasets = [];
    const data = this.historicalData;

    // Main price dataset
    if (this.currentChartType === 'candlestick') {
      datasets.push({
        label: 'Price',
        data: data.map(d => d.close),
        borderColor: '#0ea5e9',
        backgroundColor: data.map(d => d.close >= d.open ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
        borderWidth: 2,
        pointRadius: 0
      });
    } else if (this.currentChartType === 'line') {
      datasets.push({
        label: 'Price',
        data: data.map(d => d.close),
        borderColor: '#0ea5e9',
        borderWidth: 2,
        fill: false,
        pointRadius: 0,
        tension: 0.1
      });
    } else {
      datasets.push({
        label: 'Price',
        data: data.map(d => d.close),
        borderColor: '#0ea5e9',
        backgroundColor: 'rgba(14, 165, 233, 0.2)',
        borderWidth: 2,
        fill: true,
        pointRadius: 0,
        tension: 0.1
      });
    }

    // Add indicator datasets
    if (this.indicators.sma) {
      const sma = this.calculateSMA(data, 20);
      datasets.push({
        label: 'SMA (20)',
        data: sma,
        borderColor: '#f97316',
        borderWidth: 2,
        borderDash: [5, 5],
        fill: false,
        pointRadius: 0
      });
    }

    if (this.indicators.ema) {
      const ema = this.calculateEMA(data, 20);
      datasets.push({
        label: 'EMA (20)',
        data: ema,
        borderColor: '#a855f7',
        borderWidth: 2,
        fill: false,
        pointRadius: 0
      });
    }

    if (this.indicators.bollinger) {
      const bb = this.calculateBollinger(data, 20, 2);
      datasets.push(
        {
          label: 'BB Upper',
          data: bb.upper,
          borderColor: '#06b6d4',
          borderWidth: 1,
          borderDash: [2, 2],
          fill: false,
          pointRadius: 0
        },
        {
          label: 'BB Lower',
          data: bb.lower,
          borderColor: '#06b6d4',
          borderWidth: 1,
          borderDash: [2, 2],
          fill: false,
          pointRadius: 0
        }
      );
    }

    return datasets;
  },

  // Render volume chart
  renderVolumeChart() {
    const ctx = document.getElementById('volumeChart');
    if (!ctx) return;

    const context = ctx.getContext('2d');
    if (this.volumeChart) {
      this.volumeChart.destroy();
    }

    const labels = this.historicalData.map(d => new Date(d.date).toLocaleDateString());
    const volumes = this.historicalData.map(d => d.volume);
    const colors = this.historicalData.map(d => d.close >= d.open ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)');

    this.volumeChart = new Chart(context, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Volume',
          data: volumes,
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { display: false } },
          y: { position: 'right', grid: { color: '#334155' }, ticks: { color: '#9ca3af' } }
        }
      }
    });
  },

  // Technical indicator calculations
  calculateSMA(data, period) {
    return data.map((_, i, arr) => {
      if (i < period - 1) return null;
      const slice = arr.slice(i - period + 1, i + 1);
      return slice.reduce((sum, d) => sum + d.close, 0) / period;
    });
  },

  calculateEMA(data, period) {
    const k = 2 / (period + 1);
    const ema = [data[0].close];
    for (let i = 1; i < data.length; i++) {
      ema.push(data[i].close * k + ema[i - 1] * (1 - k));
    }
    return ema;
  },

  calculateBollinger(data, period, stdDev) {
    const sma = this.calculateSMA(data, period);
    const upper = [], lower = [];

    data.forEach((_, i, arr) => {
      if (i < period - 1) {
        upper.push(null);
        lower.push(null);
        return;
      }
      const slice = arr.slice(i - period + 1, i + 1);
      const mean = sma[i];
      const variance = slice.reduce((sum, d) => sum + Math.pow(d.close - mean, 2), 0) / period;
      const std = Math.sqrt(variance);
      upper.push(mean + stdDev * std);
      lower.push(mean - stdDev * std);
    });

    return { sma, upper, lower };
  },

  // Initialize WebSocket for real-time updates
  initializeWebSocket() {
    // WebSocket implementation would go here
    console.log('[ProCharts] WebSocket initialized (placeholder)');
  },

  // Initialize watchlist
  initializeWatchlist() {
    this.renderWatchlist();
  },

  // Render watchlist
  renderWatchlist() {
    const container = document.getElementById('watchlistItems');
    if (!container) return;

    container.innerHTML = this.watchlist.map(symbol => `
      <div class="watchlist-item ${symbol === this.currentSymbol ? 'active' : ''}" onclick="ProCharts.loadSymbol('${symbol}', ProCharts.currentTimeframe)">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="font-semibold text-white text-sm">${symbol}</div>
            <div class="text-xs text-slate-400">Loading...</div>
          </div>
          <div class="text-right">
            <div class="font-mono text-sm text-white skeleton w-16 h-4 ml-auto mb-1"></div>
            <div class="font-mono text-xs skeleton w-12 h-3 ml-auto"></div>
          </div>
        </div>
      </div>
    `).join('');

    // Load quotes for watchlist items
    this.updateWatchlistQuotes();
  },

  // Update watchlist quotes
  async updateWatchlistQuotes() {
    for (const symbol of this.watchlist) {
      try {
        const res = await fetch(`/api/market/quote/${symbol}`, { credentials: 'include' });
        const quote = await res.json();
        // Update watchlist item UI with quote data
      } catch (error) {
        console.error(`[ProCharts] Error fetching ${symbol}:`, error);
      }
    }
  },

  // Load profile data
  async loadProfileData(symbol) {
    try {
      const res = await fetch(`/api/market/profile/${symbol}`, { credentials: 'include' });
      const profile = await res.json();

      if (profile) {
        document.getElementById('marketCap').textContent = this.formatMarketCap(profile.marketCap);
        // Update other profile fields
      }
    } catch (error) {
      console.error('[ProCharts] Error loading profile:', error);
    }
  },

  // Format market cap
  formatMarketCap(value) {
    if (!value) return '-';
    if (value >= 1e12) return '$' + (value / 1e12).toFixed(2) + 'T';
    if (value >= 1e9) return '$' + (value / 1e9).toFixed(2) + 'B';
    if (value >= 1e6) return '$' + (value / 1e6).toFixed(2) + 'M';
    return '$' + value.toFixed(2);
  },

  // Setup keyboard shortcuts
  setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      const ctrl = e.ctrlKey || e.metaKey;

      if (ctrl && e.key === 'f') {
        e.preventDefault();
        document.getElementById('quickSearch').focus();
      } else if (ctrl && e.key === 'w') {
        e.preventDefault();
        togglePanel('watchlist');
      } else if (ctrl && e.key === 'n') {
        e.preventDefault();
        togglePanel('news');
      } else if (ctrl && e.key === 'd') {
        e.preventDefault();
        toggleDrawingMode();
      } else if (ctrl && e.key === 'e') {
        e.preventDefault();
        exportChart();
      }
    });
  },

  // Start live updates
  startLiveUpdates() {
    setInterval(() => {
      if (this.currentSymbol) {
        this.loadSymbol(this.currentSymbol, this.currentTimeframe);
      }
    }, 30000); // Update every 30 seconds
  },

  // Show toast notification
  showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <svg class="w-5 h-5 ${type === 'success' ? 'text-emerald-400' : type === 'error' ? 'text-red-400' : 'text-amber-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span class="text-white">${message}</span>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
};

// Global functions for UI interactions
function setTimeframe(tf) {
  ProCharts.currentTimeframe = tf;
  ProCharts.loadSymbol(ProCharts.currentSymbol, tf);
  document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`[data-tf="${tf}"]`).classList.add('active');
}

function setChartType(type) {
  ProCharts.currentChartType = type;
  ProCharts.renderMainChart();
  document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`[data-type="${type}"]`).classList.add('active');
}

function toggleIndicator(ind) {
  ProCharts.indicators[ind] = !ProCharts.indicators[ind];
  ProCharts.renderMainChart();
  document.querySelector(`[data-ind="${ind}"]`).classList.toggle('active');
}

function togglePanel(panel) {
  const panelEl = document.getElementById(panel + 'Panel');
  if (panelEl) {
    panelEl.classList.toggle('hidden');
  }
}

function toggleDrawingMode() {
  ProCharts.drawingMode = !ProCharts.drawingMode;
  document.getElementById('drawingToolbar').classList.toggle('hidden');
}

function toggleCompare() {
  ProCharts.showToast('Compare feature coming soon!', 'info');
}

function selectTool(tool) {
  ProCharts.selectedTool = tool;
  document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
}

function deleteSelected() {
  ProCharts.showToast('Delete tool activated', 'info');
}

function clearAllDrawings() {
  ProCharts.drawings = [];
  ProCharts.renderMainChart();
  ProCharts.showToast('All drawings cleared', 'success');
}

function createAlert() {
  ProCharts.showToast('Alert creation dialog coming soon!', 'info');
}

function exportChart() {
  ProCharts.showToast('Exporting chart...', 'info');
  // Export implementation
}

function openSettings() {
  ProCharts.showToast('Settings panel coming soon!', 'info');
}

function addToWatchlist() {
  const symbol = prompt('Enter symbol to add:');
  if (symbol) {
    ProCharts.watchlist.push(symbol.toUpperCase());
    ProCharts.renderWatchlist();
    ProCharts.showToast(`${symbol} added to watchlist`, 'success');
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  ProCharts.init();
});
</script>

<%- include('../partials/footer') %>
