<!-- Close main content wrapper from header -->
</div>

<!-- Mobile Bottom Navigation -->
<%- include('./mobile-bottom-nav') %>

<!-- Toast Container -->
<div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

<!-- PWA Install Prompt -->
<div id="installPrompt" class="fixed bottom-4 left-4 z-50 hidden">
  <div class="card p-4 flex items-center gap-4 shadow-xl border border-sky-500/30">
    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-purple-500 flex items-center justify-center">
      <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
    </div>
    <div>
      <p class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Install WealthPilot</p>
      <p class="text-sm <%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>">Add to home screen</p>
    </div>
    <button onclick="installPWA()" class="btn-primary btn-sm">Install</button>
    <button onclick="dismissInstall()" class="btn-ghost btn-sm">âœ•</button>
  </div>
</div>

<!-- WebSocket & Theme Scripts -->
<script src="/js/app.js"></script>
<script src="/js/megamenu.js"></script>
<script src="/js/toast.js"></script>
<script src="/js/skeleton-loader.js"></script>
<script src="/js/error-handler.js"></script>
<script src="/js/mobile.js"></script>
<script src="/js/push-notifications.js"></script>
<script src="/js/keyboard-shortcuts.js"></script>
<script src="/js/micro-animations.js"></script>
<script src="/js/ui-components.js"></script>
<script>
  // Initialize WebSocket connection
  const socket = io();

    <% if (typeof user !== 'undefined' && user) { %>
    socket.emit('authenticate', '<%= user.id %>');
    <% } %>

    // Listen for real-time updates
    socket.on('price:update', (data) => {
      console.log('ðŸ“Š Price update:', data);
      // Update any displayed prices
      data.forEach(update => {
        const el = document.querySelector(`[data-symbol="${update.symbol}"]`);
        if (el) {
          const price = parseFloat(update.price).toFixed(2);
          const priceEl = el.querySelector('.price');
          if (priceEl) priceEl.textContent = '$' + price;

          const changeEl = el.querySelector('.change');
          if (changeEl) {
            const change = parseFloat(update.change).toFixed(2);
            changeEl.textContent = (update.change >= 0 ? '+' : '') + change + '%';
            changeEl.className = 'change ' + (update.change >= 0 ? 'text-emerald-400' : 'text-red-400');
          }
        }
      });
    });

  socket.on('portfolio:update', (data) => {
    console.log('ðŸ“ˆ Portfolio update:', data);
    showToast('Portfolio updated', 'info');
  });

  socket.on('alert:new', (alert) => {
    console.log('ðŸ”” New alert:', alert);
    showToast(alert.title, alert.severity || 'info');
    updateAlertBadge();
  });

  socket.on('connect', () => {
    console.log('ðŸ”Œ Connected to server');
  });

  socket.on('disconnect', () => {
    console.log('ðŸ”Œ Disconnected from server');
  });

  // Theme toggle function
  function toggleTheme() {
    const current = document.documentElement.dataset.theme;
    const newTheme = current === 'dark' ? 'light' : 'dark';

    // Update icons immediately for better UX
    updateThemeIcons(newTheme);

    // Save preference to server
    fetch('/api/theme', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ theme: newTheme })
    }).then(() => {
      // Update localStorage
      localStorage.setItem('theme', newTheme);
      // Apply theme without reload for smooth transition
      document.documentElement.dataset.theme = newTheme;
      document.body.classList.toggle('light-theme', newTheme === 'light');
    }).catch(() => {
      // Fallback to reload if API fails
      location.reload();
    });
  }

  // Update theme icons visibility
  function updateThemeIcons(theme) {
    const sunIcon = document.getElementById('theme-sun');
    const moonIcon = document.getElementById('theme-moon');
    if (sunIcon && moonIcon) {
      if (theme === 'dark') {
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
      } else {
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
      }
    }
  }

  // Initialize theme icons on page load
  document.addEventListener('DOMContentLoaded', function() {
    const currentTheme = document.documentElement.dataset.theme || 'dark';
    updateThemeIcons(currentTheme);
  });

  // Update alert badge
  function updateAlertBadge() {
    const badge = document.getElementById('alertBadge');
    if (badge) {
      const count = parseInt(badge.textContent || '0') + 1;
      badge.textContent = count;
      badge.classList.remove('hidden');
    }
  }

  // PWA Service Worker Registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('âœ… Service Worker registered'))
        .catch(err => console.log('âŒ Service Worker failed:', err));
    });
  }

  // PWA Install Prompt
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Show install button after 5 seconds if not dismissed before
    if (!localStorage.getItem('pwaInstallDismissed')) {
      setTimeout(() => {
        document.getElementById('installPrompt')?.classList.remove('hidden');
      }, 5000);
    }
  });

  function installPWA() {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        if (choice.outcome === 'accepted') {
          showToast('App installed!', 'success');
        }
        deferredPrompt = null;
        document.getElementById('installPrompt')?.classList.add('hidden');
      });
    }
  }

  function dismissInstall() {
    document.getElementById('installPrompt')?.classList.add('hidden');
    localStorage.setItem('pwaInstallDismissed', 'true');
  }
</script>
</body>

</html>
