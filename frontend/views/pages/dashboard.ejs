<%- include('../partials/header', { pageTitle: 'Dashboard' }) %>
<%
  // Ensure all variables have defaults
  const safeHoldings = typeof holdings !== 'undefined' && holdings ? holdings : [];
  const safeWatchlist = typeof watchlist !== 'undefined' && watchlist ? watchlist : [];
  const safeAlerts = typeof alerts !== 'undefined' && alerts ? alerts : [];
  const safeTransactions = typeof transactions !== 'undefined' && transactions ? transactions : [];
  const safeSectors = typeof sectors !== 'undefined' && sectors ? sectors : [];
  const safeRisk = typeof risk !== 'undefined' && risk ? risk : { beta: 1.0, sharpe: 0, volatility: 0, maxDrawdown: 0 };
  const safeTotals = typeof totals !== 'undefined' && totals ? totals : { value: 0, gain: 0, cost: 0, dayChange: 0, ytdReturn: 0, income: 0, cash: 0, holdingsCount: 0 };
%>
<main class="p-4 lg:p-6">
  <div class="max-w-full mx-auto space-y-4">

    <!-- Bloomberg-Style Header Bar -->
    <div class="flex items-center justify-between bg-bloomberg-surface border border-bloomberg-border rounded-md px-4 py-3">
      <div class="flex items-center gap-6">
        <h1 class="text-lg font-semibold text-white">Portfolio Overview</h1>
        <div class="flex items-center gap-4 text-sm font-mono">
          <span class="<%= safeTotals.gain >= 0 ? 'text-emerald-400' : 'text-red-400' %> font-semibold">
            <%= safeTotals.gain >= 0 ? '+' : '' %><%= fmt.money(safeTotals.gain) %>
            (<%= safeTotals.cost > 0 ? (safeTotals.gain >= 0 ? '+' : '') + ((safeTotals.gain / safeTotals.cost) * 100).toFixed(2) + '%' : '0%' %>)
          </span>
          <span class="text-slate-500">Today</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span class="status-live" id="ws-status">CONNECTING</span>
        <span class="text-xs text-slate-500 font-mono">Last: <%= new Date().toLocaleTimeString() %></span>
        <button onclick="refreshPrices()" class="bloomberg-btn bloomberg-btn-ghost" id="refreshBtn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <!-- KPI Ticker Bar (Bloomberg Style) -->
    <div class="kpi-bar rounded-md overflow-hidden">
      <div class="kpi-item">
        <div class="kpi-label">Total Value</div>
        <div class="kpi-value"><%= fmt.money(safeTotals.value) %></div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Day P&L</div>
        <div class="kpi-value <%= safeTotals.dayChange >= 0 ? 'positive' : 'negative' %>">
          <%= safeTotals.dayChange >= 0 ? '+' : '' %><%= fmt.money(safeTotals.dayChange || 0) %>
        </div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Total P&L</div>
        <div class="kpi-value <%= safeTotals.gain >= 0 ? 'positive' : 'negative' %>">
          <%= safeTotals.gain >= 0 ? '+' : '' %><%= fmt.money(safeTotals.gain) %>
        </div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">YTD Return</div>
        <div class="kpi-value <%= safeTotals.ytdReturn >= 0 ? 'positive' : 'negative' %>">
          <%= safeTotals.ytdReturn >= 0 ? '+' : '' %><%= (safeTotals.ytdReturn || 0).toFixed(2) %>%
        </div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Div Yield</div>
        <div class="kpi-value"><%= safeTotals.value > 0 ? ((safeTotals.income / safeTotals.value) * 100).toFixed(2) : '0.00' %>%</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Holdings</div>
        <div class="kpi-value"><%= safeTotals.holdingsCount || safeHoldings.length %></div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Cash</div>
        <div class="kpi-value"><%= fmt.money(safeTotals.cash || 0) %></div>
      </div>
    </div>

    <!-- Portfolio Performance Chart -->
    <div class="bloomberg-card">
      <div class="bloomberg-card-header">
        <span class="bloomberg-card-title">Portfolio Performance</span>
        <div class="flex items-center gap-2">
          <button onclick="changeTimeframe('1D')" class="timeframe-btn active" data-timeframe="1D">1D</button>
          <button onclick="changeTimeframe('1W')" class="timeframe-btn" data-timeframe="1W">1W</button>
          <button onclick="changeTimeframe('1M')" class="timeframe-btn" data-timeframe="1M">1M</button>
          <button onclick="changeTimeframe('3M')" class="timeframe-btn" data-timeframe="3M">3M</button>
          <button onclick="changeTimeframe('1Y')" class="timeframe-btn" data-timeframe="1Y">1Y</button>
          <button onclick="changeTimeframe('ALL')" class="timeframe-btn" data-timeframe="ALL">ALL</button>
        </div>
      </div>
      <div class="bloomberg-card-body">
        <canvas id="performanceChart" height="80"></canvas>
      </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <!-- Total Return -->
      <div class="bloomberg-card">
        <div class="bloomberg-card-body">
          <div class="text-xs text-slate-500 uppercase mb-1">Total Return</div>
          <div class="text-2xl font-bold font-mono <%= safeTotals.gain >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
            <%= safeTotals.cost > 0 ? (safeTotals.gain >= 0 ? '+' : '') + ((safeTotals.gain / safeTotals.cost) * 100).toFixed(2) + '%' : '0.00%' %>
          </div>
          <div class="text-xs text-slate-500 mt-1">
            <%= safeTotals.gain >= 0 ? '+' : '' %><%= fmt.money(safeTotals.gain) %>
          </div>
        </div>
      </div>

      <!-- Annual Dividend Income -->
      <div class="bloomberg-card">
        <div class="bloomberg-card-body">
          <div class="text-xs text-slate-500 uppercase mb-1">Annual Dividends</div>
          <div class="text-2xl font-bold font-mono text-blue-400">
            <%= fmt.money(safeTotals.income || 0) %>
          </div>
          <div class="text-xs text-slate-500 mt-1">
            <%= safeTotals.value > 0 ? ((safeTotals.income / safeTotals.value) * 100).toFixed(2) : '0.00' %>% Yield
          </div>
        </div>
      </div>

      <!-- Cost Basis -->
      <div class="bloomberg-card">
        <div class="bloomberg-card-body">
          <div class="text-xs text-slate-500 uppercase mb-1">Cost Basis</div>
          <div class="text-2xl font-bold font-mono text-white">
            <%= fmt.money(safeTotals.cost) %>
          </div>
          <div class="text-xs text-slate-500 mt-1">
            Total Invested
          </div>
        </div>
      </div>

      <!-- Market Value -->
      <div class="bloomberg-card">
        <div class="bloomberg-card-body">
          <div class="text-xs text-slate-500 uppercase mb-1">Market Value</div>
          <div class="text-2xl font-bold font-mono text-white">
            <%= fmt.money(safeTotals.value) %>
          </div>
          <div class="text-xs text-slate-500 mt-1">
            Current Value
          </div>
        </div>
      </div>
    </div>

    <!-- Asset Allocation & Quick Actions -->
    <div class="grid grid-cols-12 gap-4">
      <!-- Asset Allocation -->
      <div class="col-span-12 md:col-span-8 bloomberg-card">
        <div class="bloomberg-card-header">
          <span class="bloomberg-card-title">Asset Allocation</span>
        </div>
        <div class="bloomberg-card-body">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-bloomberg-elevated rounded p-4" id="stocks-allocation">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-slate-500 uppercase">Stocks</span>
                <span class="text-sm font-mono text-blue-400">0%</span>
              </div>
              <div class="text-lg font-bold text-white">$0.00</div>
              <div class="mt-2 h-1 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-blue-400" style="width: 0%"></div>
              </div>
            </div>
            <div class="bg-bloomberg-elevated rounded p-4" id="etf-allocation">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-slate-500 uppercase">ETFs</span>
                <span class="text-sm font-mono text-green-400">0%</span>
              </div>
              <div class="text-lg font-bold text-white">$0.00</div>
              <div class="mt-2 h-1 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-green-400" style="width: 0%"></div>
              </div>
            </div>
            <div class="bg-bloomberg-elevated rounded p-4" id="crypto-allocation">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-slate-500 uppercase">Crypto</span>
                <span class="text-sm font-mono text-amber-400">0%</span>
              </div>
              <div class="text-lg font-bold text-white">$0.00</div>
              <div class="mt-2 h-1 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-amber-400" style="width: 0%"></div>
              </div>
            </div>
            <div class="bg-bloomberg-elevated rounded p-4" id="cash-allocation">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-slate-500 uppercase">Cash</span>
                <span class="text-sm font-mono text-slate-400">0%</span>
              </div>
              <div class="text-lg font-bold text-white">$<%= (safeTotals.cash || 0).toFixed(2) %></div>
              <div class="mt-2 h-1 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-slate-400" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="col-span-12 md:col-span-4 bloomberg-card">
        <div class="bloomberg-card-header">
          <span class="bloomberg-card-title">Quick Actions</span>
        </div>
        <div class="bloomberg-card-body space-y-2">
          <a href="/portfolios" class="bloomberg-btn bloomberg-btn-primary w-full flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Position
          </a>
          <a href="/transactions" class="bloomberg-btn bloomberg-btn-ghost w-full flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            View Transactions
          </a>
          <a href="/analytics" class="bloomberg-btn bloomberg-btn-ghost w-full flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            View Analytics
          </a>
          <a href="/market-movers" class="bloomberg-btn bloomberg-btn-ghost w-full flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
            </svg>
            Market Movers
          </a>
        </div>
      </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="grid grid-cols-12 gap-4">

      <!-- Holdings Table (Main Content) -->
      <div class="col-span-12 lg:col-span-8 bloomberg-card">
        <div class="bloomberg-card-header">
          <span class="bloomberg-card-title">Holdings</span>
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500 font-mono"><%= safeHoldings.length %> positions</span>
            <a href="/holdings" class="text-xs text-blue-400 hover:underline">View All</a>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="bloomberg-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Shares</th>
                <th class="text-right">Price</th>
                <th class="text-right">Change</th>
                <th class="text-right">Mkt Value</th>
                <th class="text-right">Cost</th>
                <th class="text-right">P&L</th>
                <th class="text-right">P&L %</th>
                <th class="text-right">Weight</th>
              </tr>
            </thead>
            <tbody>
              <% if (safeHoldings && safeHoldings.length > 0) {
                safeHoldings.slice(0, 15).forEach(h => {
                  const mktVal = (h.shares || 0) * (h.currentPrice || h.price || 0);
                  const cost = (h.shares || 0) * (h.avgCost || h.avg_cost_basis || 0);
                  const pl = mktVal - cost;
                  const plPct = cost > 0 ? (pl / cost) * 100 : 0;
                  const weight = safeTotals.value > 0 ? (mktVal / safeTotals.value) * 100 : 0;
                  const change = h.changePercent || h.change_percent || 0;
              %>
              <tr data-symbol="<%= h.symbol %>">
                <td>
                  <div class="flex items-center gap-2">
                    <span class="text-white font-medium"><%= h.symbol %></span>
                    <span class="text-slate-500 text-xs truncate max-w-[100px]"><%= h.name || '' %></span>
                  </div>
                </td>
                <td class="text-slate-300"><%= (h.shares || 0).toLocaleString() %></td>
                <td class="text-right text-white">
                  <span class="stock-price">$<%= (h.currentPrice || h.price || 0).toFixed(2) %></span>
                </td>
                <td class="text-right">
                  <span class="stock-change-pct <%= change >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                    <%= change >= 0 ? '+' : '' %><%= change.toFixed(2) %>%
                  </span>
                </td>
                <td class="text-right text-white"><%= fmt.money(mktVal) %></td>
                <td class="text-right text-slate-400"><%= fmt.money(cost) %></td>
                <td class="text-right <%= pl >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                  <%= pl >= 0 ? '+' : '' %><%= fmt.money(pl) %>
                </td>
                <td class="text-right <%= plPct >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                  <%= plPct >= 0 ? '+' : '' %><%= plPct.toFixed(2) %>%
                </td>
                <td class="text-right text-slate-400"><%= weight.toFixed(1) %>%</td>
              </tr>
              <% })} else { %>
              <tr>
                <td colspan="9" class="text-center text-slate-500 py-8">
                  No holdings yet. <a href="/portfolios" class="text-blue-400 hover:underline">Add your first position</a>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="col-span-12 lg:col-span-4 space-y-4">

        <!-- Watchlist -->
        <div class="bloomberg-card">
          <div class="bloomberg-card-header">
            <span class="bloomberg-card-title">Watchlist</span>
            <a href="/watchlist" class="text-xs text-blue-400 hover:underline">View All</a>
          </div>
          <div class="bloomberg-card-body p-0">
            <% if (safeWatchlist && safeWatchlist.length > 0) {
              safeWatchlist.slice(0, 6).forEach(w => {
                const change = w.changePercent || 0;
            %>
            <div class="flex items-center justify-between px-4 py-2 border-b border-bloomberg-border-secondary hover:bg-white/5">
              <div>
                <span class="text-white font-medium text-sm"><%= w.symbol %></span>
              </div>
              <div class="text-right font-mono text-sm">
                <div class="text-white">$<%= (w.price || 0).toFixed(2) %></div>
                <div class="text-xs <%= change >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                  <%= change >= 0 ? '+' : '' %><%= change.toFixed(2) %>%
                </div>
              </div>
            </div>
            <% })} else { %>
            <div class="px-4 py-6 text-center text-slate-500 text-sm">
              No watchlist items
            </div>
            <% } %>
          </div>
        </div>

        <!-- Recent Alerts -->
        <div class="bloomberg-card">
          <div class="bloomberg-card-header">
            <span class="bloomberg-card-title">Recent Alerts</span>
            <a href="/alerts" class="text-xs text-blue-400 hover:underline">Manage</a>
          </div>
          <div class="bloomberg-card-body p-0">
            <% if (safeAlerts && safeAlerts.length > 0) {
              safeAlerts.slice(0, 4).forEach(a => {
            %>
            <div class="flex items-center gap-3 px-4 py-2 border-b border-bloomberg-border-secondary">
              <div class="w-2 h-2 rounded-full <%= a.triggered ? 'bg-emerald-500' : 'bg-amber-500' %>"></div>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-white font-medium"><%= a.symbol %></div>
                <div class="text-xs text-slate-500 truncate"><%= a.message || a.condition %></div>
              </div>
            </div>
            <% })} else { %>
            <div class="px-4 py-6 text-center text-slate-500 text-sm">
              No active alerts
            </div>
            <% } %>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="bloomberg-card">
          <div class="bloomberg-card-header">
            <span class="bloomberg-card-title">Risk Metrics</span>
          </div>
          <div class="bloomberg-card-body">
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-bloomberg-elevated rounded p-3">
                <div class="text-xs text-slate-500 uppercase">Beta</div>
                <div class="text-lg font-mono text-white"><%= (safeRisk.beta || 1.0).toFixed(2) %></div>
              </div>
              <div class="bg-bloomberg-elevated rounded p-3">
                <div class="text-xs text-slate-500 uppercase">Sharpe</div>
                <div class="text-lg font-mono text-white"><%= (safeRisk.sharpe || 0).toFixed(2) %></div>
              </div>
              <div class="bg-bloomberg-elevated rounded p-3">
                <div class="text-xs text-slate-500 uppercase">Volatility</div>
                <div class="text-lg font-mono text-white"><%= (safeRisk.volatility || 0).toFixed(1) %>%</div>
              </div>
              <div class="bg-bloomberg-elevated rounded p-3">
                <div class="text-xs text-slate-500 uppercase">Max DD</div>
                <div class="text-lg font-mono text-red-400">-<%= (safeRisk.maxDrawdown || 0).toFixed(1) %>%</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Bottom Section: Charts -->
    <div class="grid grid-cols-12 gap-4">
      <!-- Sector Allocation -->
      <div class="col-span-12 md:col-span-6 lg:col-span-4 bloomberg-card">
        <div class="bloomberg-card-header">
          <span class="bloomberg-card-title">Sector Allocation</span>
        </div>
        <div class="bloomberg-card-body">
          <canvas id="sectorChart" height="200"></canvas>
        </div>
      </div>

      <!-- Top Holdings -->
      <div class="col-span-12 md:col-span-6 lg:col-span-4 bloomberg-card">
        <div class="bloomberg-card-header">
          <span class="bloomberg-card-title">Top Holdings</span>
        </div>
        <div class="bloomberg-card-body">
          <canvas id="holdingsChart" height="200"></canvas>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="col-span-12 lg:col-span-4 bloomberg-card">
        <div class="bloomberg-card-header">
          <span class="bloomberg-card-title">Recent Activity</span>
          <a href="/transactions" class="text-xs text-blue-400 hover:underline">View All</a>
        </div>
        <div class="bloomberg-card-body p-0">
          <% if (safeTransactions && safeTransactions.length > 0) {
            safeTransactions.slice(0, 5).forEach(t => {
          %>
          <div class="flex items-center justify-between px-4 py-2 border-b border-bloomberg-border-secondary">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded flex items-center justify-center text-xs font-bold <%= t.type === 'BUY' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400' %>">
                <%= t.type === 'BUY' ? 'B' : 'S' %>
              </div>
              <div>
                <div class="text-sm text-white font-medium"><%= t.symbol %></div>
                <div class="text-xs text-slate-500"><%= t.shares %> @ $<%= (t.price || 0).toFixed(2) %></div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-sm text-white font-mono"><%= fmt.money(t.amount || t.shares * t.price) %></div>
              <div class="text-xs text-slate-500"><%= new Date(t.executed_at || t.date).toLocaleDateString() %></div>
            </div>
          </div>
          <% })} else { %>
          <div class="px-4 py-6 text-center text-slate-500 text-sm">
            No recent transactions
          </div>
          <% } %>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
// Chart.js Configuration for Bloomberg Theme
Chart.defaults.color = '#8b949e';
Chart.defaults.borderColor = '#30363d';
Chart.defaults.font.family = "'JetBrains Mono', 'Inter', sans-serif";

// Sector Allocation Chart
const sectorData = <%= JSON.stringify(safeSectors) %>;
if (sectorData.length > 0 && document.getElementById('sectorChart')) {
  new Chart(document.getElementById('sectorChart'), {
    type: 'doughnut',
    data: {
      labels: sectorData.map(s => s.name || s.sector),
      datasets: [{
        data: sectorData.map(s => s.value || s.weight),
        backgroundColor: ['#58a6ff', '#3fb950', '#f85149', '#a371f7', '#ff7b72', '#79c0ff', '#7ee787', '#ffa657'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { boxWidth: 12, padding: 8, font: { size: 10 } }
        }
      },
      cutout: '65%'
    }
  });
}

// Top Holdings Chart
const holdingsData = <%= JSON.stringify(safeHoldings.slice(0, 8).map(h => ({ symbol: h.symbol, value: (h.shares || 0) * (h.currentPrice || h.price || 0) }))) %>;
if (holdingsData.length > 0 && document.getElementById('holdingsChart')) {
  new Chart(document.getElementById('holdingsChart'), {
    type: 'bar',
    data: {
      labels: holdingsData.map(h => h.symbol),
      datasets: [{
        data: holdingsData.map(h => h.value),
        backgroundColor: '#ff6600',
        borderRadius: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' } },
        y: { grid: { display: false } }
      }
    }
  });
}

// Refresh prices function
function refreshPrices() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Refreshing...';

  fetch('/api/refresh-prices', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast(data.error, 'error');
      } else {
        showToast(`Refreshed ${data.updated} symbols`, 'success');
        location.reload();
      }
    })
    .catch(() => {
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Refresh';
      showToast('Failed to refresh prices', 'error');
    });
}

// Load charts on page load
document.addEventListener('DOMContentLoaded', () => {
  initializePerformanceChart();
  calculateAssetAllocation();
});

// Performance Chart
let performanceChart = null;
let currentTimeframe = '1D';

function initializePerformanceChart() {
  const ctx = document.getElementById('performanceChart');
  if (!ctx) return;

  performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Portfolio Value',
        data: [],
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 0,
        pointHoverRadius: 5
      }, {
        label: 'Benchmark (SPY)',
        data: [],
        borderColor: '#64748b',
        borderWidth: 1,
        borderDash: [5, 5],
        fill: false,
        tension: 0.4,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { color: '#8b949e', font: { size: 11 }, boxWidth: 12 }
        },
        tooltip: {
          backgroundColor: '#161b22',
          titleColor: '#f59e0b',
          bodyColor: '#fff',
          borderColor: '#30363d',
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + '$' + context.parsed.y.toLocaleString();
            }
          }
        }
      },
      scales: {
        x: {
          grid: { color: '#30363d', drawBorder: false },
          ticks: { color: '#8b949e', font: { size: 10 } }
        },
        y: {
          grid: { color: '#30363d', drawBorder: false },
          ticks: {
            color: '#8b949e',
            font: { size: 10 },
            callback: v => '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'K' : v.toFixed(0))
          }
        }
      }
    }
  });

  // Load initial data
  loadPerformanceData(currentTimeframe);
}

function changeTimeframe(timeframe) {
  currentTimeframe = timeframe;

  // Update active button
  document.querySelectorAll('.timeframe-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.timeframe === timeframe) {
      btn.classList.add('active');
    }
  });

  loadPerformanceData(timeframe);
}

function loadPerformanceData(timeframe) {
  fetch(`/api/analytics/performance-history?timeframe=${timeframe}`, {
    credentials: 'include'
  })
    .then(res => res.json())
    .then(data => {
      if (!data.error && performanceChart) {
        performanceChart.data.labels = data.labels || [];
        performanceChart.data.datasets[0].data = data.portfolio || [];
        performanceChart.data.datasets[1].data = data.benchmark || [];
        performanceChart.update('none');
      }
    })
    .catch(err => console.error('Failed to load performance data:', err));
}

// Calculate Asset Allocation from Holdings
function calculateAssetAllocation() {
  const holdings = <%= JSON.stringify(safeHoldings) %>;
  const totalValue = <%= safeTotals.value || 0 %>;

  const allocation = {
    stock: 0,
    etf: 0,
    crypto: 0,
    mutual_fund: 0
  };

  holdings.forEach(h => {
    const value = (h.shares || 0) * (h.currentPrice || h.price || 0);
    const type = (h.asset_type || h.type || 'stock').toLowerCase();

    if (allocation.hasOwnProperty(type)) {
      allocation[type] += value;
    } else {
      allocation.stock += value;
    }
  });

  // Update UI
  updateAllocationCard('stocks-allocation', allocation.stock, totalValue, 'blue');
  updateAllocationCard('etf-allocation', allocation.etf, totalValue, 'green');
  updateAllocationCard('crypto-allocation', allocation.crypto, totalValue, 'amber');
}

function updateAllocationCard(cardId, value, totalValue, color) {
  const card = document.getElementById(cardId);
  if (!card) return;

  const percentage = totalValue > 0 ? (value / totalValue) * 100 : 0;

  card.querySelector(`.text-${color}-400`).textContent = percentage.toFixed(1) + '%';
  card.querySelector('.text-lg').textContent = '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  card.querySelector('.h-full').style.width = percentage + '%';
}
</script>

<!-- Real-Time WebSocket Integration -->
<script src="/js/dashboard-realtime.js"></script>

<!-- Additional Dashboard Styles -->
<style>
.price-flash {
  animation: flash 0.5s ease-in-out;
}

@keyframes flash {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; background-color: rgba(34, 197, 94, 0.2); }
}

/* Timeframe Buttons */
.timeframe-btn {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  background: transparent;
  border: 1px solid #30363d;
  color: #8b949e;
  border-radius: 0.25rem;
  cursor: pointer;
  transition: all 0.2s;
}

.timeframe-btn:hover {
  background: rgba(245, 158, 11, 0.1);
  border-color: #f59e0b;
  color: #f59e0b;
}

.timeframe-btn.active {
  background: #f59e0b;
  border-color: #f59e0b;
  color: white;
}

.status-live {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgb(34, 197, 94);
  border-radius: 0.25rem;
  color: rgb(34, 197, 94);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.status-live::before {
  content: '';
  display: inline-block;
  width: 6px;
  height: 6px;
  margin-right: 0.5rem;
  background: rgb(34, 197, 94);
  border-radius: 50%;
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.status-offline {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgb(239, 68, 68);
  border-radius: 0.25rem;
  color: rgb(239, 68, 68);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>

<%- include('../partials/footer') %>
