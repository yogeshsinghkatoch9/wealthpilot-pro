<%- include('../partials/header', { pageTitle: 'Social Feed' }) %>

<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
<div><h1 class="text-2xl font-bold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>">Social Feed</h1><p class="<%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">See what top investors are doing</p></div>
<div class="flex gap-2 text-sm">
<span class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>"><%= followers.length %> followers</span>
<span class="<%= theme === 'light' ? 'text-gray-500' : 'text-slate-400' %>"><%= following.length %> following</span>
</div>
</div>

<!-- Share Card -->
<div class="card p-4">
<form id="postForm">
<div class="flex gap-3">
<div class="w-10 h-10 rounded-full bg-gradient-to-br from-sky-500 to-purple-500 flex items-center justify-center text-white font-bold"><%= user?.full_name?.charAt(0) || 'U' %></div>
<div class="flex-1">
  <textarea name="content" class="w-full bg-transparent border-none resize-none <%= theme === 'light' ? 'text-gray-900 placeholder-gray-400' : 'text-white placeholder-slate-500' %> focus:outline-none" rows="2" placeholder="Share a trade idea or market insight..." required></textarea>
  <div class="flex items-center justify-between mt-2 pt-2 border-t <%= theme === 'light' ? 'border-gray-200' : 'border-slate-700' %>">
    <select name="postType" class="form-input w-32 text-sm">
      <option value="general">General</option>
      <option value="trade">Trade</option>
      <option value="analysis">Analysis</option>
    </select>
    <button type="submit" class="btn-primary btn-sm">Post</button>
  </div>
</div>
</div>
</form>
</div>

<!-- Feed -->
<div class="space-y-4" id="socialFeed">
<% if (posts.length === 0) { %>
<div class="card p-12 text-center">
<svg class="w-16 h-16 mx-auto <%= theme === 'light' ? 'text-gray-300' : 'text-slate-600' %> mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/>
</svg>
<h4 class="text-lg font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-2">No posts yet</h4>
<p class="<%= theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Be the first to share your insights!</p>
</div>
<% } else { %>
<% posts.forEach(post => { %>
<div class="card p-5">
<div class="flex items-start gap-3">
<div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-white font-bold"><%= (post.first_name || 'A').charAt(0) %></div>
<div class="flex-1">
  <div class="flex items-center justify-between">
    <div>
      <span class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %>"><%= post.first_name %> <%= post.last_name %></span>
      <% if (post.post_type && post.post_type !== 'general') { %>
      <span class="ml-2 px-2 py-0.5 <%= post.post_type === 'trade' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-purple-500/20 text-purple-400' %> rounded text-xs"><%= post.post_type %></span>
      <% } %>
    </div>
    <span class="<%= theme === 'light' ? 'text-gray-400' : 'text-slate-500' %> text-sm"><%= new Date(post.created_at).toLocaleDateString() %></span>
  </div>
  <p class="<%= theme === 'light' ? 'text-gray-700' : 'text-slate-300' %> mt-2 whitespace-pre-wrap"><%= post.content %></p>

  <div class="flex items-center gap-4 mt-3 pt-3 border-t <%= theme === 'light' ? 'border-gray-200' : 'border-slate-700' %>">
    <button onclick="likePost('<%= post.id %>')" class="flex items-center gap-1 <%= theme === 'light' ? 'text-gray-500 hover:text-red-500' : 'text-slate-400 hover:text-red-400' %> transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
      <span class="text-sm"><%= post.likes_count || 0 %></span>
    </button>
    <button onclick="commentPost('<%= post.id %>')" class="flex items-center gap-1 <%= theme === 'light' ? 'text-gray-500 hover:text-sky-500' : 'text-slate-400 hover:text-sky-400' %> transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
      <span class="text-sm"><%= post.comments_count || 0 %></span>
    </button>
  </div>
</div>
</div>
</div>
<% }) %>
<% } %>
</div>
</div></div></main>

<script>
document.getElementById('postForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);

  try {
    const res = await fetch('/api/social/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (res.ok) {
      showToast('Posted!', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      const err = await res.json();
      showToast(err.error || 'Failed to post', 'error');
    }
  } catch (e) {
    showToast('Error posting', 'error');
  }
});

function likePost(id) {
  fetch('/api/social/posts/' + id + '/like', { method: 'POST' })
    .then(res => res.ok && location.reload());
}

function commentPost(id) {
  const comment = prompt('Enter your comment:');
  if (comment) {
    fetch('/api/social/posts/' + id + '/comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: comment })
    }).then(res => res.ok && location.reload());
  }
}
</script>
<%- include('../partials/footer') %>
