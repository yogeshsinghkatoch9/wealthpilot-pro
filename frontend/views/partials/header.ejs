<!DOCTYPE html>
<html lang="en" data-theme="<%= typeof theme !== 'undefined' ? theme : 'dark' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0e17">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WealthPilot">
  <meta name="description" content="AI-Powered Portfolio Intelligence Platform">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <title>WealthPilot Pro<%= typeof pageTitle !== 'undefined' ? ' - ' + pageTitle : '' %></title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <!-- Chart.js Plugins for Advanced Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.2.5/build/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Material Symbols for Stitch UI -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

  <!-- Theme Styles -->
  <link rel="stylesheet" href="/css/bloomberg.css">
  <link rel="stylesheet" href="/css/megamenu.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/skeleton.css">
  <link rel="stylesheet" href="/css/advanced-ui.css">

  <!-- Responsive & Mobile Styles -->
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/mobile-responsive.css">
  <link rel="stylesheet" href="/css/mobile.css">
  <link rel="stylesheet" href="/css/mobile-bottom-nav.css">
  <link rel="stylesheet" href="/css/touch-optimized-tables.css">

  <!-- Enhanced UI/UX Styles -->
  <link rel="stylesheet" href="/css/enhanced-visuals.css">
  <link rel="stylesheet" href="/css/micro-animations.css">
  <link rel="stylesheet" href="/css/toast.css">
  <link rel="stylesheet" href="/css/empty-states.css">

  <!-- Tufte-Inspired Finance Components -->
  <link rel="stylesheet" href="/css/tufte-finance.css">

  <!-- Stitch UI Theme -->
  <link rel="stylesheet" href="/css/stitch-theme.css">

  <!-- Tailwind Config - Green Theme Design System -->
  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'SF Mono', 'Consolas', 'monospace']
          },
          colors: {
            // Green Theme Primary Colors
            'primary': '#22c55e',
            'primary-hover': '#16a34a',
            'primary-dark': '#15803d',
            'background-dark': '#0a0f0d',
            'card-dark': 'rgba(17, 24, 22, 0.95)',
            'border-dark': 'rgba(34, 197, 94, 0.15)',
            'text-secondary': '#94a3b8',
            'accent-green': '#22c55e',
            'accent-red': '#ef4444',
            // Green Palette
            green: {
              50: '#f0fdf4',
              100: '#dcfce7',
              200: '#bbf7d0',
              300: '#86efac',
              400: '#4ade80',
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d',
              800: '#166534',
              900: '#14532d',
              950: '#052e16'
            },
            // Legacy Bloomberg colors (backward compatibility)
            bloomberg: {
              bg: '#0a0f0d',
              surface: 'rgba(17, 24, 22, 0.95)',
              elevated: '#151d19',
              card: 'rgba(17, 24, 22, 0.95)',
              border: 'rgba(34, 197, 94, 0.15)',
              'border-secondary': 'rgba(34, 197, 94, 0.1)',
              accent: '#22c55e',
              'accent-hover': '#16a34a',
              blue: '#22c55e'
            },
            // Semantic colors
            gain: {
              DEFAULT: '#22c55e',
              light: '#f0fdf4',
              dark: '#4ade80'
            },
            loss: {
              DEFAULT: '#ef4444',
              light: '#fef2f2',
              dark: '#f87171'
            },
            slate: {
              850: '#172033',
              950: '#0a0f1a'
            },
            accent: {
              blue: '#22c55e',
              purple: '#8b5cf6',
              pink: '#ec4899',
              cyan: '#06b6d4',
              emerald: '#22c55e',
              amber: '#f59e0b',
              rose: '#f43f5e'
            }
          },
          backgroundImage: {
            'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
            'gradient-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
            'gradient-primary': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'gradient-success': 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            'gradient-danger': 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)',
            'gradient-aurora': 'linear-gradient(135deg, #00c6ff 0%, #0072ff 25%, #7c3aed 50%, #f472b6 75%, #fbbf24 100%)'
          },
          boxShadow: {
            'glow-green': '0 0 20px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.3)',
            'glow-blue': '0 0 20px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.3)',
            'glow-purple': '0 0 20px rgba(139, 92, 246, 0.5), 0 0 40px rgba(139, 92, 246, 0.3)',
            'glow-emerald': '0 0 20px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.3)',
            'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
            'elevated': '0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2)',
            'green-glow': '0 0 30px rgba(34, 197, 94, 0.4)'
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'slide-up': 'slideUp 0.3s ease-out',
            'slide-down': 'slideDown 0.3s ease-out',
            'fade-in': 'fadeIn 0.3s ease-out',
            'float': 'float 3s ease-in-out infinite',
            'glow': 'glow-pulse 2s ease-in-out infinite',
            'shimmer': 'shimmer 2s linear infinite',
            'gradient': 'gradient-shift 3s ease infinite',
            'spin-slow': 'spin 3s linear infinite',
            'bounce-subtle': 'bounce-subtle 2s ease-in-out infinite',
            'scale-in': 'scaleIn 0.2s ease-out'
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' }
            },
            'glow-pulse': {
              '0%, 100%': { boxShadow: '0 0 20px rgba(34, 197, 94, 0.3)' },
              '50%': { boxShadow: '0 0 40px rgba(34, 197, 94, 0.6)' }
            },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' }
            },
            'gradient-shift': {
              '0%': { backgroundPosition: '0% 50%' },
              '50%': { backgroundPosition: '100% 50%' },
              '100%': { backgroundPosition: '0% 50%' }
            },
            'bounce-subtle': {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-5px)' }
            },
            scaleIn: {
              '0%': { transform: 'scale(0.95)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' }
            }
          },
          backdropBlur: {
            xs: '2px'
          }
        }
      }
    }
  </script>

  <style>
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Global Stitch Theme overrides */
    body {
      background: var(--bg-primary, #0f1115) !important;
      color: var(--text-primary, #e6edf3);
      font-family: 'Manrope', 'Inter', system-ui, sans-serif;
    }

    /* Override card styles globally */
    .card {
      background: var(--bg-secondary, #181b21) !important;
      border: 1px solid var(--border-primary, #292a38) !important;
      border-radius: 0.75rem;
    }

    /* Custom scrollbar for dark theme - Stitch style */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #0f1115;
    }
    ::-webkit-scrollbar-thumb {
      background: #292a38;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #3d3e52;
    }

    /* Monospace for all numbers */
    .font-mono, [class*="text-2xl"], [class*="text-3xl"], [class*="text-4xl"] {
      font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
    }
  </style>

  <!-- Token Sync Script -->
  <script>
    (function() {
      // Sync token from server to localStorage (for existing sessions)
      // The token is provided by the server since the cookie is httpOnly
      const storedToken = localStorage.getItem('wealthpilot_token');
      const serverToken = '<%= typeof token !== "undefined" && token ? token : "" %>';

      if (serverToken) {
        // Always sync server token to localStorage when server has a valid token
        if (storedToken !== serverToken) {
          localStorage.setItem('wealthpilot_token', serverToken);
          console.log('[Auth] Token synced from server to localStorage');
        }
      } else if (storedToken) {
        // Server doesn't have token but localStorage does - might be stale
        // Keep localStorage token for now (user might be on a page that doesn't pass token)
        console.log('[Auth] Using existing localStorage token');
      }
    })();
  </script>
</head>
<body class="bg-background-dark min-h-screen font-sans text-white">

<!-- Top Navigation Bar -->
<%- include('./topnav') %>

<!-- Main Content Wrapper (add padding-top for fixed navbar) -->
<div class="pt-14">
