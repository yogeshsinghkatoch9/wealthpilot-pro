<!-- Market Data Sidebar - Shared Component -->
<style>
  /* Market Sidebar Styles */
  .market-sidebar {
    --sidebar-width: 280px;
  }

  .market-sidebar .mover-item {
    transition: all 0.15s ease;
  }
  .market-sidebar .mover-item:hover {
    background: <%= typeof theme !== 'undefined' && theme === 'light' ? 'rgba(99, 102, 241, 0.05)' : 'rgba(99, 102, 241, 0.1)' %>;
  }

  .market-sidebar .pulse-dot {
    animation: pulseDotSidebar 2s infinite;
  }
  @keyframes pulseDotSidebar {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .market-sidebar .thin-scrollbar::-webkit-scrollbar { width: 4px; }
  .market-sidebar .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .market-sidebar .thin-scrollbar::-webkit-scrollbar-thumb {
    background: <%= typeof theme !== 'undefined' && theme === 'light' ? '#cbd5e1' : '#334155' %>;
    border-radius: 4px;
  }

  .market-sidebar .skeleton {
    background: linear-gradient(90deg,
      <%= typeof theme !== 'undefined' && theme === 'light' ? '#e2e8f0' : '#1e293b' %> 25%,
      <%= typeof theme !== 'undefined' && theme === 'light' ? '#f1f5f9' : '#334155' %> 50%,
      <%= typeof theme !== 'undefined' && theme === 'light' ? '#e2e8f0' : '#1e293b' %> 75%);
    background-size: 200% 100%;
    animation: shimmerSidebar 1.5s infinite;
  }
  @keyframes shimmerSidebar {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>

<div class="market-sidebar space-y-3">

  <!-- Quote Lookup -->
  <div class="rounded-xl p-3 <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-white border border-gray-200' : 'bg-slate-900 border border-slate-800' %>">
    <div class="flex items-center gap-2 mb-2">
      <svg class="w-4 h-4 <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-400' : 'text-slate-500' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <span class="text-xs font-medium <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">Quote Lookup</span>
    </div>
    <input type="text" id="sidebarQuoteSearch" placeholder="Search symbol..."
           onkeypress="if(event.key==='Enter')goToChartFromSidebar(this.value)"
           class="w-full h-8 px-3 text-xs rounded-lg <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-gray-100 text-gray-700 placeholder-gray-400' : 'bg-slate-800 text-white placeholder-slate-500' %> border-0 focus:ring-2 focus:ring-indigo-500">
  </div>

  <!-- Market Status -->
  <div class="rounded-xl p-3 <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-white border border-gray-200' : 'bg-slate-900 border border-slate-800' %>">
    <div class="flex items-center gap-2 mb-2">
      <span class="pulse-dot w-2 h-2 rounded-full bg-green-500"></span>
      <span class="text-[10px] <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-600' : 'text-slate-400' %>">U.S. markets open</span>
    </div>
    <div id="sidebarMarketIndices" class="grid grid-cols-2 gap-2">
      <div class="p-2 rounded-lg <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-gray-50' : 'bg-slate-800' %>">
        <div class="text-[10px] <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-500' : 'text-slate-500' %>">S&P 500</div>
        <div class="text-sm font-bold <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-900' : 'text-white' %>" id="sidebarSpyPrice">--</div>
        <div class="text-[10px] font-medium" id="sidebarSpyChange">--</div>
      </div>
      <div class="p-2 rounded-lg <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-gray-50' : 'bg-slate-800' %>">
        <div class="text-[10px] <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-500' : 'text-slate-500' %>">Nasdaq</div>
        <div class="text-sm font-bold <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-900' : 'text-white' %>" id="sidebarQqqPrice">--</div>
        <div class="text-[10px] font-medium" id="sidebarQqqChange">--</div>
      </div>
    </div>
  </div>

  <!-- Top Gainers -->
  <div class="rounded-xl overflow-hidden <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-white border border-gray-200' : 'bg-slate-900 border border-slate-800' %>">
    <div class="p-2.5 border-b <%= typeof theme !== 'undefined' && theme === 'light' ? 'border-gray-100' : 'border-slate-800' %>">
      <div class="flex items-center justify-between">
        <span class="text-xs font-bold <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-900' : 'text-white' %>">Top Gainers</span>
        <div class="flex items-center gap-1">
          <span class="pulse-dot w-1.5 h-1.5 bg-green-500 rounded-full"></span>
          <span class="text-[9px] <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-500' : 'text-slate-500' %>">Live</span>
        </div>
      </div>
    </div>
    <div id="sidebarTopGainersList" class="overflow-y-auto thin-scrollbar max-h-[200px]">
      <% for(let i = 0; i < 5; i++) { %>
      <div class="flex items-center justify-between px-2.5 py-1.5 border-b <%= typeof theme !== 'undefined' && theme === 'light' ? 'border-gray-50' : 'border-slate-800/50' %>">
        <div class="skeleton h-3 w-12 rounded"></div>
        <div class="skeleton h-3 w-16 rounded"></div>
        <div class="skeleton h-3 w-14 rounded"></div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Top Losers -->
  <div class="rounded-xl overflow-hidden <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-white border border-gray-200' : 'bg-slate-900 border border-slate-800' %>">
    <div class="p-2.5 border-b <%= typeof theme !== 'undefined' && theme === 'light' ? 'border-gray-100' : 'border-slate-800' %>">
      <div class="flex items-center justify-between">
        <span class="text-xs font-bold <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-900' : 'text-white' %>">Top Losers</span>
        <div class="flex items-center gap-1">
          <span class="pulse-dot w-1.5 h-1.5 bg-red-500 rounded-full"></span>
          <span class="text-[9px] <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-500' : 'text-slate-500' %>">Live</span>
        </div>
      </div>
    </div>
    <div id="sidebarTopLosersList" class="overflow-y-auto thin-scrollbar max-h-[200px]">
      <% for(let i = 0; i < 5; i++) { %>
      <div class="flex items-center justify-between px-2.5 py-1.5 border-b <%= typeof theme !== 'undefined' && theme === 'light' ? 'border-gray-50' : 'border-slate-800/50' %>">
        <div class="skeleton h-3 w-12 rounded"></div>
        <div class="skeleton h-3 w-16 rounded"></div>
        <div class="skeleton h-3 w-14 rounded"></div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Trending Tickers -->
  <div class="rounded-xl overflow-hidden <%= typeof theme !== 'undefined' && theme === 'light' ? 'bg-white border border-gray-200' : 'bg-slate-900 border border-slate-800' %>">
    <div class="p-2.5 border-b <%= typeof theme !== 'undefined' && theme === 'light' ? 'border-gray-100' : 'border-slate-800' %>">
      <span class="text-xs font-bold <%= typeof theme !== 'undefined' && theme === 'light' ? 'text-gray-900' : 'text-white' %>">Trending Tickers</span>
    </div>
    <div id="sidebarTrendingTickers" class="overflow-y-auto thin-scrollbar max-h-[180px]">
      <% for(let i = 0; i < 4; i++) { %>
      <div class="flex items-center justify-between px-2.5 py-1.5 border-b <%= typeof theme !== 'undefined' && theme === 'light' ? 'border-gray-50' : 'border-slate-800/50' %>">
        <div class="skeleton h-3 w-12 rounded"></div>
        <div class="skeleton h-3 w-16 rounded"></div>
        <div class="skeleton h-3 w-14 rounded"></div>
      </div>
      <% } %>
    </div>
  </div>

</div>

<script>
(function() {
  // Only initialize if not already initialized
  if (window.marketSidebarInitialized) return;
  window.marketSidebarInitialized = true;

  const sidebarTheme = '<%= typeof theme !== "undefined" ? theme : "dark" %>';

  // Market symbols
  const SIDEBAR_MARKET_SYMBOLS = [
    'NVDA', 'SMCI', 'PLTR', 'AMD', 'TSLA', 'MSTR', 'COIN', 'AVGO', 'META', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NFLX',
    'BTC-USD', 'ETH-USD', 'SOL-USD', 'XRP-USD', 'DOGE-USD',
    'SOXL', 'TQQQ', 'ARKK', 'QQQ', 'SPY', 'SOXS', 'SQQQ',
    'GC=F', 'SI=F'
  ];

  const SIDEBAR_SYMBOL_NAMES = {
    'AAPL': 'Apple', 'MSFT': 'Microsoft', 'GOOGL': 'Google', 'NVDA': 'NVIDIA', 'TSLA': 'Tesla',
    'AMD': 'AMD', 'META': 'Meta', 'AMZN': 'Amazon', 'BTC-USD': 'Bitcoin', 'ETH-USD': 'Ethereum',
    'SOL-USD': 'Solana', 'XRP-USD': 'Ripple', 'SPY': 'S&P 500', 'QQQ': 'Nasdaq', 'SOXL': 'Semi Bull',
    'SMCI': 'Super Micro', 'PLTR': 'Palantir', 'MSTR': 'MicroStrategy', 'COIN': 'Coinbase',
    'AVGO': 'Broadcom', 'NFLX': 'Netflix', 'DOGE-USD': 'Doge', 'TQQQ': 'Nasdaq 3X',
    'SOXS': 'Semi Bear', 'SQQQ': 'Nasdaq Bear', 'GC=F': 'Gold', 'SI=F': 'Silver', 'ARKK': 'ARK Innov'
  };

  let sidebarGainers = [];
  let sidebarLosers = [];
  let sidebarTrending = [];

  // Go to chart
  window.goToChartFromSidebar = function(symbol) {
    if (symbol) {
      window.location.href = `/charts?symbol=${encodeURIComponent(symbol.trim().toUpperCase())}`;
    }
  };

  // Format price
  function formatSidebarPrice(price) {
    if (!price) return '0.00';
    if (price >= 10000) return price.toLocaleString('en-US', { maximumFractionDigits: 0 });
    if (price >= 100) return price.toFixed(2);
    if (price >= 1) return price.toFixed(2);
    return price.toFixed(4);
  }

  // Update index
  function updateSidebarIndex(id, data) {
    const priceEl = document.getElementById(`sidebar${id}Price`);
    const changeEl = document.getElementById(`sidebar${id}Change`);
    if (priceEl) priceEl.textContent = `$${formatSidebarPrice(data.price)}`;
    if (changeEl) {
      const pct = data.changePercent || 0;
      const color = pct >= 0 ? 'text-green-500' : 'text-red-500';
      changeEl.className = `text-[10px] font-medium ${color}`;
      changeEl.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
    }
  }

  // Render gainers
  function renderSidebarGainers() {
    const list = document.getElementById('sidebarTopGainersList');
    if (!list) return;
    const valid = sidebarGainers.filter(item => item.price > 0 && !isNaN(item.changePercent));
    list.innerHTML = valid.slice(0, 8).map(item => {
      const displaySymbol = item.symbol.replace('-USD', '').replace('=F', '');
      const pct = item.changePercent || 0;
      return `
        <div onclick="goToChartFromSidebar('${item.symbol}')" class="mover-item flex items-center justify-between px-2.5 py-1.5 cursor-pointer border-b ${sidebarTheme === 'light' ? 'border-gray-50' : 'border-slate-800/50'}">
          <div class="min-w-0">
            <div class="text-xs font-bold text-green-500">${displaySymbol}</div>
            <div class="text-[9px] ${sidebarTheme === 'light' ? 'text-gray-500' : 'text-slate-500'} truncate max-w-[70px]">${item.name || displaySymbol}</div>
          </div>
          <div class="text-right">
            <div class="text-[11px] font-semibold ${sidebarTheme === 'light' ? 'text-gray-900' : 'text-white'}">${formatSidebarPrice(item.price)}</div>
          </div>
          <div class="text-right min-w-[50px]">
            <div class="text-[10px] font-bold text-green-500">+${Math.abs(pct).toFixed(2)}%</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Render losers
  function renderSidebarLosers() {
    const list = document.getElementById('sidebarTopLosersList');
    if (!list) return;
    const valid = sidebarLosers.filter(item => item.price > 0 && !isNaN(item.changePercent));
    list.innerHTML = valid.slice(0, 8).map(item => {
      const displaySymbol = item.symbol.replace('-USD', '').replace('=F', '');
      const pct = item.changePercent || 0;
      return `
        <div onclick="goToChartFromSidebar('${item.symbol}')" class="mover-item flex items-center justify-between px-2.5 py-1.5 cursor-pointer border-b ${sidebarTheme === 'light' ? 'border-gray-50' : 'border-slate-800/50'}">
          <div class="min-w-0">
            <div class="text-xs font-bold text-red-500">${displaySymbol}</div>
            <div class="text-[9px] ${sidebarTheme === 'light' ? 'text-gray-500' : 'text-slate-500'} truncate max-w-[70px]">${item.name || displaySymbol}</div>
          </div>
          <div class="text-right">
            <div class="text-[11px] font-semibold ${sidebarTheme === 'light' ? 'text-gray-900' : 'text-white'}">${formatSidebarPrice(item.price)}</div>
          </div>
          <div class="text-right min-w-[50px]">
            <div class="text-[10px] font-bold text-red-500">${pct.toFixed(2)}%</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Render trending
  function renderSidebarTrending() {
    const list = document.getElementById('sidebarTrendingTickers');
    if (!list) return;
    const valid = sidebarTrending.filter(item => item.price > 0 && !isNaN(item.changePercent));
    list.innerHTML = valid.slice(0, 8).map(item => {
      const displaySymbol = item.symbol.replace('-USD', '').replace('=F', '');
      const pct = item.changePercent || 0;
      const color = pct >= 0 ? 'text-green-500' : 'text-red-500';
      return `
        <div onclick="goToChartFromSidebar('${item.symbol}')" class="mover-item flex items-center justify-between px-2.5 py-1.5 cursor-pointer border-b ${sidebarTheme === 'light' ? 'border-gray-50' : 'border-slate-800/50'}">
          <div class="min-w-0">
            <div class="text-xs font-bold ${sidebarTheme === 'light' ? 'text-indigo-600' : 'text-indigo-400'}">${displaySymbol}</div>
            <div class="text-[9px] ${sidebarTheme === 'light' ? 'text-gray-500' : 'text-slate-500'} truncate max-w-[70px]">${item.name || displaySymbol}</div>
          </div>
          <div class="text-right">
            <div class="text-[11px] font-semibold ${sidebarTheme === 'light' ? 'text-gray-900' : 'text-white'}">${formatSidebarPrice(item.price)}</div>
          </div>
          <div class="text-right min-w-[50px]">
            <div class="text-[10px] font-bold ${color}">${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Fallback data
  function loadSidebarFallbackData() {
    sidebarGainers = [
      { symbol: 'SMCI', name: 'Super Micro', price: 42.18, changePercent: 14.52 },
      { symbol: 'NVDA', name: 'NVIDIA', price: 142.85, changePercent: 8.34 },
      { symbol: 'SOL-USD', name: 'Solana', price: 218.45, changePercent: 7.82 },
      { symbol: 'XRP-USD', name: 'Ripple', price: 2.42, changePercent: 6.28 },
      { symbol: 'SOXL', name: 'Semi Bull 3X', price: 32.45, changePercent: 5.85 },
      { symbol: 'PLTR', name: 'Palantir', price: 78.45, changePercent: 4.77 },
      { symbol: 'BTC-USD', name: 'Bitcoin', price: 98542.80, changePercent: 3.97 },
      { symbol: 'TSLA', name: 'Tesla', price: 412.50, changePercent: 3.42 }
    ];
    sidebarLosers = [
      { symbol: 'SQQQ', name: 'Nasdaq Bear 3X', price: 8.42, changePercent: -12.85 },
      { symbol: 'SOXS', name: 'Semi Bear 3X', price: 4.18, changePercent: -9.24 },
      { symbol: 'INTC', name: 'Intel', price: 21.42, changePercent: -5.82 },
      { symbol: 'VTI', name: 'Total Market', price: 285.62, changePercent: -2.15 },
      { symbol: 'NFLX', name: 'Netflix', price: 91.46, changePercent: -1.95 },
      { symbol: 'CRM', name: 'Salesforce', price: 256.26, changePercent: -1.87 },
      { symbol: 'ORCL', name: 'Oracle', price: 142.80, changePercent: -1.12 },
      { symbol: 'BA', name: 'Boeing', price: 178.92, changePercent: -0.72 }
    ];
    sidebarTrending = [
      { symbol: 'NVDA', name: 'NVIDIA', price: 142.85, changePercent: 8.34 },
      { symbol: 'BTC-USD', name: 'Bitcoin', price: 98542.80, changePercent: 3.97 },
      { symbol: 'TSLA', name: 'Tesla', price: 412.50, changePercent: 3.42 },
      { symbol: 'AMD', name: 'AMD', price: 124.32, changePercent: -2.37 },
      { symbol: 'META', name: 'Meta', price: 612.45, changePercent: 1.85 },
      { symbol: 'AAPL', name: 'Apple', price: 248.52, changePercent: -0.42 },
      { symbol: 'MSFT', name: 'Microsoft', price: 418.75, changePercent: 0.85 },
      { symbol: 'SPY', name: 'S&P 500', price: 602.18, changePercent: 1.42 }
    ];
    updateSidebarIndex('Spy', { price: 602.18, changePercent: 1.42 });
    updateSidebarIndex('Qqq', { price: 528.45, changePercent: 2.18 });
    renderSidebarGainers();
    renderSidebarLosers();
    renderSidebarTrending();
  }

  // Fetch market data
  async function loadSidebarMarketData() {
    try {
      const token = localStorage.getItem('wealthpilot_token') || localStorage.getItem('token') || '';
      const symbolsParam = SIDEBAR_MARKET_SYMBOLS.join(',');
      const res = await fetch(`/api/market/quotes?symbols=${symbolsParam}`, {
        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
      });
      const data = await res.json();

      if (Array.isArray(data) && data.length > 0) {
        const quotes = data.map(q => ({
          symbol: q.symbol,
          name: q.name || q.shortName || SIDEBAR_SYMBOL_NAMES[q.symbol] || q.symbol,
          price: q.price || q.regularMarketPrice || 0,
          changePercent: q.changePercent || q.regularMarketChangePercent || 0
        }));

        // Update indices
        const spy = quotes.find(q => q.symbol === 'SPY');
        const qqq = quotes.find(q => q.symbol === 'QQQ');
        if (spy) updateSidebarIndex('Spy', spy);
        if (qqq) updateSidebarIndex('Qqq', qqq);

        // Filter and sort
        const validQuotes = quotes.filter(q => q.price > 0 && !isNaN(q.changePercent));
        sidebarGainers = [...validQuotes].sort((a, b) => b.changePercent - a.changePercent).slice(0, 10);
        sidebarLosers = [...validQuotes].sort((a, b) => a.changePercent - b.changePercent).slice(0, 10);
        sidebarTrending = [...validQuotes].sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent)).slice(0, 10);

        renderSidebarGainers();
        renderSidebarLosers();
        renderSidebarTrending();
      } else {
        loadSidebarFallbackData();
      }
    } catch (e) {
      console.error('Sidebar market fetch error:', e);
      loadSidebarFallbackData();
    }
  }

  // Initialize
  function initMarketSidebar() {
    loadSidebarMarketData();
    // Refresh every 30 seconds
    setInterval(loadSidebarMarketData, 30000);
  }

  // Start when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMarketSidebar);
  } else {
    initMarketSidebar();
  }
})();
</script>
