<%
// Safe defaults for potentially undefined variables
const safeTheme = typeof theme !== 'undefined' ? theme : 'dark';
const safeUser = typeof user !== 'undefined' ? user : {};
const safePageTitle = typeof pageTitle !== 'undefined' ? pageTitle : 'Cash Flow Analysis';
%>
<%- include('../partials/header', { pageTitle: safePageTitle }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-amber-400">Cash Flow Analysis</h1>
      <p class="text-slate-400">Operating, investing & financing cash flows</p>
    </div>
    <div class="flex gap-2">
      <input type="text" value="AAPL" class="form-input w-24 font-mono bg-slate-900 border-slate-700 text-white">
      <button class="bloomberg-btn">Analyze</button>
    </div>
  </div>
</div>

<!-- Company Header -->
<div class="bloomberg-card p-5 border-l-4 border-amber-400">
  <div class="flex items-center gap-4">
    <div class="w-14 h-14 rounded bg-slate-700 flex items-center justify-center text-white font-bold text-xl">AAPL</div>
    <div class="flex-1">
      <h2 class="text-xl font-bold text-white">Apple Inc.</h2>
      <p class="text-slate-400">FY 2024 Cash Flow Statement</p>
    </div>
  </div>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
    <div class="text-center">
      <p class="text-sm text-slate-400">Operating CF</p>
      <p class="text-3xl font-bold font-mono tabular-nums positive">$118.3B</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">Free Cash Flow</p>
      <p class="text-3xl font-bold font-mono tabular-nums positive">$99.6B</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">FCF Yield</p>
      <p class="text-3xl font-bold font-mono tabular-nums text-white">3.4%</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-slate-400">FCF/Share</p>
      <p class="text-3xl font-bold font-mono tabular-nums text-white">$6.43</p>
    </div>
  </div>
</div>

<!-- Cash Flow Statement -->
<div class="bloomberg-card overflow-hidden">
  <div class="p-4 border-b border-slate-700">
    <h3 class="font-semibold text-amber-400">Cash Flow Statement (Quarterly, $B)</h3>
  </div>
  <table class="w-full text-sm">
    <thead>
      <tr class="bg-slate-800 text-slate-400 text-left">
        <th class="px-4 py-3">Line Item</th>
        <th class="px-4 py-3 text-right">Q4 2024</th>
        <th class="px-4 py-3 text-right">Q3 2024</th>
        <th class="px-4 py-3 text-right">Q2 2024</th>
        <th class="px-4 py-3 text-right">Q1 2024</th>
      </tr>
    </thead>
    <tbody class="text-white">
      <tr class="border-b border-slate-700/50 bg-emerald-500/5">
        <td class="px-4 py-2 font-bold text-emerald-400">Operating Activities</td><td></td><td></td><td></td><td></td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">Net Income</td>
        <td class="px-4 py-2 text-right font-mono">$24.6</td>
        <td class="px-4 py-2 text-right font-mono">$21.4</td>
        <td class="px-4 py-2 text-right font-mono">$23.2</td>
        <td class="px-4 py-2 text-right font-mono">$33.9</td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">D&A</td>
        <td class="px-4 py-2 text-right font-mono">$2.8</td>
        <td class="px-4 py-2 text-right font-mono">$2.9</td>
        <td class="px-4 py-2 text-right font-mono">$2.8</td>
        <td class="px-4 py-2 text-right font-mono">$2.9</td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">Stock Comp</td>
        <td class="px-4 py-2 text-right font-mono">$2.9</td>
        <td class="px-4 py-2 text-right font-mono">$2.8</td>
        <td class="px-4 py-2 text-right font-mono">$2.8</td>
        <td class="px-4 py-2 text-right font-mono">$2.7</td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">Working Capital Î”</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums positive">$1.2</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(2.4)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums positive">$3.8</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(4.2)</td>
      </tr>
      <tr class="border-b border-slate-700 bg-slate-800/50">
        <td class="px-4 py-2 font-bold">Cash from Operations</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums positive">$31.5</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums positive">$24.7</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums positive">$32.6</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums positive">$35.3</td>
      </tr>

      <tr class="border-b border-slate-700/50 bg-amber-500/5">
        <td class="px-4 py-2 font-bold text-amber-400">Investing Activities</td><td></td><td></td><td></td><td></td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">CapEx</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(3.2)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(2.9)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(2.4)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(2.8)</td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">Acquisitions</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(0.2)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums">$0</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(0.8)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(0.4)</td>
      </tr>
      <tr class="border-b border-slate-700 bg-slate-800/50">
        <td class="px-4 py-2 font-bold">Cash from Investing</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(4.8)</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(2.9)</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(8.2)</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(6.4)</td>
      </tr>

      <tr class="border-b border-slate-700/50 bg-sky-500/5">
        <td class="px-4 py-2 font-bold text-sky-400">Financing Activities</td><td></td><td></td><td></td><td></td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">Dividends Paid</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(3.8)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(3.8)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(3.7)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(3.7)</td>
      </tr>
      <tr class="border-b border-slate-700/50">
        <td class="px-4 py-2 pl-6">Share Repurchases</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(24.2)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(22.8)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(23.4)</td>
        <td class="px-4 py-2 text-right font-mono tabular-nums negative">$(27.1)</td>
      </tr>
      <tr class="border-b border-slate-700 bg-slate-800/50">
        <td class="px-4 py-2 font-bold">Cash from Financing</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(28.0)</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(26.6)</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(27.1)</td>
        <td class="px-4 py-2 text-right font-bold font-mono tabular-nums negative">$(30.8)</td>
      </tr>

      <tr class="bg-purple-500/10">
        <td class="px-4 py-3 font-bold text-purple-400">Free Cash Flow</td>
        <td class="px-4 py-3 text-right font-bold font-mono text-purple-400">$28.3</td>
        <td class="px-4 py-3 text-right font-bold font-mono text-purple-400">$21.8</td>
        <td class="px-4 py-3 text-right font-bold font-mono text-purple-400">$30.2</td>
        <td class="px-4 py-3 text-right font-bold font-mono text-purple-400">$32.5</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Cash Flow Metrics -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div class="bloomberg-card p-5">
    <h4 class="font-bold text-emerald-400 mb-3 border-b border-emerald-400/30 pb-2">FCF Quality</h4>
    <div class="space-y-2">
      <div class="flex justify-between"><span class="text-slate-400">FCF/Net Income</span><span class="font-bold font-mono text-emerald-400">97%</span></div>
      <div class="flex justify-between"><span class="text-slate-400">FCF Margin</span><span class="font-bold font-mono text-emerald-400">26.0%</span></div>
      <div class="flex justify-between"><span class="text-slate-400">Cash Conversion</span><span class="font-bold font-mono text-emerald-400">115%</span></div>
    </div>
  </div>
  <div class="bloomberg-card p-5">
    <h4 class="font-bold text-sky-400 mb-3 border-b border-sky-400/30 pb-2">Capital Allocation</h4>
    <div class="space-y-2">
      <div class="flex justify-between"><span class="text-slate-400">Buybacks % of FCF</span><span class="font-bold font-mono text-white">98%</span></div>
      <div class="flex justify-between"><span class="text-slate-400">Dividends % of FCF</span><span class="font-bold font-mono text-white">15%</span></div>
      <div class="flex justify-between"><span class="text-slate-400">CapEx % of OCF</span><span class="font-bold font-mono text-white">9.6%</span></div>
    </div>
  </div>
  <div class="bloomberg-card p-5">
    <h4 class="font-bold text-purple-400 mb-3 border-b border-purple-400/30 pb-2">5Y Trends</h4>
    <div class="space-y-2">
      <div class="flex justify-between"><span class="text-slate-400">FCF CAGR</span><span class="font-bold font-mono text-emerald-400">+8.4%</span></div>
      <div class="flex justify-between"><span class="text-slate-400">OCF CAGR</span><span class="font-bold font-mono text-emerald-400">+6.2%</span></div>
      <div class="flex justify-between"><span class="text-slate-400">CapEx Intensity</span><span class="font-bold font-mono text-white">Decreasing</span></div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="card p-5">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Cash Flow Trend</h3>
<div class="h-48"><canvas id="cfChart"></canvas></div>
</div>
<div class="card p-5">
<h3 class="font-semibold <%= theme === 'light' ? 'text-gray-900' : 'text-white' %> mb-4">Cash Flow Composition</h3>
<div class="h-48"><canvas id="compChart"></canvas></div>
</div>
</div>
</div></div></main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('cfChart'), {
  type: 'line',
  data: { labels: ['Q1 23','Q2 23','Q3 23','Q4 23','Q1 24','Q2 24','Q3 24','Q4 24'], datasets: [
    { label: 'Operating CF', data: [34.0,26.4,21.8,30.2,35.3,32.6,24.7,31.5], borderColor: '#10b981', fill: false },
    { label: 'Free Cash Flow', data: [30.8,23.2,18.9,27.4,32.5,30.2,21.8,28.3], borderColor: '#8b5cf6', fill: false }
  ]},
  options: { responsive: true, maintainAspectRatio: false }
});
new Chart(document.getElementById('compChart'), {
  type: 'bar',
  data: { labels: ['FY 2022','FY 2023','FY 2024'], datasets: [
    { label: 'Operating', data: [122.2,110.5,118.3], backgroundColor: '#10b981' },
    { label: 'Investing', data: [-22.4,-18.2,-22.3], backgroundColor: '#f59e0b' },
    { label: 'Financing', data: [-110.8,-108.4,-112.5], backgroundColor: '#ef4444' }
  ]},
  options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: false } } }
});
</script>
<%- include('../partials/footer') %>
