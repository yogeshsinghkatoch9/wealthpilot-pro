<%- include('../partials/header', { pageTitle: 'Market Scanner' }) %>

<!-- Bloomberg Header Bar -->
<div class="bloomberg-header">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold text-amber-400 tracking-wide">MARKET SCANNER</h1>
      <p class="text-xs text-slate-400 mt-1">Real-time scanning with custom conditions</p>
    </div>
    <button onclick="runScanner()" class="bloomberg-btn bloomberg-btn-primary">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      RUN SCAN
    </button>
  </div>
</div>

<!-- Scanner Presets -->
<div class="flex flex-wrap gap-2 mb-6">
  <button onclick="loadPreset('gainers')" class="preset-btn bloomberg-btn bloomberg-btn-sm bg-emerald-500 text-black font-bold">
    TOP GAINERS
  </button>
  <button onclick="loadPreset('losers')" class="preset-btn bloomberg-btn bloomberg-btn-sm">
    TOP LOSERS
  </button>
  <button onclick="loadPreset('volume')" class="preset-btn bloomberg-btn bloomberg-btn-sm">
    HIGH VOLUME
  </button>
  <button onclick="loadPreset('breakout')" class="preset-btn bloomberg-btn bloomberg-btn-sm">
    BREAKOUTS
  </button>
  <button onclick="loadPreset('oversold')" class="preset-btn bloomberg-btn bloomberg-btn-sm">
    OVERSOLD RSI
  </button>
  <button onclick="loadPreset('overbought')" class="preset-btn bloomberg-btn bloomberg-btn-sm">
    OVERBOUGHT RSI
  </button>
  <button onclick="loadPreset('earnings')" class="preset-btn bloomberg-btn bloomberg-btn-sm">
    EARNINGS SOON
  </button>
  <button onclick="loadPreset('dividend')" class="preset-btn bloomberg-btn bloomberg-btn-sm">
    HIGH DIVIDEND
  </button>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <!-- Filter Builder -->
  <div class="bloomberg-card">
    <div class="p-5">
      <h3 class="text-sm font-bold text-amber-400 mb-4 tracking-wide">FILTERS</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-slate-400 mb-2">MARKET CAP</label>
          <select name="marketCap" class="w-full bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400">
            <option>Any</option>
            <option>Mega ($200B+)</option>
            <option>Large ($10B-$200B)</option>
            <option>Mid ($2B-$10B)</option>
            <option>Small ($300M-$2B)</option>
            <option>Micro (&lt;$300M)</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-2">SECTOR</label>
          <select name="sector" class="w-full bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400">
            <option>All Sectors</option>
            <option>Technology</option>
            <option>Healthcare</option>
            <option>Financial Services</option>
            <option>Consumer Cyclical</option>
            <option>Energy</option>
            <option>Communication Services</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-2">PRICE RANGE</label>
          <div class="flex gap-2">
            <input type="number" name="minPrice" placeholder="Min" class="w-1/2 bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400 font-mono">
            <input type="number" name="maxPrice" placeholder="Max" class="w-1/2 bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400 font-mono">
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-2">DAILY CHANGE %</label>
          <div class="flex gap-2">
            <input type="number" name="minChange" placeholder="Min" class="w-1/2 bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400 font-mono">
            <input type="number" name="maxChange" placeholder="Max" class="w-1/2 bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400 font-mono">
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-2">VOLUME</label>
          <select name="volumeFilter" class="w-full bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400">
            <option>Above Average</option>
            <option>2x Average</option>
            <option>5x Average</option>
            <option>10x Average</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-2">RSI (14)</label>
          <div class="flex gap-2">
            <input type="number" name="minRsi" placeholder="Min" class="w-1/2 bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400 font-mono">
            <input type="number" name="maxRsi" placeholder="Max" class="w-1/2 bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400 font-mono">
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-2">52-WEEK POSITION</label>
          <select class="w-full bg-slate-900 border border-slate-700 text-white text-sm px-3 py-2 rounded focus:outline-none focus:border-amber-400">
            <option>Any</option>
            <option>Near 52W High</option>
            <option>Near 52W Low</option>
            <option>New 52W High</option>
            <option>New 52W Low</option>
          </select>
        </div>

        <button onclick="addCondition()" class="bloomberg-btn bloomberg-btn-sm w-full text-xs">
          + ADD CUSTOM CONDITION
        </button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="lg:col-span-3 space-y-4">
    <div class="flex items-center justify-between">
      <p class="text-sm text-slate-400">
        <span class="font-bold text-emerald-400 font-mono" id="resultCount">47</span> STOCKS MATCH YOUR CRITERIA
      </p>
      <div class="flex gap-2">
        <select class="bg-slate-900 border border-slate-700 text-white text-xs px-3 py-2 rounded focus:outline-none focus:border-amber-400">
          <option>SORT: CHANGE %</option>
          <option>SORT: VOLUME</option>
          <option>SORT: MARKET CAP</option>
          <option>SORT: PRICE</option>
        </select>
        <button onclick="saveScanner()" class="bloomberg-btn bloomberg-btn-sm">SAVE</button>
        <button onclick="exportResults()" class="bloomberg-btn bloomberg-btn-sm">EXPORT CSV</button>
      </div>
    </div>

    <div class="bloomberg-card overflow-hidden">
      <table class="bloomberg-table">
        <thead>
          <tr>
            <th>SYMBOL</th>
            <th>PRICE</th>
            <th>CHANGE</th>
            <th>VOLUME</th>
            <th>MARKET CAP</th>
            <th>RSI</th>
            <th>SIGNAL</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="scanResults">
          <tr>
            <td>
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">
                  SMCI
                </div>
                <div>
                  <p class="font-bold text-white">SMCI</p>
                  <p class="text-xs text-slate-500">Super Micro</p>
                </div>
              </div>
            </td>
            <td class="font-mono text-white">$42.85</td>
            <td class="font-mono text-emerald-400 font-bold">+18.4%</td>
            <td class="font-mono text-slate-400">45.2M</td>
            <td class="font-mono text-slate-400">$25B</td>
            <td>
              <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded text-xs font-mono font-bold">58</span>
            </td>
            <td>
              <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs font-bold">BREAKOUT</span>
            </td>
            <td>
              <button class="bloomberg-btn bloomberg-btn-sm">ADD</button>
            </td>
          </tr>

          <tr>
            <td>
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white text-xs font-bold">
                  PLTR
                </div>
                <div>
                  <p class="font-bold text-white">PLTR</p>
                  <p class="text-xs text-slate-500">Palantir</p>
                </div>
              </div>
            </td>
            <td class="font-mono text-white">$71.24</td>
            <td class="font-mono text-emerald-400 font-bold">+12.8%</td>
            <td class="font-mono text-slate-400">89.4M</td>
            <td class="font-mono text-slate-400">$158B</td>
            <td>
              <span class="px-2 py-0.5 bg-red-500/20 text-red-400 rounded text-xs font-mono font-bold">78</span>
            </td>
            <td>
              <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs font-bold">52W HIGH</span>
            </td>
            <td>
              <button class="bloomberg-btn bloomberg-btn-sm">ADD</button>
            </td>
          </tr>

          <tr>
            <td>
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white text-xs font-bold">
                  RIVN
                </div>
                <div>
                  <p class="font-bold text-white">RIVN</p>
                  <p class="text-xs text-slate-500">Rivian</p>
                </div>
              </div>
            </td>
            <td class="font-mono text-white">$14.87</td>
            <td class="font-mono text-emerald-400 font-bold">+9.2%</td>
            <td class="font-mono text-slate-400">67.8M</td>
            <td class="font-mono text-slate-400">$15B</td>
            <td>
              <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded text-xs font-mono font-bold">42</span>
            </td>
            <td>
              <span class="px-2 py-1 bg-sky-500/20 text-sky-400 rounded text-xs font-bold">VOLUME</span>
            </td>
            <td>
              <button class="bloomberg-btn bloomberg-btn-sm">ADD</button>
            </td>
          </tr>

          <tr>
            <td>
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-rose-500 to-rose-600 flex items-center justify-center text-white text-xs font-bold">
                  MARA
                </div>
                <div>
                  <p class="font-bold text-white">MARA</p>
                  <p class="text-xs text-slate-500">Marathon Digital</p>
                </div>
              </div>
            </td>
            <td class="font-mono text-white">$24.56</td>
            <td class="font-mono text-emerald-400 font-bold">+8.7%</td>
            <td class="font-mono text-slate-400">52.1M</td>
            <td class="font-mono text-slate-400">$7.8B</td>
            <td>
              <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded text-xs font-mono font-bold">55</span>
            </td>
            <td>
              <span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-bold">CRYPTO</span>
            </td>
            <td>
              <button class="bloomberg-btn bloomberg-btn-sm">ADD</button>
            </td>
          </tr>

          <tr>
            <td>
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white text-xs font-bold">
                  SOUN
                </div>
                <div>
                  <p class="font-bold text-white">SOUN</p>
                  <p class="text-xs text-slate-500">SoundHound AI</p>
                </div>
              </div>
            </td>
            <td class="font-mono text-white">$8.42</td>
            <td class="font-mono text-emerald-400 font-bold">+7.5%</td>
            <td class="font-mono text-slate-400">38.9M</td>
            <td class="font-mono text-slate-400">$2.8B</td>
            <td>
              <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded text-xs font-mono font-bold">62</span>
            </td>
            <td>
              <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs font-bold">AI THEME</span>
            </td>
            <td>
              <button class="bloomberg-btn bloomberg-btn-sm">ADD</button>
            </td>
          </tr>

          <tr>
            <td>
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold">
                  IONQ
                </div>
                <div>
                  <p class="font-bold text-white">IONQ</p>
                  <p class="text-xs text-slate-500">IonQ</p>
                </div>
              </div>
            </td>
            <td class="font-mono text-white">$42.18</td>
            <td class="font-mono text-emerald-400 font-bold">+6.9%</td>
            <td class="font-mono text-slate-400">24.5M</td>
            <td class="font-mono text-slate-400">$9.2B</td>
            <td>
              <span class="px-2 py-0.5 bg-red-500/20 text-red-400 rounded text-xs font-mono font-bold">72</span>
            </td>
            <td>
              <span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-bold">QUANTUM</span>
            </td>
            <td>
              <button class="bloomberg-btn bloomberg-btn-sm">ADD</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="flex justify-center">
      <button class="bloomberg-btn">LOAD MORE RESULTS</button>
    </div>
  </div>
</div>

<!-- Saved Scanners -->
<div class="bloomberg-card mt-6">
  <div class="p-5">
    <h3 class="text-sm font-bold text-amber-400 mb-4 tracking-wide">SAVED SCANNERS</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="p-4 rounded bg-slate-800/50 hover:bg-slate-800 cursor-pointer border border-slate-700 transition-all" onclick="loadSaved('momentum')">
        <p class="font-bold text-white text-sm">MOMENTUM PLAYS</p>
        <p class="text-xs text-slate-400 mt-1">RSI > 60, Vol > 2x</p>
      </div>
      <div class="p-4 rounded bg-slate-800/50 hover:bg-slate-800 cursor-pointer border border-slate-700 transition-all" onclick="loadSaved('value')">
        <p class="font-bold text-white text-sm">VALUE STOCKS</p>
        <p class="text-xs text-slate-400 mt-1">P/E < 15, Div > 2%</p>
      </div>
      <div class="p-4 rounded bg-slate-800/50 hover:bg-slate-800 cursor-pointer border border-slate-700 transition-all" onclick="loadSaved('smallcap')">
        <p class="font-bold text-white text-sm">SMALL CAP GROWTH</p>
        <p class="text-xs text-slate-400 mt-1">$300M-$2B, +50% YoY</p>
      </div>
      <div class="p-4 rounded bg-slate-800/50 hover:bg-slate-800 cursor-pointer border border-slate-700 transition-all" onclick="loadSaved('squeeze')">
        <p class="font-bold text-white text-sm">SHORT SQUEEZE</p>
        <p class="text-xs text-slate-400 mt-1">SI > 20%, Days < 5</p>
      </div>
    </div>
  </div>
</div>

<script>
let currentPreset = 'gainers';
let currentFilters = {};

async function runScanner() {
  showToast('Scanning markets...', 'info');

  try {
    // Build query params
    const params = new URLSearchParams();
    if (currentPreset) params.append('preset', currentPreset);

    // Get filter values
    const marketCap = document.querySelector('select[name="marketCap"]')?.value;
    const sector = document.querySelector('select[name="sector"]')?.value;
    const minPrice = document.querySelector('input[name="minPrice"]')?.value;
    const maxPrice = document.querySelector('input[name="maxPrice"]')?.value;
    const minChange = document.querySelector('input[name="minChange"]')?.value;
    const maxChange = document.querySelector('input[name="maxChange"]')?.value;
    const minRsi = document.querySelector('input[name="minRsi"]')?.value;
    const maxRsi = document.querySelector('input[name="maxRsi"]')?.value;

    if (sector && sector !== 'All Sectors') params.append('sector', sector);
    if (minPrice) params.append('minPrice', minPrice);
    if (maxPrice) params.append('maxPrice', maxPrice);
    if (minChange) params.append('minChange', minChange);
    if (maxChange) params.append('maxChange', maxChange);
    if (minRsi) params.append('minRsi', minRsi);
    if (maxRsi) params.append('maxRsi', maxRsi);

    // Map market cap to values
    const marketCapMap = {
      'Mega ($200B+)': { min: 200000000000 },
      'Large ($10B-$200B)': { min: 10000000000, max: 200000000000 },
      'Mid ($2B-$10B)': { min: 2000000000, max: 10000000000 },
      'Small ($300M-$2B)': { min: 300000000, max: 2000000000 },
      'Micro (<$300M)': { max: 300000000 }
    };
    if (marketCap && marketCapMap[marketCap]) {
      if (marketCapMap[marketCap].min) params.append('minMarketCap', marketCapMap[marketCap].min);
      if (marketCapMap[marketCap].max) params.append('maxMarketCap', marketCapMap[marketCap].max);
    }

    const response = await fetch(`/api/scanner/scan?${params.toString()}`);
    const data = await response.json();

    if (data.success) {
      renderResults(data.results);
      document.getElementById('resultCount').textContent = data.count;
      showToast('Scan complete!', 'success');
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    console.error('Scanner error:', error);
    showToast('Scan failed: ' + error.message, 'error');
  }
}

function renderResults(stocks) {
  const tbody = document.getElementById('scanResults');
  if (!stocks || stocks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-400 py-8">No stocks match your criteria</td></tr>';
    return;
  }

  tbody.innerHTML = stocks.map(stock => `
    <tr>
      <td>
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded bg-gradient-to-br from-${getColorForSymbol(stock.symbol)}-500 to-${getColorForSymbol(stock.symbol)}-600 flex items-center justify-center text-white text-xs font-bold">
            ${stock.symbol.substring(0, 4)}
          </div>
          <div>
            <p class="font-bold text-white">${stock.symbol}</p>
            <p class="text-xs text-slate-500">${stock.name || ''}</p>
          </div>
        </div>
      </td>
      <td class="font-mono text-white">$${stock.price?.toFixed(2) || '-'}</td>
      <td class="font-mono ${stock.changePercent >= 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">
        ${stock.changePercent >= 0 ? '+' : ''}${stock.changePercent?.toFixed(1) || '0'}%
      </td>
      <td class="font-mono text-slate-400">${formatVolume(stock.volume)}</td>
      <td class="font-mono text-slate-400">${formatMarketCap(stock.marketCap)}</td>
      <td>
        <span class="px-2 py-0.5 ${getRsiClass(stock.rsi)} rounded text-xs font-mono font-bold">
          ${stock.rsi?.toFixed(0) || '-'}
        </span>
      </td>
      <td>
        <span class="px-2 py-1 bg-${stock.signal?.color || 'slate'}-500/20 text-${stock.signal?.color || 'slate'}-400 rounded text-xs font-bold">
          ${stock.signal?.type || 'NEUTRAL'}
        </span>
      </td>
      <td>
        <button onclick="addToWatchlist('${stock.symbol}')" class="bloomberg-btn bloomberg-btn-sm">ADD</button>
      </td>
    </tr>
  `).join('');
}

function getColorForSymbol(symbol) {
  const colors = ['purple', 'sky', 'emerald', 'rose', 'amber', 'indigo'];
  const hash = symbol.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
  return colors[hash % colors.length];
}

function getRsiClass(rsi) {
  if (rsi < 30) return 'bg-emerald-500/20 text-emerald-400';
  if (rsi > 70) return 'bg-red-500/20 text-red-400';
  return 'bg-amber-500/20 text-amber-400';
}

function formatVolume(vol) {
  if (!vol) return '-';
  if (vol >= 1e9) return (vol / 1e9).toFixed(1) + 'B';
  if (vol >= 1e6) return (vol / 1e6).toFixed(1) + 'M';
  if (vol >= 1e3) return (vol / 1e3).toFixed(1) + 'K';
  return vol.toString();
}

function formatMarketCap(cap) {
  if (!cap) return '-';
  if (cap >= 1e12) return '$' + (cap / 1e12).toFixed(1) + 'T';
  if (cap >= 1e9) return '$' + (cap / 1e9).toFixed(0) + 'B';
  if (cap >= 1e6) return '$' + (cap / 1e6).toFixed(0) + 'M';
  return '$' + cap.toString();
}

function loadPreset(preset) {
  currentPreset = preset;
  // Reset all preset buttons
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.className = 'preset-btn bloomberg-btn bloomberg-btn-sm';
  });
  // Highlight selected preset
  event.currentTarget.className = 'preset-btn bloomberg-btn bloomberg-btn-sm bg-emerald-500 text-black font-bold';
  showToast(`Loaded ${preset} preset`, 'info');
  runScanner();
}

async function saveScanner() {
  const name = prompt('Enter a name for this scanner:');
  if (!name) return;

  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/scanner/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ name, filters: currentFilters })
    });
    const data = await response.json();
    if (data.success) {
      showToast('Scanner saved!', 'success');
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    showToast('Failed to save scanner', 'error');
  }
}

function exportResults() {
  showToast('Exporting to CSV...', 'info');

  const rows = Array.from(document.querySelectorAll('#scanResults tr')).map(row => {
    const cells = row.querySelectorAll('td');
    return [
      cells[0]?.querySelector('.font-bold')?.textContent || '',
      cells[1]?.textContent?.trim() || '',
      cells[2]?.textContent?.trim() || '',
      cells[3]?.textContent?.trim() || '',
      cells[4]?.textContent?.trim() || '',
      cells[5]?.textContent?.trim() || ''
    ].join(',');
  });

  const csv = 'Symbol,Price,Change%,Volume,MarketCap,RSI\n' + rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `scanner-results-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  showToast('Export complete!', 'success');
}

function addCondition() {
  showToast('Custom condition builder coming soon!', 'info');
}

function loadSaved(name) {
  currentPreset = name;
  showToast(`Loading ${name} scanner...`, 'info');
  runScanner();
}

async function addToWatchlist(symbol) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/watchlist/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ symbol })
    });
    showToast(`${symbol} added to watchlist!`, 'success');
  } catch (error) {
    showToast('Failed to add to watchlist', 'error');
  }
}

// Load scanner on page load
document.addEventListener('DOMContentLoaded', () => {
  runScanner();
});
</script>

<%- include('../partials/footer') %>
