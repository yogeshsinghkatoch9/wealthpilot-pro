// Prisma Schema for WealthPilot Pro
// PostgreSQL for AWS RDS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USER & AUTH ==============

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  phone         String?
  avatarUrl     String?   @map("avatar_url")
  timezone      String    @default("America/New_York")
  currency      String    @default("USD")
  theme         String    @default("dark")
  isActive      Boolean   @default(true) @map("is_active")
  isVerified    Boolean   @default(false) @map("is_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  plan          String    @default("free")
  planExpiresAt DateTime? @map("plan_expires_at")

  portfolios    Portfolio[]
  watchlists    Watchlist[]
  alerts        Alert[]
  transactions  Transaction[]
  sessions      Session[]
  apiKeys       ApiKey[]
  settings      UserSettings?
  notifications Notification[]

  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String
  name        String
  keyHash     String    @unique
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
}

model UserSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(false)
  alertsEnabled         Boolean  @default(true)
  dividendAlerts        Boolean  @default(true)
  earningsAlerts        Boolean  @default(true)
  priceAlerts           Boolean  @default(true)
  weeklyReport          Boolean  @default(true)
  monthlyReport         Boolean  @default(true)
  defaultPortfolioId    String?
  dashboardLayout       String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============== PORTFOLIO ==============

model Portfolio {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  name          String
  description   String?
  currency      String    @default("USD")
  benchmark     String    @default("SPY")
  isDefault     Boolean   @default(false) @map("is_default")
  isPublic      Boolean   @default(false) @map("is_public")
  cashBalance   Float     @default(0) @map("cash_balance")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings      Holding[]
  transactions  Transaction[]
  snapshots     PortfolioSnapshot[]
  sectorAllocations PortfolioSectorAllocation[]

  @@unique([userId, name])
  @@index([userId])
  @@map("portfolios")
}

model Holding {
  id            String    @id @default(uuid())
  portfolioId   String    @map("portfolio_id")
  symbol        String
  shares        Float
  avgCostBasis  Float     @map("avg_cost_basis")
  sector        String?
  assetType     String    @default("stock") @map("asset_type")
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  portfolio     Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  taxLots       TaxLot[]

  @@unique([portfolioId, symbol])
  @@index([portfolioId])
  @@index([symbol])
  @@map("holdings")
}

model TaxLot {
  id            String    @id @default(uuid())
  holdingId     String    @map("holding_id")
  shares        Float
  costBasis     Float     @map("cost_basis")
  purchaseDate  DateTime  @map("purchase_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  holding       Holding   @relation(fields: [holdingId], references: [id], onDelete: Cascade)

  @@index([holdingId])
  @@map("tax_lots")
}

model Transaction {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  portfolioId   String    @map("portfolio_id")
  symbol        String
  type          String
  shares        Float?
  price         Float?
  amount        Float
  fees          Float     @default(0)
  notes         String?
  executedAt    DateTime  @map("executed_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolio     Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([userId])
  @@index([symbol])
  @@index([executedAt])
  @@map("transactions")
}

model PortfolioSnapshot {
  id            String    @id @default(uuid())
  portfolioId   String
  totalValue    Float
  cashBalance   Float
  dayGain       Float
  dayGainPct    Float
  totalGain     Float
  totalGainPct  Float
  holdings      String
  snapshotDate  DateTime
  createdAt     DateTime  @default(now())

  portfolio     Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, snapshotDate])
  @@index([portfolioId])
  @@index([snapshotDate])
}

// ============== WATCHLIST ==============

model Watchlist {
  id            String    @id @default(uuid())
  userId        String
  name          String
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         WatchlistItem[]

  @@unique([userId, name])
  @@index([userId])
}

model WatchlistItem {
  id            String    @id @default(uuid())
  watchlistId   String    @map("watchlist_id")
  symbol        String
  targetPrice   Float?    @map("target_price")
  notes         String?
  addedAt       DateTime  @default(now()) @map("added_at")
  watchlist     Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade)

  @@unique([watchlistId, symbol])
  @@index([watchlistId])
  @@map("watchlist_items")
}

// ============== ALERTS ==============

model Alert {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  symbol        String?
  type          String
  condition     String
  message       String?
  isActive      Boolean   @default(true) @map("is_active")
  isTriggered   Boolean   @default(false) @map("is_triggered")
  triggeredAt   DateTime? @map("triggered_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([symbol])
  @@index([isActive])
  @@map("alerts")
}

// ============== NOTIFICATIONS ==============

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // alert, dividend, earnings, price_target, system
  title     String
  message   String
  data      String?  // JSON string for additional data
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============== MARKET DATA CACHE ==============

model StockQuote {
  symbol            String    @id
  name              String?
  exchange          String?
  sector            String?
  industry          String?
  price             Float
  previousClose     Float?    @map("previous_close")
  open              Float?    @map("open_price")
  high              Float?
  low               Float?
  volume            BigInt?
  marketCap         BigInt?   @map("market_cap")
  peRatio           Float?    @map("pe_ratio")
  dividend          Float?
  dividendYield     Float?    @map("dividend_yield")
  beta              Float?
  week52High        Float?    @map("week_52_high")
  week52Low         Float?    @map("week_52_low")
  change            Float?    @map("change_amount")
  changePercent     Float?    @map("change_percent")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("stock_quotes")
}

model StockHistory {
  id            String    @id @default(uuid())
  symbol        String
  date          DateTime
  open          Float
  high          Float
  low           Float
  close         Float
  adjClose      Float
  volume        Int

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
}

model DividendHistory {
  id            String    @id @default(uuid())
  symbol        String
  exDate        DateTime
  payDate       DateTime?
  recordDate    DateTime?
  amount        Float
  frequency     String?
  type          String?

  @@unique([symbol, exDate])
  @@index([symbol])
  @@index([exDate])
}

model EarningsCalendar {
  id              String    @id @default(uuid())
  symbol          String
  reportDate      DateTime
  fiscalQuarter   String?
  fiscalYear      Int?
  epsEstimate     Float?
  epsActual       Float?
  revenueEstimate Float?
  revenueActual   Float?
  surprise        Float?
  timing          String?

  @@unique([symbol, reportDate])
  @@index([symbol])
  @@index([reportDate])
}

// ============== FUNDAMENTALS ==============

model CompanyProfile {
  id                String    @id @default(uuid())
  symbol            String    @unique
  name              String
  description       String?
  exchange          String?
  sector            String?
  industry          String?
  employees         Int?
  ceo               String?
  headquarters      String?
  website           String?
  ipoDate           DateTime?
  updatedAt         DateTime  @updatedAt

  @@index([symbol])
  @@index([sector])
}

model FinancialStatement {
  id                String    @id @default(uuid())
  symbol            String
  period            String
  fiscalDate        DateTime
  reportedDate      DateTime?
  revenue           Float?
  costOfRevenue     Float?
  grossProfit       Float?
  operatingExpenses Float?
  operatingIncome   Float?
  netIncome         Float?
  eps               Float?
  epsDiluted        Float?
  totalAssets       Float?
  totalLiabilities  Float?
  totalEquity       Float?
  cash              Float?
  totalDebt         Float?
  operatingCashFlow Float?
  capitalExpenditure Float?
  freeCashFlow      Float?
  dividendsPaid     Float?
  grossMargin       Float?
  operatingMargin   Float?
  netMargin         Float?
  roe               Float?
  roa               Float?
  currentRatio      Float?
  debtToEquity      Float?
  createdAt         DateTime  @default(now())

  @@unique([symbol, period, fiscalDate])
  @@index([symbol])
  @@index([fiscalDate])
}

// ============== ANALYTICS ==============

model InsiderTransaction {
  id                String    @id @default(uuid())
  symbol            String
  filingDate        DateTime
  transactionDate   DateTime?
  ownerName         String
  ownerTitle        String?
  transactionType   String
  shares            Float
  pricePerShare     Float?
  totalValue        Float?
  sharesOwned       Float?

  @@index([symbol])
  @@index([filingDate])
}

model InstitutionalHolding {
  id                String    @id @default(uuid())
  symbol            String
  holderName        String
  shares            Float
  value             Float
  percentOwned      Float?
  changeShares      Float?
  changePercent     Float?
  reportDate        DateTime

  @@unique([symbol, holderName, reportDate])
  @@index([symbol])
  @@index([reportDate])
}

model AnalystRating {
  id                String    @id @default(uuid())
  symbol            String
  firm              String
  analyst           String?
  rating            String
  priceTarget       Float?
  previousRating    String?
  previousTarget    Float?
  date              DateTime

  @@index([symbol])
  @@index([date])
}

// ============== NEWS ==============

model NewsArticle {
  id                String    @id @default(uuid())
  symbol            String?
  title             String
  summary           String?
  source            String
  url               String
  imageUrl          String?
  sentiment         String?
  sentimentScore    Float?
  publishedAt       DateTime
  createdAt         DateTime  @default(now())

  @@index([symbol])
  @@index([publishedAt])
}

// ============== ADVANCED ANALYTICS ==============

model BenchmarkHistory {
  id            String    @id @default(uuid())
  symbol        String    // SPY, QQQ, DIA, etc.
  date          DateTime
  close         Float
  adjustedClose Float

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
}

model FactorReturns {
  id          String    @id @default(uuid())
  date        DateTime  @unique
  mktRf       Float     // Market - Risk Free
  smb         Float     // Small Minus Big
  hml         Float     // High Minus Low
  rmw         Float     // Robust Minus Weak
  cma         Float     // Conservative Minus Aggressive
  mom         Float     // Momentum
  rf          Float     // Risk Free Rate

  @@index([date])
}

model ESGScores {
  id                String    @id @default(uuid())
  symbol            String
  date              DateTime
  esgScore          Float     // Overall ESG score (0-100)
  environmentScore  Float     // Environmental score
  socialScore       Float     // Social score
  governanceScore   Float     // Governance score
  carbonFootprint   Float?    // Metric tons CO2e per $M invested

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
}

model LiquidityMetrics {
  id              String    @id @default(uuid())
  symbol          String
  date            DateTime
  bidAskSpread    Float     // Absolute spread
  bidAskSpreadPct Float     // Percentage spread
  avgDailyVolume  Int       // Average daily volume
  avgDollarVolume Float     // Average dollar volume

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
}

// ============== SENTIMENT ANALYSIS ==============

model SentimentData {
  id                String    @id @default(uuid())
  symbol            String
  date              DateTime
  overallScore      Float     // Overall sentiment score (0-100)
  overallSentiment  String    // BULLISH, BEARISH, NEUTRAL
  socialMediaScore  Float     // Social media sentiment (0-100)
  newsScore         Float     // News sentiment (0-100)
  analystScore      Float     // Analyst sentiment (0-100)
  mentionVolume     Int       // Total mentions across all platforms
  correlationScore  Float?    // Correlation with price movement
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
  @@index([overallScore])
}

model SocialMediaMention {
  id            String    @id @default(uuid())
  symbol        String
  platform      String    // twitter, reddit, stocktwits, yahoo_finance
  content       String?   // Mention text (optional)
  sentiment     String    // positive, negative, neutral, bullish, bearish
  sentimentScore Float    // Numerical sentiment score
  author        String?   // Username/author
  mentions      Int       @default(1)
  likes         Int?      // Engagement metrics
  retweets      Int?
  publishedAt   DateTime
  createdAt     DateTime  @default(now())

  @@index([symbol])
  @@index([platform])
  @@index([publishedAt])
  @@index([sentiment])
}

model TrendingTopic {
  id            String    @id @default(uuid())
  symbol        String
  topic         String    // Hashtag or topic name
  mentionCount  Int       // Number of mentions
  sentiment     String    // Overall sentiment for this topic
  trendingScore Float     // Trending score/velocity
  date          DateTime
  createdAt     DateTime  @default(now())

  @@unique([symbol, topic, date])
  @@index([symbol])
  @@index([date])
  @@index([trendingScore])
}

model SentimentHistory {
  id            String    @id @default(uuid())
  symbol        String
  timestamp     DateTime
  score         Float     // Sentiment score at this timestamp
  volume        Int       // Mention volume at this timestamp
  source        String    // social_media, news, analyst

  @@index([symbol])
  @@index([timestamp])
  @@index([source])
}

// ============== SECTOR ANALYSIS ==============

model SectorData {
  id                    String    @id @default(uuid())
  sectorName            String    @unique
  sectorCode            String    @unique
  description           String?
  currentPrice          Float?
  change                Float?
  changePercent         Float?
  volume                Int?
  marketCap             Float?
  peRatio               Float?
  dividendYield         Float?
  week52High            Float?
  week52Low             Float?
  ytdReturn             Float?
  oneMonthReturn        Float?
  threeMonthReturn      Float?
  oneYearReturn         Float?
  volatility            Float?
  beta                  Float?
  sharpeRatio           Float?
  updatedAt             DateTime  @updatedAt
  createdAt             DateTime  @default(now())

  @@index([sectorName])
  @@index([sectorCode])
}

model SectorPerformance {
  id                String    @id @default(uuid())
  sectorName        String
  sectorCode        String
  date              DateTime
  open              Float
  high              Float
  low               Float
  close             Float
  volume            Int?
  returnPct         Float?
  relativeStrength  Float?
  momentumScore     Float?
  createdAt         DateTime  @default(now())

  @@unique([sectorCode, date])
  @@index([sectorCode])
  @@index([sectorName])
  @@index([date])
}

model PortfolioSectorAllocation {
  id              String    @id @default(uuid())
  portfolioId     String
  sectorName      String
  sectorCode      String?
  totalValue      Float
  percentAlloc    Float
  numHoldings     Int
  avgCostBasis    Float?
  currentReturn   Float?
  returnPct       Float?
  weight          Float?
  date            DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  portfolio       Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, sectorName, date])
  @@index([portfolioId])
  @@index([sectorName])
  @@index([date])
}

model SectorRotation {
  id              String    @id @default(uuid())
  fromSector      String
  toSector        String
  date            DateTime
  flowAmount      Float
  flowPercent     Float
  reason          String?
  createdAt       DateTime  @default(now())

  @@index([date])
  @@index([fromSector])
  @@index([toSector])
}
